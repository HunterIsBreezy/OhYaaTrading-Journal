<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>ohYaaa Trading Journal</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='32' height='32' rx='6' fill='%231e40af'/%3E%3Cline x1='8' y1='6' x2='8' y2='20' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='6' y='9' width='4' height='7' fill='%2322c55e' rx='0.5'/%3E%3Cline x1='16' y1='10' x2='16' y2='28' stroke='%23ef4444' stroke-width='1.5'/%3E%3Crect x='14' y='14' width='4' height='10' fill='%23ef4444' rx='0.5'/%3E%3Cline x1='24' y1='3' x2='24' y2='18' stroke='%2322c55e' stroke-width='1.5'/%3E%3Crect x='22' y='5' width='4' height='8' fill='%2322c55e' rx='0.5'/%3E%3Cpath d='M4 24 L10 16 L16 20 L22 14 L28 8' stroke='white' stroke-width='4' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M4 24 L10 16 L16 20 L22 14 L28 8' stroke='url(%23favGrad)' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M23 8 L28 8 L28 13' stroke='white' stroke-width='3.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cpath d='M23 8 L28 8 L28 13' stroke='%2322c55e' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3Cdefs%3E%3ClinearGradient id='favGrad' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%23ef4444'/%3E%3Cstop offset='100%25' stop-color='%2322c55e'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0); }
    .mb-safe { margin-bottom: env(safe-area-inset-bottom, 0); }
    
    /* Mobile bottom nav spacing */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .mobile-content-padding {
        padding-bottom: calc(4rem + env(safe-area-inset-bottom, 0));
      }
    }
    @supports not (padding-bottom: env(safe-area-inset-bottom)) {
      .mobile-content-padding {
        padding-bottom: 4rem;
      }
    }
    
    /* Prevent body scroll when modal open */
    body.modal-open {
      overflow: hidden;
    }
    
    /* Touch-friendly tap highlights */
    @media (hover: none) {
      button, a {
        -webkit-tap-highlight-color: transparent;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

    // =============================================================================
    // FIREBASE CONFIGURATION
    // =============================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCVh51PQ4IgSR7b-I6JtZgv42X2-03vJeo",
      authDomain: "trading-journal-86e97.firebaseapp.com",
      projectId: "trading-journal-86e97",
      storageBucket: "trading-journal-86e97.firebasestorage.app",
      messagingSenderId: "928347541219",
      appId: "1:928347541219:web:44f62f5034fc91e476bfd6",
      measurementId: "G-S8NTTW1NNR"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // =============================================================================
    // EMAIL CONFIGURATION (via Firebase Cloud Function)
    // =============================================================================
    
    // Send email via Firebase Cloud Function (HTTP endpoint)
    const sendEmail = async ({ to, subject, html }) => {
      try {
        const response = await fetch('https://us-central1-trading-journal-86e97.cloudfunctions.net/sendEmail', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ to, subject, html }),
        });
        
        const data = await response.json();
        if (!response.ok) {
          console.error('Email send error:', data);
          return { success: false, error: data };
        }
        return { success: true, data };
      } catch (error) {
        console.error('Email send error:', error);
        return { success: false, error };
      }
    };

    // Email templates
    const emailTemplates = {
      mentorInvite: (mentorName, studentEmail) => ({
        to: studentEmail,
        subject: `${mentorName} wants to mentor you on Trading Journal`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <h2 style="color: #1f2937;">You've Been Invited!</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              <strong>${mentorName}</strong> has invited you to be their student on Trading Journal.
            </p>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              As a student, your mentor will be able to view your trading journal to help guide your trading journey.
            </p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                Log In to Accept
              </a>
            </div>
            <p style="color: #6b7280; font-size: 14px;">
              Log in to your account to accept or decline this invitation.
            </p>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),
      
      inviteAccepted: (mentorEmail, studentName) => ({
        to: mentorEmail,
        subject: `${studentName} accepted your mentor invitation!`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <h2 style="color: #1f2937;">Great News! üéâ</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              <strong>${studentName}</strong> has accepted your mentor invitation!
            </p>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              You can now view their trading journal and help guide their trading journey.
            </p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                View Your Students
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),

      welcome: (userEmail, userName) => ({
        to: userEmail,
        subject: `Welcome to Trading Journal, ${userName}!`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <h2 style="color: #1f2937;">Welcome, ${userName}! üëã</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              Thank you for joining Trading Journal. We're excited to help you track and improve your trading performance.
            </p>
            <h3 style="color: #1f2937;">Get Started:</h3>
            <ul style="color: #4b5563; font-size: 16px; line-height: 1.8;">
              <li>üìà Log your first trade</li>
              <li>üéØ Set up your trading setups</li>
              <li>‚ö†Ô∏è Track your common mistakes</li>
              <li>üèÜ Set yearly goals and challenges</li>
            </ul>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                Start Trading Journal
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),

      dailyTargetHit: (userEmail, userName, dailyPnL, dailyTarget) => ({
        to: userEmail,
        subject: `üéØ Daily Target Hit! +${dailyPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
              <span style="font-size: 48px;">üéØ</span>
            </div>
            <h2 style="color: #059669; text-align: center;">Daily Target Hit!</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6; text-align: center;">
              Congratulations, <strong>${userName}</strong>! You crushed your daily target today!
            </p>
            <div style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
              <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 14px;">Today's P&L</p>
              <p style="color: white; font-size: 36px; font-weight: bold; margin: 0;">+${dailyPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
              <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0 0; font-size: 14px;">Target: ${dailyTarget.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
            </div>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6; text-align: center;">
              Keep up the great work! Consistency is key to long-term trading success.
            </p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #059669; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                View Your Dashboard
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),

      weeklyRecap: (userEmail, userName, stats) => ({
        to: userEmail,
        subject: `üìä Your Weekly Trading Recap - ${stats.totalPnL >= 0 ? '+' : ''}${stats.totalPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <h2 style="color: #1f2937; text-align: center;">Weekly Trading Recap üìä</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6; text-align: center;">
              Hey ${userName}, here's how your week went!
            </p>
            
            <!-- Main P&L Card -->
            <div style="background: ${stats.totalPnL >= 0 ? 'linear-gradient(135deg, #059669 0%, #10b981 100%)' : 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)'}; border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
              <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 14px;">Week's P&L</p>
              <p style="color: white; font-size: 36px; font-weight: bold; margin: 0;">${stats.totalPnL >= 0 ? '+' : ''}${stats.totalPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
            </div>

            <!-- Stats Grid -->
            <div style="display: table; width: 100%; margin: 24px 0;">
              <div style="display: table-row;">
                <div style="display: table-cell; width: 50%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Total Trades</p>
                    <p style="color: #1f2937; font-size: 24px; font-weight: bold; margin: 0;">${stats.totalTrades}</p>
                  </div>
                </div>
                <div style="display: table-cell; width: 50%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Win Rate</p>
                    <p style="color: #1f2937; font-size: 24px; font-weight: bold; margin: 0;">${stats.winRate}%</p>
                  </div>
                </div>
              </div>
              <div style="display: table-row;">
                <div style="display: table-cell; width: 50%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Wins / Losses</p>
                    <p style="color: #1f2937; font-size: 24px; font-weight: bold; margin: 0;"><span style="color: #059669;">${stats.wins}W</span> / <span style="color: #dc2626;">${stats.losses}L</span></p>
                  </div>
                </div>
                <div style="display: table-cell; width: 50%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Best Trade</p>
                    <p style="color: #059669; font-size: 24px; font-weight: bold; margin: 0;">+${stats.bestTrade.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                  </div>
                </div>
              </div>
            </div>

            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                View Full Report
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),

      monthlyReport: (userEmail, userName, stats) => ({
        to: userEmail,
        subject: `üìà Your ${stats.monthName} Trading Report - ${stats.totalPnL >= 0 ? '+' : ''}${stats.totalPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;"><span style="color: #111827;">oh</span><span style="color: #2563eb;">Yaaa</span></h1>
            </div>
            <h2 style="color: #1f2937; text-align: center;">${stats.monthName} Performance Report üìà</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6; text-align: center;">
              Hey ${userName}, here's your monthly breakdown!
            </p>
            
            <!-- Main P&L Card -->
            <div style="background: ${stats.totalPnL >= 0 ? 'linear-gradient(135deg, #059669 0%, #10b981 100%)' : 'linear-gradient(135deg, #dc2626 0%, #ef4444 100%)'}; border-radius: 12px; padding: 24px; margin: 24px 0; text-align: center;">
              <p style="color: rgba(255,255,255,0.8); margin: 0 0 8px 0; font-size: 14px;">${stats.monthName} P&L</p>
              <p style="color: white; font-size: 36px; font-weight: bold; margin: 0;">${stats.totalPnL >= 0 ? '+' : ''}${stats.totalPnL.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
              ${stats.yearlyGoal ? `<p style="color: rgba(255,255,255,0.8); margin: 8px 0 0 0; font-size: 14px;">${stats.goalProgress}% of yearly goal</p>` : ''}
            </div>

            <!-- Stats Grid -->
            <div style="display: table; width: 100%; margin: 24px 0;">
              <div style="display: table-row;">
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Total Trades</p>
                    <p style="color: #1f2937; font-size: 20px; font-weight: bold; margin: 0;">${stats.totalTrades}</p>
                  </div>
                </div>
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Win Rate</p>
                    <p style="color: #1f2937; font-size: 20px; font-weight: bold; margin: 0;">${stats.winRate}%</p>
                  </div>
                </div>
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Trading Days</p>
                    <p style="color: #1f2937; font-size: 20px; font-weight: bold; margin: 0;">${stats.tradingDays}</p>
                  </div>
                </div>
              </div>
              <div style="display: table-row;">
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Best Day</p>
                    <p style="color: #059669; font-size: 20px; font-weight: bold; margin: 0;">+${stats.bestDay.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                  </div>
                </div>
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Worst Day</p>
                    <p style="color: #dc2626; font-size: 20px; font-weight: bold; margin: 0;">${stats.worstDay.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                  </div>
                </div>
                <div style="display: table-cell; width: 33%; padding: 8px;">
                  <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; text-align: center;">
                    <p style="color: #6b7280; margin: 0 0 4px 0; font-size: 12px;">Avg/Day</p>
                    <p style="color: ${stats.avgPerDay >= 0 ? '#059669' : '#dc2626'}; font-size: 20px; font-weight: bold; margin: 0;">${stats.avgPerDay >= 0 ? '+' : ''}${stats.avgPerDay.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</p>
                  </div>
                </div>
              </div>
            </div>

            ${stats.topSetup ? `
            <div style="background: #eff6ff; border-radius: 8px; padding: 16px; margin: 24px 0;">
              <p style="color: #1e40af; margin: 0; font-weight: bold;">üèÜ Top Performing Setup: ${stats.topSetup}</p>
            </div>
            ` : ''}

            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                View Full Report
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),
    };

    // =============================================================================
    // AUTH CONTEXT
    // =============================================================================
    const AuthContext = createContext(null);

    function useAuth() {
      return useContext(AuthContext);
    }

    // =============================================================================
    // CONSTANTS
    // =============================================================================
    const STORAGE_KEY = 'tradingJournal:v1';
    const STORAGE_LIMIT_BYTES = 5 * 1024 * 1024;
    const STORAGE_WARNING_PERCENT = 80;
    const BE_THRESHOLD = 0.01;
    const PNL_MISMATCH_THRESHOLD = 0.01;

    // Feedback types for mentor comments on trades
    const FEEDBACK_TYPES = {
      general: { icon: 'üí¨', label: 'General', bgColor: 'bg-blue-100', textColor: 'text-blue-700', borderColor: 'border-blue-200' },
      question: { icon: '‚ùì', label: 'Question', bgColor: 'bg-orange-100', textColor: 'text-orange-700', borderColor: 'border-orange-200' },
      praise: { icon: '‚≠ê', label: 'Praise', bgColor: 'bg-green-100', textColor: 'text-green-700', borderColor: 'border-green-200' },
      improvement: { icon: '‚ö†Ô∏è', label: 'Needs Improvement', bgColor: 'bg-yellow-100', textColor: 'text-yellow-700', borderColor: 'border-yellow-200' },
      setup: { icon: 'üéØ', label: 'Setup Related', bgColor: 'bg-purple-100', textColor: 'text-purple-700', borderColor: 'border-purple-200' },
      psychology: { icon: 'üß†', label: 'Psychology', bgColor: 'bg-pink-100', textColor: 'text-pink-700', borderColor: 'border-pink-200' },
      risk: { icon: 'üìè', label: 'Risk Management', bgColor: 'bg-red-100', textColor: 'text-red-700', borderColor: 'border-red-200' },
    };

    // Flag types for marking trades
    const FLAG_TYPES = {
      discuss: { icon: 'üó£Ô∏è', label: "Let's Discuss", bgColor: 'bg-blue-100', textColor: 'text-blue-700' },
      great: { icon: '‚ú®', label: 'Great Execution', bgColor: 'bg-green-100', textColor: 'text-green-700' },
      risk_concern: { icon: '‚ö†Ô∏è', label: 'Risk Concern', bgColor: 'bg-orange-100', textColor: 'text-orange-700' },
      rule_violation: { icon: 'üö´', label: 'Rule Violation', bgColor: 'bg-red-100', textColor: 'text-red-700' },
    };

    // Assignment categories for homework
    const ASSIGNMENT_CATEGORIES = {
      reading: { icon: 'üìñ', label: 'Reading', bgColor: 'bg-blue-100', textColor: 'text-blue-700' },
      practice: { icon: 'üéØ', label: 'Practice', bgColor: 'bg-green-100', textColor: 'text-green-700' },
      review: { icon: 'üìä', label: 'Review', bgColor: 'bg-purple-100', textColor: 'text-purple-700' },
      mindset: { icon: 'üß†', label: 'Mindset', bgColor: 'bg-pink-100', textColor: 'text-pink-700' },
      risk: { icon: 'üìè', label: 'Risk Management', bgColor: 'bg-orange-100', textColor: 'text-orange-700' },
      other: { icon: 'üìù', label: 'Other', bgColor: 'bg-gray-100', textColor: 'text-gray-700' },
    };

    // Challenge types for homework challenges
    const HOMEWORK_CHALLENGE_TYPES = {
      profit: { label: 'Profit Target', metric: 'Total P&L', unit: '$' },
      winrate: { label: 'Win Rate', metric: 'Win percentage', unit: '%' },
      trades: { label: 'Trade Count', metric: 'Number of trades', unit: 'trades' },
      streak: { label: 'Profitable Streak', metric: 'Consecutive profitable days', unit: 'days' },
      max_loss: { label: 'Max Loss Limit', metric: 'No single loss over', unit: '$' },
      custom: { label: 'Custom', metric: 'Manual tracking', unit: '' },
    };

    const EMPTY_STATE = {
      trades: [],
      setups: [],
      mistakes: [],
      dailyNotes: {},
      yearlyGoal: null, // { year, target, createdAt, updatedAt }
      challenges: [], // Array of challenge objects
    };

    const NAV_ITEMS = [
      { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
      { id: 'tradelog', label: 'Trade Log', icon: 'tradelog' },
      { id: 'calendar', label: 'Calendar', icon: 'calendar' },
      { id: 'goals', label: 'Goals', icon: 'goals' },
      { id: 'setups', label: 'Setups', icon: 'setups' },
      { id: 'mistakes', label: 'Mistakes', icon: 'mistakes' },
      { id: 'profile', label: 'Profile', icon: 'profile' },
    ];

    const FILTER_OPTIONS = [
      { id: 'day', label: 'Day' },
      { id: 'week', label: 'Week' },
      { id: 'month', label: 'Month' },
      { id: 'year', label: 'Year' },
      { id: 'all', label: 'All Time' },
    ];

    const ASSET_TYPES = [
      { id: 'stock', label: 'Stock', sizeLabel: 'Shares' },
      { id: 'option', label: 'Option', sizeLabel: 'Contracts' },
      { id: 'future', label: 'Future', sizeLabel: 'Contracts' },
      { id: 'forex', label: 'Forex', sizeLabel: 'Units' },
      { id: 'crypto', label: 'Crypto', sizeLabel: 'Units' },
    ];

    const POSITION_TYPES = [
      { id: 'long', label: 'Long' },
      { id: 'short', label: 'Short' },
      { id: 'long_scalp', label: 'Long Scalp' },
      { id: 'short_scalp', label: 'Short Scalp' },
    ];

    // =============================================================================
    // ICONS
    // =============================================================================
    const Icons = {
      dashboard: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
      ),
      tradelog: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" />
          <rect x="9" y="3" width="6" height="4" rx="1" />
          <path d="M9 12h6M9 16h6" />
        </svg>
      ),
      calendar: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <rect x="3" y="4" width="18" height="18" rx="2" />
          <path d="M16 2v4M8 2v4M3 10h18" />
        </svg>
      ),
      setups: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2L2 7l10 5 10-5-10-5z" />
          <path d="M2 17l10 5 10-5" />
          <path d="M2 12l10 5 10-5" />
        </svg>
      ),
      mistakes: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 8v4M12 16h.01" />
        </svg>
      ),
      menu: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      ),
      chevronLeft: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M15 18l-6-6 6-6" />
        </svg>
      ),
      chevronRight: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M9 18l6-6-6-6" />
        </svg>
      ),
      warning: (
        <svg viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4">
          <path d="M12 2L1 21h22L12 2zm0 4l7.53 13H4.47L12 6zm-1 5v4h2v-4h-2zm0 6v2h2v-2h-2z" />
        </svg>
      ),
      trendUp: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M23 6l-9.5 9.5-5-5L1 18" />
          <path d="M17 6h6v6" />
        </svg>
      ),
      trendDown: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M23 18l-9.5-9.5-5 5L1 6" />
          <path d="M17 18h6v-6" />
        </svg>
      ),
      plus: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 5v14M5 12h14" />
        </svg>
      ),
      x: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      ),
      edit: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>
      ),
      trash: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
        </svg>
      ),
      upload: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
        </svg>
      ),
      starEmpty: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      ),
      starFilled: (
        <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      ),
      goals: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="6" />
          <circle cx="12" cy="12" r="2" />
        </svg>
      ),
      profile: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
      ),
      students: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 00-3-3.87" />
          <path d="M16 3.13a4 4 0 010 7.75" />
        </svg>
      ),
      assignments: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" />
          <rect x="9" y="3" width="6" height="4" rx="1" />
          <path d="M9 14l2 2 4-4" />
        </svg>
      ),
      checkins: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z" />
          <path d="M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01" />
        </svg>
      ),
      sessions: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14v-4z" />
          <rect x="3" y="6" width="12" height="12" rx="2" />
        </svg>
      ),
    };

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    function todayISO() {
      return new Date().toISOString().split('T')[0];
    }

    function nowISO() {
      return new Date().toISOString();
    }

    function generateId() {
      return crypto.randomUUID();
    }

    // Get week bounds (Monday to Sunday) for a given date
    function getWeekBounds(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday
      const monday = new Date(d.setDate(diff));
      monday.setHours(0, 0, 0, 0);
      const sunday = new Date(monday);
      sunday.setDate(monday.getDate() + 6);
      return {
        start: monday.toISOString().split('T')[0],
        end: sunday.toISOString().split('T')[0],
      };
    }

    // Get list of recent weeks for dropdown
    function getRecentWeeks(count = 8) {
      const weeks = [];
      const today = new Date();
      for (let i = 0; i < count; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - (i * 7));
        weeks.push(getWeekBounds(d));
      }
      return weeks;
    }

    // Format week range for display
    function formatWeekRange(start, end) {
      const startDate = new Date(start + 'T00:00:00');
      const endDate = new Date(end + 'T00:00:00');
      const options = { month: 'short', day: 'numeric' };
      return `${startDate.toLocaleDateString('en-US', options)} - ${endDate.toLocaleDateString('en-US', options)}, ${endDate.getFullYear()}`;
    }

    // Calculate week stats from trades
    function calculateWeekStats(trades, weekStart, weekEnd, setups = [], mistakes = []) {
      const weekTrades = trades.filter(t => {
        const date = t.exitDate || t.entryDate;
        return date >= weekStart && date <= weekEnd;
      }).map(t => ({ ...t, derived: calcTradeDerived(t) }));

      const closedTrades = weekTrades.filter(t => !t.derived.isOpen);
      const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
      const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
      const pnls = closedTrades.map(t => t.derived.pnlFinal || 0);
      
      const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
      const winRate = closedTrades.length > 0 ? ((wins.length / closedTrades.length) * 100) : 0;

      // Best and worst trades
      const bestTrade = closedTrades.length > 0
        ? closedTrades.reduce((best, t) => (t.derived.pnlFinal || 0) > (best.derived.pnlFinal || 0) ? t : best, closedTrades[0])
        : null;
      const worstTrade = closedTrades.length > 0
        ? closedTrades.reduce((worst, t) => (t.derived.pnlFinal || 0) < (worst.derived.pnlFinal || 0) ? t : worst, closedTrades[0])
        : null;

      // Avg win/loss and R:R ratio
      const avgWin = wins.length > 0 
        ? wins.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / wins.length 
        : 0;
      const avgLoss = losses.length > 0 
        ? Math.abs(losses.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / losses.length)
        : 0;
      const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';

      // Average rating
      const ratedTrades = closedTrades.filter(t => t.rating && t.rating > 0);
      const avgRating = ratedTrades.length > 0
        ? ratedTrades.reduce((sum, t) => sum + t.rating, 0) / ratedTrades.length
        : 0;

      // P&L by Asset Type
      const pnlByAsset = {};
      closedTrades.forEach(t => {
        const asset = ASSET_TYPES.find(a => a.id === t.assetType)?.label || t.assetType || 'Unknown';
        if (!pnlByAsset[asset]) pnlByAsset[asset] = 0;
        pnlByAsset[asset] += t.derived.pnlFinal || 0;
      });
      const assetPieData = Object.entries(pnlByAsset).map(([label, value]) => ({ label, value }));

      // P&L by Ticker
      const pnlByTicker = {};
      closedTrades.forEach(t => {
        if (!pnlByTicker[t.ticker]) pnlByTicker[t.ticker] = 0;
        pnlByTicker[t.ticker] += t.derived.pnlFinal || 0;
      });
      const tickerPnLData = Object.entries(pnlByTicker)
        .map(([label, value]) => ({ label, value }))
        .sort((a, b) => b.value - a.value);

      // Individual trade P&L
      const tradePnLData = closedTrades.map(t => ({
        label: t.ticker,
        value: t.derived.pnlFinal || 0,
      }));

      // Setup usage and success
      const setupStats = {};
      closedTrades.forEach(t => {
        if (!t.setupId) return;
        const setup = setups.find(s => s.id === t.setupId);
        if (!setup) return;
        
        if (!setupStats[setup.id]) {
          setupStats[setup.id] = { id: setup.id, name: setup.name, wins: 0, losses: 0, total: 0, totalPnL: 0 };
        }
        setupStats[setup.id].total++;
        setupStats[setup.id].totalPnL += t.derived.pnlFinal || 0;
        if (t.derived.winLoss === 'W') setupStats[setup.id].wins++;
        if (t.derived.winLoss === 'L') setupStats[setup.id].losses++;
      });
      const setupData = Object.values(setupStats).map(s => ({
        ...s,
        winRate: s.total > 0 ? ((s.wins / s.total) * 100).toFixed(0) : 0,
      })).sort((a, b) => b.total - a.total);

      // Mistake analytics
      const mistakeStats = {};
      closedTrades.forEach(t => {
        if (!t.mistakeIds || t.mistakeIds.length === 0) return;
        const pnl = t.derived.pnlFinal || 0;
        
        t.mistakeIds.forEach(mistakeId => {
          const mistake = mistakes.find(m => m.id === mistakeId);
          if (!mistake) return;
          
          if (!mistakeStats[mistakeId]) {
            mistakeStats[mistakeId] = {
              id: mistakeId,
              name: mistake.name,
              totalOccurrences: 0,
              losingTrades: 0,
              profitableTrades: 0,
              totalLossAmount: 0,
            };
          }
          mistakeStats[mistakeId].totalOccurrences++;
          if (pnl < 0) {
            mistakeStats[mistakeId].losingTrades++;
            mistakeStats[mistakeId].totalLossAmount += pnl;
          } else {
            mistakeStats[mistakeId].profitableTrades++;
          }
        });
      });
      const mistakeData = Object.values(mistakeStats).sort((a, b) => b.totalOccurrences - a.totalOccurrences);
      const totalMistakeOccurrences = mistakeData.reduce((sum, m) => sum + m.totalOccurrences, 0);
      const totalMistakeLoss = mistakeData.reduce((sum, m) => sum + m.totalLossAmount, 0);

      // Daily P&L breakdown
      const dailyPnL = {};
      closedTrades.forEach(t => {
        const date = t.exitDate || t.entryDate;
        if (!dailyPnL[date]) dailyPnL[date] = { pnl: 0, trades: 0, wins: 0 };
        dailyPnL[date].pnl += t.derived.pnlFinal || 0;
        dailyPnL[date].trades++;
        if (t.derived.winLoss === 'W') dailyPnL[date].wins++;
      });
      const dailyBreakdown = Object.entries(dailyPnL)
        .map(([date, data]) => ({ 
          date, 
          ...data,
          winRate: data.trades > 0 ? ((data.wins / data.trades) * 100).toFixed(0) : 0,
        }))
        .sort((a, b) => a.date.localeCompare(b.date));

      const greenDays = dailyBreakdown.filter(d => d.pnl > 0).length;
      const redDays = dailyBreakdown.filter(d => d.pnl < 0).length;
      const tradingDays = dailyBreakdown.length;

      return {
        // Core stats
        totalTrades: closedTrades.length,
        totalPnL,
        winRate,
        wins: wins.length,
        losses: losses.length,
        
        // Trade stats
        biggestWin: pnls.length > 0 ? Math.max(0, ...pnls) : 0,
        biggestLoss: pnls.length > 0 ? Math.min(0, ...pnls) : 0,
        bestTrade,
        worstTrade,
        avgWin,
        avgLoss,
        riskRewardRatio,
        
        // Rating
        avgRating,
        ratedTradesCount: ratedTrades.length,
        
        // Breakdowns
        assetPieData,
        tickerPnLData,
        tradePnLData,
        setupData,
        mistakeData,
        totalMistakeOccurrences,
        totalMistakeLoss,
        
        // Daily breakdown
        dailyBreakdown,
        tradingDays,
        greenDays,
        redDays,
        
        // All trades for the week (for trade log display)
        trades: weekTrades,
        closedTradesList: closedTrades,
      };
    }

    function calcTradeDerived(trade) {
      // Check if manual P&L is provided (including 0 as valid value)
      const hasManualPnl = trade.pnlManual !== null && trade.pnlManual !== undefined && String(trade.pnlManual).trim() !== '';
      
      // Trade is open only if: no exit date/price AND no manual P&L override
      const hasExit = trade.exitDate !== null && trade.exitDate !== '' && 
                      trade.exitPrice !== null && trade.exitPrice !== undefined;
      const isOpen = !hasExit && !hasManualPnl;
      
      let lengthDays = null;
      if (trade.entryDate && trade.exitDate) {
        const entry = new Date(trade.entryDate);
        const exit = new Date(trade.exitDate);
        lengthDays = Math.round((exit - entry) / (1000 * 60 * 60 * 24));
      }
      
      let pnlCalculated = null;
      if (hasExit && trade.entryPrice != null && trade.exitPrice != null && trade.positionSize != null) {
        if (trade.positionType === 'long') {
          pnlCalculated = (trade.exitPrice - trade.entryPrice) * trade.positionSize;
        } else {
          pnlCalculated = (trade.entryPrice - trade.exitPrice) * trade.positionSize;
        }
        pnlCalculated = Math.round(pnlCalculated * 100) / 100;
      }
      
      const pnlFinal = hasManualPnl ? parseFloat(trade.pnlManual) : pnlCalculated;
      
      let pnlMismatch = false;
      if (hasManualPnl && pnlCalculated !== null) {
        pnlMismatch = Math.abs(parseFloat(trade.pnlManual) - pnlCalculated) > PNL_MISMATCH_THRESHOLD;
      }
      
      let winLoss = null;
      if (pnlFinal !== null && !isNaN(pnlFinal)) {
        if (pnlFinal > BE_THRESHOLD) {
          winLoss = 'W';
        } else if (pnlFinal < -BE_THRESHOLD) {
          winLoss = 'L';
        } else {
          winLoss = 'BE';
        }
      }
      
      return { lengthDays, pnlCalculated, pnlFinal, winLoss, pnlMismatch, isOpen };
    }

    function formatCurrency(amount) {
      if (amount === null || amount === undefined) return '$0.00';
      const prefix = amount >= 0 ? '+' : '';
      return prefix + '$' + Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatCurrencyShort(amount) {
      if (amount === null || amount === undefined) return '$0';
      const absAmount = Math.abs(amount);
      const prefix = amount >= 0 ? '+' : '-';
      if (absAmount >= 1000000) {
        return prefix + '$' + (absAmount / 1000000).toFixed(1) + 'M';
      } else if (absAmount >= 1000) {
        return prefix + '$' + (absAmount / 1000).toFixed(1) + 'K';
      }
      return prefix + '$' + absAmount.toFixed(0);
    }

    // =============================================================================
    // STORAGE HELPERS
    // =============================================================================
    function loadState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return { ...EMPTY_STATE };
        const parsed = JSON.parse(stored);
        if (!parsed.trades || !parsed.setups || !parsed.mistakes || !parsed.dailyNotes) {
          return { ...EMPTY_STATE };
        }
        return parsed;
      } catch (error) {
        console.error('Error loading state:', error);
        return { ...EMPTY_STATE };
      }
    }

    function saveState(state) {
      const jsonString = JSON.stringify(state);
      const storageInfo = getStorageInfo(jsonString);
      if (storageInfo.percentUsed >= 100) {
        throw new Error('Storage quota exceeded. Please export and clear old data.');
      }
      localStorage.setItem(STORAGE_KEY, jsonString);
      return storageInfo;
    }

    function getStorageInfo(jsonString) {
      const str = jsonString || localStorage.getItem(STORAGE_KEY) || '';
      const bytes = new Blob([str]).size;
      const megabytes = Math.round((bytes / (1024 * 1024)) * 100) / 100;
      const percentUsed = Math.round((bytes / STORAGE_LIMIT_BYTES) * 100);
      return {
        bytes,
        megabytes,
        percentUsed,
        nearLimit: percentUsed >= STORAGE_WARNING_PERCENT,
      };
    }

    // =============================================================================
    // SIMPLE SVG LINE CHART COMPONENT (INTERACTIVE)
    // =============================================================================
    function SimpleLineChart({ data, width = 700, height = 350, onPointClick }) {
      const [hoveredPoint, setHoveredPoint] = useState(null);
      const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
      const chartRef = React.useRef(null);

      if (!data || data.length === 0) {
        return (
          <div className="h-96 flex items-center justify-center text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl border border-gray-200">
            <div className="text-center">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="w-16 h-16 mx-auto mb-3 text-gray-300">
                <path d="M3 3v18h18" />
                <path d="M7 14l4-4 4 4 5-5" />
              </svg>
              <p className="font-medium text-gray-500">No P&L Data Yet</p>
              <p className="text-sm text-gray-400 mt-1">Complete some trades to see your performance chart</p>
            </div>
          </div>
        );
      }

      const padding = { top: 20, right: 50, bottom: 45, left: 65 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      const values = data.map(d => d.cumulative);
      const minVal = Math.min(0, ...values);
      const maxVal = Math.max(0, ...values);
      const range = maxVal - minVal || 1;
      
      // Add padding to range
      const paddedMin = minVal - (range * 0.1);
      const paddedMax = maxVal + (range * 0.1);
      const paddedRange = paddedMax - paddedMin;

      // For single point, center it
      const getX = (index) => {
        if (data.length === 1) return padding.left + chartWidth / 2;
        return padding.left + (index / (data.length - 1)) * chartWidth;
      };
      const getY = (value) => padding.top + chartHeight - ((value - paddedMin) / paddedRange) * chartHeight;

      const pathD = data.map((d, i) => {
        const x = getX(i);
        const y = getY(d.cumulative);
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
      }).join(' ');

      const zeroY = getY(0);
      const finalValue = data[data.length - 1]?.cumulative || 0;
      const startValue = data[0]?.cumulative || 0;
      const isPositive = finalValue >= 0;
      const changePercent = startValue !== 0 ? ((finalValue - startValue) / Math.abs(startValue) * 100).toFixed(1) : 0;

      // Area path
      const areaPath = pathD + ` L ${getX(data.length - 1)} ${zeroY} L ${padding.left} ${zeroY} Z`;

      // Y-axis labels
      const yLabels = [];
      const numYLabels = 5;
      for (let i = 0; i <= numYLabels; i++) {
        const value = paddedMin + (paddedRange * (numYLabels - i) / numYLabels);
        yLabels.push({
          value: Math.round(value),
          y: padding.top + (chartHeight * i / numYLabels),
        });
      }

      // X-axis labels
      const xLabels = [];
      const maxXLabels = Math.min(data.length, 7);
      const step = Math.max(1, Math.floor((data.length - 1) / (maxXLabels - 1)));
      for (let i = 0; i < data.length; i += step) {
        xLabels.push({ date: data[i].date, x: getX(i) });
      }
      if (xLabels.length > 0 && data.length > 1 && xLabels[xLabels.length - 1].date !== data[data.length - 1].date) {
        xLabels.push({ date: data[data.length - 1].date, x: getX(data.length - 1) });
      }

      // Stats
      const highestPoint = Math.max(...values);
      const lowestPoint = Math.min(...values);
      const avgValue = values.reduce((a, b) => a + b, 0) / values.length;

      // Find closest point to mouse - improved to always find a point
      const handleMouseMove = (e) => {
        if (!chartRef.current) return;
        const rect = chartRef.current.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Convert to SVG coordinates
        const svgX = (mouseX / rect.width) * width;
        const svgY = (mouseY / rect.height) * height;
        
        setMousePos({ x: mouseX, y: mouseY });

        // Find closest data point by X distance only
        let closestIdx = 0;
        let closestDist = Infinity;
        data.forEach((d, i) => {
          const px = getX(i);
          const dist = Math.abs(svgX - px);
          if (dist < closestDist) {
            closestDist = dist;
            closestIdx = i;
          }
        });

        // Show tooltip if within the general chart area (with generous padding)
        if (svgX >= padding.left - 30 && svgX <= width - padding.right + 30 && 
            svgY >= padding.top - 20 && svgY <= height - padding.bottom + 20) {
          setHoveredPoint(closestIdx);
        } else {
          setHoveredPoint(null);
        }
      };

      const handleMouseLeave = () => {
        setHoveredPoint(null);
      };

      const handleClick = (idx) => {
        if (onPointClick && data[idx]) {
          onPointClick(data[idx]);
        }
      };

      const hoveredData = hoveredPoint !== null ? data[hoveredPoint] : null;
      const prevData = hoveredPoint !== null && hoveredPoint > 0 ? data[hoveredPoint - 1] : null;
      const dayChange = hoveredData && prevData ? hoveredData.cumulative - prevData.cumulative : 
                        hoveredData && hoveredPoint === 0 ? hoveredData.cumulative : null;

      return (
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
          {/* Header */}
          <div className="px-3 md:px-6 py-3 md:py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
              <div>
                <p className="text-[10px] md:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 md:mb-1">Cumulative P&L</p>
                <div className="flex items-baseline gap-2 md:gap-3">
                  <span className={`text-xl md:text-3xl font-bold ${isPositive ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrency(finalValue)}
                  </span>
                  <span className={`inline-flex items-center px-1.5 md:px-2 py-0.5 rounded-full text-[10px] md:text-xs font-medium ${
                    isPositive ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                  }`}>
                    {isPositive ? '‚Üë' : '‚Üì'} {Math.abs(changePercent)}%
                  </span>
                </div>
              </div>
              <div className="flex gap-3 md:gap-6 text-right">
                <div>
                  <p className="text-[10px] md:text-xs text-gray-500">Peak</p>
                  <p className="text-xs md:text-sm font-semibold text-emerald-600">{formatCurrencyShort(highestPoint)}</p>
                </div>
                <div>
                  <p className="text-[10px] md:text-xs text-gray-500">Trough</p>
                  <p className="text-xs md:text-sm font-semibold text-red-600">{formatCurrencyShort(lowestPoint)}</p>
                </div>
                <div className="hidden sm:block">
                  <p className="text-[10px] md:text-xs text-gray-500">Average</p>
                  <p className={`text-xs md:text-sm font-semibold ${avgValue >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(avgValue)}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Chart */}
          <div className="px-1 md:px-2 py-2 relative" ref={chartRef}>
            <svg 
              viewBox={`0 0 ${width} ${height}`} 
              className="w-full cursor-crosshair" 
              style={{ height: '280px' }}
              onMouseMove={handleMouseMove}
              onMouseLeave={handleMouseLeave}
              preserveAspectRatio="xMidYMid meet"
            >
              <defs>
                <linearGradient id="areaGradientPos" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="#10b981" stopOpacity="0.4" />
                  <stop offset="100%" stopColor="#10b981" stopOpacity="0.02" />
                </linearGradient>
                <linearGradient id="areaGradientNeg" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="#ef4444" stopOpacity="0.02" />
                  <stop offset="100%" stopColor="#ef4444" stopOpacity="0.4" />
                </linearGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                  <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>

              {/* Background */}
              <rect x={padding.left} y={padding.top} width={chartWidth} height={chartHeight} fill="#fafbfc" rx="4" />

              {/* Horizontal grid lines */}
              {yLabels.map((label, i) => (
                <g key={i}>
                  <line
                    x1={padding.left}
                    y1={label.y}
                    x2={width - padding.right}
                    y2={label.y}
                    stroke={Math.abs(label.value) < 1 ? '#64748b' : '#e5e7eb'}
                    strokeWidth={Math.abs(label.value) < 1 ? 1.5 : 1}
                    strokeDasharray={Math.abs(label.value) < 1 ? '0' : '4,4'}
                  />
                  <text
                    x={padding.left - 8}
                    y={label.y + 4}
                    textAnchor="end"
                    fontSize="10"
                    fill="#6b7280"
                    fontWeight="500"
                  >
                    {formatCurrencyShort(label.value)}
                  </text>
                </g>
              ))}

              {/* Area fill */}
              <path
                d={areaPath}
                fill={isPositive ? 'url(#areaGradientPos)' : 'url(#areaGradientNeg)'}
              />

              {/* Main line with glow */}
              <path
                d={pathD}
                fill="none"
                stroke={isPositive ? '#10b981' : '#ef4444'}
                strokeWidth="3"
                strokeLinecap="round"
                strokeLinejoin="round"
                filter="url(#glow)"
              />

              {/* Vertical hover line */}
              {hoveredPoint !== null && (
                <line
                  x1={getX(hoveredPoint)}
                  y1={padding.top}
                  x2={getX(hoveredPoint)}
                  y2={height - padding.bottom}
                  stroke="#6366f1"
                  strokeWidth="1.5"
                  strokeDasharray="4,4"
                  opacity="0.8"
                />
              )}

              {/* Data points */}
              {data.map((d, i) => {
                const x = getX(i);
                const y = getY(d.cumulative);
                const ptPositive = d.cumulative >= 0;
                const isLast = i === data.length - 1;
                const isHovered = i === hoveredPoint;
                return (
                  <g 
                    key={i} 
                    onClick={() => handleClick(i)}
                    style={{ cursor: onPointClick ? 'pointer' : 'crosshair' }}
                  >
                    {/* Outer glow for last point or hovered */}
                    {(isLast || isHovered) && (
                      <circle 
                        cx={x} 
                        cy={y} 
                        r={isHovered ? 14 : 10} 
                        fill={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                        opacity="0.25"
                      >
                        {isLast && !isHovered && (
                          <>
                            <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite" />
                            <animate attributeName="opacity" values="0.3;0.1;0.3" dur="2s" repeatCount="indefinite" />
                          </>
                        )}
                      </circle>
                    )}
                    <circle 
                      cx={x} 
                      cy={y} 
                      r={isHovered ? 9 : (isLast ? 7 : 5)} 
                      fill="white" 
                      stroke={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                      strokeWidth="2.5" 
                    />
                    <circle 
                      cx={x} 
                      cy={y} 
                      r={isHovered ? 5 : (isLast ? 4 : 3)} 
                      fill={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                    />
                  </g>
                );
              })}

              {/* X-axis labels */}
              {xLabels.map((label, i) => (
                <text
                  key={i}
                  x={label.x}
                  y={height - padding.bottom + 18}
                  textAnchor="middle"
                  fontSize="10"
                  fill="#6b7280"
                  fontWeight="500"
                >
                  {label.date.slice(5)}
                </text>
              ))}
            </svg>

            {/* Tooltip */}
            {hoveredData && (
              <div 
                className="absolute pointer-events-none bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl text-sm z-10 border border-gray-700"
                style={{
                  left: Math.min(Math.max(mousePos.x - 75, 10), (chartRef.current?.offsetWidth || 400) - 170),
                  top: Math.max(mousePos.y - 90, 10),
                }}
              >
                <p className="font-semibold text-gray-300 text-xs mb-1">{hoveredData.date}</p>
                <p className={`text-xl font-bold ${hoveredData.cumulative >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                  {formatCurrency(hoveredData.cumulative)}
                </p>
                {dayChange !== null && (
                  <p className={`text-xs mt-1 ${dayChange >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                    {dayChange >= 0 ? '+' : ''}{formatCurrency(dayChange)} this day
                  </p>
                )}
                {onPointClick && (
                  <p className="text-xs text-indigo-400 mt-2 font-medium">Click to view details ‚Üí</p>
                )}
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="px-3 md:px-6 py-2 md:py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
            <div className="flex items-center gap-2 md:gap-4">
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-1.5 md:w-2 h-1.5 md:h-2 rounded-full bg-emerald-500" />
                <span className="text-[10px] md:text-xs text-gray-600">Profit</span>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-1.5 md:w-2 h-1.5 md:h-2 rounded-full bg-red-500" />
                <span className="text-[10px] md:text-xs text-gray-600">Loss</span>
              </div>
            </div>
            <div className="text-[10px] md:text-xs text-gray-500">
              {data.length} trade{data.length !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // STAR RATING COMPONENT
    // =============================================================================
    function StarRating({ value, onChange, readonly = false, size = 'md' }) {
      const [hoverValue, setHoverValue] = useState(0);
      
      const sizeClasses = {
        sm: 'w-4 h-4',
        md: 'w-6 h-6',
        lg: 'w-8 h-8',
      };
      
      const starSize = sizeClasses[size] || sizeClasses.md;
      
      return (
        <div className="flex gap-1">
          {[1, 2, 3, 4, 5].map((star) => {
            const isFilled = star <= (hoverValue || value);
            return (
              <button
                key={star}
                type="button"
                onClick={() => !readonly && onChange(star === value ? 0 : star)}
                onMouseEnter={() => !readonly && setHoverValue(star)}
                onMouseLeave={() => !readonly && setHoverValue(0)}
                disabled={readonly}
                className={`${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'} transition-transform ${
                  isFilled ? 'text-amber-400' : 'text-gray-300'
                }`}
              >
                <svg viewBox="0 0 24 24" fill={isFilled ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2" className={starSize}>
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
              </button>
            );
          })}
        </div>
      );
    }

    // Avatar component - displays profile photo or initials
    function Avatar({ user, size = 'md', className = '' }) {
      const sizeClasses = {
        xs: 'w-6 h-6 text-xs',
        sm: 'w-8 h-8 text-sm',
        md: 'w-10 h-10 text-base',
        lg: 'w-12 h-12 text-lg',
        xl: 'w-16 h-16 text-2xl',
      };
      
      const sizeClass = sizeClasses[size] || sizeClasses.md;
      const initial = user?.displayName?.charAt(0)?.toUpperCase() || user?.email?.charAt(0)?.toUpperCase() || '?';
      const photoURL = user?.photoURL;
      
      if (photoURL) {
        return (
          <img 
            src={photoURL} 
            alt={user?.displayName || 'User'} 
            className={`${sizeClass} rounded-full object-cover ${className}`}
          />
        );
      }
      
      return (
        <div className={`${sizeClass} bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-600 ${className}`}>
          {initial}
        </div>
      );
    }

    // =============================================================================
    // TRADE ENTRY MODAL
    // =============================================================================
    function TradeModal({ isOpen, onClose, trade, state, setState }) {
      const isEdit = trade !== null && trade.id !== undefined;
      const fileInputRef = useRef(null);

      const emptyForm = {
        entryDate: todayISO(),
        ticker: '',
        assetType: 'stock',
        positionType: 'long',
        positionSize: '',
        entryPrice: '',
        exitDate: '',
        exitPrice: '',
        pnlManual: '',
        setupId: '',
        mistakeIds: [],
        notes: '',
        screenshot: null,
        rating: 0,
      };

      const [form, setForm] = useState(emptyForm);
      const [errors, setErrors] = useState({});
      const [showTickerDropdown, setShowTickerDropdown] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

      // Initialize form when modal opens
      useEffect(() => {
        if (isOpen) {
          if (trade && trade.id) {
            // Editing existing trade
            setForm({
              entryDate: trade.entryDate || todayISO(),
              ticker: trade.ticker || '',
              assetType: trade.assetType || 'stock',
              positionType: trade.positionType || 'long',
              positionSize: trade.positionSize?.toString() || '',
              entryPrice: trade.entryPrice?.toString() || '',
              exitDate: trade.exitDate || '',
              exitPrice: trade.exitPrice?.toString() || '',
              pnlManual: trade.pnlManual?.toString() || '',
              setupId: trade.setupId || '',
              mistakeIds: trade.mistakeIds || [],
              notes: trade.notes || '',
              screenshot: trade.screenshot || null,
              rating: trade.rating || 0,
            });
          } else if (trade && trade.entryDate) {
            // New trade with pre-filled date
            setForm({
              ...emptyForm,
              entryDate: trade.entryDate,
            });
          } else {
            // New trade with today's date
            setForm(emptyForm);
          }
          setErrors({});
          setShowDeleteConfirm(false);
        }
      }, [isOpen, trade]);

      // Get unique previous tickers (most recent first)
      const previousTickers = useMemo(() => {
        // Get tickers in order of most recent trade first
        const tickersByDate = state.trades
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))
          .map(t => t.ticker);
        
        // Remove duplicates while preserving order (most recent first)
        const uniqueTickers = [...new Set(tickersByDate)];
        
        // If user is typing, filter by input
        if (form.ticker) {
          return uniqueTickers
            .filter(t => t.toLowerCase().includes(form.ticker.toLowerCase()))
            .slice(0, 10);
        }
        
        // Otherwise show most recent 10
        return uniqueTickers.slice(0, 10);
      }, [state.trades, form.ticker]);

      // Get size label based on asset type
      const sizeLabel = ASSET_TYPES.find(a => a.id === form.assetType)?.sizeLabel || 'Shares';

      // Calculate derived values live
      const liveCalc = useMemo(() => {
        const hasExit = form.exitDate && form.exitPrice;
        let lengthDays = null;
        let pnlCalculated = null;

        if (hasExit && form.entryDate) {
          const entry = new Date(form.entryDate);
          const exit = new Date(form.exitDate);
          lengthDays = Math.round((exit - entry) / (1000 * 60 * 60 * 24));
        }

        if (hasExit && form.entryPrice && form.positionSize) {
          const entryP = parseFloat(form.entryPrice);
          const exitP = parseFloat(form.exitPrice);
          const size = parseFloat(form.positionSize);

          if (!isNaN(entryP) && !isNaN(exitP) && !isNaN(size)) {
            if (form.positionType === 'long') {
              pnlCalculated = (exitP - entryP) * size;
            } else {
              pnlCalculated = (entryP - exitP) * size;
            }
            pnlCalculated = Math.round(pnlCalculated * 100) / 100;
          }
        }

        // Check mismatch
        let pnlMismatch = false;
        if (form.pnlManual !== '' && pnlCalculated !== null) {
          const manual = parseFloat(form.pnlManual);
          if (!isNaN(manual)) {
            pnlMismatch = Math.abs(manual - pnlCalculated) > PNL_MISMATCH_THRESHOLD;
          }
        }

        return { lengthDays, pnlCalculated, pnlMismatch };
      }, [form]);

      // Handle input changes
      const handleChange = (field, value) => {
        setForm(prev => ({ ...prev, [field]: value }));
        if (errors[field]) {
          setErrors(prev => ({ ...prev, [field]: null }));
        }
      };

      // Handle ticker selection - auto-fill asset type and size from most recent trade
      const selectTicker = (ticker) => {
        // Find most recent trade with this ticker
        const previousTrade = state.trades
          .filter(t => t.ticker.toUpperCase() === ticker.toUpperCase())
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
        
        if (previousTrade) {
          setForm(prev => ({
            ...prev,
            ticker: ticker,
            assetType: previousTrade.assetType || prev.assetType,
            positionSize: previousTrade.positionSize?.toString() || prev.positionSize,
          }));
        } else {
          handleChange('ticker', ticker);
        }
        setShowTickerDropdown(false);
      };

      // Handle asset type change - auto-fill size from most recent trade with same ticker + asset type
      const handleAssetTypeChange = (assetType) => {
        // Find most recent trade with current ticker and this asset type
        const previousTrade = state.trades
          .filter(t => 
            t.ticker.toUpperCase() === form.ticker.toUpperCase() && 
            t.assetType === assetType
          )
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
        
        if (previousTrade && previousTrade.positionSize) {
          setForm(prev => ({
            ...prev,
            assetType: assetType,
            positionSize: previousTrade.positionSize.toString(),
          }));
        } else {
          // No previous trade with this combo, just try asset type alone
          const anyPreviousTrade = state.trades
            .filter(t => t.assetType === assetType)
            .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
          
          setForm(prev => ({
            ...prev,
            assetType: assetType,
            positionSize: anyPreviousTrade?.positionSize?.toString() || prev.positionSize,
          }));
        }
      };

      // Handle mistake toggle
      const toggleMistake = (mistakeId) => {
        setForm(prev => ({
          ...prev,
          mistakeIds: prev.mistakeIds.includes(mistakeId)
            ? prev.mistakeIds.filter(id => id !== mistakeId)
            : [...prev.mistakeIds, mistakeId]
        }));
      };

      // Handle screenshot upload with compression
      const handleScreenshotUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Check if it's an image
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file.');
          return;
        }

        try {
          const compressedBase64 = await compressImage(file, 200 * 1024); // 200KB max
          handleChange('screenshot', compressedBase64);
        } catch (error) {
          alert(error.message);
        }
        
        // Reset input so same file can be selected again
        e.target.value = '';
      };

      // Compress image to target size using canvas
      const compressImage = (file, maxSizeBytes) => {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.src = e.target.result;
          };

          reader.onerror = () => reject(new Error('Failed to read file'));

          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let { width, height } = img;
            const maxDimension = 1920; // Max width/height

            // Scale down if too large
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = Math.round((height * maxDimension) / width);
                width = maxDimension;
              } else {
                width = Math.round((width * maxDimension) / height);
                height = maxDimension;
              }
            }

            // Try different quality levels
            const tryCompress = (currentWidth, currentHeight, quality) => {
              canvas.width = currentWidth;
              canvas.height = currentHeight;
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, currentWidth, currentHeight);
              ctx.drawImage(img, 0, 0, currentWidth, currentHeight);

              const base64 = canvas.toDataURL('image/jpeg', quality);
              const sizeBytes = Math.round((base64.length - 'data:image/jpeg;base64,'.length) * 0.75);

              return { base64, sizeBytes };
            };

            // Start with original dimensions and high quality
            let currentWidth = width;
            let currentHeight = height;
            let quality = 0.9;
            let result = tryCompress(currentWidth, currentHeight, quality);

            // Reduce quality first
            while (result.sizeBytes > maxSizeBytes && quality > 0.1) {
              quality -= 0.1;
              result = tryCompress(currentWidth, currentHeight, quality);
            }

            // If still too large, reduce dimensions
            while (result.sizeBytes > maxSizeBytes && currentWidth > 200) {
              currentWidth = Math.round(currentWidth * 0.8);
              currentHeight = Math.round(currentHeight * 0.8);
              quality = 0.8; // Reset quality for smaller size
              result = tryCompress(currentWidth, currentHeight, quality);

              // Try reducing quality again at new size
              while (result.sizeBytes > maxSizeBytes && quality > 0.1) {
                quality -= 0.1;
                result = tryCompress(currentWidth, currentHeight, quality);
              }
            }

            if (result.sizeBytes > maxSizeBytes) {
              reject(new Error('Unable to compress image below 200KB. Please use a smaller image.'));
            } else {
              resolve(result.base64);
            }
          };

          img.onerror = () => reject(new Error('Failed to load image'));

          reader.readAsDataURL(file);
        });
      };

      // Validate form
      const validate = () => {
        const newErrors = {};

        if (!form.entryDate) newErrors.entryDate = 'Required';
        if (!form.ticker.trim()) newErrors.ticker = 'Required';
        if (!form.assetType) newErrors.assetType = 'Required';
        if (!form.positionType) newErrors.positionType = 'Required';
        
        if (!form.positionSize) {
          newErrors.positionSize = 'Required';
        } else if (parseFloat(form.positionSize) <= 0) {
          newErrors.positionSize = 'Must be > 0';
        }

        if (form.entryPrice && parseFloat(form.entryPrice) < 0) {
          newErrors.entryPrice = 'Must be >= 0';
        }

        if (form.exitPrice && parseFloat(form.exitPrice) < 0) {
          newErrors.exitPrice = 'Must be >= 0';
        }

        if (form.exitDate && form.entryDate && form.exitDate < form.entryDate) {
          newErrors.exitDate = 'Must be >= entry date';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      // Handle save
      const handleSave = () => {
        if (!validate()) return;

        const now = nowISO();
        const tradeData = {
          id: trade?.id || generateId(),
          entryDate: form.entryDate,
          ticker: form.ticker.toUpperCase().trim(),
          assetType: form.assetType,
          positionType: form.positionType,
          positionSize: parseFloat(form.positionSize),
          entryPrice: form.entryPrice ? parseFloat(form.entryPrice) : null,
          exitDate: form.exitDate || null,
          exitPrice: form.exitPrice ? parseFloat(form.exitPrice) : null,
          pnlManual: form.pnlManual ? parseFloat(form.pnlManual) : null,
          setupId: form.setupId || null,
          mistakeIds: form.mistakeIds,
          notes: form.notes,
          screenshot: form.screenshot,
          rating: form.rating || 0,
          createdAt: trade?.createdAt || now,
          updatedAt: now,
        };

        if (isEdit) {
          setState(prev => ({
            ...prev,
            trades: prev.trades.map(t => t.id === trade.id ? tradeData : t)
          }));
        } else {
          setState(prev => ({
            ...prev,
            trades: [...prev.trades, tradeData]
          }));
        }

        onClose();
      };

      // Handle delete
      const handleDelete = () => {
        setState(prev => ({
          ...prev,
          trades: prev.trades.filter(t => t.id !== trade.id)
        }));
        onClose();
      };

      if (!isOpen) return null;

      const mismatchRing = liveCalc.pnlMismatch ? 'ring-2 ring-red-500' : '';

      return (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="fixed inset-0 bg-black/50" onClick={onClose} />
          <div className="relative min-h-screen flex items-start md:items-center justify-center p-2 md:p-4 pt-4 md:pt-4">
            <div className="relative bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[92vh] overflow-y-auto">
              {/* Header */}
              <div className="sticky top-0 bg-white border-b border-gray-200 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between rounded-t-xl z-10">
                <h2 className="text-lg md:text-xl font-semibold text-gray-900">
                  {isEdit ? 'Edit Trade' : 'Add Trade'}
                </h2>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
                  {Icons.x}
                </button>
              </div>

              {/* Form */}
              <div className="p-4 md:p-6 space-y-3 md:space-y-6">
                {/* Row 1: Entry Date, Ticker */}
                <div className="grid grid-cols-2 gap-2 md:gap-4">
                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Entry Date <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="date"
                      value={form.entryDate}
                      onChange={(e) => handleChange('entryDate', e.target.value)}
                      max={todayISO()}
                      className={`w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.entryDate ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {errors.entryDate && <p className="text-red-500 text-xs mt-1">{errors.entryDate}</p>}
                  </div>

                  <div className="relative">
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Ticker <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      value={form.ticker}
                      onChange={(e) => {
                        handleChange('ticker', e.target.value.toUpperCase());
                        setShowTickerDropdown(true);
                      }}
                      onFocus={() => setShowTickerDropdown(true)}
                      onBlur={() => setTimeout(() => setShowTickerDropdown(false), 200)}
                      placeholder="AAPL"
                      className={`w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.ticker ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {showTickerDropdown && previousTickers.length > 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                        <div className="px-3 py-1.5 text-xs text-gray-500 border-b border-gray-100">
                          Recent tickers
                        </div>
                        {previousTickers.map(ticker => (
                          <button
                            key={ticker}
                            type="button"
                            onClick={() => selectTicker(ticker)}
                            className="w-full px-3 py-2 text-left hover:bg-gray-100 text-sm"
                          >
                            {ticker}
                          </button>
                        ))}
                      </div>
                    )}
                    {errors.ticker && <p className="text-red-500 text-xs mt-1">{errors.ticker}</p>}
                  </div>
                </div>

                {/* Row 2: Asset Type, Position Type */}
                <div className="grid grid-cols-2 gap-2 md:gap-4">
                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Asset <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={form.assetType}
                      onChange={(e) => handleAssetTypeChange(e.target.value)}
                      className="w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      {ASSET_TYPES.map(type => (
                        <option key={type.id} value={type.id}>{type.label}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Position <span className="text-red-500">*</span>
                    </label>
                    <div className="flex gap-1 md:gap-2">
                      {POSITION_TYPES.map(type => (
                        <button
                          key={type.id}
                          type="button"
                          onClick={() => handleChange('positionType', type.id)}
                          className={`flex-1 py-1.5 md:py-2 px-2 md:px-4 rounded-lg border text-xs md:text-sm font-medium transition-colors ${
                            form.positionType === type.id
                              ? type.id === 'long' 
                                ? 'bg-emerald-100 border-emerald-500 text-emerald-700'
                                : 'bg-red-100 border-red-500 text-red-700'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50'
                          }`}
                        >
                          {type.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Row 3: Position Size, Entry Price */}
                <div className="grid grid-cols-2 gap-2 md:gap-4">
                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      {sizeLabel} <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="number"
                      value={form.positionSize}
                      onChange={(e) => handleChange('positionSize', e.target.value)}
                      placeholder="100"
                      step="any"
                      min="0"
                      className={`w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.positionSize ? 'border-red-500' : 'border-gray-300'
                      } ${mismatchRing}`}
                    />
                    {errors.positionSize && <p className="text-red-500 text-xs mt-1">{errors.positionSize}</p>}
                  </div>

                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Entry Price
                    </label>
                    <div className="relative">
                      <span className="absolute left-2 md:left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                      <input
                        type="number"
                        value={form.entryPrice}
                        onChange={(e) => handleChange('entryPrice', e.target.value)}
                        placeholder="0.00"
                        step="any"
                        min="0"
                        className={`w-full pl-5 md:pl-7 pr-2 md:pr-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          errors.entryPrice ? 'border-red-500' : 'border-gray-300'
                        } ${mismatchRing}`}
                      />
                    </div>
                    {errors.entryPrice && <p className="text-red-500 text-xs mt-1">{errors.entryPrice}</p>}
                  </div>
                </div>

                {/* Row 4: Exit Date, Exit Price */}
                <div className="grid grid-cols-2 gap-2 md:gap-4">
                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Exit Date
                    </label>
                    <input
                      type="date"
                      value={form.exitDate}
                      onChange={(e) => handleChange('exitDate', e.target.value)}
                      min={form.entryDate}
                      max={todayISO()}
                      className={`w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.exitDate ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {errors.exitDate && <p className="text-red-500 text-xs mt-1">{errors.exitDate}</p>}
                  </div>

                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                      Exit Price
                    </label>
                    <div className="relative">
                      <span className="absolute left-2 md:left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                      <input
                        type="number"
                        value={form.exitPrice}
                        onChange={(e) => handleChange('exitPrice', e.target.value)}
                        placeholder="0.00"
                        step="any"
                        min="0"
                        className={`w-full pl-5 md:pl-7 pr-2 md:pr-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          errors.exitPrice ? 'border-red-500' : 'border-gray-300'
                        } ${mismatchRing}`}
                      />
                    </div>
                    {errors.exitPrice && <p className="text-red-500 text-xs mt-1">{errors.exitPrice}</p>}
                  </div>
                </div>

                {/* Live Calculations */}
                {(liveCalc.lengthDays !== null || liveCalc.pnlCalculated !== null) && (
                  <div className="bg-gray-50 rounded-lg p-3 md:p-4 flex gap-4 md:gap-6">
                    {liveCalc.lengthDays !== null && (
                      <div>
                        <p className="text-[10px] md:text-xs text-gray-500">Length</p>
                        <p className="text-sm md:text-lg font-semibold text-gray-900">{liveCalc.lengthDays}d</p>
                      </div>
                    )}
                    {liveCalc.pnlCalculated !== null && (
                      <div>
                        <p className="text-[10px] md:text-xs text-gray-500">Calc P&L</p>
                        <p className={`text-sm md:text-lg font-semibold ${liveCalc.pnlCalculated >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {formatCurrency(liveCalc.pnlCalculated)}
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* P&L Manual Override */}
                <div>
                  <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                    Manual P&L
                    {liveCalc.pnlMismatch && (
                      <span className="ml-1 md:ml-2 text-red-500 text-[10px] md:text-xs">‚ö† Mismatch</span>
                    )}
                  </label>
                  <div className="relative">
                    <span className="absolute left-2 md:left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                    <input
                      type="number"
                      value={form.pnlManual}
                      onChange={(e) => handleChange('pnlManual', e.target.value)}
                      placeholder="Leave empty for calculated"
                      step="any"
                      className={`w-full pl-5 md:pl-7 pr-2 md:pr-3 py-1.5 md:py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        liveCalc.pnlMismatch ? 'border-amber-500 bg-amber-50' : 'border-gray-300'
                      }`}
                    />
                  </div>
                </div>

                {/* Setup Dropdown */}
                <div>
                  <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                    Setup
                  </label>
                  <select
                    value={form.setupId}
                    onChange={(e) => handleChange('setupId', e.target.value)}
                    className="w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">No setup selected</option>
                    {state.setups.map(setup => (
                      <option key={setup.id} value={setup.id}>{setup.name}</option>
                    ))}
                  </select>
                </div>

                {/* Mistakes Multi-select */}
                {state.mistakes.length > 0 && (
                  <div>
                    <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">
                      Mistakes
                    </label>
                    <div className="flex flex-wrap gap-1.5 md:gap-2">
                      {state.mistakes.map(mistake => (
                        <button
                          key={mistake.id}
                          type="button"
                          onClick={() => toggleMistake(mistake.id)}
                          className={`px-2 md:px-3 py-1 md:py-1.5 rounded-full text-xs md:text-sm font-medium transition-colors ${
                            form.mistakeIds.includes(mistake.id)
                              ? 'bg-red-100 text-red-700 border-2 border-red-300'
                              : 'bg-gray-100 text-gray-600 border-2 border-transparent hover:bg-gray-200'
                          }`}
                        >
                          {mistake.name}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Screenshot Upload */}
                <div>
                  <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                    Screenshot
                  </label>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    onChange={handleScreenshotUpload}
                    className="hidden"
                  />
                  {form.screenshot ? (
                    <div className="relative">
                      <img 
                        src={form.screenshot} 
                        alt="Trade screenshot" 
                        className="w-full max-h-32 md:max-h-48 object-contain rounded-lg border border-gray-200 bg-gray-50"
                      />
                      <div className="absolute top-2 right-2 flex gap-2">
                        <span className="px-2 py-1 bg-black/60 text-white text-[10px] md:text-xs rounded">
                          {Math.round((form.screenshot.length - 'data:image/jpeg;base64,'.length) * 0.75 / 1024)}KB
                        </span>
                        <button
                          type="button"
                          onClick={() => handleChange('screenshot', null)}
                          className="p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                        >
                          {Icons.x}
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button
                      type="button"
                      onClick={() => fileInputRef.current?.click()}
                      className="w-full py-4 md:py-8 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 transition-colors flex flex-col items-center gap-1 md:gap-2 text-gray-500"
                    >
                      {Icons.upload}
                      <span className="text-xs md:text-sm">Tap to upload</span>
                    </button>
                  )}
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1">
                    Notes
                  </label>
                  <textarea
                    value={form.notes}
                    onChange={(e) => handleChange('notes', e.target.value)}
                    placeholder="Trade notes..."
                    rows={2}
                    className="w-full px-2 md:px-3 py-1.5 md:py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                  />
                </div>

                {/* Trade Rating */}
                <div>
                  <label className="block text-xs md:text-sm font-medium text-gray-700 mb-1 md:mb-2">
                    Rating
                  </label>
                  <div className="flex items-center gap-2 md:gap-3">
                    <StarRating 
                      value={form.rating} 
                      onChange={(rating) => handleChange('rating', rating)} 
                      size="lg"
                    />
                    {form.rating > 0 && (
                      <span className="text-xs md:text-sm text-gray-500">
                        {form.rating === 1 && 'Poor'}
                        {form.rating === 2 && 'Below Average'}
                        {form.rating === 3 && 'Average'}
                        {form.rating === 4 && 'Good'}
                        {form.rating === 5 && 'Excellent'}
                      </span>
                    )}
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-between rounded-b-xl">
                <div>
                  {isEdit && (
                    showDeleteConfirm ? (
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-red-600">Delete this trade?</span>
                        <button
                          type="button"
                          onClick={handleDelete}
                          className="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700"
                        >
                          Yes, Delete
                        </button>
                        <button
                          type="button"
                          onClick={() => setShowDeleteConfirm(false)}
                          className="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300"
                        >
                          Cancel
                        </button>
                      </div>
                    ) : (
                      <button
                        type="button"
                        onClick={() => setShowDeleteConfirm(true)}
                        className="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                      >
                        {Icons.trash}
                        <span>Delete</span>
                      </button>
                    )
                  )}
                </div>
                <div className="flex gap-3">
                  <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    onClick={handleSave}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    {isEdit ? 'Save Changes' : 'Add Trade'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // DASHBOARD PAGE
    // =============================================================================
    function DashboardPage({ state, setState, setActivePage, setSelectedDate, isMobile, isReadOnly = false }) {
      const [filter, setFilter] = useState('week');
      const [dailyNote, setDailyNote] = useState('');
      const [showDatePicker, setShowDatePicker] = useState(false);
      const [customStartDate, setCustomStartDate] = useState(null);
      const datePickerRef = React.useRef(null);
      const today = todayISO();

      useEffect(() => {
        if (state.dailyNotes[today]) {
          setDailyNote(state.dailyNotes[today].note || '');
        }
      }, [state.dailyNotes, today]);

      // Close date picker when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (datePickerRef.current && !datePickerRef.current.contains(e.target)) {
            setShowDatePicker(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      // Reset to current period when filter changes
      useEffect(() => {
        setCustomStartDate(null);
      }, [filter]);

      const getDateRange = (filterType) => {
        const now = new Date();
        const todayStr = todayISO();
        
        switch (filterType) {
          case 'day':
            return { start: todayStr, end: todayStr };
          case 'week':
            // Get start of week (Sunday) and end of week (Saturday)
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - dayOfWeek);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return { 
              start: weekStart.toISOString().split('T')[0], 
              end: weekEnd.toISOString().split('T')[0] 
            };
          case 'month':
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            return { start: monthStart, end: monthEnd };
          case 'year':
            const yearStart = `${now.getFullYear()}-01-01`;
            const yearEnd = `${now.getFullYear()}-12-31`;
            return { start: yearStart, end: yearEnd };
          case 'all':
          default:
            return { start: '1900-01-01', end: '2100-12-31' };
        }
      };

      const metrics = useMemo(() => {
        // Calculate the actual range (considering custom date selection)
        let range;
        if (customStartDate && filter !== 'all') {
          const start = new Date(customStartDate);
          let end = new Date(customStartDate);
          
          switch (filter) {
            case 'day':
              break;
            case 'week':
              end.setDate(start.getDate() + 6);
              break;
            case 'month':
              end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
              break;
            case 'year':
              end = new Date(start.getFullYear(), 11, 31);
              break;
          }
          range = {
            start: customStartDate,
            end: end.toISOString().split('T')[0]
          };
        } else {
          range = getDateRange(filter);
        }
        
        const closedTrades = state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            if (t.derived.isOpen) return false;
            // Use exitDate if available and not empty, otherwise use entryDate for filtering
            const dateToCheck = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
            if (!dateToCheck) return false;
            return dateToCheck >= range.start && dateToCheck <= range.end;
          });

        const totalTrades = closedTrades.length;
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');

        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const winRate = totalTrades > 0 ? ((wins.length / totalTrades) * 100).toFixed(1) : 0;

        const avgWin = wins.length > 0 
          ? wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / wins.length 
          : 0;
        const avgLoss = losses.length > 0 
          ? Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / losses.length)
          : 0;
        const avgWinLossRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';

        const dailyPnL = {};
        const dailyTradeCounts = {};
        const dailyWins = {};
        const dailyLosses = {};
        closedTrades.forEach(t => {
          // Use exitDate if available, otherwise use entryDate
          const date = t.exitDate || t.entryDate;
          if (!dailyPnL[date]) dailyPnL[date] = 0;
          if (!dailyTradeCounts[date]) dailyTradeCounts[date] = 0;
          if (!dailyWins[date]) dailyWins[date] = 0;
          if (!dailyLosses[date]) dailyLosses[date] = 0;
          dailyPnL[date] += t.derived.pnlFinal || 0;
          dailyTradeCounts[date]++;
          if (t.derived.winLoss === 'W') dailyWins[date]++;
          if (t.derived.winLoss === 'L') dailyLosses[date]++;
        });

        const days = Object.entries(dailyPnL);
        const bestDay = days.length > 0 ? days.reduce((best, curr) => curr[1] > best[1] ? curr : best, days[0]) : null;
        const worstDay = days.length > 0 ? days.reduce((worst, curr) => curr[1] < worst[1] ? curr : worst, days[0]) : null;

        const biggestWin = wins.length > 0 
          ? wins.reduce((best, curr) => curr.derived.pnlFinal > best.derived.pnlFinal ? curr : best, wins[0])
          : null;
        const biggestLoss = losses.length > 0 
          ? losses.reduce((worst, curr) => curr.derived.pnlFinal < worst.derived.pnlFinal ? curr : worst, losses[0])
          : null;

        const sortedTrades = [...closedTrades].sort((a, b) => {
          const dateA = a.exitDate || a.entryDate;
          const dateB = b.exitDate || b.entryDate;
          return dateA.localeCompare(dateB);
        });
        let cumulative = 0;
        const chartByDate = {};
        sortedTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          cumulative += t.derived.pnlFinal || 0;
          chartByDate[date] = Math.round(cumulative * 100) / 100;
        });
        const chartData = Object.entries(chartByDate).map(([date, cumulative]) => ({ date, cumulative }));

        // Setup analytics (filtered by date range)
        const setupStats = {};
        state.setups.forEach(setup => {
          setupStats[setup.id] = {
            id: setup.id,
            name: setup.name,
            totalTrades: 0,
            wins: 0,
            losses: 0,
            totalPnL: 0,
            winRate: 0,
          };
        });
        closedTrades.forEach(trade => {
          if (!trade.setupId || !setupStats[trade.setupId]) return;
          setupStats[trade.setupId].totalTrades++;
          setupStats[trade.setupId].totalPnL += trade.derived.pnlFinal || 0;
          if (trade.derived.winLoss === 'W') setupStats[trade.setupId].wins++;
          if (trade.derived.winLoss === 'L') setupStats[trade.setupId].losses++;
        });
        Object.values(setupStats).forEach(setup => {
          const totalClosed = setup.wins + setup.losses;
          setup.winRate = totalClosed > 0 ? Math.round((setup.wins / totalClosed) * 100) : 0;
        });
        const setupAnalytics = Object.values(setupStats);

        // Mistake analytics (filtered by date range) - ONLY count losses
        const mistakeStats = {};
        state.mistakes.forEach(mistake => {
          mistakeStats[mistake.id] = {
            id: mistake.id,
            name: mistake.name,
            totalOccurrences: 0,
            losingTrades: 0,
            profitableTrades: 0,
            totalLossAmount: 0,
          };
        });
        closedTrades.forEach(trade => {
          if (!trade.mistakeIds || trade.mistakeIds.length === 0) return;
          const pnl = trade.derived.pnlFinal || 0;
          trade.mistakeIds.forEach(mistakeId => {
            if (!mistakeStats[mistakeId]) return;
            mistakeStats[mistakeId].totalOccurrences++;
            if (pnl < 0) {
              mistakeStats[mistakeId].losingTrades++;
              mistakeStats[mistakeId].totalLossAmount += pnl;
            } else {
              mistakeStats[mistakeId].profitableTrades++;
            }
          });
        });
        const mistakeAnalytics = Object.values(mistakeStats);

        // Calculate average daily trades
        const tradeCounts = Object.values(dailyTradeCounts);
        const avgDailyTrades = tradeCounts.length > 0 
          ? tradeCounts.reduce((a, b) => a + b, 0) / tradeCounts.length 
          : 0;

        return {
          totalTrades, totalPnL, wins: wins.length, losses: losses.length, winRate,
          avgWin, avgLoss, avgWinLossRatio, riskRewardRatio, avgDailyTrades,
          dailyPnL, dailyTradeCounts, dailyWins, dailyLosses, bestDay, worstDay, biggestWin, biggestLoss, chartData,
          setupAnalytics, mistakeAnalytics,
        };
      }, [state.trades, state.setups, state.mistakes, filter, customStartDate]);

      const calendarData = useMemo(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = firstDay.getDay();

        const days = [];
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push({ day: null, pnl: null, trades: 0, wins: 0, losses: 0 });
        }
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const pnl = metrics.dailyPnL[dateStr] || null;
          const trades = metrics.dailyTradeCounts[dateStr] || 0;
          const wins = metrics.dailyWins[dateStr] || 0;
          const losses = metrics.dailyLosses[dateStr] || 0;
          days.push({ day: d, date: dateStr, pnl, trades, wins, losses });
        }

        return { year, month, monthName: firstDay.toLocaleString('default', { month: 'long' }), days };
      }, [metrics.dailyPnL, metrics.dailyTradeCounts, metrics.dailyWins, metrics.dailyLosses]);

      // Goal progress calculation (based on yearly goal)
      const goalProgress = useMemo(() => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const TRADING_DAYS_PER_YEAR = 252;
        
        // Check for yearly goal
        const yearlyGoal = state.yearlyGoal;
        if (!yearlyGoal || yearlyGoal.year !== currentYear) return null;
        
        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        // Calculate year P&L and build cumulative by date
        const yearTrades = state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            if (t.derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .sort((a, b) => {
            const dateA = a.exitDate || a.entryDate;
            const dateB = b.exitDate || b.entryDate;
            return dateA.localeCompare(dateB);
          });
        
        // Build cumulative P&L by date
        const cumulativeByDate = {};
        let runningTotal = 0;
        yearTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          runningTotal += t.derived.pnlFinal || 0;
          cumulativeByDate[date] = runningTotal;
        });
        
        const yearPnL = runningTotal;
        
        // Calculate progress percentage
        const progress = yearlyGoal.target > 0 ? (yearPnL / yearlyGoal.target) * 100 : 0;
        const isComplete = yearPnL >= yearlyGoal.target;
        const remaining = yearlyGoal.target - yearPnL;
        
        // Calculate days remaining
        const endOfYear = new Date(currentYear, 11, 31);
        const calendarDaysRemaining = Math.ceil((endOfYear - now) / (1000 * 60 * 60 * 24));
        const tradingDaysRemaining = Math.round(calendarDaysRemaining * (TRADING_DAYS_PER_YEAR / 365));
        const tradingDaysPassed = TRADING_DAYS_PER_YEAR - tradingDaysRemaining;
        
        // Calculate pace
        const expectedPnL = (yearlyGoal.target / TRADING_DAYS_PER_YEAR) * tradingDaysPassed;
        const paceStatus = yearPnL >= expectedPnL ? 'ahead' : 'behind';
        const paceDifference = yearPnL - expectedPnL;
        
        // Calculate targets for different periods (based on 252 trading days)
        const dailyTarget = yearlyGoal.target / TRADING_DAYS_PER_YEAR;
        const weeklyTarget = yearlyGoal.target / 52;
        const monthlyTarget = yearlyGoal.target / 12;
        const quarterlyTarget = yearlyGoal.target / 4;
        
        // Calculate remaining targets (to hit goal)
        const remainingDailyTarget = tradingDaysRemaining > 0 ? remaining / tradingDaysRemaining : 0;
        const weeksRemaining = Math.ceil(calendarDaysRemaining / 7);
        const remainingWeeklyTarget = weeksRemaining > 0 ? remaining / weeksRemaining : 0;
        
        // Build pace line data for calendar
        const paceByDate = {};
        let dayCount = 0;
        for (let d = new Date(currentYear, 0, 1); d <= endOfYear; d.setDate(d.getDate() + 1)) {
          const day = d.getDay();
          if (day !== 0 && day !== 6) { // Skip weekends for trading days
            dayCount++;
            const dateStr = d.toISOString().split('T')[0];
            paceByDate[dateStr] = dailyTarget * dayCount;
          }
        }
        
        return {
          goal: yearlyGoal,
          yearPnL,
          progress: Math.min(progress, 100),
          progressRaw: progress,
          isComplete,
          remaining,
          paceStatus,
          paceDifference,
          dailyTarget,
          weeklyTarget,
          monthlyTarget,
          quarterlyTarget,
          remainingDailyTarget,
          remainingWeeklyTarget,
          daysRemaining: calendarDaysRemaining,
          tradingDaysRemaining,
          weeksRemaining,
          yearLabel: `${currentYear}`,
          yearStartStr: yearStart,
          yearEndStr: yearEnd,
          cumulativeByDate,
          paceByDate,
        };
      }, [state.yearlyGoal, state.trades]);

      const handleSaveDailyNote = () => {
        const updatedNotes = {
          ...state.dailyNotes,
          [today]: {
            date: today,
            note: dailyNote,
            emotionalState: state.dailyNotes[today]?.emotionalState || null,
            updatedAt: nowISO(),
          },
        };
        setState({ ...state, dailyNotes: updatedNotes });
      };

      const handleDayClick = (dateStr) => {
        if (dateStr) {
          setSelectedDate(dateStr);
          setActivePage('calendar');
        }
      };

      // Get the actual date range being used
      const currentRange = useMemo(() => {
        if (customStartDate && filter !== 'all') {
          const start = new Date(customStartDate);
          let end = new Date(customStartDate);
          
          switch (filter) {
            case 'day':
              // end is same as start
              break;
            case 'week':
              end.setDate(start.getDate() + 6);
              break;
            case 'month':
              end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
              break;
            case 'year':
              end = new Date(start.getFullYear(), 11, 31);
              break;
          }
          return {
            start: customStartDate,
            end: end.toISOString().split('T')[0]
          };
        }
        return getDateRange(filter);
      }, [filter, customStartDate]);

      // Format date range for display
      const formatDateRange = () => {
        const start = new Date(currentRange.start + 'T12:00:00');
        const end = new Date(currentRange.end + 'T12:00:00');
        
        const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const formatShort = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        if (filter === 'day') {
          return formatDate(start);
        } else if (filter === 'all') {
          return 'All Time';
        } else if (start.getFullYear() === end.getFullYear()) {
          return `${formatShort(start)} - ${formatShort(end)}, ${start.getFullYear()}`;
        } else {
          return `${formatDate(start)} - ${formatDate(end)}`;
        }
      };

      // Handle date selection from mini calendar
      const handleDateSelect = (dateStr) => {
        const selectedDate = new Date(dateStr + 'T12:00:00');
        
        switch (filter) {
          case 'day':
            setCustomStartDate(dateStr);
            break;
          case 'week':
            // Set to Sunday of selected week
            const dayOfWeek = selectedDate.getDay();
            const sunday = new Date(selectedDate);
            sunday.setDate(selectedDate.getDate() - dayOfWeek);
            setCustomStartDate(sunday.toISOString().split('T')[0]);
            break;
          case 'month':
            // Set to first of month
            const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            setCustomStartDate(monthStart.toISOString().split('T')[0]);
            break;
          case 'year':
            // Set to Jan 1 of year
            setCustomStartDate(`${selectedDate.getFullYear()}-01-01`);
            break;
          default:
            setCustomStartDate(null);
        }
        setShowDatePicker(false);
      };

      // Mini Calendar for date picker
      const MiniCalendar = () => {
        const [viewMonth, setViewMonth] = useState(() => {
          const d = customStartDate ? new Date(customStartDate + 'T12:00:00') : new Date();
          return { year: d.getFullYear(), month: d.getMonth() };
        });

        const daysInMonth = new Date(viewMonth.year, viewMonth.month + 1, 0).getDate();
        const firstDayOfWeek = new Date(viewMonth.year, viewMonth.month, 1).getDay();
        const monthName = new Date(viewMonth.year, viewMonth.month, 1).toLocaleString('default', { month: 'long' });

        const days = [];
        for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
        for (let d = 1; d <= daysInMonth; d++) days.push(d);

        const isInRange = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr >= currentRange.start && dateStr <= currentRange.end;
        };

        const isRangeStart = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr === currentRange.start;
        };

        const isRangeEnd = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr === currentRange.end;
        };

        return (
          <div className="p-3">
            <div className="flex items-center justify-between mb-3">
              <button
                onClick={() => setViewMonth(prev => prev.month === 0 
                  ? { year: prev.year - 1, month: 11 } 
                  : { ...prev, month: prev.month - 1 })}
                className="p-1 hover:bg-gray-100 rounded"
              >
                {Icons.chevronLeft}
              </button>
              <span className="font-semibold text-gray-900">{monthName} {viewMonth.year}</span>
              <button
                onClick={() => setViewMonth(prev => prev.month === 11 
                  ? { year: prev.year + 1, month: 0 } 
                  : { ...prev, month: prev.month + 1 })}
                className="p-1 hover:bg-gray-100 rounded"
              >
                {Icons.chevronRight}
              </button>
            </div>
            <div className="grid grid-cols-7 gap-0.5 text-center">
              {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                <div key={i} className="text-xs text-gray-500 py-1">{d}</div>
              ))}
              {days.map((day, i) => {
                const dateStr = day ? `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                const inRange = isInRange(day);
                const isStart = isRangeStart(day);
                const isEnd = isRangeEnd(day);
                
                return (
                  <button
                    key={i}
                    onClick={() => day && handleDateSelect(dateStr)}
                    disabled={!day}
                    className={`
                      text-xs py-1.5 transition-colors
                      ${!day ? 'invisible' : 'hover:bg-blue-100 cursor-pointer'}
                      ${inRange ? 'bg-blue-100 text-blue-900' : 'text-gray-700'}
                      ${isStart ? 'rounded-l-md bg-blue-500 text-white hover:bg-blue-600' : ''}
                      ${isEnd ? 'rounded-r-md bg-blue-500 text-white hover:bg-blue-600' : ''}
                      ${isStart && isEnd ? 'rounded-md' : ''}
                    `}
                  >
                    {day}
                  </button>
                );
              })}
            </div>
            {filter !== 'all' && (
              <div className="mt-3 pt-3 border-t border-gray-100">
                <button
                  onClick={() => { setCustomStartDate(null); setShowDatePicker(false); }}
                  className="w-full text-xs text-blue-600 hover:text-blue-700 font-medium"
                >
                  Reset to Current {filter.charAt(0).toUpperCase() + filter.slice(1)}
                </button>
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header with filters */}
          <div className="flex flex-col gap-3">
            <div className="flex items-center justify-between">
              <h1 className="text-xl md:text-2xl font-bold text-gray-900">Dashboard</h1>
              {/* Date Range Display with Picker */}
              <div className="relative" ref={datePickerRef}>
                <button
                  onClick={() => filter !== 'all' && setShowDatePicker(!showDatePicker)}
                  className={`flex items-center gap-1 text-xs md:text-sm ${
                    filter === 'all' ? 'text-gray-500 cursor-default' : 'text-blue-600 hover:text-blue-700 cursor-pointer'
                  }`}
                >
                  {Icons.calendar}
                  <span className="font-medium hidden sm:inline">{formatDateRange()}</span>
                  <span className="font-medium sm:hidden">{filter === 'all' ? 'All' : formatDateRange().split(',')[0]}</span>
                  {filter !== 'all' && (
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-3 h-3 md:w-4 md:h-4">
                      <path d="M6 9l6 6 6-6" />
                    </svg>
                  )}
                </button>
                {showDatePicker && filter !== 'all' && (
                  <div className="absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 min-w-[280px]">
                    <MiniCalendar />
                  </div>
                )}
              </div>
            </div>
            {/* Filter buttons - scrollable on mobile */}
            <div className="flex gap-1 bg-gray-100 p-1 rounded-lg overflow-x-auto no-scrollbar">
              {FILTER_OPTIONS.map(opt => (
                <button
                  key={opt.id}
                  onClick={() => setFilter(opt.id)}
                  className={`px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm font-medium rounded-md transition-colors whitespace-nowrap flex-shrink-0 ${
                    filter === opt.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  {opt.label}
                </button>
              ))}
            </div>
          </div>

          {/* Stats Grid - 2 columns on mobile, 5 on desktop */}
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 md:gap-4">
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm col-span-2 md:col-span-1">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Total P&L</p>
              <p className={`text-xl sm:text-2xl md:text-3xl font-bold truncate ${metrics.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                {formatCurrency(metrics.totalPnL)}
              </p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Win/Loss</p>
              <p className="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                <span className="text-emerald-600">{metrics.wins}W</span>{' / '}<span className="text-red-600">{metrics.losses}L</span>
              </p>
              <p className="text-xs md:text-sm text-gray-500 mt-1">{metrics.winRate}%</p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Avg W/L</p>
              <p className="text-base sm:text-lg md:text-xl font-bold text-gray-900">{metrics.avgWinLossRatio}:1</p>
              <p className="text-[10px] md:text-xs text-gray-500 mt-1 truncate">
                {formatCurrencyShort(metrics.avgWin)} / {formatCurrencyShort(metrics.avgLoss)}
              </p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Trades</p>
              <p className="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{metrics.totalTrades}</p>
              {metrics.avgDailyTrades > 0 && (
                <p className="text-[10px] md:text-xs text-gray-500 mt-1">
                  {metrics.avgDailyTrades.toFixed(1)}/day
                </p>
              )}
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">R/R</p>
              <p className="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{metrics.riskRewardRatio}:1</p>
            </div>
          </div>

          {/* Goal Progress Card */}
          {goalProgress && (
            <div className={`rounded-xl border-2 p-4 md:p-6 ${
              goalProgress.isComplete 
                ? 'bg-emerald-50 border-emerald-300' 
                : goalProgress.paceStatus === 'ahead' 
                  ? 'bg-blue-50 border-blue-300'
                  : 'bg-amber-50 border-amber-300'
            }`}>
              <div className="flex flex-col lg:flex-row lg:items-center gap-4 lg:gap-8">
                {/* Progress Ring */}
                <div className="flex items-center gap-4">
                  <div className="relative w-20 h-20 md:w-24 md:h-24 flex-shrink-0">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle
                        cx="50%"
                        cy="50%"
                        r="45%"
                        fill="none"
                        stroke="#e5e7eb"
                        strokeWidth="8"
                      />
                      <circle
                        cx="50%"
                        cy="50%"
                        r="45%"
                        fill="none"
                        stroke={goalProgress.isComplete ? '#10b981' : goalProgress.paceStatus === 'ahead' ? '#3b82f6' : '#f59e0b'}
                        strokeWidth="8"
                        strokeLinecap="round"
                        strokeDasharray={`${goalProgress.progress * 2.83} 283`}
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className={`text-lg md:text-xl font-bold ${
                        goalProgress.isComplete ? 'text-emerald-600' : goalProgress.paceStatus === 'ahead' ? 'text-blue-600' : 'text-amber-600'
                      }`}>
                        {goalProgress.progress.toFixed(0)}%
                      </span>
                    </div>
                  </div>
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-semibold px-2 py-0.5 rounded ${
                        goalProgress.isComplete 
                          ? 'bg-emerald-200 text-emerald-800' 
                          : goalProgress.paceStatus === 'ahead'
                            ? 'bg-blue-200 text-blue-800'
                            : 'bg-amber-200 text-amber-800'
                      }`}>
                        {goalProgress.yearLabel} Goal
                      </span>
                      {goalProgress.isComplete && <span className="text-lg">üéØ</span>}
                    </div>
                    <p className="text-sm text-gray-600 mt-1">
                      {goalProgress.isComplete 
                        ? 'Goal achieved!' 
                        : goalProgress.paceStatus === 'ahead' 
                          ? 'On track' 
                          : 'Behind pace'}
                    </p>
                  </div>
                </div>
                
                {/* Stats */}
                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">Target</p>
                    <p className="text-base md:text-lg font-bold text-gray-900">{formatCurrencyShort(goalProgress.goal.target)}</p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">Current</p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.yearPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                      {formatCurrencyShort(goalProgress.yearPnL)}
                    </p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">
                      {goalProgress.isComplete ? 'Exceeded' : 'Remaining'}
                    </p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.isComplete ? 'text-emerald-600' : 'text-gray-900'}`}>
                      {formatCurrencyShort(Math.abs(goalProgress.remaining))}
                    </p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">
                      {goalProgress.paceStatus === 'ahead' ? 'Ahead by' : 'Behind by'}
                    </p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.paceStatus === 'ahead' ? 'text-emerald-600' : 'text-red-600'}`}>
                      {formatCurrencyShort(Math.abs(goalProgress.paceDifference))}
                    </p>
                  </div>
                </div>
                
                {/* Period Target based on filter */}
                <div className={`p-3 rounded-lg ${
                  goalProgress.isComplete 
                    ? 'bg-emerald-100' 
                    : goalProgress.paceStatus === 'ahead'
                      ? 'bg-blue-100'
                      : 'bg-amber-100'
                } flex-shrink-0`}>
                  <p className="text-[10px] md:text-xs text-gray-600 uppercase mb-1">
                    {filter === 'day' ? 'Daily' : filter === 'week' ? 'Weekly' : filter === 'month' ? 'Monthly' : filter === 'year' ? 'Quarterly' : 'Weekly'} Target
                  </p>
                  <p className="text-lg md:text-xl font-bold text-gray-900">
                    {formatCurrencyShort(
                      filter === 'day' ? goalProgress.dailyTarget :
                      filter === 'month' ? goalProgress.monthlyTarget :
                      filter === 'year' ? goalProgress.quarterlyTarget :
                      goalProgress.weeklyTarget
                    )}
                  </p>
                  {!goalProgress.isComplete && goalProgress.tradingDaysRemaining > 0 && (
                    <p className="text-[10px] text-gray-500 mt-1">
                      Need {formatCurrencyShort(goalProgress.remainingDailyTarget)}/day
                    </p>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">{calendarData.monthName} {calendarData.year}</h2>
              <div className="grid grid-cols-7 gap-1">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                  <div key={day} className="text-center text-xs font-medium text-gray-500 py-2">{day}</div>
                ))}
                {calendarData.days.map((d, i) => {
                  const winRate = d.trades > 0 && (d.wins + d.losses) > 0 
                    ? Math.round((d.wins / (d.wins + d.losses)) * 100) 
                    : null;
                  
                  // Calculate if day met its daily goal target (only for days with trades)
                  let metDailyGoal = null;
                  if (goalProgress && d.day && d.trades > 0 && d.date >= goalProgress.yearStartStr && d.date <= goalProgress.yearEndStr) {
                    metDailyGoal = d.pnl >= goalProgress.dailyTarget;
                  }
                  
                  return (
                    <div
                      key={i}
                      onClick={() => d.day && handleDayClick(d.date)}
                      className={`
                        min-h-[60px] md:min-h-[72px] p-1 rounded-lg flex flex-col items-center justify-start
                        ${d.day ? 'cursor-pointer hover:ring-2 hover:ring-blue-400' : ''}
                        ${!d.day ? 'bg-transparent' : ''}
                        ${d.day && d.trades === 0 ? 'bg-gray-50' : ''}
                        ${d.day && d.trades > 0 && d.pnl > 0 ? 'bg-emerald-100 border border-emerald-300' : ''}
                        ${d.day && d.trades > 0 && d.pnl < 0 ? 'bg-red-100 border border-red-300' : ''}
                        ${d.day && d.trades > 0 && d.pnl === 0 ? 'bg-gray-200' : ''}
                      `}
                    >
                      {d.day && (
                        <>
                          <span className="text-xs md:text-sm font-semibold text-gray-700">{d.day}</span>
                          {d.trades > 0 && (
                            <div className="flex flex-col items-center leading-tight">
                              <span className={`text-[10px] md:text-xs font-bold ${d.pnl >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>
                                {formatCurrencyShort(d.pnl)}
                              </span>
                              <span className="text-[8px] md:text-[10px] text-gray-500">{d.wins}W/{d.losses}L</span>
                            </div>
                          )}
                          {/* Goal indicator - only on trading days */}
                          {metDailyGoal !== null && (
                            <span className="text-[8px]" title={metDailyGoal ? 'Hit daily goal' : 'Missed daily goal'}>
                              {metDailyGoal ? '‚úÖ' : '‚ùå'}
                            </span>
                          )}
                        </>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col">
              <h2 className="text-lg font-semibold text-gray-900 mb-2">Today's Notes</h2>
              <p className="text-sm text-gray-500 mb-3">{today}</p>
              <textarea
                value={dailyNote}
                onChange={(e) => !isReadOnly && setDailyNote(e.target.value)}
                placeholder={isReadOnly ? "No notes for today" : "Jot down your thoughts for today..."}
                className={`w-full flex-1 min-h-[280px] p-3 border border-gray-200 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent ${isReadOnly ? 'bg-gray-50 cursor-not-allowed' : ''}`}
                readOnly={isReadOnly}
              />
              {!isReadOnly && (
                <button
                  onClick={handleSaveDailyNote}
                  className="mt-3 w-full py-2 px-4 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                >
                  Save Note
                </button>
              )}
            </div>
          </div>

          <div className="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4">
            <div className="bg-white p-3 md:p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1.5 md:p-2 bg-emerald-100 rounded-lg text-emerald-600">{Icons.trendUp}</div>
                <p className="text-xs md:text-sm font-medium text-gray-500">Biggest Win</p>
              </div>
              {metrics.biggestWin ? (
                <>
                  <p className="text-base sm:text-lg md:text-xl font-bold text-emerald-600 truncate">{formatCurrency(metrics.biggestWin.derived.pnlFinal)}</p>
                  <p className="text-xs md:text-sm text-gray-500 truncate">{metrics.biggestWin.ticker} ‚Ä¢ {metrics.biggestWin.exitDate || metrics.biggestWin.entryDate}</p>
                </>
              ) : (
                <p className="text-xs md:text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-3 md:p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1.5 md:p-2 bg-red-100 rounded-lg text-red-600">{Icons.trendDown}</div>
                <p className="text-xs md:text-sm font-medium text-gray-500">Biggest Loss</p>
              </div>
              {metrics.biggestLoss ? (
                <>
                  <p className="text-base sm:text-lg md:text-xl font-bold text-red-600 truncate">{formatCurrency(metrics.biggestLoss.derived.pnlFinal)}</p>
                  <p className="text-xs md:text-sm text-gray-500 truncate">{metrics.biggestLoss.ticker} ‚Ä¢ {metrics.biggestLoss.exitDate || metrics.biggestLoss.entryDate}</p>
                </>
              ) : (
                <p className="text-xs md:text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-3 md:p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1.5 md:p-2 bg-emerald-100 rounded-lg text-emerald-600">{Icons.trendUp}</div>
                <p className="text-xs md:text-sm font-medium text-gray-500">Best Day</p>
              </div>
              {metrics.bestDay ? (
                <>
                  <p className="text-base sm:text-lg md:text-xl font-bold text-emerald-600 truncate">{formatCurrency(metrics.bestDay[1])}</p>
                  <p className="text-xs md:text-sm text-gray-500">{metrics.bestDay[0]}</p>
                </>
              ) : (
                <p className="text-xs md:text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-3 md:p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-1.5 md:p-2 bg-red-100 rounded-lg text-red-600">{Icons.trendDown}</div>
                <p className="text-xs md:text-sm font-medium text-gray-500">Worst Day</p>
              </div>
              {metrics.worstDay ? (
                <>
                  <p className="text-base sm:text-lg md:text-xl font-bold text-red-600 truncate">{formatCurrency(metrics.worstDay[1])}</p>
                  <p className="text-xs md:text-sm text-gray-500">{metrics.worstDay[0]}</p>
                </>
              ) : (
                <p className="text-xs md:text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
          </div>

          {/* Cumulative P&L Chart */}
          <SimpleLineChart 
            data={metrics.chartData} 
            onPointClick={(point) => {
              setSelectedDate(point.date);
              setActivePage('calendar');
            }}
          />

          {/* Setups Performance */}
          {metrics.setupAnalytics.some(s => s.totalTrades > 0) && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Setups Performance</h2>
                  <p className="text-xs text-gray-500 mt-0.5">Filtered by selected time range</p>
                </div>
                <button
                  onClick={() => setActivePage('setups')}
                  className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  View All ‚Üí
                </button>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Setup Charts */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Trade Count</h4>
                    <SimplePieChart data={metrics.setupAnalytics.filter(s => s.totalTrades > 0).map(s => ({ label: s.name, value: s.totalTrades }))} />
                  </div>
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Total P&L</h4>
                    <SimpleBarChart data={metrics.setupAnalytics.filter(s => s.totalTrades > 0).sort((a, b) => b.totalPnL - a.totalPnL).map(s => ({ label: s.name, value: s.totalPnL }))} />
                  </div>
                </div>

                {/* Setup Top Lists */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-gray-100">
                  {/* Top Profit */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Top Profit</p>
                    {metrics.setupAnalytics.filter(s => s.totalPnL > 0).sort((a, b) => b.totalPnL - a.totalPnL).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-emerald-600">{formatCurrencyShort(s.totalPnL)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalPnL > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Top Loss */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Worst Loss</p>
                    {metrics.setupAnalytics.filter(s => s.totalPnL < 0).sort((a, b) => a.totalPnL - b.totalPnL).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-red-600">{formatCurrencyShort(s.totalPnL)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalPnL < 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Most Used */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Used</p>
                    {metrics.setupAnalytics.filter(s => s.totalTrades > 0).sort((a, b) => b.totalTrades - a.totalTrades).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-blue-600">{s.totalTrades}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalTrades > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Best Win Rate */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Best Win Rate</p>
                    {metrics.setupAnalytics.filter(s => s.totalTrades >= 3).sort((a, b) => b.winRate - a.winRate).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-amber-600">{s.winRate}%</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">Min 3 trades</p>}
                    {metrics.setupAnalytics.filter(s => s.totalTrades >= 3).length === 0 && <p className="text-xs text-gray-400 italic">Min 3 trades</p>}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Mistakes Analysis */}
          {metrics.mistakeAnalytics.some(m => m.totalOccurrences > 0) && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Mistakes Analysis</h2>
                  <p className="text-xs text-gray-500 mt-0.5">Filtered by selected time range ‚Ä¢ Loss amounts only include losing trades</p>
                </div>
                <button
                  onClick={() => setActivePage('mistakes')}
                  className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  View All ‚Üí
                </button>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Mistake Charts */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Frequency</h4>
                    <SimplePieChart data={metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).sort((a, b) => b.totalOccurrences - a.totalOccurrences).map(m => ({ label: m.name, value: m.totalOccurrences }))} />
                  </div>
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Loss Amount (Losses Only)</h4>
                    {(() => {
                      const lossData = metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).sort((a, b) => a.totalLossAmount - b.totalLossAmount).map(m => ({ label: m.name, value: Math.abs(m.totalLossAmount) }));
                      if (lossData.length === 0) {
                        return <div className="h-32 flex items-center justify-center text-gray-400 text-sm">No loss data</div>;
                      }
                      const maxVal = Math.max(...lossData.map(d => d.value), 1);
                      return (
                        <div className="space-y-2">
                          {lossData.map((d, i) => (
                            <div key={i} className="flex items-center gap-2">
                              <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
                              <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                                <div className="h-full rounded bg-red-500" style={{ width: `${(d.value / maxVal) * 100}%` }} />
                              </div>
                              <span className="text-xs font-medium w-16 text-right text-red-600">-{formatCurrencyShort(d.value)}</span>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                </div>

                {/* Mistake Top Lists */}
                <div className="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-gray-100">
                  {/* Most Frequent */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Frequent</p>
                    {metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).sort((a, b) => b.totalOccurrences - a.totalOccurrences).slice(0, 3).map((m, i) => (
                      <div key={m.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[120px]" title={m.name}>{i + 1}. {m.name}</span>
                        <span className="text-xs font-semibold text-amber-600">{m.totalOccurrences}x</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Most Costly */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Costly</p>
                    {metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).sort((a, b) => a.totalLossAmount - b.totalLossAmount).slice(0, 3).map((m, i) => (
                      <div key={m.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[120px]" title={m.name}>{i + 1}. {m.name}</span>
                        <span className="text-xs font-semibold text-red-600">{formatCurrencyShort(m.totalLossAmount)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // IMAGE MODAL COMPONENT
    // =============================================================================
    function ImageModal({ isOpen, onClose, src, title, trade, state, setState, getSetupName, getMistakeNames }) {
      const [notes, setNotes] = useState(trade?.notes || '');
      
      // Update notes when trade changes
      useEffect(() => {
        setNotes(trade?.notes || '');
      }, [trade]);

      if (!isOpen || !src) return null;

      const handleSaveNotes = () => {
        if (trade && setState) {
          setState(prev => ({
            ...prev,
            trades: prev.trades.map(t => 
              t.id === trade.id 
                ? { ...t, notes: notes, updatedAt: nowISO() }
                : t
            )
          }));
        }
        onClose();
      };

      // Calculate derived data if not already present
      const derivedTrade = trade ? { ...trade, derived: trade.derived || calcTradeDerived(trade) } : null;

      return (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="fixed inset-0 bg-black/80" onClick={onClose} />
          <div className="relative min-h-screen flex items-center justify-center p-4">
            <div className="relative bg-white rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col">
              <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                <h3 className="text-sm font-semibold text-gray-900">{title}</h3>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                    <path d="M18 6L6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="flex flex-col lg:flex-row flex-1 overflow-hidden">
                {/* Screenshot */}
                <div className="flex-1 p-4 overflow-auto">
                  <img src={src} alt={title} className="w-full rounded-lg" />
                </div>
                {/* Trade Notes Panel */}
                {trade && setState && (
                  <div className="lg:w-96 border-t lg:border-t-0 lg:border-l border-gray-200 p-4 bg-gray-50 flex flex-col overflow-auto">
                    <h4 className="text-sm font-semibold text-gray-900 mb-3 flex-shrink-0">Trade Notes</h4>
                    <textarea
                      value={notes}
                      onChange={(e) => setNotes(e.target.value)}
                      placeholder="Add notes for this trade..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                      style={{ minHeight: '200px', resize: 'none' }}
                    />
                    <button
                      onClick={handleSaveNotes}
                      className="mt-2 w-full px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors flex-shrink-0"
                    >
                      Save Notes
                    </button>
                    {derivedTrade && (
                      <div className="mt-4 pt-4 border-t border-gray-200 space-y-2 flex-shrink-0">
                        <div className="flex justify-between text-sm">
                          <span className="text-gray-500">P&L</span>
                          <span className={`font-medium ${(derivedTrade.derived?.pnlFinal || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                            {formatCurrency(derivedTrade.derived?.pnlFinal)}
                          </span>
                        </div>
                        {getSetupName && (
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-500">Setup</span>
                            <span className="text-gray-900">{getSetupName(derivedTrade.setupId)}</span>
                          </div>
                        )}
                        {getMistakeNames && (
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-500">Mistakes</span>
                            <span className="text-gray-900 text-right max-w-[150px]">{getMistakeNames(derivedTrade.mistakeIds)}</span>
                          </div>
                        )}
                        {derivedTrade.rating > 0 && (
                          <div className="flex justify-between text-sm items-center">
                            <span className="text-gray-500">Rating</span>
                            <StarRating value={derivedTrade.rating} readonly size="sm" />
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // NOTES MODAL COMPONENT
    // =============================================================================
    function NotesModal({ isOpen, onClose, notes, title }) {
      if (!isOpen || !notes) return null;

      // Calculate modal size based on notes length
      const getModalWidth = () => {
        if (notes.length < 200) return 'max-w-sm';
        if (notes.length < 500) return 'max-w-md';
        if (notes.length < 1000) return 'max-w-lg';
        return 'max-w-xl';
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="fixed inset-0 bg-black/50" />
          <div 
            className={`relative ${getModalWidth()} w-full bg-white rounded-xl shadow-xl`} 
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">{title || 'Trade Notes'}</h3>
              <button
                onClick={onClose}
                className="p-1 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5 text-gray-500">
                  <path d="M18 6L6 18M6 6l12 12" />
                </svg>
              </button>
            </div>
            {/* Content */}
            <div className="p-4 max-h-[60vh] overflow-y-auto">
              <p className="text-gray-700 whitespace-pre-wrap text-sm leading-relaxed">{notes}</p>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // TRADE LOG PAGE
    // =============================================================================
    function TradeLogPage({ 
      state, 
      setState, 
      isMobile, 
      isReadOnly = false,
      isMentorView = false,
      tradeFeedback = [],
      tradeFlags = [],
      onAddFeedback,
      onAddFlag,
      onRemoveFlag,
      onToggleFlagStatus,
      // For student view
      myTradeFeedback = [],
      myTradeFlags = [],
      markFeedbackAsRead,
      // Trade Questions (student asks, mentor answers)
      tradeQuestions = [],
      onAskQuestion,
      onAnswerQuestion,
      onResolveQuestion,
      userProfile,
    }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingTrade, setEditingTrade] = useState(null);
      const [sortField, setSortField] = useState('entryDate');
      const [sortDir, setSortDir] = useState('desc');
      const [imageModalOpen, setImageModalOpen] = useState(false);
      const [imageModalData, setImageModalData] = useState({ src: null, title: '' });
      const [notesModalOpen, setNotesModalOpen] = useState(false);
      const [notesModalData, setNotesModalData] = useState({ notes: '', title: '' });
      const [showFilters, setShowFilters] = useState(false);
      const [viewingTrade, setViewingTrade] = useState(null); // For read-only view modal
      
      // Feedback form state (for mentor)
      const [feedbackType, setFeedbackType] = useState('general');
      const [feedbackContent, setFeedbackContent] = useState('');
      const [submittingFeedback, setSubmittingFeedback] = useState(false);
      const [showFlagMenu, setShowFlagMenu] = useState(false);

      // Question form state (for student)
      const [showQuestionForm, setShowQuestionForm] = useState(false);
      const [questionType, setQuestionType] = useState('general');
      const [questionContent, setQuestionContent] = useState('');
      const [submittingQuestion, setSubmittingQuestion] = useState(false);
      
      // Answer form state (for mentor) - keyed by question ID
      const [answerContents, setAnswerContents] = useState({});
      const [submittingAnswerId, setSubmittingAnswerId] = useState(null);

      // Get feedback for the current context (mentor view vs student view)
      const activeFeedback = isMentorView ? tradeFeedback : myTradeFeedback;
      const activeFlags = isMentorView ? tradeFlags : myTradeFlags;

      // Get questions for a specific trade
      const getTradeQuestions = (tradeId) => tradeQuestions.filter(q => q.tradeId === tradeId);

      // Get feedback for a specific trade
      const getTradeFeedback = (tradeId) => activeFeedback.filter(f => f.tradeId === tradeId);
      const getTradeFlag = (tradeId) => activeFlags.find(f => f.tradeId === tradeId);

      // Mark feedback as read when student views a trade (not for mentor)
      useEffect(() => {
        if (!viewingTrade || isMentorView || !markFeedbackAsRead) return;
        
        const unreadFeedback = getTradeFeedback(viewingTrade.id).filter(f => !f.read);
        if (unreadFeedback.length > 0) {
          markFeedbackAsRead(unreadFeedback.map(f => f.id));
        }
      }, [viewingTrade?.id, isMentorView]);
      
      // Filter state
      const [filters, setFilters] = useState({
        dateStart: '',
        dateEnd: '',
        tickers: [], // Changed to array for multi-select
        assetTypes: [], // Changed to array for multi-select
        positionTypes: [], // Changed to array for multi-select
        setupIds: [], // Changed to array for multi-select
        mistakeIds: [], // Changed to array for multi-select
        ratings: [], // Array for multi-select ratings
        results: [], // Array for multi-select results (W, L, BE, open)
      });

      // Track which dropdowns are open
      const [openDropdown, setOpenDropdown] = useState(null);

      // Get unique tickers for filter dropdown
      const uniqueTickers = useMemo(() => {
        return [...new Set(state.trades.map(t => t.ticker))].sort();
      }, [state.trades]);

      // Filter and sort trades
      const filteredTrades = useMemo(() => {
        return state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            // Date range filter
            if (filters.dateStart && t.entryDate < filters.dateStart) return false;
            if (filters.dateEnd && t.entryDate > filters.dateEnd) return false;
            
            // Ticker filter (multi-select)
            if (filters.tickers.length > 0 && !filters.tickers.includes(t.ticker)) return false;
            
            // Asset type filter (multi-select)
            if (filters.assetTypes.length > 0 && !filters.assetTypes.includes(t.assetType)) return false;
            
            // Position type filter (multi-select)
            if (filters.positionTypes.length > 0 && !filters.positionTypes.includes(t.positionType)) return false;
            
            // Setup filter (multi-select)
            if (filters.setupIds.length > 0 && !filters.setupIds.includes(t.setupId)) return false;
            
            // Mistake filter (multi-select) - trade must have at least one of the selected mistakes
            if (filters.mistakeIds.length > 0 && !t.mistakeIds.some(id => filters.mistakeIds.includes(id))) return false;
            
            // Rating filter (multi-select)
            if (filters.ratings.length > 0 && !filters.ratings.includes(t.rating || 0)) return false;
            
            // Result filter (multi-select)
            if (filters.results.length > 0) {
              const tradeResult = t.derived.isOpen ? 'open' : t.derived.winLoss;
              if (!filters.results.includes(tradeResult)) return false;
            }
            
            return true;
          })
          .sort((a, b) => {
            let aVal, bVal;
            
            switch (sortField) {
              case 'entryDate':
                aVal = a.entryDate || '';
                bVal = b.entryDate || '';
                break;
              case 'exitDate':
                aVal = a.exitDate || '';
                bVal = b.exitDate || '';
                break;
              case 'ticker':
                aVal = a.ticker || '';
                bVal = b.ticker || '';
                break;
              case 'assetType':
                aVal = a.assetType || '';
                bVal = b.assetType || '';
                break;
              case 'positionType':
                aVal = a.positionType || '';
                bVal = b.positionType || '';
                break;
              case 'positionSize':
                aVal = a.positionSize || 0;
                bVal = b.positionSize || 0;
                break;
              case 'entryPrice':
                aVal = a.entryPrice || 0;
                bVal = b.entryPrice || 0;
                break;
              case 'exitPrice':
                aVal = a.exitPrice || 0;
                bVal = b.exitPrice || 0;
                break;
              case 'length':
                aVal = a.derived.lengthDays || 0;
                bVal = b.derived.lengthDays || 0;
                break;
              case 'pnl':
                aVal = a.derived.pnlFinal || 0;
                bVal = b.derived.pnlFinal || 0;
                break;
              case 'rating':
                aVal = a.rating || 0;
                bVal = b.rating || 0;
                break;
              case 'setup':
                const setupA = state.setups.find(s => s.id === a.setupId);
                const setupB = state.setups.find(s => s.id === b.setupId);
                aVal = setupA?.name || '';
                bVal = setupB?.name || '';
                break;
              case 'mistakes':
                aVal = a.mistakeIds.length;
                bVal = b.mistakeIds.length;
                break;
              default:
                aVal = a.entryDate || '';
                bVal = b.entryDate || '';
            }
            
            if (sortDir === 'asc') {
              return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            }
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          });
      }, [state.trades, state.setups, filters, sortField, sortDir]);

      // Calculate summary stats for filtered trades
      const summaryStats = useMemo(() => {
        const closedTrades = filteredTrades.filter(t => !t.derived.isOpen);
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const grossProfit = wins.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const grossLoss = Math.abs(losses.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0));
        
        const winRate = closedTrades.length > 0 ? ((wins.length / closedTrades.length) * 100).toFixed(1) : 0;
        const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : grossProfit > 0 ? '‚àû' : '0.00';
        const avgTrade = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
        
        const avgWin = wins.length > 0 ? grossProfit / wins.length : 0;
        const avgLoss = losses.length > 0 ? grossLoss / losses.length : 0;
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';
        
        // Best and worst trades
        const bestTrade = closedTrades.length > 0
          ? closedTrades.reduce((best, t) => (t.derived.pnlFinal || 0) > (best.derived.pnlFinal || 0) ? t : best, closedTrades[0])
          : null;
        const worstTrade = closedTrades.length > 0
          ? closedTrades.reduce((worst, t) => (t.derived.pnlFinal || 0) < (worst.derived.pnlFinal || 0) ? t : worst, closedTrades[0])
          : null;
        
        // Top ticker by P&L
        const pnlByTicker = {};
        closedTrades.forEach(t => {
          if (!pnlByTicker[t.ticker]) pnlByTicker[t.ticker] = { pnl: 0, count: 0 };
          pnlByTicker[t.ticker].pnl += t.derived.pnlFinal || 0;
          pnlByTicker[t.ticker].count++;
        });
        const topTicker = Object.entries(pnlByTicker)
          .sort((a, b) => b[1].pnl - a[1].pnl)[0];
        
        // Top setup by P&L
        const pnlBySetup = {};
        closedTrades.forEach(t => {
          if (!t.setupId) return;
          const setup = state.setups.find(s => s.id === t.setupId);
          if (!setup) return;
          if (!pnlBySetup[setup.id]) pnlBySetup[setup.id] = { name: setup.name, pnl: 0, count: 0 };
          pnlBySetup[setup.id].pnl += t.derived.pnlFinal || 0;
          pnlBySetup[setup.id].count++;
        });
        const topSetup = Object.values(pnlBySetup)
          .sort((a, b) => b.pnl - a.pnl)[0];
        
        // Average rating
        const ratedTrades = closedTrades.filter(t => t.rating && t.rating > 0);
        const avgRating = ratedTrades.length > 0
          ? ratedTrades.reduce((sum, t) => sum + t.rating, 0) / ratedTrades.length
          : 0;
        
        // Average hold time
        const tradesWithLength = closedTrades.filter(t => t.derived.lengthDays !== null);
        const avgHoldDays = tradesWithLength.length > 0
          ? tradesWithLength.reduce((sum, t) => sum + t.derived.lengthDays, 0) / tradesWithLength.length
          : 0;
        
        return {
          total: filteredTrades.length,
          closedCount: closedTrades.length,
          openCount: filteredTrades.length - closedTrades.length,
          totalPnL,
          wins: wins.length,
          losses: losses.length,
          winRate,
          profitFactor,
          avgTrade,
          avgWin,
          avgLoss,
          riskRewardRatio,
          bestTrade,
          worstTrade,
          topTicker: topTicker ? { ticker: topTicker[0], pnl: topTicker[1].pnl, count: topTicker[1].count } : null,
          topSetup,
          avgRating,
          ratedCount: ratedTrades.length,
          avgHoldDays,
        };
      }, [filteredTrades, state.setups]);

      const handleSort = (field) => {
        if (sortField === field) {
          setSortDir(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
          setSortField(field);
          setSortDir('desc');
        }
      };

      const handleFilterChange = (field, value) => {
        setFilters(prev => ({ ...prev, [field]: value }));
      };

      const resetFilters = () => {
        setFilters({
          dateStart: '',
          dateEnd: '',
          tickers: [],
          assetTypes: [],
          positionTypes: [],
          setupIds: [],
          mistakeIds: [],
          ratings: [],
          results: [],
        });
        setOpenDropdown(null);
      };

      const hasActiveFilters = 
        filters.dateStart !== '' ||
        filters.dateEnd !== '' ||
        filters.tickers.length > 0 ||
        filters.assetTypes.length > 0 ||
        filters.positionTypes.length > 0 ||
        filters.setupIds.length > 0 ||
        filters.mistakeIds.length > 0 ||
        filters.ratings.length > 0 ||
        filters.results.length > 0;

      // Toggle item in array filter
      const toggleFilterItem = (field, value) => {
        setFilters(prev => {
          const arr = prev[field];
          if (arr.includes(value)) {
            return { ...prev, [field]: arr.filter(v => v !== value) };
          }
          return { ...prev, [field]: [...arr, value] };
        });
      };

      // Multi-select dropdown component
      const MultiSelectDropdown = ({ label, field, options, renderOption }) => {
        const isOpen = openDropdown === field;
        const selected = filters[field];
        
        return (
          <div className="relative" data-dropdown="true">
            <label className="block text-xs font-medium text-gray-500 mb-1">{label}</label>
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                setOpenDropdown(isOpen ? null : field);
              }}
              className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[100px] bg-white text-left flex items-center justify-between gap-2"
            >
              <span className={selected.length === 0 ? 'text-gray-500' : 'text-gray-900'}>
                {selected.length === 0 ? 'All' : `${selected.length} selected`}
              </span>
              <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            {isOpen && (
              <div 
                className="absolute z-20 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="p-2 border-b border-gray-100">
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      setFilters(prev => ({ ...prev, [field]: [] }));
                    }}
                    className="text-xs text-blue-600 hover:text-blue-800"
                  >
                    Clear all
                  </button>
                </div>
                {options.map((option, idx) => (
                  <label
                    key={idx}
                    className="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <input
                      type="checkbox"
                      checked={selected.includes(option.value)}
                      onChange={(e) => {
                        e.stopPropagation();
                        toggleFilterItem(field, option.value);
                      }}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">{renderOption ? renderOption(option) : option.label}</span>
                  </label>
                ))}
              </div>
            )}
          </div>
        );
      };

      const openAddModal = () => {
        setEditingTrade(null);
        setModalOpen(true);
      };

      const openEditModal = (trade) => {
        setEditingTrade(trade);
        setModalOpen(true);
      };

      const openImageModal = (src, title, trade) => {
        setImageModalData({ src, title, trade });
        setImageModalOpen(true);
      };

      const openNotesModal = (notes, title) => {
        setNotesModalData({ notes, title });
        setNotesModalOpen(true);
      };

      // Helper to get setup name
      const getSetupName = (setupId) => {
        if (!setupId) return '-';
        const setup = state.setups.find(s => s.id === setupId);
        return setup?.name || '-';
      };

      // Helper to get mistake names
      const getMistakeNames = (mistakeIds) => {
        if (!mistakeIds || mistakeIds.length === 0) return '-';
        return mistakeIds
          .map(id => state.mistakes.find(m => m.id === id)?.name)
          .filter(Boolean)
          .join(', ') || '-';
      };

      // Sort indicator
      const SortIndicator = ({ field }) => {
        if (sortField !== field) return <span className="text-gray-300 ml-1">‚Üï</span>;
        return <span className="text-blue-600 ml-1">{sortDir === 'asc' ? '‚Üë' : '‚Üì'}</span>;
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <h1 className="text-xl md:text-2xl font-bold text-gray-900">Trade Log</h1>
            {!isReadOnly && (
              <button
                onClick={openAddModal}
                className="flex items-center gap-1 md:gap-2 px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
              >
                {Icons.plus}
                <span className="hidden sm:inline">Add Trade</span>
                <span className="sm:hidden">Add</span>
              </button>
            )}
          </div>

          {/* Filters Toolbar */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3 md:p-4 overflow-x-auto" onClick={(e) => {
            // Close dropdowns when clicking outside
            if (!e.target.closest('[data-dropdown]')) setOpenDropdown(null);
          }}>
            <div className="flex flex-wrap items-end gap-2 md:gap-3 min-w-0">
              {/* Date Range */}
              <div className="flex gap-2 items-end flex-shrink-0">
                <div>
                  <label className="block text-[10px] md:text-xs font-medium text-gray-500 mb-1">From</label>
                  <input
                    type="date"
                    value={filters.dateStart}
                    onChange={(e) => handleFilterChange('dateStart', e.target.value)}
                    className="w-[115px] md:w-auto px-1.5 md:px-2 py-1.5 text-xs md:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-[10px] md:text-xs font-medium text-gray-500 mb-1">To</label>
                  <input
                    type="date"
                    value={filters.dateEnd}
                    onChange={(e) => handleFilterChange('dateEnd', e.target.value)}
                    className="w-[115px] md:w-auto px-1.5 md:px-2 py-1.5 text-xs md:text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Ticker - Multi-select */}
              <MultiSelectDropdown
                label="Ticker"
                field="tickers"
                options={uniqueTickers.map(t => ({ value: t, label: t }))}
              />

              {/* Asset Type - Multi-select */}
              <MultiSelectDropdown
                label="Asset"
                field="assetTypes"
                options={ASSET_TYPES.map(t => ({ value: t.id, label: t.label }))}
              />

              {/* Position Type - Multi-select */}
              <MultiSelectDropdown
                label="Position"
                field="positionTypes"
                options={POSITION_TYPES.map(t => ({ value: t.id, label: t.label }))}
              />

              {/* Setup - Multi-select */}
              <MultiSelectDropdown
                label="Setup"
                field="setupIds"
                options={state.setups.map(s => ({ value: s.id, label: s.name }))}
              />

              {/* Mistake - Multi-select */}
              <MultiSelectDropdown
                label="Mistake"
                field="mistakeIds"
                options={state.mistakes.map(m => ({ value: m.id, label: m.name }))}
              />

              {/* Rating - Multi-select */}
              <MultiSelectDropdown
                label="Rating"
                field="ratings"
                options={[
                  { value: 0, label: '‚òÜ No Rating' },
                  { value: 1, label: '‚òÖ 1 Star' },
                  { value: 2, label: '‚òÖ‚òÖ 2 Stars' },
                  { value: 3, label: '‚òÖ‚òÖ‚òÖ 3 Stars' },
                  { value: 4, label: '‚òÖ‚òÖ‚òÖ‚òÖ 4 Stars' },
                  { value: 5, label: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5 Stars' },
                ]}
              />

              {/* Result - Multi-select */}
              <MultiSelectDropdown
                label="Result"
                field="results"
                options={[
                  { value: 'W', label: 'Win' },
                  { value: 'L', label: 'Loss' },
                  { value: 'BE', label: 'Break-even' },
                  { value: 'open', label: 'Open' },
                ]}
              />

              {/* Reset Button */}
              {hasActiveFilters && (
                <button
                  onClick={resetFilters}
                  className="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Reset Filters
                </button>
              )}
            </div>

            {/* Summary Stats */}
            <div className="mt-4 pt-4 border-t border-gray-100">
              <div className="flex items-center justify-between mb-3">
                <span className="text-sm text-gray-500">
                  Showing <span className="font-semibold text-gray-900">{summaryStats.total}</span> trades
                  {summaryStats.openCount > 0 && (
                    <span className="text-gray-400"> ({summaryStats.openCount} open)</span>
                  )}
                </span>
              </div>
              
              {/* Row 1: Core Metrics */}
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 mb-2">
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Total P&L</p>
                  <p className={`text-lg font-bold ${summaryStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(summaryStats.totalPnL)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Win Rate</p>
                  <p className="text-lg font-bold text-gray-900">{summaryStats.winRate}%</p>
                  <p className="text-[10px] text-gray-500">
                    <span className="text-emerald-600">{summaryStats.wins}W</span> / <span className="text-red-600">{summaryStats.losses}L</span>
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Profit Factor</p>
                  <p className={`text-lg font-bold ${parseFloat(summaryStats.profitFactor) >= 1 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {summaryStats.profitFactor}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Avg Trade</p>
                  <p className={`text-lg font-bold ${summaryStats.avgTrade >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(summaryStats.avgTrade)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">R:R Ratio</p>
                  <p className="text-lg font-bold text-gray-900">{summaryStats.riskRewardRatio}:1</p>
                  <p className="text-[10px] text-gray-500 truncate">
                    {formatCurrencyShort(summaryStats.avgWin)}/{formatCurrencyShort(summaryStats.avgLoss)}
                  </p>
                </div>
              </div>
              
              {/* Row 2: Insights */}
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                <div className="bg-emerald-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-emerald-700 mb-1">Best Trade</p>
                  {summaryStats.bestTrade ? (
                    <>
                      <p className="text-lg font-bold text-emerald-600">{formatCurrencyShort(summaryStats.bestTrade.derived.pnlFinal)}</p>
                      <p className="text-[10px] text-emerald-700 truncate">{summaryStats.bestTrade.ticker}</p>
                    </>
                  ) : (
                    <p className="text-sm text-emerald-400">-</p>
                  )}
                </div>
                <div className="bg-red-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-red-700 mb-1">Worst Trade</p>
                  {summaryStats.worstTrade ? (
                    <>
                      <p className="text-lg font-bold text-red-600">{formatCurrencyShort(summaryStats.worstTrade.derived.pnlFinal)}</p>
                      <p className="text-[10px] text-red-700 truncate">{summaryStats.worstTrade.ticker}</p>
                    </>
                  ) : (
                    <p className="text-sm text-red-400">-</p>
                  )}
                </div>
                <div className="bg-blue-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-blue-700 mb-1">Top Ticker</p>
                  {summaryStats.topTicker ? (
                    <>
                      <p className="text-lg font-bold text-blue-600">{summaryStats.topTicker.ticker}</p>
                      <p className="text-[10px] text-blue-700 truncate">
                        {formatCurrencyShort(summaryStats.topTicker.pnl)} ({summaryStats.topTicker.count})
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-blue-400">-</p>
                  )}
                </div>
                <div className="bg-purple-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-purple-700 mb-1">Top Setup</p>
                  {summaryStats.topSetup ? (
                    <>
                      <p className="text-sm font-bold text-purple-600 truncate">{summaryStats.topSetup.name}</p>
                      <p className="text-[10px] text-purple-700 truncate">
                        {formatCurrencyShort(summaryStats.topSetup.pnl)} ({summaryStats.topSetup.count})
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-purple-400">-</p>
                  )}
                </div>
                <div className="bg-amber-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-amber-700 mb-1">Avg Rating</p>
                  {summaryStats.ratedCount > 0 ? (
                    <>
                      <div className="flex items-center gap-1">
                        <p className="text-lg font-bold text-amber-600">{summaryStats.avgRating.toFixed(1)}</p>
                        <span className="text-amber-500">‚òÖ</span>
                      </div>
                      <p className="text-[10px] text-amber-700">{summaryStats.ratedCount} rated</p>
                    </>
                  ) : (
                    <p className="text-sm text-amber-400">No ratings</p>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Trades Table */}
          {filteredTrades.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                {Icons.tradelog}
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                {state.trades.length === 0 ? 'No trades yet' : 'No trades match filters'}
              </h3>
              <p className="text-gray-500 mb-4">
                {state.trades.length === 0 
                  ? 'Start tracking your trades to see your performance.'
                  : 'Try adjusting your filters to see more trades.'}
              </p>
              {state.trades.length === 0 ? (
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Trade</span>
                </button>
              ) : (
                <button
                  onClick={resetFilters}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                >
                  Reset Filters
                </button>
              )}
            </div>
          ) : (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th 
                        onClick={() => handleSort('entryDate')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Entry Date <SortIndicator field="entryDate" />
                      </th>
                      <th 
                        onClick={() => handleSort('ticker')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Ticker <SortIndicator field="ticker" />
                      </th>
                      <th 
                        onClick={() => handleSort('assetType')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Asset <SortIndicator field="assetType" />
                      </th>
                      <th 
                        onClick={() => handleSort('positionType')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Type <SortIndicator field="positionType" />
                      </th>
                      <th 
                        onClick={() => handleSort('positionSize')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Size <SortIndicator field="positionSize" />
                      </th>
                      <th 
                        onClick={() => handleSort('entryPrice')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Entry <SortIndicator field="entryPrice" />
                      </th>
                      <th 
                        onClick={() => handleSort('exitDate')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Exit Date <SortIndicator field="exitDate" />
                      </th>
                      <th 
                        onClick={() => handleSort('exitPrice')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Exit <SortIndicator field="exitPrice" />
                      </th>
                      <th 
                        onClick={() => handleSort('length')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Length <SortIndicator field="length" />
                      </th>
                      <th 
                        onClick={() => handleSort('pnl')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        P&L <SortIndicator field="pnl" />
                      </th>
                      <th 
                        onClick={() => handleSort('rating')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Rating <SortIndicator field="rating" />
                      </th>
                      <th 
                        onClick={() => handleSort('setup')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Setup <SortIndicator field="setup" />
                      </th>
                      <th 
                        onClick={() => handleSort('mistakes')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Mistakes <SortIndicator field="mistakes" />
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        Notes
                      </th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        Screenshot
                      </th>
                      {(isReadOnly || activeFeedback.length > 0 || activeFlags.length > 0) && (
                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                          Feedback
                        </th>
                      )}
                      {!isReadOnly && (
                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                          Actions
                        </th>
                      )}
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredTrades.map(trade => (
                      <tr 
                        key={trade.id} 
                        className={`hover:bg-gray-50 ${(isReadOnly || activeFeedback.length > 0) ? 'cursor-pointer' : ''}`}
                        onClick={(isReadOnly || activeFeedback.length > 0) ? () => setViewingTrade(trade) : undefined}
                      >
                        <td className="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">{trade.entryDate}</td>
                        <td className="px-4 py-3 text-sm font-medium text-gray-900 whitespace-nowrap">{trade.ticker}</td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {ASSET_TYPES.find(a => a.id === trade.assetType)?.label || trade.assetType}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                            trade.positionType === 'long' 
                              ? 'bg-emerald-100 text-emerald-700' 
                              : 'bg-red-100 text-red-700'
                          }`}>
                            {trade.positionType.toUpperCase()}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">{trade.positionSize}</td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.entryPrice != null ? `$${trade.entryPrice.toFixed(2)}` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.exitDate || '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.exitPrice != null ? `$${trade.exitPrice.toFixed(2)}` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.derived.lengthDays != null ? `${trade.derived.lengthDays} days` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          {trade.derived.isOpen ? (
                            <span className="text-gray-400">Open</span>
                          ) : (
                            <span className={`font-medium ${trade.derived.pnlFinal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                              {formatCurrency(trade.derived.pnlFinal)}
                              {trade.derived.pnlMismatch && (
                                <span className="ml-1 text-amber-500" title="Manual P&L differs from calculated">‚ö†</span>
                              )}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          <StarRating value={trade.rating || 0} readonly size="sm" />
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap max-w-[150px] truncate" title={getSetupName(trade.setupId)}>
                          {getSetupName(trade.setupId)}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap max-w-[150px] truncate" title={getMistakeNames(trade.mistakeIds)}>
                          {getMistakeNames(trade.mistakeIds)}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          {trade.notes ? (
                            <button
                              onClick={() => openNotesModal(trade.notes, `${trade.ticker} - ${trade.entryDate}`)}
                              className="text-left max-w-[150px] hover:bg-gray-100 rounded px-2 py-1 -mx-2 -my-1 transition-colors group"
                              title="Click to expand"
                            >
                              <p className="text-gray-600 truncate text-xs leading-relaxed" style={{ display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden', whiteSpace: 'normal' }}>
                                {trade.notes}
                              </p>
                              {trade.notes.length > 50 && (
                                <span className="text-blue-500 text-xs group-hover:underline">more...</span>
                              )}
                            </button>
                          ) : (
                            <span className="text-gray-300">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center whitespace-nowrap">
                          {trade.screenshot ? (
                            <button
                              onClick={() => openImageModal(trade.screenshot, `${trade.ticker} - ${trade.entryDate}`, trade)}
                              className="inline-block hover:opacity-80 transition-opacity"
                              title="Click to expand"
                            >
                              <img 
                                src={trade.screenshot} 
                                alt="Screenshot" 
                                className="w-12 h-12 object-cover rounded border border-gray-200 hover:border-blue-400 transition-colors"
                              />
                            </button>
                          ) : (
                            <span className="text-gray-300">-</span>
                          )}
                        </td>
                        {/* Feedback Column */}
                        {(isReadOnly || activeFeedback.length > 0 || activeFlags.length > 0 || tradeQuestions.length > 0) && (
                          <td className="px-4 py-3 text-center whitespace-nowrap">
                            {(() => {
                              const feedback = getTradeFeedback(trade.id);
                              const flag = getTradeFlag(trade.id);
                              const questions = getTradeQuestions(trade.id);
                              const hasContent = feedback.length > 0 || flag || questions.length > 0;
                              const hasUnread = feedback.some(f => !f.read);
                              const hasUnanswered = questions.some(q => q.status === 'asked');
                              const hasAnswered = questions.some(q => q.status === 'answered' && !isMentorView);
                              
                              if (!hasContent) {
                                return <span className="text-gray-300">-</span>;
                              }
                              
                              return (
                                <div className="flex items-center justify-center gap-1">
                                  {/* Flag indicator */}
                                  {flag && (
                                    <span 
                                      className={`text-sm ${flag.status === 'resolved' ? 'opacity-50' : ''}`}
                                      title={`${FLAG_TYPES[flag.flagType]?.label || 'Flagged'}${flag.status === 'resolved' ? ' (Resolved)' : ''}`}
                                    >
                                      {FLAG_TYPES[flag.flagType]?.icon || 'üö©'}
                                    </span>
                                  )}
                                  {/* Question indicator */}
                                  {questions.length > 0 && (
                                    <span 
                                      className={`text-sm relative ${hasUnanswered ? 'animate-pulse' : ''}`}
                                      title={`${questions.length} question(s)${hasUnanswered ? ' - awaiting answer' : ''}`}
                                    >
                                      ‚ùì
                                      {hasUnanswered && (
                                        <span className="absolute -top-1 -right-1 w-2 h-2 bg-orange-500 rounded-full"></span>
                                      )}
                                      {hasAnswered && (
                                        <span className="absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full"></span>
                                      )}
                                    </span>
                                  )}
                                  {/* Feedback icons */}
                                  {feedback.length > 0 && (
                                    <div className={`flex items-center gap-0.5 ${hasUnread ? 'relative' : ''}`}>
                                      {/* Show first 2 unique feedback type icons */}
                                      {[...new Set(feedback.map(f => f.type))].slice(0, 2).map((type, idx) => (
                                        <span key={idx} className="text-sm" title={FEEDBACK_TYPES[type]?.label}>
                                          {FEEDBACK_TYPES[type]?.icon || 'üí¨'}
                                        </span>
                                      ))}
                                      {/* Count badge */}
                                      {feedback.length > 1 && (
                                        <span className="text-xs bg-gray-200 text-gray-600 px-1 rounded">
                                          {feedback.length}
                                        </span>
                                      )}
                                      {/* Unread dot */}
                                      {hasUnread && (
                                        <span className="absolute -top-1 -right-1 w-2 h-2 bg-blue-500 rounded-full"></span>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            })()}
                          </td>
                        )}
                        {!isReadOnly && (
                          <td className="px-4 py-3 text-right whitespace-nowrap">
                            <button
                              onClick={() => openEditModal(trade)}
                              className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                              title="Edit trade"
                            >
                              {Icons.edit}
                            </button>
                          </td>
                        )}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          <TradeModal
            isOpen={modalOpen}
            onClose={() => setModalOpen(false)}
            trade={editingTrade}
            state={state}
            setState={setState}
          />

          <ImageModal
            isOpen={imageModalOpen}
            onClose={() => setImageModalOpen(false)}
            src={imageModalData.src}
            title={imageModalData.title}
            trade={imageModalData.trade}
            state={state}
            setState={setState}
            getSetupName={getSetupName}
            getMistakeNames={getMistakeNames}
          />

          <NotesModal
            isOpen={notesModalOpen}
            onClose={() => setNotesModalOpen(false)}
            notes={notesModalData.notes}
            title={notesModalData.title}
          />

          {/* Trade View Modal (for read-only/mentor view OR student viewing feedback) */}
          {viewingTrade && (isReadOnly || activeFeedback.length > 0) && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setViewingTrade(null)} />
              <div className="relative min-h-screen flex items-start md:items-center justify-center p-2 md:p-4 pt-4">
                <div className="relative bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[92vh] overflow-y-auto">
                  {/* Header */}
                  <div className="sticky top-0 bg-white border-b border-gray-200 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between rounded-t-xl z-10">
                    <div>
                      <h2 className="text-lg md:text-xl font-semibold text-gray-900">
                        {viewingTrade.ticker} - {viewingTrade.entryDate}
                      </h2>
                      <p className="text-sm text-gray-500">
                        {isMentorView ? 'Trade Details (Read-Only)' : 'Trade Details & Feedback'}
                      </p>
                    </div>
                    <button onClick={() => setViewingTrade(null)} className="p-2 hover:bg-gray-100 rounded-lg">
                      {Icons.x}
                    </button>
                  </div>

                  {/* Trade Details */}
                  <div className="p-4 md:p-6 space-y-6">
                    {/* P&L Banner */}
                    <div className={`p-4 rounded-xl ${viewingTrade.derived?.pnlFinal >= 0 ? 'bg-emerald-50' : 'bg-red-50'}`}>
                      <p className="text-sm text-gray-600 mb-1">P&L</p>
                      <p className={`text-3xl font-bold ${viewingTrade.derived?.pnlFinal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                        {viewingTrade.derived?.isOpen ? 'Open' : formatCurrency(viewingTrade.derived?.pnlFinal || 0)}
                      </p>
                    </div>

                    {/* Trade Info Grid */}
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Asset Type</p>
                        <p className="font-medium">{ASSET_TYPES.find(a => a.id === viewingTrade.assetType)?.label || viewingTrade.assetType}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Position</p>
                        <p className="font-medium capitalize">{viewingTrade.positionType}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Size</p>
                        <p className="font-medium">{viewingTrade.positionSize}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Entry Price</p>
                        <p className="font-medium">{viewingTrade.entryPrice != null ? `$${viewingTrade.entryPrice.toFixed(2)}` : '-'}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Exit Date</p>
                        <p className="font-medium">{viewingTrade.exitDate || '-'}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Exit Price</p>
                        <p className="font-medium">{viewingTrade.exitPrice != null ? `$${viewingTrade.exitPrice.toFixed(2)}` : '-'}</p>
                      </div>
                    </div>

                    {/* Setup & Mistakes */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Setup</p>
                        <p className="font-medium">{getSetupName(viewingTrade.setupId)}</p>
                      </div>
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Mistakes</p>
                        <p className="font-medium">{getMistakeNames(viewingTrade.mistakeIds) || 'None'}</p>
                      </div>
                    </div>

                    {/* Rating */}
                    <div>
                      <p className="text-xs text-gray-500 mb-1">Rating</p>
                      <StarRating value={viewingTrade.rating || 0} readonly size="md" />
                    </div>

                    {/* Notes */}
                    {viewingTrade.notes && (
                      <div>
                        <p className="text-xs text-gray-500 mb-1">Notes</p>
                        <p className="text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded-lg">{viewingTrade.notes}</p>
                      </div>
                    )}

                    {/* Screenshot */}
                    {viewingTrade.screenshot && (
                      <div>
                        <p className="text-xs text-gray-500 mb-2">Screenshot</p>
                        <img 
                          src={viewingTrade.screenshot} 
                          alt="Trade screenshot" 
                          className="w-full rounded-lg border border-gray-200 cursor-pointer hover:opacity-90"
                          onClick={() => {
                            setImageModalData({ src: viewingTrade.screenshot, title: `${viewingTrade.ticker} - ${viewingTrade.entryDate}`, trade: viewingTrade });
                            setImageModalOpen(true);
                          }}
                        />
                      </div>
                    )}

                    {/* Trade Flag Section */}
                    {(() => {
                      const flag = getTradeFlag(viewingTrade.id);
                      return (
                        <div className="border-t border-gray-200 pt-4">
                          <div className="flex items-center justify-between mb-3">
                            <p className="text-sm font-medium text-gray-700">Trade Flag</p>
                            {isMentorView && flag && onToggleFlagStatus && (
                              <button
                                onClick={() => onToggleFlagStatus(viewingTrade.id)}
                                className={`text-xs px-2 py-1 rounded ${
                                  flag.status === 'open' 
                                    ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                                }`}
                              >
                                {flag.status === 'open' ? 'Mark Resolved' : 'Reopen'}
                              </button>
                            )}
                          </div>
                          
                          {flag ? (
                            <div className={`p-3 rounded-lg border ${FLAG_TYPES[flag.flagType]?.bgColor || 'bg-gray-50'} ${flag.status === 'resolved' ? 'opacity-60' : ''}`}>
                              <div className="flex items-center gap-2 mb-1">
                                <span className="text-lg">{FLAG_TYPES[flag.flagType]?.icon || 'üö©'}</span>
                                <span className={`font-medium ${FLAG_TYPES[flag.flagType]?.textColor || 'text-gray-700'}`}>
                                  {FLAG_TYPES[flag.flagType]?.label || 'Flagged'}
                                </span>
                                {flag.status === 'resolved' && (
                                  <span className="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">Resolved</span>
                                )}
                              </div>
                              {flag.note && <p className="text-sm text-gray-600 mt-1">{flag.note}</p>}
                              <p className="text-xs text-gray-400 mt-2">Flagged by {flag.mentorName}</p>
                              {isMentorView && onRemoveFlag && (
                                <button
                                  onClick={() => onRemoveFlag(viewingTrade.id)}
                                  className="text-xs text-red-500 hover:text-red-700 mt-2"
                                >
                                  Remove Flag
                                </button>
                              )}
                            </div>
                          ) : isMentorView && onAddFlag ? (
                            <div className="relative">
                              <button
                                onClick={() => setShowFlagMenu(!showFlagMenu)}
                                className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm text-gray-700"
                              >
                                <span>üö©</span>
                                <span>Flag this Trade</span>
                                <svg className={`w-4 h-4 transition-transform ${showFlagMenu ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                </svg>
                              </button>
                              {showFlagMenu && (
                                <div className="absolute top-full left-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[200px]">
                                  {Object.entries(FLAG_TYPES).map(([key, val]) => (
                                    <button
                                      key={key}
                                      onClick={() => {
                                        onAddFlag(viewingTrade.id, key);
                                        setShowFlagMenu(false);
                                      }}
                                      className="w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-50 text-left text-sm"
                                    >
                                      <span>{val.icon}</span>
                                      <span>{val.label}</span>
                                    </button>
                                  ))}
                                </div>
                              )}
                            </div>
                          ) : (
                            <p className="text-sm text-gray-400">No flag on this trade</p>
                          )}
                        </div>
                      );
                    })()}

                    {/* Mentor Feedback Section */}
                    <div className="border-t border-gray-200 pt-4">
                      <p className="text-sm font-medium text-gray-700 mb-3">Mentor Feedback</p>
                      
                      {/* Existing Feedback List */}
                      {(() => {
                        const feedback = getTradeFeedback(viewingTrade.id);
                        return feedback.length > 0 ? (
                          <div className="space-y-3 mb-4">
                            {feedback.map((fb) => {
                              const typeInfo = FEEDBACK_TYPES[fb.type] || FEEDBACK_TYPES.general;
                              return (
                                <div 
                                  key={fb.id} 
                                  className={`p-3 rounded-lg border ${typeInfo.bgColor} ${typeInfo.borderColor}`}
                                >
                                  <div className="flex items-start gap-2">
                                    <span className="text-lg flex-shrink-0">{typeInfo.icon}</span>
                                    <div className="flex-1 min-w-0">
                                      <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-xs font-medium ${typeInfo.textColor}`}>
                                          {typeInfo.label}
                                        </span>
                                        {!fb.read && !isMentorView && (
                                          <span className="text-xs bg-blue-500 text-white px-1.5 py-0.5 rounded">New</span>
                                        )}
                                      </div>
                                      <p className="text-sm text-gray-700">{fb.content}</p>
                                      <p className="text-xs text-gray-400 mt-2">
                                        {fb.mentorName} ‚Ä¢ {fb.createdAt?.toDate ? fb.createdAt.toDate().toLocaleDateString() : 'Just now'}
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        ) : (
                          <p className="text-sm text-gray-400 mb-4">No feedback yet</p>
                        );
                      })()}

                      {/* Add Feedback Form (Mentor Only) */}
                      {isMentorView && (
                        <div className="bg-gray-50 rounded-lg p-4">
                          <p className="text-sm font-medium text-gray-700 mb-3">Add Feedback</p>
                          
                          {/* Feedback Type Selector */}
                          <div className="mb-3">
                            <label className="block text-xs text-gray-500 mb-1">Feedback Type</label>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(FEEDBACK_TYPES).map(([key, val]) => (
                                <button
                                  key={key}
                                  onClick={() => setFeedbackType(key)}
                                  className={`flex items-center gap-1 px-2 py-1 rounded text-sm border transition-colors ${
                                    feedbackType === key 
                                      ? `${val.bgColor} ${val.textColor} ${val.borderColor}` 
                                      : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                  }`}
                                >
                                  <span>{val.icon}</span>
                                  <span className="hidden sm:inline">{val.label}</span>
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* Feedback Content */}
                          <div className="mb-3">
                            <textarea
                              value={feedbackContent}
                              onChange={(e) => setFeedbackContent(e.target.value)}
                              placeholder="Write your feedback..."
                              rows={3}
                              className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </div>

                          {/* Submit Button */}
                          <button
                            onClick={async () => {
                              if (!feedbackContent.trim() || !onAddFeedback) return;
                              setSubmittingFeedback(true);
                              try {
                                const success = await onAddFeedback(viewingTrade.id, feedbackType, feedbackContent);
                                if (success) {
                                  setFeedbackContent('');
                                  setFeedbackType('general');
                                }
                              } catch (err) {
                                console.error('Error adding feedback:', err);
                              }
                              setSubmittingFeedback(false);
                            }}
                            disabled={!feedbackContent.trim() || submittingFeedback || !onAddFeedback}
                            className="w-full py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            {submittingFeedback ? 'Adding...' : 'Add Feedback'}
                          </button>
                        </div>
                      )}
                    </div>

                    {/* Trade Questions Section */}
                    <div className="border-t border-gray-200 pt-4">
                      <p className="text-sm font-medium text-gray-700 mb-3">üí¨ Questions & Discussion</p>
                      
                      {/* Existing Questions List */}
                      {(() => {
                        const questions = getTradeQuestions(viewingTrade.id);
                        return questions.length > 0 ? (
                          <div className="space-y-4 mb-4">
                            {questions.map((q) => (
                              <div key={q.id} className="bg-gray-50 rounded-lg p-3">
                                {/* Question */}
                                <div className="flex items-start gap-2 mb-2">
                                  <span className="text-lg">‚ùì</span>
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-0.5 rounded">
                                        {q.questionType === 'entry' ? 'Entry Question' :
                                         q.questionType === 'exit' ? 'Exit Question' :
                                         q.questionType === 'improvement' ? 'How to Improve' :
                                         'Question'}
                                      </span>
                                      <span className={`text-xs px-2 py-0.5 rounded ${
                                        q.status === 'asked' ? 'bg-orange-100 text-orange-600' :
                                        q.status === 'answered' ? 'bg-blue-100 text-blue-600' :
                                        'bg-green-100 text-green-600'
                                      }`}>
                                        {q.status === 'asked' ? '‚è≥ Awaiting Answer' :
                                         q.status === 'answered' ? 'üí¨ Answered' :
                                         '‚úÖ Resolved'}
                                      </span>
                                    </div>
                                    <p className="text-sm text-gray-700">{q.question}</p>
                                    <p className="text-xs text-gray-400 mt-1">
                                      {q.studentName || 'You'} ‚Ä¢ {q.createdAt?.toDate ? q.createdAt.toDate().toLocaleDateString() : 'Just now'}
                                    </p>
                                  </div>
                                </div>
                                
                                {/* Answer (if exists) */}
                                {q.answer && (
                                  <div className="ml-6 mt-2 pl-3 border-l-2 border-blue-300">
                                    <div className="flex items-start gap-2">
                                      <span className="text-lg">üí°</span>
                                      <div className="flex-1">
                                        <p className="text-sm text-gray-700">{q.answer}</p>
                                        <p className="text-xs text-gray-400 mt-1">
                                          {q.mentorName || 'Mentor'} ‚Ä¢ {q.answeredAt?.toDate ? q.answeredAt.toDate().toLocaleDateString() : 'Just now'}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                )}
                                
                                {/* Answer Form (Mentor Only, if not answered) */}
                                {isMentorView && q.status === 'asked' && onAnswerQuestion && (
                                  <div className="ml-6 mt-3 pl-3 border-l-2 border-gray-200">
                                    <textarea
                                      value={answerContents[q.id] || ''}
                                      onChange={(e) => setAnswerContents(prev => ({ ...prev, [q.id]: e.target.value }))}
                                      placeholder="Write your answer..."
                                      rows={2}
                                      className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button
                                      onClick={async () => {
                                        const answer = answerContents[q.id]?.trim();
                                        if (!answer) return;
                                        setSubmittingAnswerId(q.id);
                                        try {
                                          await onAnswerQuestion(q.id, answer);
                                          setAnswerContents(prev => ({ ...prev, [q.id]: '' }));
                                        } catch (err) {
                                          console.error('Error answering question:', err);
                                        }
                                        setSubmittingAnswerId(null);
                                      }}
                                      disabled={!answerContents[q.id]?.trim() || submittingAnswerId === q.id}
                                      className="mt-2 px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50"
                                    >
                                      {submittingAnswerId === q.id ? 'Sending...' : 'Send Answer'}
                                    </button>
                                  </div>
                                )}
                                
                                {/* Resolve Button (Both can resolve after answered) */}
                                {q.status === 'answered' && onResolveQuestion && (
                                  <div className="ml-6 mt-2">
                                    <button
                                      onClick={() => onResolveQuestion(q.id)}
                                      className="text-xs text-green-600 hover:text-green-700 font-medium"
                                    >
                                      ‚úì Mark as Resolved
                                    </button>
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="text-sm text-gray-400 mb-4">No questions yet</p>
                        );
                      })()}

                      {/* Ask Question Form (Student Only - when they have a mentor) */}
                      {!isMentorView && userProfile?.mentorId && onAskQuestion && (
                        <>
                          {!showQuestionForm ? (
                            <button
                              onClick={() => setShowQuestionForm(true)}
                              className="flex items-center gap-2 text-purple-600 hover:text-purple-700 font-medium text-sm"
                            >
                              <span>‚ùì</span>
                              <span>Ask Mentor a Question</span>
                            </button>
                          ) : (
                            <div className="bg-purple-50 rounded-lg p-4">
                              <p className="text-sm font-medium text-purple-700 mb-3">Ask Your Mentor</p>
                              
                              {/* Question Type */}
                              <div className="mb-3">
                                <label className="block text-xs text-gray-500 mb-1">Question Type</label>
                                <div className="flex flex-wrap gap-2">
                                  {[
                                    { key: 'entry', label: 'Entry', icon: 'üìà' },
                                    { key: 'exit', label: 'Exit', icon: 'üìâ' },
                                    { key: 'improvement', label: 'How to Improve', icon: 'üéØ' },
                                    { key: 'general', label: 'General', icon: 'üí¨' },
                                  ].map(({ key, label, icon }) => (
                                    <button
                                      key={key}
                                      onClick={() => setQuestionType(key)}
                                      className={`flex items-center gap-1 px-2 py-1 rounded text-sm border transition-colors ${
                                        questionType === key 
                                          ? 'bg-purple-100 text-purple-700 border-purple-300' 
                                          : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                                      }`}
                                    >
                                      <span>{icon}</span>
                                      <span>{label}</span>
                                    </button>
                                  ))}
                                </div>
                              </div>

                              {/* Question Content */}
                              <div className="mb-3">
                                <textarea
                                  value={questionContent}
                                  onChange={(e) => setQuestionContent(e.target.value)}
                                  placeholder={
                                    questionType === 'entry' ? "Was this a good entry? What could I have done better?" :
                                    questionType === 'exit' ? "Should I have held longer? Exited earlier?" :
                                    questionType === 'improvement' ? "How can I improve on trades like this?" :
                                    "Ask your mentor anything about this trade..."
                                  }
                                  rows={3}
                                  className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500"
                                />
                              </div>

                              {/* Buttons */}
                              <div className="flex gap-2">
                                <button
                                  onClick={() => {
                                    setShowQuestionForm(false);
                                    setQuestionContent('');
                                    setQuestionType('general');
                                  }}
                                  className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm"
                                >
                                  Cancel
                                </button>
                                <button
                                  onClick={async () => {
                                    if (!questionContent.trim()) return;
                                    setSubmittingQuestion(true);
                                    try {
                                      const success = await onAskQuestion(viewingTrade.id, questionType, questionContent.trim());
                                      if (success) {
                                        setQuestionContent('');
                                        setQuestionType('general');
                                        setShowQuestionForm(false);
                                      }
                                    } catch (err) {
                                      console.error('Error asking question:', err);
                                    }
                                    setSubmittingQuestion(false);
                                  }}
                                  disabled={!questionContent.trim() || submittingQuestion}
                                  className="flex-1 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 disabled:opacity-50"
                                >
                                  {submittingQuestion ? 'Sending...' : 'Send Question'}
                                </button>
                              </div>
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // OTHER PAGE PLACEHOLDERS
    // =============================================================================
    // =============================================================================
    // SIMPLE PIE CHART COMPONENT
    // =============================================================================
    function SimplePieChart({ data, title }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-48 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const total = data.reduce((sum, d) => sum + Math.abs(d.value), 0);
      if (total === 0) {
        return (
          <div className="h-48 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
      let currentAngle = 0;

      const slices = data.map((d, i) => {
        const percentage = Math.abs(d.value) / total;
        const angle = percentage * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;
        currentAngle = endAngle;

        const startRad = (startAngle - 90) * (Math.PI / 180);
        const endRad = (endAngle - 90) * (Math.PI / 180);

        const x1 = 50 + 40 * Math.cos(startRad);
        const y1 = 50 + 40 * Math.sin(startRad);
        const x2 = 50 + 40 * Math.cos(endRad);
        const y2 = 50 + 40 * Math.sin(endRad);

        const largeArc = angle > 180 ? 1 : 0;

        const pathD = `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`;

        return {
          ...d,
          path: pathD,
          color: colors[i % colors.length],
          percentage: (percentage * 100).toFixed(1),
        };
      });

      return (
        <div className="flex items-center gap-4">
          <svg viewBox="0 0 100 100" className="w-32 h-32">
            {slices.map((slice, i) => (
              <path key={i} d={slice.path} fill={slice.color} stroke="white" strokeWidth="1" />
            ))}
          </svg>
          <div className="flex-1 space-y-1">
            {slices.map((slice, i) => (
              <div key={i} className="flex items-center gap-2 text-xs">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: slice.color }} />
                <span className="text-gray-600">{slice.label}</span>
                <span className="text-gray-400 ml-auto">{slice.percentage}%</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // =============================================================================
    // SIMPLE BAR CHART COMPONENT
    // =============================================================================
    function SimpleBarChart({ data, title, showValues = true }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const maxVal = Math.max(...data.map(d => Math.abs(d.value)), 1);

      return (
        <div className="space-y-2">
          {data.map((d, i) => (
            <div key={i} className="flex items-center gap-2">
              <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
              <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                <div
                  className={`h-full rounded ${d.value >= 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                  style={{ width: `${(Math.abs(d.value) / maxVal) * 100}%` }}
                />
              </div>
              {showValues && (
                <span className={`text-xs font-medium w-16 text-right ${d.value >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                  {formatCurrency(d.value)}
                </span>
              )}
            </div>
          ))}
        </div>
      );
    }

    // =============================================================================
    // SETUP SUCCESS BAR CHART
    // =============================================================================
    function SetupBarChart({ data }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
            No setups used
          </div>
        );
      }

      return (
        <div className="space-y-3">
          {data.map((d, i) => (
            <div key={i}>
              <div className="flex items-center justify-between text-xs mb-1">
                <span className="text-gray-700 font-medium">{d.name}</span>
                <span className="text-gray-500">{d.wins}W / {d.losses}L ({d.winRate}%)</span>
              </div>
              <div className="h-4 bg-gray-100 rounded overflow-hidden flex">
                {d.wins > 0 && (
                  <div
                    className="h-full bg-emerald-500"
                    style={{ width: `${(d.wins / d.total) * 100}%` }}
                  />
                )}
                {d.losses > 0 && (
                  <div
                    className="h-full bg-red-500"
                    style={{ width: `${(d.losses / d.total) * 100}%` }}
                  />
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // =============================================================================
    // CALENDAR PAGE
    // =============================================================================
    function CalendarPage({ state, setState, selectedDate, setSelectedDate, isMobile, isReadOnly = false }) {
      const [viewDate, setViewDate] = useState(() => {
        if (selectedDate) {
          const [year, month] = selectedDate.split('-');
          return { year: parseInt(year), month: parseInt(month) - 1 };
        }
        const now = new Date();
        return { year: now.getFullYear(), month: now.getMonth() };
      });
      const [modalOpen, setModalOpen] = useState(false);
      const [editingTrade, setEditingTrade] = useState(null);
      const [dailyNote, setDailyNote] = useState('');
      const [imageModalOpen, setImageModalOpen] = useState(false);
      const [imageModalData, setImageModalData] = useState({ src: null, title: '' });

      // Get all trades with derived data
      const allTradesWithDerived = useMemo(() => {
        return state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) }));
      }, [state.trades]);

      // Calculate daily stats for the entire dataset (for averages)
      const overallStats = useMemo(() => {
        const closedTrades = allTradesWithDerived.filter(t => !t.derived.isOpen);
        const dailyPnL = {};
        const dailyTradeCount = {};
        
        closedTrades.forEach(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          if (!dailyPnL[date]) dailyPnL[date] = 0;
          if (!dailyTradeCount[date]) dailyTradeCount[date] = 0;
          dailyPnL[date] += t.derived.pnlFinal || 0;
          dailyTradeCount[date]++;
        });

        const days = Object.values(dailyPnL);
        const tradeCounts = Object.values(dailyTradeCount);
        const avgDailyPnL = days.length > 0 ? days.reduce((a, b) => a + b, 0) / days.length : 0;
        const avgDailyTrades = tradeCounts.length > 0 ? tradeCounts.reduce((a, b) => a + b, 0) / tradeCounts.length : 0;
        
        return { avgDailyPnL, avgDailyTrades, tradingDays: days.length };
      }, [allTradesWithDerived]);

      // Goal progress calculation for calendar (based on yearly goal)
      const goalProgress = useMemo(() => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const TRADING_DAYS_PER_YEAR = 252;
        
        // Check for yearly goal
        const yearlyGoal = state.yearlyGoal;
        if (!yearlyGoal || yearlyGoal.year !== currentYear) return null;
        
        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        // Calculate year P&L and build cumulative by date
        const yearTrades = allTradesWithDerived
          .filter(t => {
            if (t.derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .sort((a, b) => {
            const dateA = a.exitDate || a.entryDate;
            const dateB = b.exitDate || b.entryDate;
            return dateA.localeCompare(dateB);
          });
        
        // Build cumulative P&L by date
        const cumulativeByDate = {};
        let runningTotal = 0;
        yearTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          runningTotal += t.derived.pnlFinal || 0;
          cumulativeByDate[date] = runningTotal;
        });
        
        const yearPnL = runningTotal;
        const progress = yearlyGoal.target > 0 ? (yearPnL / yearlyGoal.target) * 100 : 0;
        
        // Calculate daily target (based on 252 trading days)
        const dailyTarget = yearlyGoal.target / TRADING_DAYS_PER_YEAR;
        
        // Build pace line data for calendar
        const paceByDate = {};
        let dayCount = 0;
        const endOfYear = new Date(currentYear, 11, 31);
        for (let d = new Date(currentYear, 0, 1); d <= endOfYear; d.setDate(d.getDate() + 1)) {
          const day = d.getDay();
          if (day !== 0 && day !== 6) { // Skip weekends for trading days
            dayCount++;
            const dateStr = d.toISOString().split('T')[0];
            paceByDate[dateStr] = dailyTarget * dayCount;
          }
        }
        
        return {
          goal: yearlyGoal,
          yearPnL,
          progress: Math.min(progress, 100),
          dailyTarget,
          cumulativeByDate,
          paceByDate,
          yearStartStr: yearStart,
          yearEndStr: yearEnd,
          yearLabel: `${currentYear}`,
        };
      }, [state.yearlyGoal, allTradesWithDerived]);

      // Calculate calendar data
      const calendarData = useMemo(() => {
        const { year, month } = viewDate;
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        // Get daily stats
        const dailyStats = {};
        allTradesWithDerived.forEach(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          if (!date) return;
          
          if (!dailyStats[date]) {
            dailyStats[date] = { pnl: 0, trades: 0, wins: 0, losses: 0 };
          }
          dailyStats[date].trades++;
          if (!t.derived.isOpen) {
            dailyStats[date].pnl += t.derived.pnlFinal || 0;
            if (t.derived.winLoss === 'W') dailyStats[date].wins++;
            if (t.derived.winLoss === 'L') dailyStats[date].losses++;
          }
        });

        const days = [];
        
        // Empty cells before month starts
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push({ day: null });
        }

        // Days of the month
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const stats = dailyStats[dateStr] || { pnl: 0, trades: 0, wins: 0, losses: 0 };
          days.push({
            day: d,
            date: dateStr,
            ...stats,
            hasNote: !!state.dailyNotes[dateStr],
          });
        }

        return {
          year,
          month,
          monthName: firstDay.toLocaleString('default', { month: 'long' }),
          days,
        };
      }, [viewDate, allTradesWithDerived, state.dailyNotes]);

      // Get trades for selected date
      const selectedDateTrades = useMemo(() => {
        if (!selectedDate) return [];
        return allTradesWithDerived.filter(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          return date === selectedDate;
        });
      }, [selectedDate, allTradesWithDerived]);

      // Calculate stats for selected date
      const selectedDateStats = useMemo(() => {
        if (!selectedDate || selectedDateTrades.length === 0) {
          return null;
        }

        const closedTrades = selectedDateTrades.filter(t => !t.derived.isOpen);
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        const winRate = closedTrades.length > 0 ? ((wins.length / closedTrades.length) * 100).toFixed(1) : 0;

        // Best trade
        const bestTrade = closedTrades.length > 0
          ? closedTrades.reduce((best, t) => (t.derived.pnlFinal || 0) > (best.derived.pnlFinal || 0) ? t : best, closedTrades[0])
          : null;

        // P&L by Asset Type
        const pnlByAsset = {};
        closedTrades.forEach(t => {
          const asset = ASSET_TYPES.find(a => a.id === t.assetType)?.label || t.assetType;
          if (!pnlByAsset[asset]) pnlByAsset[asset] = 0;
          pnlByAsset[asset] += t.derived.pnlFinal || 0;
        });
        const assetPieData = Object.entries(pnlByAsset).map(([label, value]) => ({ label, value }));

        // P&L by Ticker
        const pnlByTicker = {};
        closedTrades.forEach(t => {
          if (!pnlByTicker[t.ticker]) pnlByTicker[t.ticker] = 0;
          pnlByTicker[t.ticker] += t.derived.pnlFinal || 0;
        });
        const tickerPnLData = Object.entries(pnlByTicker)
          .map(([label, value]) => ({ label, value }))
          .sort((a, b) => b.value - a.value); // Sort by P&L descending (best first)

        // Individual trade P&L (for bar chart)
        const tradePnLData = closedTrades.map(t => ({
          label: t.ticker,
          value: t.derived.pnlFinal || 0,
        }));

        // Setup usage and success
        const setupStats = {};
        closedTrades.forEach(t => {
          if (!t.setupId) return;
          const setup = state.setups.find(s => s.id === t.setupId);
          if (!setup) return;
          
          if (!setupStats[setup.id]) {
            setupStats[setup.id] = { id: setup.id, name: setup.name, wins: 0, losses: 0, total: 0, totalPnL: 0 };
          }
          setupStats[setup.id].total++;
          setupStats[setup.id].totalPnL += t.derived.pnlFinal || 0;
          if (t.derived.winLoss === 'W') setupStats[setup.id].wins++;
          if (t.derived.winLoss === 'L') setupStats[setup.id].losses++;
        });
        const setupData = Object.values(setupStats).map(s => ({
          ...s,
          winRate: s.total > 0 ? ((s.wins / s.total) * 100).toFixed(0) : 0,
        }));

        // Mistake analytics - ONLY count losses towards cost
        const mistakeStats = {};
        closedTrades.forEach(t => {
          if (!t.mistakeIds || t.mistakeIds.length === 0) return;
          const pnl = t.derived.pnlFinal || 0;
          
          t.mistakeIds.forEach(mistakeId => {
            const mistake = state.mistakes.find(m => m.id === mistakeId);
            if (!mistake) return;
            
            if (!mistakeStats[mistakeId]) {
              mistakeStats[mistakeId] = {
                id: mistakeId,
                name: mistake.name,
                totalOccurrences: 0,
                losingTrades: 0,
                profitableTrades: 0,
                totalLossAmount: 0,
              };
            }
            mistakeStats[mistakeId].totalOccurrences++;
            if (pnl < 0) {
              mistakeStats[mistakeId].losingTrades++;
              mistakeStats[mistakeId].totalLossAmount += pnl;
            } else {
              mistakeStats[mistakeId].profitableTrades++;
            }
          });
        });
        const mistakeData = Object.values(mistakeStats);

        // Compare to average
        const vsAverage = overallStats.avgDailyPnL !== 0
          ? ((totalPnL - overallStats.avgDailyPnL) / Math.abs(overallStats.avgDailyPnL) * 100).toFixed(1)
          : totalPnL > 0 ? 100 : totalPnL < 0 ? -100 : 0;

        // Calculate avg win/loss and R:R ratio
        const avgWin = wins.length > 0 
          ? wins.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / wins.length 
          : 0;
        const avgLoss = losses.length > 0 
          ? Math.abs(losses.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / losses.length)
          : 0;
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';

        // Trades vs average
        const tradesVsAvg = overallStats.avgDailyTrades > 0
          ? closedTrades.length - overallStats.avgDailyTrades
          : 0;

        // Calculate average rating
        const ratedTrades = closedTrades.filter(t => t.rating && t.rating > 0);
        const avgRating = ratedTrades.length > 0
          ? ratedTrades.reduce((sum, t) => sum + t.rating, 0) / ratedTrades.length
          : 0;

        return {
          totalPnL,
          totalTrades: selectedDateTrades.length,
          closedTrades: closedTrades.length,
          wins: wins.length,
          losses: losses.length,
          winRate,
          bestTrade,
          assetPieData,
          tickerPnLData,
          tradePnLData,
          setupData,
          mistakeData,
          vsAverage,
          avgDailyPnL: overallStats.avgDailyPnL,
          avgWin,
          avgLoss,
          riskRewardRatio,
          tradesVsAvg,
          avgDailyTrades: overallStats.avgDailyTrades,
          avgRating,
          ratedTradesCount: ratedTrades.length,
        };
      }, [selectedDate, selectedDateTrades, state.setups, state.mistakes, overallStats]);

      // Load daily note when date changes
      useEffect(() => {
        if (selectedDate && state.dailyNotes[selectedDate]) {
          setDailyNote(state.dailyNotes[selectedDate].note || '');
        } else {
          setDailyNote('');
        }
        // Auto-resize textarea after note loads
        setTimeout(() => {
          const textarea = document.querySelector('textarea[placeholder*="Market conditions"]');
          if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(150, textarea.scrollHeight) + 'px';
          }
        }, 0);
      }, [selectedDate, state.dailyNotes]);

      // Navigation
      const prevMonth = () => {
        setViewDate(prev => {
          if (prev.month === 0) {
            return { year: prev.year - 1, month: 11 };
          }
          return { ...prev, month: prev.month - 1 };
        });
      };

      const nextMonth = () => {
        setViewDate(prev => {
          if (prev.month === 11) {
            return { year: prev.year + 1, month: 0 };
          }
          return { ...prev, month: prev.month + 1 };
        });
      };

      const goToToday = () => {
        const now = new Date();
        setViewDate({ year: now.getFullYear(), month: now.getMonth() });
        setSelectedDate(todayISO());
      };

      // Save daily note
      const handleSaveNote = () => {
        if (!selectedDate) return;
        
        const updatedNote = {
          date: selectedDate,
          note: dailyNote,
          emotionalState: state.dailyNotes[selectedDate]?.emotionalState || null,
          updatedAt: nowISO(),
        };

        setState({
          ...state,
          dailyNotes: {
            ...state.dailyNotes,
            [selectedDate]: updatedNote,
          },
        });
      };

      // Edit trade
      const openEditModal = (trade) => {
        setEditingTrade(trade);
        setModalOpen(true);
      };

      // Helper functions
      const getSetupName = (setupId) => {
        if (!setupId) return '-';
        const setup = state.setups.find(s => s.id === setupId);
        return setup?.name || '-';
      };

      const getMistakeNames = (mistakeIds) => {
        if (!mistakeIds || mistakeIds.length === 0) return '-';
        return mistakeIds
          .map(id => state.mistakes.find(m => m.id === id)?.name)
          .filter(Boolean)
          .join(', ') || '-';
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <h1 className="text-xl md:text-2xl font-bold text-gray-900">Calendar</h1>
            <button
              onClick={goToToday}
              className="px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            >
              Today
            </button>
          </div>

          {/* Goal Progress Bar */}
          {goalProgress && (
            <div className={`rounded-xl p-4 ${
              goalProgress.progress >= 100 
                ? 'bg-emerald-50 border border-emerald-200' 
                : 'bg-white border border-gray-200'
            }`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-semibold text-gray-900">{goalProgress.yearLabel} Goal</span>
                  {goalProgress.progress >= 100 && <span>üéØ</span>}
                </div>
                <span className={`text-sm font-bold ${goalProgress.progress >= 100 ? 'text-emerald-600' : 'text-blue-600'}`}>
                  {goalProgress.progress.toFixed(1)}%
                </span>
              </div>
              <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full rounded-full transition-all ${goalProgress.progress >= 100 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                  style={{ width: `${Math.min(goalProgress.progress, 100)}%` }}
                />
              </div>
              <div className="flex justify-between mt-2 text-xs text-gray-500">
                <span>{formatCurrencyShort(goalProgress.yearPnL)} earned</span>
                <span>{formatCurrencyShort(goalProgress.goal.target)} target</span>
              </div>
            </div>
          )}

          {/* Mobile: Stack calendar and details */}
          <div className={`grid gap-4 md:gap-6 ${isMobile ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-3'}`}>
            {/* Left Column: Calendar + Daily Notes */}
            <div className="lg:col-span-1 space-y-4">
              {/* Calendar */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                {/* Month Navigation */}
                <div className="flex items-center justify-between mb-4">
                  <button
                    onClick={prevMonth}
                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    {Icons.chevronLeft}
                  </button>
                  <h2 className="text-lg font-semibold text-gray-900">
                    {calendarData.monthName} {calendarData.year}
                  </h2>
                  <button
                    onClick={nextMonth}
                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    {Icons.chevronRight}
                  </button>
                </div>

                {/* Calendar Grid */}
                <div className="grid grid-cols-7 gap-0.5 md:gap-1">
                  {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, i) => (
                    <div key={i} className="text-center text-[10px] md:text-xs font-medium text-gray-500 py-1 md:py-2">
                      {day}
                    </div>
                  ))}
                  {calendarData.days.map((d, i) => {
                    const winRate = d.trades > 0 && (d.wins + d.losses) > 0 
                      ? Math.round((d.wins / (d.wins + d.losses)) * 100) 
                      : null;
                    
                    // Calculate if day met its daily goal target (only for days with trades)
                    let metDailyGoal = null;
                    if (goalProgress && d.day && d.trades > 0 && d.date >= goalProgress.yearStartStr && d.date <= goalProgress.yearEndStr) {
                      metDailyGoal = d.pnl >= goalProgress.dailyTarget;
                    }
                    
                    // Format P&L compactly for mobile
                    const formatPnLCompact = (pnl) => {
                      const absAmount = Math.abs(pnl);
                      const prefix = pnl >= 0 ? '+' : '-';
                      if (absAmount >= 1000000) {
                        return prefix + (absAmount / 1000000).toFixed(1) + 'M';
                      } else if (absAmount >= 10000) {
                        return prefix + (absAmount / 1000).toFixed(0) + 'K';
                      } else if (absAmount >= 1000) {
                        return prefix + (absAmount / 1000).toFixed(1) + 'K';
                      }
                      return prefix + absAmount.toFixed(0);
                    };
                    
                    return (
                      <button
                        key={i}
                        onClick={() => d.day && setSelectedDate(d.date)}
                        disabled={!d.day}
                        className={`
                          min-h-[52px] md:min-h-[72px] p-0.5 md:p-1 rounded-lg flex flex-col items-center justify-start
                          transition-all relative overflow-hidden
                          ${!d.day ? 'invisible' : ''}
                          ${d.date === selectedDate ? 'ring-2 ring-blue-500 bg-blue-50' : ''}
                          ${d.date === todayISO() && d.date !== selectedDate ? 'ring-1 ring-gray-300' : ''}
                          ${d.day && d.trades === 0 ? 'bg-gray-50 hover:bg-gray-100' : ''}
                          ${d.day && d.trades > 0 && d.pnl > 0 ? 'bg-emerald-100 hover:bg-emerald-200 border border-emerald-300' : ''}
                          ${d.day && d.trades > 0 && d.pnl < 0 ? 'bg-red-100 hover:bg-red-200 border border-red-300' : ''}
                          ${d.day && d.trades > 0 && d.pnl === 0 ? 'bg-gray-200 hover:bg-gray-300' : ''}
                        `}
                      >
                        {d.day && (
                          <>
                            <span className={`text-[10px] md:text-sm font-semibold ${d.date === todayISO() ? 'text-blue-600' : 'text-gray-700'}`}>
                              {d.day}
                            </span>
                            {d.trades > 0 && (
                              <div className="flex flex-col items-center leading-none w-full">
                                <span className={`text-[9px] md:text-xs font-bold truncate w-full text-center ${d.pnl >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>
                                  <span className="md:hidden">{formatPnLCompact(d.pnl)}</span>
                                  <span className="hidden md:inline">{formatCurrencyShort(d.pnl)}</span>
                                </span>
                                <span className="text-[7px] md:text-[10px] text-gray-500">{d.wins}W/{d.losses}L</span>
                              </div>
                            )}
                            {d.hasNote && d.trades === 0 && (
                              <span className="text-[8px] md:text-[10px]">üìù</span>
                            )}
                            {/* Goal indicator - only on trading days */}
                            {metDailyGoal !== null && (
                              <span className="text-[6px] md:text-[8px]" title={metDailyGoal ? 'Hit daily goal' : 'Missed daily goal'}>
                                {metDailyGoal ? '‚úÖ' : '‚ùå'}
                              </span>
                            )}
                          </>
                        )}
                      </button>
                    );
                  })}
                </div>

                {/* Legend */}
                <div className="mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-3 text-xs">
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-emerald-100" />
                    <span className="text-gray-600">Profit</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-red-100" />
                    <span className="text-gray-600">Loss</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-gray-50 border border-gray-200" />
                    <span className="text-gray-600">No trades</span>
                  </div>
                  {goalProgress && (
                    <>
                      <div className="flex items-center gap-1">
                        <span className="text-[10px]">‚úÖ</span>
                        <span className="text-gray-600">Hit daily goal</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-[10px]">‚ùå</span>
                        <span className="text-gray-600">Missed daily goal</span>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* Daily Notes - Below Calendar in same column */}
              {selectedDate && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <h3 className="text-sm font-semibold text-gray-900 mb-3">
                    Daily Notes
                    <span className="text-xs font-normal text-gray-500 ml-2">
                      {new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </span>
                  </h3>
                  <textarea
                    value={dailyNote}
                    onChange={(e) => {
                      if (isReadOnly) return;
                      setDailyNote(e.target.value);
                      // Auto-expand textarea
                      e.target.style.height = 'auto';
                      e.target.style.height = Math.max(150, e.target.scrollHeight) + 'px';
                    }}
                    onFocus={(e) => {
                      // Ensure proper height on focus
                      e.target.style.height = 'auto';
                      e.target.style.height = Math.max(150, e.target.scrollHeight) + 'px';
                    }}
                    placeholder={isReadOnly ? "No notes for this date" : "Market conditions, trading plan, lessons learned, emotions..."}
                    className={`w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 overflow-hidden ${isReadOnly ? 'bg-gray-50 cursor-not-allowed' : ''}`}
                    style={{ minHeight: '150px', resize: 'none' }}
                    readOnly={isReadOnly}
                  />
                  {!isReadOnly && (
                    <button
                      onClick={handleSaveNote}
                      className="mt-2 w-full px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      Save Note
                    </button>
                  )}
                </div>
              )}
            </div>

            {/* Day Details */}
            <div className="lg:col-span-2 space-y-6">
              {!selectedDate ? (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
                  <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    {Icons.calendar}
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 mb-2">Select a date</h3>
                  <p className="text-gray-500">Click on a day in the calendar to view details</p>
                </div>
              ) : (
                <>
                  {/* Date Header */}
                  <div className="flex items-center justify-between">
                    <h2 className="text-xl font-semibold text-gray-900">
                      {new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      })}
                    </h2>
                  </div>

                  {/* Daily Goal Progress for Selected Date */}
                  {goalProgress && selectedDate >= goalProgress.yearStartStr && selectedDate <= goalProgress.yearEndStr && selectedDateStats && selectedDateStats.closedTrades > 0 && (
                    (() => {
                      const dailyPnL = selectedDateStats.totalPnL;
                      const dailyTarget = goalProgress.dailyTarget;
                      const dailyProgress = dailyTarget > 0 ? Math.min((dailyPnL / dailyTarget) * 100, 100) : 0;
                      const metGoal = dailyPnL >= dailyTarget;
                      
                      return (
                        <div className={`rounded-lg p-3 ${
                          metGoal 
                            ? 'bg-emerald-50 border border-emerald-200' 
                            : 'bg-gray-50 border border-gray-200'
                        }`}>
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-gray-700">Daily Goal</span>
                              <span className="text-sm">{metGoal ? '‚úÖ' : '‚ùå'}</span>
                            </div>
                            <span className={`text-sm font-bold ${metGoal ? 'text-emerald-600' : dailyPnL >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                              {dailyProgress > 0 ? dailyProgress.toFixed(0) : 0}%
                            </span>
                          </div>
                          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div 
                              className={`h-full rounded-full transition-all ${
                                metGoal ? 'bg-emerald-500' : dailyPnL >= 0 ? 'bg-blue-500' : 'bg-red-400'
                              }`}
                              style={{ width: `${Math.max(0, Math.min(dailyProgress, 100))}%` }}
                            />
                          </div>
                          <div className="flex justify-between mt-1.5 text-xs text-gray-500">
                            <span>
                              <span className={dailyPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}>{formatCurrencyShort(dailyPnL)}</span>
                              {' / '}
                              {formatCurrencyShort(dailyTarget)} target
                            </span>
                            <span>
                              {metGoal 
                                ? `+${formatCurrencyShort(dailyPnL - dailyTarget)} over` 
                                : `${formatCurrencyShort(dailyTarget - dailyPnL)} short`
                              }
                            </span>
                          </div>
                        </div>
                      );
                    })()
                  )}

                  {/* Summary Cards */}
                  {selectedDateStats ? (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-7 gap-2">
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Daily P&L</p>
                        <p className={`text-lg font-bold truncate ${selectedDateStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {formatCurrencyShort(selectedDateStats.totalPnL)}
                        </p>
                        <p className={`text-[10px] mt-1 truncate ${parseFloat(selectedDateStats.vsAverage) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {parseFloat(selectedDateStats.vsAverage) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(selectedDateStats.vsAverage))}% vs avg
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate"># Trades</p>
                        <div className="flex items-baseline gap-1">
                          <p className="text-lg font-bold text-gray-900">{selectedDateStats.closedTrades}</p>
                          {selectedDateStats.avgDailyTrades > 0 && (
                            <span className={`text-xs font-medium ${selectedDateStats.tradesVsAvg >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                              {selectedDateStats.tradesVsAvg >= 0 ? '‚Üë' : '‚Üì'}{Math.abs(selectedDateStats.tradesVsAvg).toFixed(1)}
                            </span>
                          )}
                        </div>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">avg {selectedDateStats.avgDailyTrades.toFixed(1)}/day</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Win Rate</p>
                        <p className="text-lg font-bold text-gray-900">{selectedDateStats.winRate}%</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">
                          <span className="text-emerald-600">{selectedDateStats.wins}W</span>
                          {' / '}
                          <span className="text-red-600">{selectedDateStats.losses}L</span>
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">R:R</p>
                        <p className="text-lg font-bold text-gray-900">{selectedDateStats.riskRewardRatio}:1</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">
                          {formatCurrencyShort(selectedDateStats.avgWin)}/{formatCurrencyShort(selectedDateStats.avgLoss)}
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Win</p>
                        <p className="text-lg font-bold text-emerald-600 truncate">{formatCurrencyShort(selectedDateStats.avgWin)}</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.wins} win{selectedDateStats.wins !== 1 ? 's' : ''}</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Loss</p>
                        <p className="text-lg font-bold text-red-600 truncate">-{formatCurrencyShort(selectedDateStats.avgLoss)}</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.losses} loss{selectedDateStats.losses !== 1 ? 'es' : ''}</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Rating</p>
                        {selectedDateStats.ratedTradesCount > 0 ? (
                          <>
                            <div className="flex items-center gap-1">
                              <span className="text-lg font-bold text-gray-900">{selectedDateStats.avgRating.toFixed(1)}</span>
                              <span className="text-amber-400">‚òÖ</span>
                            </div>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.ratedTradesCount} rated</p>
                          </>
                        ) : (
                          <p className="text-xs text-gray-400 italic">No ratings</p>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6 text-center text-gray-500">
                      No trades on this date
                    </div>
                  )}

                  {/* Charts */}
                  {selectedDateStats && selectedDateStats.closedTrades > 0 && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      {/* P&L by Asset Type */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Asset</h3>
                        <SimplePieChart data={selectedDateStats.assetPieData} />
                      </div>

                      {/* P&L by Ticker */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Ticker</h3>
                        <SimpleBarChart data={selectedDateStats.tickerPnLData} />
                      </div>

                      {/* Trade P&L Distribution */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">Trade P&L</h3>
                        <SimpleBarChart data={selectedDateStats.tradePnLData} />
                      </div>

                      {/* Setups Used */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">Setups Used</h3>
                        <SetupBarChart data={selectedDateStats.setupData} />
                      </div>
                    </div>
                  )}

                  {/* Trades Table */}
                  <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                      <h3 className="text-sm font-semibold text-gray-900">
                        {selectedDateTrades.length > 0 
                          ? `Trades (${selectedDateTrades.length})`
                          : 'No trades yet'
                        }
                      </h3>
                      {!isReadOnly && (
                        <button
                          onClick={() => {
                            setEditingTrade({ entryDate: selectedDate });
                            setModalOpen(true);
                          }}
                          className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-medium"
                        >
                          {Icons.plus}
                          <span>Add Trade</span>
                        </button>
                      )}
                    </div>
                    {selectedDateTrades.length > 0 ? (
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead className="bg-gray-50 border-b border-gray-200">
                            <tr>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">#</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ticker</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Setup</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mistakes</th>
                                <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Screenshot</th>
                              {!isReadOnly && (
                                <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                              )}
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {[...selectedDateTrades]
                              .sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''))
                              .map((trade, index) => (
                              <tr key={trade.id} className="hover:bg-gray-50">
                                <td className="px-3 py-2 text-sm font-medium text-gray-400">{index + 1}</td>
                                <td className="px-3 py-2 text-sm font-medium text-gray-900">{trade.ticker}</td>
                                <td className="px-3 py-2 text-sm">
                                  <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                    trade.positionType === 'long' 
                                      ? 'bg-emerald-100 text-emerald-700' 
                                      : 'bg-red-100 text-red-700'
                                  }`}>
                                    {trade.positionType.toUpperCase()}
                                  </span>
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600">{trade.positionSize}</td>
                                <td className="px-3 py-2 text-sm">
                                  {trade.derived.isOpen ? (
                                    <span className="text-gray-400">Open</span>
                                  ) : (
                                    <span className={`font-medium ${(trade.derived.pnlFinal || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                      {formatCurrency(trade.derived.pnlFinal)}
                                    </span>
                                  )}
                                </td>
                                <td className="px-3 py-2">
                                  <StarRating value={trade.rating || 0} readonly size="sm" />
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600 max-w-[100px] truncate">
                                  {getSetupName(trade.setupId)}
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600 max-w-[100px] truncate">
                                  {getMistakeNames(trade.mistakeIds)}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {trade.screenshot ? (
                                    <button
                                      onClick={() => {
                                        setImageModalData({ 
                                          src: trade.screenshot, 
                                          title: `${trade.ticker} - ${trade.entryDate}`,
                                          notes: trade.notes,
                                          trade: trade
                                        });
                                        setImageModalOpen(true);
                                      }}
                                      className="inline-flex items-center justify-center w-10 h-10 rounded-lg overflow-hidden border border-gray-200 hover:border-blue-400 hover:ring-2 hover:ring-blue-100 transition-all"
                                    >
                                      <img src={trade.screenshot} alt="Trade screenshot" className="w-full h-full object-cover" />
                                    </button>
                                  ) : (
                                    <span className="text-gray-300 text-xs">‚Äî</span>
                                  )}
                                </td>
                                {!isReadOnly && (
                                  <td className="px-3 py-2 text-right">
                                    <button
                                      onClick={() => openEditModal(trade)}
                                      className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                    >
                                      {Icons.edit}
                                    </button>
                                  </td>
                                )}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="p-8 text-center text-gray-500">
                        <p className="text-sm">No trades logged for this date yet.</p>
                        <p className="text-xs mt-1">Click "Add Trade" above to log your first trade.</p>
                      </div>
                    )}
                  </div>

                  {/* Setups Performance for Selected Date */}
                  {selectedDateStats && selectedDateStats.setupData && selectedDateStats.setupData.length > 0 && (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                        <h3 className="text-sm font-semibold text-gray-900">Setups Used on {selectedDate}</h3>
                      </div>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Setup Pie Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Trade Count</h4>
                            <SimplePieChart data={selectedDateStats.setupData.map(s => ({ label: s.name, value: s.total }))} />
                          </div>
                          {/* Setup Bar Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By P&L</h4>
                            <SimpleBarChart data={selectedDateStats.setupData.sort((a, b) => b.totalPnL - a.totalPnL).map(s => ({ label: s.name, value: s.totalPnL }))} />
                          </div>
                        </div>
                        {/* Setup Details Table */}
                        <div className="mt-4 pt-4 border-t border-gray-100">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-gray-500 uppercase">
                                <th className="pb-2">Setup</th>
                                <th className="pb-2 text-center">Trades</th>
                                <th className="pb-2 text-center">W/L</th>
                                <th className="pb-2 text-center">Win Rate</th>
                                <th className="pb-2 text-right">P&L</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {selectedDateStats.setupData.map(s => (
                                <tr key={s.id}>
                                  <td className="py-2 font-medium text-gray-900">{s.name}</td>
                                  <td className="py-2 text-center text-gray-600">{s.total}</td>
                                  <td className="py-2 text-center">
                                    <span className="text-emerald-600">{s.wins}W</span>
                                    {' / '}
                                    <span className="text-red-600">{s.losses}L</span>
                                  </td>
                                  <td className="py-2 text-center text-gray-600">{s.winRate}%</td>
                                  <td className={`py-2 text-right font-semibold ${s.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {formatCurrency(s.totalPnL)}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Mistakes Analysis for Selected Date */}
                  {selectedDateStats && selectedDateStats.mistakeData && selectedDateStats.mistakeData.length > 0 && (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                        <div className="flex items-center justify-between">
                          <h3 className="text-sm font-semibold text-gray-900">Mistakes on {selectedDate}</h3>
                          <span className="text-xs text-gray-500">Loss amounts only include losing trades</span>
                        </div>
                      </div>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Mistake Pie Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Frequency</h4>
                            <SimplePieChart data={selectedDateStats.mistakeData.map(m => ({ label: m.name, value: m.totalOccurrences }))} />
                          </div>
                          {/* Mistake Loss Bar Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Loss Amount</h4>
                            {(() => {
                              const lossData = selectedDateStats.mistakeData
                                .filter(m => m.totalLossAmount < 0)
                                .sort((a, b) => a.totalLossAmount - b.totalLossAmount)
                                .map(m => ({ label: m.name, value: Math.abs(m.totalLossAmount) }));
                              if (lossData.length === 0) {
                                return <div className="h-24 flex items-center justify-center text-gray-400 text-sm">No losses from mistakes</div>;
                              }
                              const maxVal = Math.max(...lossData.map(d => d.value), 1);
                              return (
                                <div className="space-y-2">
                                  {lossData.map((d, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                      <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
                                      <div className="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                                        <div className="h-full rounded bg-red-500" style={{ width: `${(d.value / maxVal) * 100}%` }} />
                                      </div>
                                      <span className="text-xs font-medium w-16 text-right text-red-600">-{formatCurrencyShort(d.value)}</span>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                          </div>
                        </div>
                        {/* Mistake Details Table */}
                        <div className="mt-4 pt-4 border-t border-gray-100">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-gray-500 uppercase">
                                <th className="pb-2">Mistake</th>
                                <th className="pb-2 text-center">Occurrences</th>
                                <th className="pb-2 text-center">Losing / Profitable</th>
                                <th className="pb-2 text-right">Total Loss</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {selectedDateStats.mistakeData.map(m => (
                                <tr key={m.id}>
                                  <td className="py-2 font-medium text-gray-900">{m.name}</td>
                                  <td className="py-2 text-center text-gray-600">{m.totalOccurrences}x</td>
                                  <td className="py-2 text-center">
                                    <span className="text-red-600">{m.losingTrades}</span>
                                    {' / '}
                                    <span className="text-emerald-600">{m.profitableTrades}</span>
                                  </td>
                                  <td className={`py-2 text-right font-semibold ${m.totalLossAmount < 0 ? 'text-red-600' : 'text-gray-400'}`}>
                                    {m.totalLossAmount < 0 ? formatCurrency(m.totalLossAmount) : '-'}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Trade Modal */}
          <TradeModal
            isOpen={modalOpen}
            onClose={() => setModalOpen(false)}
            trade={editingTrade}
            state={state}
            setState={setState}
          />

          {/* Image Modal */}
          <ImageModal
            isOpen={imageModalOpen}
            onClose={() => setImageModalOpen(false)}
            src={imageModalData.src}
            title={imageModalData.title}
            trade={imageModalData.trade}
            state={state}
            setState={setState}
            getSetupName={getSetupName}
            getMistakeNames={getMistakeNames}
          />
        </div>
      );
    }

    // =============================================================================
    // SETUPS PAGE
    // =============================================================================
    function SetupsPage({ state, setState, isMobile, isReadOnly = false }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingSetup, setEditingSetup] = useState(null);
      const [setupName, setSetupName] = useState('');
      const [setupDescription, setSetupDescription] = useState('');
      const [setupScreenshot, setSetupScreenshot] = useState(null);
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [viewingScreenshot, setViewingScreenshot] = useState(null);
      const [error, setError] = useState('');

      // Calculate setup analytics
      const setupAnalytics = useMemo(() => {
        const analytics = {};
        
        // Initialize all setups
        state.setups.forEach(setup => {
          analytics[setup.id] = {
            id: setup.id,
            name: setup.name,
            description: setup.description || '',
            totalTrades: 0,
            wins: 0,
            losses: 0,
            totalPnL: 0,
            winRate: 0,
            avgPnL: 0,
          };
        });

        // Calculate stats from trades
        state.trades.forEach(trade => {
          if (!trade.setupId || !analytics[trade.setupId]) return;
          
          const derived = calcTradeDerived(trade);
          if (derived.isOpen) return;

          analytics[trade.setupId].totalTrades++;
          analytics[trade.setupId].totalPnL += derived.pnlFinal || 0;
          
          if (derived.winLoss === 'W') analytics[trade.setupId].wins++;
          if (derived.winLoss === 'L') analytics[trade.setupId].losses++;
        });

        // Calculate win rates and avg P&L
        Object.values(analytics).forEach(setup => {
          const totalClosed = setup.wins + setup.losses;
          setup.winRate = totalClosed > 0 ? Math.round((setup.wins / totalClosed) * 100) : 0;
          setup.avgPnL = setup.totalTrades > 0 ? setup.totalPnL / setup.totalTrades : 0;
        });

        return Object.values(analytics);
      }, [state.setups, state.trades]);

      // Charts data
      const pieData = useMemo(() => {
        return setupAnalytics
          .filter(s => s.totalTrades > 0)
          .map(s => ({ label: s.name, value: s.totalTrades }));
      }, [setupAnalytics]);

      const barData = useMemo(() => {
        return setupAnalytics
          .filter(s => s.totalTrades > 0)
          .sort((a, b) => b.totalPnL - a.totalPnL)
          .map(s => ({ label: s.name, value: s.totalPnL }));
      }, [setupAnalytics]);

      // Top lists
      const topByProfit = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalPnL > 0)
          .sort((a, b) => b.totalPnL - a.totalPnL)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByLoss = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalPnL < 0)
          .sort((a, b) => a.totalPnL - b.totalPnL)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByQuantity = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalTrades > 0)
          .sort((a, b) => b.totalTrades - a.totalTrades)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByWinRate = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalTrades >= 3) // Minimum 3 trades for meaningful win rate
          .sort((a, b) => b.winRate - a.winRate)
          .slice(0, 3);
      }, [setupAnalytics]);

      // Check if setup is referenced by trades
      const getTradesUsingSetup = (setupId) => {
        return state.trades.filter(t => t.setupId === setupId);
      };

      // Modal handlers
      const openAddModal = () => {
        setEditingSetup(null);
        setSetupName('');
        setSetupDescription('');
        setSetupScreenshot(null);
        setError('');
        setModalOpen(true);
      };

      const openEditModal = (setup) => {
        setEditingSetup(setup);
        setSetupName(setup.name);
        setSetupDescription(setup.description || '');
        setSetupScreenshot(setup.screenshot || null);
        setError('');
        setModalOpen(true);
      };

      const closeModal = () => {
        setModalOpen(false);
        setEditingSetup(null);
        setSetupName('');
        setSetupDescription('');
        setSetupScreenshot(null);
        setError('');
      };

      const handleSave = () => {
        const trimmedName = setupName.trim();
        
        if (!trimmedName) {
          setError('Setup name is required');
          return;
        }

        // Check for duplicate names
        const duplicate = state.setups.find(s => 
          s.name.toLowerCase() === trimmedName.toLowerCase() && 
          s.id !== editingSetup?.id
        );
        if (duplicate) {
          setError('A setup with this name already exists');
          return;
        }

        if (editingSetup) {
          // Update existing
          setState({
            ...state,
            setups: state.setups.map(s => 
              s.id === editingSetup.id 
                ? { ...s, name: trimmedName, description: setupDescription.trim(), screenshot: setupScreenshot, updatedAt: nowISO() }
                : s
            ),
          });
        } else {
          // Create new
          const newSetup = {
            id: generateId(),
            name: trimmedName,
            description: setupDescription.trim(),
            screenshot: setupScreenshot,
            rules: [],
            createdAt: nowISO(),
            updatedAt: nowISO(),
          };
          setState({
            ...state,
            setups: [...state.setups, newSetup],
          });
        }

        closeModal();
      };

      const handleDelete = (setupId, nullifyTrades = false) => {
        if (nullifyTrades) {
          // Remove setup reference from all trades
          setState({
            ...state,
            setups: state.setups.filter(s => s.id !== setupId),
            trades: state.trades.map(t => 
              t.setupId === setupId ? { ...t, setupId: null } : t
            ),
          });
        } else {
          // Just delete the setup
          setState({
            ...state,
            setups: state.setups.filter(s => s.id !== setupId),
          });
        }
        setDeleteConfirm(null);
      };

      const initiateDelete = (setup) => {
        const tradesUsing = getTradesUsingSetup(setup.id);
        if (tradesUsing.length > 0) {
          setDeleteConfirm({ setup, tradesCount: tradesUsing.length });
        } else {
          handleDelete(setup.id);
        }
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Setups</h1>
              <p className="text-sm text-gray-500 mt-1">{state.setups.length} setups defined</p>
            </div>
            {!isReadOnly && (
              <button
                onClick={openAddModal}
                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                {Icons.plus}
                <span>Add Setup</span>
              </button>
            )}
          </div>

          {/* Analytics Section */}
          {setupAnalytics.some(s => s.totalTrades > 0) && (
            <>
              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Pie Chart - Setups by Quantity */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Setups by Trade Count</h3>
                  <SimplePieChart data={pieData} />
                </div>

                {/* Bar Chart - Setups by P&L */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Setups by Total P&L</h3>
                  <SimpleBarChart data={barData} />
                </div>
              </div>

              {/* Top Lists */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {/* Top by Profit */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
                      {Icons.trendUp}
                    </div>
                    <h4 className="font-semibold text-gray-900">Top Profit</h4>
                  </div>
                  {topByProfit.length > 0 ? (
                    <div className="space-y-2">
                      {topByProfit.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-emerald-600">{formatCurrency(s.totalPnL)}</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No profitable setups yet</p>
                  )}
                </div>

                {/* Top by Loss */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-red-100 rounded-lg text-red-600">
                      {Icons.trendDown}
                    </div>
                    <h4 className="font-semibold text-gray-900">Worst Loss</h4>
                  </div>
                  {topByLoss.length > 0 ? (
                    <div className="space-y-2">
                      {topByLoss.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-red-600">{formatCurrency(s.totalPnL)}</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No losing setups yet</p>
                  )}
                </div>

                {/* Top by Quantity */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-blue-100 rounded-lg text-blue-600">
                      {Icons.tradelog}
                    </div>
                    <h4 className="font-semibold text-gray-900">Most Used</h4>
                  </div>
                  {topByQuantity.length > 0 ? (
                    <div className="space-y-2">
                      {topByQuantity.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-blue-600">{s.totalTrades} trades</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No trades with setups yet</p>
                  )}
                </div>

                {/* Top by Win Rate */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-amber-100 rounded-lg text-amber-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                      </svg>
                    </div>
                    <h4 className="font-semibold text-gray-900">Best Win Rate</h4>
                  </div>
                  {topByWinRate.length > 0 ? (
                    <div className="space-y-2">
                      {topByWinRate.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-amber-600">{s.winRate}%</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">Need 3+ trades per setup</p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Setups List */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">All Setups</h3>
            </div>
            
            {state.setups.length === 0 ? (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.setups}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No setups defined</h3>
                <p className="text-gray-500 mb-4">Create setups to categorize and analyze your trading strategies</p>
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Setup</span>
                </button>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {setupAnalytics.map(setup => {
                  const maxPnL = Math.max(...setupAnalytics.map(s => Math.abs(s.totalPnL)), 1);
                  const pnlBarWidth = (Math.abs(setup.totalPnL) / maxPnL) * 100;
                  const winPercent = setup.wins + setup.losses > 0 ? (setup.wins / (setup.wins + setup.losses)) * 100 : 0;
                  const fullSetup = state.setups.find(s => s.id === setup.id);
                  
                  return (
                    <div key={setup.id} className="px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div className="flex items-center justify-between gap-4">
                        {/* Left: Screenshot thumbnail + Name & Description */}
                        <div className="flex items-center gap-3 flex-shrink-0 w-56">
                          {fullSetup?.screenshot ? (
                            <img 
                              src={fullSetup.screenshot} 
                              alt={setup.name}
                              onClick={() => setViewingScreenshot(fullSetup.screenshot)}
                              className="w-12 h-12 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80 transition-opacity"
                            />
                          ) : (
                            <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400">
                              <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="1.5">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                              </svg>
                            </div>
                          )}
                          <div className="min-w-0">
                            <h4 className="font-medium text-gray-900">{setup.name}</h4>
                            {setup.description && (
                              <p className="text-xs text-gray-500 mt-0.5 truncate">{setup.description}</p>
                            )}
                          </div>
                        </div>
                        
                        {/* Middle: Stats & Bars */}
                        {setup.totalTrades > 0 ? (
                          <div className="flex-1 flex items-center gap-6">
                            {/* Trades & P&L */}
                            <div className="flex items-center gap-3 text-xs">
                              <span className="text-gray-600 font-medium whitespace-nowrap">
                                {setup.totalTrades} trades
                              </span>
                              <div className="flex items-center gap-1.5">
                                <span className={`font-semibold whitespace-nowrap ${setup.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                  {formatCurrency(setup.totalPnL)}
                                </span>
                                <div className="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full rounded-full ${setup.totalPnL >= 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                                    style={{ width: `${pnlBarWidth}%` }}
                                  />
                                </div>
                              </div>
                            </div>
                            
                            {/* Win Rate with integrated bar */}
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-emerald-600 font-medium w-6 text-right">{setup.wins}W</span>
                              <div className="w-24 h-2 bg-red-200 rounded-full overflow-hidden">
                                <div 
                                  className="h-full bg-emerald-500 rounded-full"
                                  style={{ width: `${winPercent}%` }}
                                />
                              </div>
                              <span className="text-xs text-red-600 font-medium w-6">{setup.losses}L</span>
                              <span className="text-xs text-gray-500 font-medium w-10">{setup.winRate}%</span>
                            </div>
                          </div>
                        ) : (
                          <div className="flex-1">
                            <span className="text-xs text-gray-400">No trades yet</span>
                          </div>
                        )}
                        
                        {/* Right: Actions */}
                        {!isReadOnly && (
                          <div className="flex items-center gap-1 flex-shrink-0">
                            <button
                              onClick={() => openEditModal(state.setups.find(s => s.id === setup.id))}
                              className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                              title="Edit setup"
                            >
                              {Icons.edit}
                            </button>
                            <button
                              onClick={() => initiateDelete(state.setups.find(s => s.id === setup.id))}
                              className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              title="Delete setup"
                            >
                              {Icons.trash}
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Add/Edit Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={closeModal} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">
                      {editingSetup ? 'Edit Setup' : 'Add Setup'}
                    </h2>
                  </div>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Name <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={setupName}
                        onChange={(e) => {
                          setSetupName(e.target.value);
                          setError('');
                        }}
                        placeholder="e.g., Breakout, Mean Reversion, Gap Fill"
                        className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          error ? 'border-red-500' : 'border-gray-300'
                        }`}
                        autoFocus
                      />
                      {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Description
                      </label>
                      <textarea
                        value={setupDescription}
                        onChange={(e) => setSetupDescription(e.target.value)}
                        placeholder="Describe the setup criteria, entry/exit rules..."
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Example Screenshot
                      </label>
                      {setupScreenshot ? (
                        <div className="relative">
                          <img 
                            src={setupScreenshot} 
                            alt="Setup example" 
                            className="w-full h-40 object-cover rounded-lg border border-gray-200"
                          />
                          <button
                            onClick={() => setSetupScreenshot(null)}
                            className="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-colors"
                          >
                            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      ) : (
                        <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-colors">
                          <svg className="w-8 h-8 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                          <span className="text-sm text-gray-500">Click to upload example chart</span>
                          <input
                            type="file"
                            accept="image/*"
                            className="hidden"
                            onChange={async (e) => {
                              const file = e.target.files?.[0];
                              if (!file) return;
                              
                              const compressImage = (file, maxWidth = 800, quality = 0.7) => {
                                return new Promise((resolve) => {
                                  const reader = new FileReader();
                                  reader.onload = (e) => {
                                    const img = new Image();
                                    img.onload = () => {
                                      const canvas = document.createElement('canvas');
                                      const ratio = Math.min(maxWidth / img.width, 1);
                                      canvas.width = img.width * ratio;
                                      canvas.height = img.height * ratio;
                                      const ctx = canvas.getContext('2d');
                                      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                      resolve(canvas.toDataURL('image/jpeg', quality));
                                    };
                                    img.src = e.target.result;
                                  };
                                  reader.readAsDataURL(file);
                                });
                              };
                              
                              try {
                                const compressed = await compressImage(file);
                                setSetupScreenshot(compressed);
                              } catch (err) {
                                console.error('Failed to process image:', err);
                              }
                            }}
                          />
                        </label>
                      )}
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 rounded-b-xl">
                    <button
                      onClick={closeModal}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      {editingSetup ? 'Save Changes' : 'Add Setup'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deleteConfirm && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setDeleteConfirm(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">Delete Setup</h2>
                  </div>
                  <div className="p-6">
                    <div className="flex items-start gap-4">
                      <div className="p-3 bg-red-100 rounded-full text-red-600 flex-shrink-0">
                        {Icons.warning}
                      </div>
                      <div>
                        <p className="text-gray-900 font-medium">
                          Delete "{deleteConfirm.setup.name}"?
                        </p>
                        <p className="text-gray-500 text-sm mt-2">
                          This setup is linked to <span className="font-semibold text-gray-700">{deleteConfirm.tradesCount} trade{deleteConfirm.tradesCount !== 1 ? 's' : ''}</span>.
                        </p>
                        <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <p className="text-amber-800 text-sm font-medium">‚ö†Ô∏è This action cannot be undone</p>
                          <p className="text-amber-700 text-xs mt-1">
                            The setup will be removed from all linked trades. Your trade data (P&L, dates, etc.) will remain intact, but the setup association will be lost.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col gap-2 rounded-b-xl">
                    <button
                      onClick={() => handleDelete(deleteConfirm.setup.id, true)}
                      className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                    >
                      Delete Setup
                    </button>
                    <button
                      onClick={() => setDeleteConfirm(null)}
                      className="w-full px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Screenshot Viewing Modal */}
          {viewingScreenshot && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/80" onClick={() => setViewingScreenshot(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative max-w-4xl w-full">
                  <button
                    onClick={() => setViewingScreenshot(null)}
                    className="absolute -top-10 right-0 p-2 text-white hover:text-gray-300 transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                  <img 
                    src={viewingScreenshot} 
                    alt="Setup example" 
                    className="w-full rounded-lg shadow-2xl"
                  />
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // MISTAKES PAGE
    // =============================================================================
    function MistakesPage({ state, setState, isMobile, isReadOnly = false }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingMistake, setEditingMistake] = useState(null);
      const [mistakeName, setMistakeName] = useState('');
      const [mistakeDescription, setMistakeDescription] = useState('');
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [error, setError] = useState('');

      // Calculate mistake analytics
      // CRITICAL RULE: Only count LOSSES (negative P&L) towards mistake cost
      // Profitable trades with mistakes do NOT reduce the mistake's loss amount
      const mistakeAnalytics = useMemo(() => {
        const analytics = {};
        
        // Initialize all mistakes
        state.mistakes.forEach(mistake => {
          analytics[mistake.id] = {
            id: mistake.id,
            name: mistake.name,
            description: mistake.description || '',
            totalOccurrences: 0,      // Count of trades tagged with this mistake
            losingTrades: 0,          // Count of losing trades with this mistake
            profitableTrades: 0,      // Count of profitable trades (mistake didn't cost us)
            totalLossAmount: 0,       // Sum of ONLY negative P&L (losses)
            avgLossPerOccurrence: 0,  // Average loss when this mistake occurs
          };
        });

        // Calculate stats from trades
        state.trades.forEach(trade => {
          if (!trade.mistakeIds || trade.mistakeIds.length === 0) return;
          
          const derived = calcTradeDerived(trade);
          if (derived.isOpen) return;

          const pnl = derived.pnlFinal || 0;

          // For each mistake tagged on this trade
          trade.mistakeIds.forEach(mistakeId => {
            if (!analytics[mistakeId]) return;
            
            analytics[mistakeId].totalOccurrences++;
            
            // ONLY count losses towards the mistake's cost
            if (pnl < 0) {
              analytics[mistakeId].losingTrades++;
              analytics[mistakeId].totalLossAmount += pnl; // pnl is negative, so this sums negatives
            } else {
              analytics[mistakeId].profitableTrades++;
            }
          });
        });

        // Calculate averages
        Object.values(analytics).forEach(mistake => {
          if (mistake.losingTrades > 0) {
            mistake.avgLossPerOccurrence = mistake.totalLossAmount / mistake.losingTrades;
          }
        });

        return Object.values(analytics);
      }, [state.mistakes, state.trades]);

      // Charts data
      const pieData = useMemo(() => {
        return mistakeAnalytics
          .filter(m => m.totalOccurrences > 0)
          .sort((a, b) => b.totalOccurrences - a.totalOccurrences)
          .map(m => ({ label: m.name, value: m.totalOccurrences }));
      }, [mistakeAnalytics]);

      // Bar chart: Loss amount (worst to least) - only show mistakes with losses
      const barData = useMemo(() => {
        return mistakeAnalytics
          .filter(m => m.totalLossAmount < 0) // Only mistakes that caused losses
          .sort((a, b) => a.totalLossAmount - b.totalLossAmount) // Most negative first (worst)
          .map(m => ({ 
            label: m.name, 
            value: Math.abs(m.totalLossAmount) // Show as positive for display, but it represents loss
          }));
      }, [mistakeAnalytics]);

      // Top lists
      const mostFrequent = useMemo(() => {
        return [...mistakeAnalytics]
          .filter(m => m.totalOccurrences > 0)
          .sort((a, b) => b.totalOccurrences - a.totalOccurrences)
          .slice(0, 3);
      }, [mistakeAnalytics]);

      const mostCostly = useMemo(() => {
        return [...mistakeAnalytics]
          .filter(m => m.totalLossAmount < 0)
          .sort((a, b) => a.totalLossAmount - b.totalLossAmount) // Most negative first
          .slice(0, 3);
      }, [mistakeAnalytics]);

      // Check if mistake is referenced by trades
      const getTradesUsingMistake = (mistakeId) => {
        return state.trades.filter(t => t.mistakeIds && t.mistakeIds.includes(mistakeId));
      };

      // Modal handlers
      const openAddModal = () => {
        setEditingMistake(null);
        setMistakeName('');
        setMistakeDescription('');
        setError('');
        setModalOpen(true);
      };

      const openEditModal = (mistake) => {
        setEditingMistake(mistake);
        setMistakeName(mistake.name);
        setMistakeDescription(mistake.description || '');
        setError('');
        setModalOpen(true);
      };

      const closeModal = () => {
        setModalOpen(false);
        setEditingMistake(null);
        setMistakeName('');
        setMistakeDescription('');
        setError('');
      };

      const handleSave = () => {
        const trimmedName = mistakeName.trim();
        
        if (!trimmedName) {
          setError('Mistake name is required');
          return;
        }

        // Check for duplicate names
        const duplicate = state.mistakes.find(m => 
          m.name.toLowerCase() === trimmedName.toLowerCase() && 
          m.id !== editingMistake?.id
        );
        if (duplicate) {
          setError('A mistake with this name already exists');
          return;
        }

        if (editingMistake) {
          // Update existing
          setState({
            ...state,
            mistakes: state.mistakes.map(m => 
              m.id === editingMistake.id 
                ? { ...m, name: trimmedName, description: mistakeDescription.trim(), updatedAt: nowISO() }
                : m
            ),
          });
        } else {
          // Create new
          const newMistake = {
            id: generateId(),
            name: trimmedName,
            description: mistakeDescription.trim(),
            createdAt: nowISO(),
            updatedAt: nowISO(),
          };
          setState({
            ...state,
            mistakes: [...state.mistakes, newMistake],
          });
        }

        closeModal();
      };

      const handleDelete = (mistakeId, removeFromTrades = false) => {
        if (removeFromTrades) {
          // Remove mistake reference from all trades
          setState({
            ...state,
            mistakes: state.mistakes.filter(m => m.id !== mistakeId),
            trades: state.trades.map(t => ({
              ...t,
              mistakeIds: t.mistakeIds ? t.mistakeIds.filter(id => id !== mistakeId) : [],
            })),
          });
        } else {
          // Just delete the mistake
          setState({
            ...state,
            mistakes: state.mistakes.filter(m => m.id !== mistakeId),
          });
        }
        setDeleteConfirm(null);
      };

      const initiateDelete = (mistake) => {
        const tradesUsing = getTradesUsingMistake(mistake.id);
        if (tradesUsing.length > 0) {
          setDeleteConfirm({ mistake, tradesCount: tradesUsing.length });
        } else {
          handleDelete(mistake.id);
        }
      };

      // Custom bar chart for losses (shows in red)
      const LossBarChart = ({ data }) => {
        if (!data || data.length === 0) {
          return (
            <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
              No loss data
            </div>
          );
        }

        const maxVal = Math.max(...data.map(d => d.value), 1);

        return (
          <div className="space-y-2">
            {data.map((d, i) => (
              <div key={i} className="flex items-center gap-2">
                <span className="text-xs text-gray-600 w-24 truncate" title={d.label}>{d.label}</span>
                <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                  <div
                    className="h-full rounded bg-red-500"
                    style={{ width: `${(d.value / maxVal) * 100}%` }}
                  />
                </div>
                <span className="text-xs font-medium w-20 text-right text-red-600">
                  -${d.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </span>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Mistakes</h1>
              <p className="text-sm text-gray-500 mt-1">{state.mistakes.length} mistake types defined</p>
            </div>
            {!isReadOnly && (
              <button
                onClick={openAddModal}
                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                {Icons.plus}
                <span>Add Mistake</span>
              </button>
            )}
          </div>

          {/* Info Banner */}
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div className="flex gap-3">
              <div className="text-amber-600">{Icons.warning}</div>
              <div>
                <p className="text-sm font-medium text-amber-800">Loss Amount Calculation Rule</p>
                <p className="text-xs text-amber-700 mt-1">
                  Only <strong>losing trades</strong> contribute to a mistake's total loss amount. 
                  Profitable trades tagged with a mistake are counted in occurrences but do not reduce the loss total.
                </p>
              </div>
            </div>
          </div>

          {/* Analytics Section */}
          {mistakeAnalytics.some(m => m.totalOccurrences > 0) && (
            <>
              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Pie Chart - Mistakes by Occurrence */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-1">Mistakes by Frequency</h3>
                  <p className="text-xs text-gray-500 mb-4">Number of trades tagged with each mistake</p>
                  <SimplePieChart data={pieData} />
                </div>

                {/* Bar Chart - Mistakes by Loss Amount */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-1">Mistakes by Loss Amount</h3>
                  <p className="text-xs text-gray-500 mb-4">Total losses from trades with each mistake (losses only)</p>
                  <LossBarChart data={barData} />
                </div>
              </div>

              {/* Top Lists */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Most Frequent */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-2 bg-amber-100 rounded-lg text-amber-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                        <path d="M12 8v4M12 16h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <h4 className="font-semibold text-gray-900">Most Frequent Mistakes</h4>
                      <p className="text-xs text-gray-500">Mistakes you make most often</p>
                    </div>
                  </div>
                  {mostFrequent.length > 0 ? (
                    <div className="space-y-3">
                      {mostFrequent.map((m, i) => (
                        <div key={m.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                              i === 0 ? 'bg-amber-500 text-white' : 
                              i === 1 ? 'bg-gray-400 text-white' : 
                              'bg-amber-200 text-amber-800'
                            }`}>
                              {i + 1}
                            </span>
                            <span className="font-medium text-gray-700">{m.name}</span>
                          </div>
                          <div className="text-right">
                            <span className="text-sm font-semibold text-gray-900">{m.totalOccurrences}x</span>
                            <p className="text-xs text-gray-500">{m.losingTrades} losses, {m.profitableTrades} wins</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic text-center py-4">No mistakes logged yet</p>
                  )}
                </div>

                {/* Most Costly */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-2 bg-red-100 rounded-lg text-red-600">
                      {Icons.trendDown}
                    </div>
                    <div>
                      <h4 className="font-semibold text-gray-900">Most Costly Mistakes</h4>
                      <p className="text-xs text-gray-500">Mistakes costing you the most money</p>
                    </div>
                  </div>
                  {mostCostly.length > 0 ? (
                    <div className="space-y-3">
                      {mostCostly.map((m, i) => (
                        <div key={m.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                              i === 0 ? 'bg-red-500 text-white' : 
                              i === 1 ? 'bg-red-400 text-white' : 
                              'bg-red-200 text-red-800'
                            }`}>
                              {i + 1}
                            </span>
                            <span className="font-medium text-gray-700">{m.name}</span>
                          </div>
                          <div className="text-right">
                            <span className="text-sm font-bold text-red-600">{formatCurrency(m.totalLossAmount)}</span>
                            <p className="text-xs text-gray-500">Avg: {formatCurrency(m.avgLossPerOccurrence)}/loss</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic text-center py-4">No losing trades with mistakes yet</p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Mistakes List */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">All Mistake Types</h3>
            </div>
            
            {state.mistakes.length === 0 ? (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.mistakes}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No mistake types defined</h3>
                <p className="text-gray-500 mb-4">Create mistake types to track and analyze your trading errors</p>
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Mistake Type</span>
                </button>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {mistakeAnalytics.map(mistake => {
                  // Calculate importance score (0-3) based on total loss amount
                  const maxLoss = Math.max(...mistakeAnalytics.map(m => Math.abs(m.totalLossAmount)), 1);
                  const lossRatio = Math.abs(mistake.totalLossAmount) / maxLoss;
                  const importance = mistake.totalLossAmount >= 0 ? 0 : 
                    lossRatio >= 0.7 ? 3 : 
                    lossRatio >= 0.4 ? 2 : 
                    lossRatio > 0 ? 1 : 0;
                  
                  return (
                    <div key={mistake.id} className="px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div className="flex items-center justify-between gap-4">
                        {/* Left: Importance & Name */}
                        <div className="flex items-center gap-3 flex-shrink-0 w-56">
                          {/* Importance Indicator - 3 bars */}
                          <div className="flex items-end gap-0.5" title={`Priority: ${importance === 3 ? 'Critical' : importance === 2 ? 'High' : importance === 1 ? 'Medium' : 'Low'}`}>
                            {[0, 1, 2].map(i => (
                              <div 
                                key={i} 
                                className={`w-1.5 rounded-sm ${i < importance ? (importance === 3 ? 'bg-red-500' : importance === 2 ? 'bg-orange-500' : 'bg-amber-400') : 'bg-gray-200'}`}
                                style={{ height: `${8 + (i * 4)}px` }}
                              />
                            ))}
                          </div>
                          <div className="min-w-0">
                            <h4 className="font-medium text-gray-900 truncate">{mistake.name}</h4>
                            {mistake.description && (
                              <p className="text-xs text-gray-500 mt-0.5 truncate">{mistake.description}</p>
                            )}
                          </div>
                        </div>
                        
                        {/* Middle: Stats */}
                        {mistake.totalOccurrences > 0 ? (
                          <div className="flex-1 flex items-center gap-8 text-xs">
                            {/* Occurrences */}
                            <div className="text-center min-w-[60px]">
                              <p className="text-lg font-bold text-gray-900">{mistake.totalOccurrences}</p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">times</p>
                            </div>
                            
                            {/* Total Cost */}
                            <div className="text-center min-w-[80px]">
                              <p className={`text-lg font-bold ${mistake.totalLossAmount < 0 ? 'text-red-600' : 'text-gray-400'}`}>
                                {mistake.totalLossAmount < 0 ? formatCurrencyShort(mistake.totalLossAmount) : '$0'}
                              </p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">total cost</p>
                            </div>
                            
                            {/* Avg Loss */}
                            <div className="text-center min-w-[80px]">
                              <p className={`text-lg font-bold ${mistake.avgLossPerOccurrence < 0 ? 'text-orange-600' : 'text-gray-400'}`}>
                                {mistake.avgLossPerOccurrence < 0 ? formatCurrencyShort(mistake.avgLossPerOccurrence) : '$0'}
                              </p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">avg/loss</p>
                            </div>
                          </div>
                        ) : (
                          <div className="flex-1">
                            <span className="text-xs text-gray-400">No occurrences yet</span>
                          </div>
                        )}
                        
                        {/* Right: Actions */}
                        {!isReadOnly && (
                          <div className="flex items-center gap-1 flex-shrink-0">
                            <button
                              onClick={() => openEditModal(state.mistakes.find(m => m.id === mistake.id))}
                              className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                              title="Edit mistake"
                            >
                              {Icons.edit}
                            </button>
                            <button
                              onClick={() => initiateDelete(state.mistakes.find(m => m.id === mistake.id))}
                              className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              title="Delete mistake"
                            >
                              {Icons.trash}
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Add/Edit Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={closeModal} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">
                      {editingMistake ? 'Edit Mistake' : 'Add Mistake Type'}
                    </h2>
                  </div>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Name <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={mistakeName}
                        onChange={(e) => {
                          setMistakeName(e.target.value);
                          setError('');
                        }}
                        placeholder="e.g., FOMO, Overtrading, Moved Stop Loss"
                        className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          error ? 'border-red-500' : 'border-gray-300'
                        }`}
                        autoFocus
                      />
                      {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Description
                      </label>
                      <textarea
                        value={mistakeDescription}
                        onChange={(e) => setMistakeDescription(e.target.value)}
                        placeholder="Describe what this mistake looks like, how to avoid it..."
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                      />
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 rounded-b-xl">
                    <button
                      onClick={closeModal}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      {editingMistake ? 'Save Changes' : 'Add Mistake'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deleteConfirm && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setDeleteConfirm(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">Delete Mistake Type</h2>
                  </div>
                  <div className="p-6">
                    <div className="flex items-start gap-4">
                      <div className="p-3 bg-red-100 rounded-full text-red-600 flex-shrink-0">
                        {Icons.warning}
                      </div>
                      <div>
                        <p className="text-gray-900 font-medium">
                          Delete "{deleteConfirm.mistake.name}"?
                        </p>
                        <p className="text-gray-500 text-sm mt-2">
                          This mistake is tagged on <span className="font-semibold text-gray-700">{deleteConfirm.tradesCount} trade{deleteConfirm.tradesCount !== 1 ? 's' : ''}</span>.
                        </p>
                        <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <p className="text-amber-800 text-sm font-medium">‚ö†Ô∏è This action cannot be undone</p>
                          <p className="text-amber-700 text-xs mt-1">
                            The mistake tag will be removed from all linked trades. Your trade data (P&L, dates, etc.) will remain intact, but the mistake association will be lost.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col gap-2 rounded-b-xl">
                    <button
                      onClick={() => handleDelete(deleteConfirm.mistake.id, true)}
                      className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                    >
                      Delete Mistake
                    </button>
                    <button
                      onClick={() => setDeleteConfirm(null)}
                      className="w-full px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // GOALS PAGE
    // =============================================================================
    function GoalsPage({ state, setState, isMobile, isReadOnly = false }) {
      const [yearlyGoalModalOpen, setYearlyGoalModalOpen] = useState(false);
      const [yearlyGoalInput, setYearlyGoalInput] = useState('');
      const [challengeModalOpen, setChallengeModalOpen] = useState(false);
      const [challengeTab, setChallengeTab] = useState('tried'); // 'tried' or 'custom'
      const [selectedTemplate, setSelectedTemplate] = useState(null);
      const [customChallenge, setCustomChallenge] = useState({
        metricType: 'profit',
        condition: 'by_date',
        value: '',
        timeValue: '',
        endDate: '',
      });
      const [templateValues, setTemplateValues] = useState({});
      const [error, setError] = useState('');

      const TRADING_DAYS_PER_YEAR = 252;
      const currentYear = new Date().getFullYear();

      // Challenge templates
      const CHALLENGE_TEMPLATES = {
        profit: [
          { id: 'profit_by_date', name: 'Make ${amount} by {date}', defaults: { amount: 5000, date: '' }, type: 'profit', condition: 'by_date' },
          { id: 'profit_in_trades', name: 'Make ${amount} in only {trades} trades', defaults: { amount: 5000, trades: 10 }, type: 'profit', condition: 'in_trades' },
          { id: 'profit_streak', name: 'Make ${amount} for {days} days in a row', defaults: { amount: 1000, days: 5 }, type: 'profit', condition: 'streak_days' },
          { id: 'profit_single_day', name: 'Make ${amount} in a single day', defaults: { amount: 2000 }, type: 'profit', condition: 'single_day' },
          { id: 'profit_single_trade', name: 'Make ${amount} in a single trade', defaults: { amount: 1000 }, type: 'profit', condition: 'single_trade' },
        ],
        consistency: [
          { id: 'profitable_streak', name: 'Be profitable {days} days in a row', defaults: { days: 5 }, type: 'consistency', condition: 'profitable_days' },
          { id: 'trade_streak', name: 'Trade {days} days in a row', defaults: { days: 10 }, type: 'consistency', condition: 'trading_days' },
          { id: 'win_rate', name: 'Stay above {percent}% win rate for {trades} trades', defaults: { percent: 60, trades: 20 }, type: 'consistency', condition: 'win_rate' },
        ],
        risk: [
          { id: 'max_loss_per_trade', name: 'No losses greater than ${amount} for {days} days', defaults: { amount: 500, days: 5 }, type: 'risk', condition: 'max_loss_days' },
          { id: 'max_daily_loss', name: 'Keep max daily loss under ${amount} for {days} days', defaults: { amount: 1000, days: 10 }, type: 'risk', condition: 'daily_loss_limit' },
          { id: 'no_mistakes', name: 'Complete {trades} trades with no mistakes tagged', defaults: { trades: 10 }, type: 'risk', condition: 'no_mistakes' },
        ],
        volume: [
          { id: 'trades_by_date', name: 'Complete {trades} trades by {date}', defaults: { trades: 20, date: '' }, type: 'volume', condition: 'trades_by_date' },
          { id: 'trade_every_day', name: 'Trade every market day for {weeks} weeks', defaults: { weeks: 2 }, type: 'volume', condition: 'consecutive_weeks' },
        ],
      };

      // Calculate yearly goal progress
      const yearlyGoalProgress = useMemo(() => {
        const goal = state.yearlyGoal;
        if (!goal || goal.year !== currentYear) return null;

        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        const yearPnL = state.trades
          .filter(t => {
            const derived = calcTradeDerived(t);
            if (derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .reduce((sum, t) => sum + (calcTradeDerived(t).pnlFinal || 0), 0);

        const progress = goal.target > 0 ? (yearPnL / goal.target) * 100 : 0;
        const isComplete = yearPnL >= goal.target;

        // Calculate days remaining
        const now = new Date();
        const endOfYear = new Date(currentYear, 11, 31);
        const calendarDaysRemaining = Math.ceil((endOfYear - now) / (1000 * 60 * 60 * 24));
        
        // Estimate trading days remaining (roughly 252/365 ratio)
        const tradingDaysRemaining = Math.round(calendarDaysRemaining * (TRADING_DAYS_PER_YEAR / 365));

        // Extrapolated targets
        const dailyTarget = goal.target / TRADING_DAYS_PER_YEAR;
        const weeklyTarget = goal.target / 52;
        const monthlyTarget = goal.target / 12;
        const quarterlyTarget = goal.target / 4;

        return {
          goal,
          yearPnL,
          progress: Math.min(progress, 100),
          progressRaw: progress,
          isComplete,
          remaining: goal.target - yearPnL,
          calendarDaysRemaining,
          tradingDaysRemaining,
          dailyTarget,
          weeklyTarget,
          monthlyTarget,
          quarterlyTarget,
        };
      }, [state.yearlyGoal, state.trades, currentYear]);

      // Calculate challenge progress
      const challengesWithProgress = useMemo(() => {
        return (state.challenges || []).map(challenge => {
          let currentValue = 0;
          let targetValue = challenge.targetValue;
          let progress = 0;
          let isComplete = false;
          let isFailed = false;
          let statusText = 'In Progress';

          const now = new Date();
          const trades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) })).filter(t => !t.derived.isOpen);

          // Filter trades based on challenge start date
          const challengeTrades = trades.filter(t => {
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= challenge.startDate;
          });

          switch (challenge.condition) {
            case 'by_date': {
              currentValue = challengeTrades
                .filter(t => (t.exitDate || t.entryDate) <= challenge.endDate)
                .reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = currentValue >= targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'in_trades': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              currentValue = limitedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = currentValue >= targetValue && limitedTrades.length <= challenge.tradeLimit;
              isFailed = challengeTrades.length >= challenge.tradeLimit && currentValue < targetValue;
              break;
            }
            case 'streak_days': {
              // Check for consecutive profitable days
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              sortedDays.forEach(([date, pnl]) => {
                if (pnl >= targetValue) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'single_day': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              currentValue = Math.max(0, ...Object.values(dailyPnL));
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'single_trade': {
              currentValue = Math.max(0, ...challengeTrades.map(t => t.derived.pnlFinal || 0));
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'profitable_days': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              sortedDays.forEach(([date, pnl]) => {
                if (pnl > 0) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'trading_days': {
              const tradingDays = new Set(challengeTrades.map(t => t.exitDate || t.entryDate));
              // Check consecutive days
              const sortedDays = [...tradingDays].sort();
              let maxStreak = 0, currentStreak = 0, lastDate = null;
              sortedDays.forEach(date => {
                if (lastDate) {
                  const diff = (new Date(date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
                  if (diff === 1 || (diff <= 3 && isWeekend(lastDate))) { // Allow weekends
                    currentStreak++;
                  } else {
                    currentStreak = 1;
                  }
                } else {
                  currentStreak = 1;
                }
                maxStreak = Math.max(maxStreak, currentStreak);
                lastDate = date;
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'win_rate': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              const wins = limitedTrades.filter(t => t.derived.winLoss === 'W').length;
              currentValue = limitedTrades.length > 0 ? (wins / limitedTrades.length) * 100 : 0;
              targetValue = challenge.targetPercent;
              isComplete = limitedTrades.length >= challenge.tradeLimit && currentValue >= targetValue;
              isFailed = limitedTrades.length >= challenge.tradeLimit && currentValue < targetValue;
              break;
            }
            case 'max_loss_days': {
              const dailyMaxLoss = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                const loss = t.derived.pnlFinal < 0 ? Math.abs(t.derived.pnlFinal) : 0;
                dailyMaxLoss[date] = Math.max(dailyMaxLoss[date] || 0, loss);
              });
              const sortedDays = Object.entries(dailyMaxLoss).sort((a, b) => a[0].localeCompare(b[0]));
              let streak = 0;
              for (const [date, maxLoss] of sortedDays) {
                if (maxLoss <= challenge.maxLossAmount) {
                  streak++;
                } else {
                  streak = 0;
                }
              }
              currentValue = streak;
              targetValue = challenge.streakDays;
              isComplete = streak >= challenge.streakDays;
              break;
            }
            case 'daily_loss_limit': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let streak = 0;
              for (const [date, pnl] of sortedDays) {
                if (pnl >= -challenge.maxLossAmount) {
                  streak++;
                } else {
                  streak = 0;
                }
              }
              currentValue = streak;
              targetValue = challenge.streakDays;
              isComplete = streak >= challenge.streakDays;
              break;
            }
            case 'no_mistakes': {
              const cleanTrades = challengeTrades.filter(t => !t.mistakeIds || t.mistakeIds.length === 0);
              currentValue = cleanTrades.length;
              targetValue = challenge.tradeLimit;
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'trades_by_date': {
              currentValue = challengeTrades.filter(t => (t.exitDate || t.entryDate) <= challenge.endDate).length;
              targetValue = challenge.tradeLimit;
              isComplete = currentValue >= targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'consecutive_weeks': {
              // Simplified: count weeks with at least one trade
              const weeksWithTrades = new Set();
              challengeTrades.forEach(t => {
                const date = new Date(t.exitDate || t.entryDate);
                const weekNum = Math.floor((date - new Date(currentYear, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                weeksWithTrades.add(weekNum);
              });
              currentValue = weeksWithTrades.size;
              targetValue = challenge.targetWeeks;
              isComplete = currentValue >= targetValue;
              break;
            }
          }

          progress = targetValue > 0 ? Math.min((currentValue / targetValue) * 100, 100) : 0;
          
          if (isComplete) {
            statusText = 'Completed';
          } else if (isFailed) {
            statusText = 'Failed';
          } else if (progress >= 75) {
            statusText = 'Almost There!';
          } else if (progress >= 50) {
            statusText = 'Halfway';
          }

          return {
            ...challenge,
            currentValue,
            targetValue,
            progress,
            isComplete,
            isFailed,
            statusText,
          };
        });
      }, [state.challenges, state.trades, currentYear]);

      // Helper function to check if date is weekend
      const isWeekend = (dateStr) => {
        const day = new Date(dateStr).getDay();
        return day === 0 || day === 6;
      };

      // Active and completed challenges
      const activeChallenges = challengesWithProgress.filter(c => !c.isComplete && !c.isFailed);
      const completedChallenges = challengesWithProgress.filter(c => c.isComplete);
      const failedChallenges = challengesWithProgress.filter(c => c.isFailed);

      // Save yearly goal
      const saveYearlyGoal = () => {
        const target = parseFloat(yearlyGoalInput);
        if (isNaN(target) || target <= 0) {
          setError('Please enter a valid profit target');
          return;
        }

        setState({
          ...state,
          yearlyGoal: {
            year: currentYear,
            target,
            createdAt: state.yearlyGoal?.createdAt || nowISO(),
            updatedAt: nowISO(),
          },
        });
        setYearlyGoalModalOpen(false);
        setError('');
      };

      // Create challenge from template
      const createChallengeFromTemplate = () => {
        if (!selectedTemplate) return;

        const template = Object.values(CHALLENGE_TEMPLATES).flat().find(t => t.id === selectedTemplate);
        if (!template) return;

        const values = templateValues[selectedTemplate] || template.defaults;
        
        const challenge = {
          id: generateId(),
          templateId: template.id,
          name: template.name
            .replace('{amount}', values.amount || '')
            .replace('{date}', values.date ? new Date(values.date).toLocaleDateString() : '')
            .replace('{trades}', values.trades || '')
            .replace('{days}', values.days || '')
            .replace('{percent}', values.percent || '')
            .replace('{weeks}', values.weeks || ''),
          type: template.type,
          condition: template.condition,
          targetValue: values.amount || 0,
          targetPercent: values.percent || 0,
          tradeLimit: values.trades || 0,
          streakDays: values.days || 0,
          targetWeeks: values.weeks || 0,
          maxLossAmount: values.amount || 0,
          endDate: values.date || '',
          startDate: todayISO(),
          createdAt: nowISO(),
        };

        setState({
          ...state,
          challenges: [...(state.challenges || []), challenge],
        });
        setChallengeModalOpen(false);
        setSelectedTemplate(null);
        setTemplateValues({});
      };

      // Create custom challenge
      const createCustomChallenge = () => {
        const { metricType, condition, value, timeValue, endDate } = customChallenge;
        
        if (!value || parseFloat(value) <= 0) {
          setError('Please enter a valid value');
          return;
        }

        let name = '';
        const challenge = {
          id: generateId(),
          type: metricType,
          condition,
          startDate: todayISO(),
          createdAt: nowISO(),
        };

        switch (condition) {
          case 'by_date':
            name = `Make $${value} by ${new Date(endDate).toLocaleDateString()}`;
            challenge.targetValue = parseFloat(value);
            challenge.endDate = endDate;
            break;
          case 'in_trades':
            name = `Make $${value} in ${timeValue} trades`;
            challenge.targetValue = parseFloat(value);
            challenge.tradeLimit = parseInt(timeValue);
            break;
          case 'streak_days':
            name = `Make $${value} for ${timeValue} days in a row`;
            challenge.targetValue = parseFloat(value);
            challenge.streakDays = parseInt(timeValue);
            break;
          case 'single_day':
            name = `Make $${value} in a single day`;
            challenge.targetValue = parseFloat(value);
            break;
          case 'single_trade':
            name = `Make $${value} in a single trade`;
            challenge.targetValue = parseFloat(value);
            break;
          case 'profitable_days':
            name = `Be profitable ${value} days in a row`;
            challenge.streakDays = parseInt(value);
            break;
          case 'win_rate':
            name = `Stay above ${value}% win rate for ${timeValue} trades`;
            challenge.targetPercent = parseFloat(value);
            challenge.tradeLimit = parseInt(timeValue);
            break;
          case 'max_loss_days':
            name = `No losses > $${value} for ${timeValue} days`;
            challenge.maxLossAmount = parseFloat(value);
            challenge.streakDays = parseInt(timeValue);
            break;
          case 'no_mistakes':
            name = `Complete ${value} trades with no mistakes`;
            challenge.tradeLimit = parseInt(value);
            break;
        }

        challenge.name = name;

        setState({
          ...state,
          challenges: [...(state.challenges || []), challenge],
        });
        setChallengeModalOpen(false);
        setCustomChallenge({ metricType: 'profit', condition: 'by_date', value: '', timeValue: '', endDate: '' });
        setError('');
      };

      // Delete challenge
      const deleteChallenge = (challengeId) => {
        setState({
          ...state,
          challenges: state.challenges.filter(c => c.id !== challengeId),
        });
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Goals & Challenges</h1>
              <p className="text-sm text-gray-500 mt-1">Set your yearly target and take on challenges</p>
            </div>
          </div>

          {/* Yearly Goal Section */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <h2 className="font-semibold text-gray-900">{currentYear} Yearly Goal</h2>
              {!isReadOnly && (
                <button
                  onClick={() => {
                    setYearlyGoalInput(state.yearlyGoal?.target?.toString() || '');
                    setYearlyGoalModalOpen(true);
                  }}
                  className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  {state.yearlyGoal?.year === currentYear ? 'Edit' : 'Set Goal'}
                </button>
              )}
            </div>

            {yearlyGoalProgress ? (
              <div className="p-6">
                {/* Progress Section */}
                <div className="flex items-center gap-6 mb-6">
                  {/* Progress Ring */}
                  <div className="relative w-24 h-24 flex-shrink-0">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle cx="50%" cy="50%" r="45%" fill="none" stroke="#e5e7eb" strokeWidth="8" />
                      <circle
                        cx="50%" cy="50%" r="45%" fill="none"
                        stroke={yearlyGoalProgress.isComplete ? '#10b981' : '#3b82f6'}
                        strokeWidth="8" strokeLinecap="round"
                        strokeDasharray={`${yearlyGoalProgress.progress * 2.83} 283`}
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className={`text-lg font-bold ${yearlyGoalProgress.isComplete ? 'text-emerald-600' : 'text-blue-600'}`}>
                        {yearlyGoalProgress.progress.toFixed(0)}%
                      </span>
                    </div>
                  </div>

                  {/* Stats */}
                  <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <div>
                      <p className="text-[10px] md:text-xs text-gray-500 uppercase">Target</p>
                      <p className="text-base sm:text-lg md:text-xl font-bold text-gray-900 truncate">{formatCurrency(yearlyGoalProgress.goal.target)}</p>
                    </div>
                    <div>
                      <p className="text-[10px] md:text-xs text-gray-500 uppercase">Current</p>
                      <p className={`text-base sm:text-lg md:text-xl font-bold truncate ${yearlyGoalProgress.yearPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                        {formatCurrency(yearlyGoalProgress.yearPnL)}
                      </p>
                    </div>
                    <div>
                      <p className="text-[10px] md:text-xs text-gray-500 uppercase">Trade Days</p>
                      <p className="text-base sm:text-lg md:text-xl font-bold text-gray-900">{yearlyGoalProgress.tradingDaysRemaining}</p>
                    </div>
                    <div>
                      <p className="text-[10px] md:text-xs text-gray-500 uppercase">Days Left</p>
                      <p className="text-base sm:text-lg md:text-xl font-bold text-gray-900">{yearlyGoalProgress.calendarDaysRemaining}</p>
                    </div>
                  </div>
                </div>

                {/* Extrapolated Targets */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                  <div className="bg-blue-50 rounded-lg p-3 md:p-4 text-center">
                    <p className="text-[10px] md:text-xs text-blue-600 uppercase font-medium">Daily</p>
                    <p className="text-sm sm:text-base md:text-lg font-bold text-blue-900 truncate">{formatCurrency(yearlyGoalProgress.dailyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-3 md:p-4 text-center">
                    <p className="text-[10px] md:text-xs text-blue-600 uppercase font-medium">Weekly</p>
                    <p className="text-sm sm:text-base md:text-lg font-bold text-blue-900 truncate">{formatCurrency(yearlyGoalProgress.weeklyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-3 md:p-4 text-center">
                    <p className="text-[10px] md:text-xs text-blue-600 uppercase font-medium">Monthly</p>
                    <p className="text-sm sm:text-base md:text-lg font-bold text-blue-900 truncate">{formatCurrency(yearlyGoalProgress.monthlyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-3 md:p-4 text-center">
                    <p className="text-[10px] md:text-xs text-blue-600 uppercase font-medium">Quarterly</p>
                    <p className="text-sm sm:text-base md:text-lg font-bold text-blue-900 truncate">{formatCurrency(yearlyGoalProgress.quarterlyTarget)}</p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.goals}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No yearly goal set</h3>
                <p className="text-gray-500 mb-4">Set a profit target for {currentYear} to track your progress</p>
                {!isReadOnly && (
                  <button
                    onClick={() => setYearlyGoalModalOpen(true)}
                    className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    {Icons.plus}
                    <span>Set Yearly Goal</span>
                  </button>
                )}
              </div>
            )}
          </div>

          {/* Challenges Section */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <h2 className="font-semibold text-gray-900">Challenges</h2>
              {!isReadOnly && (
                <button
                  onClick={() => setChallengeModalOpen(true)}
                  className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>New Challenge</span>
                </button>
              )}
            </div>

            {/* Active Challenges */}
            {activeChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-gray-700 mb-3">Active ({activeChallenges.length})</h3>
                <div className="space-y-3">
                  {activeChallenges.map(challenge => (
                    <div key={challenge.id} className={`rounded-lg p-4 ${challenge.fromMentor ? 'bg-purple-50 border border-purple-100' : 'bg-gray-50'}`}>
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <h4 className="font-medium text-gray-900">{challenge.name}</h4>
                          {challenge.fromMentor && (
                            <span className="text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 font-medium">
                              From {challenge.mentorName || 'Mentor'}
                            </span>
                          )}
                        </div>
                        <div className="flex items-center gap-2">
                          <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${
                            challenge.progress >= 75 ? 'bg-emerald-100 text-emerald-700' :
                            challenge.progress >= 50 ? 'bg-blue-100 text-blue-700' :
                            'bg-gray-200 text-gray-600'
                          }`}>
                            {challenge.statusText}
                          </span>
                          {!isReadOnly && !challenge.fromMentor && (
                            <button
                              onClick={() => deleteChallenge(challenge.id)}
                              className="p-1 text-gray-400 hover:text-red-600"
                            >
                              {Icons.trash}
                            </button>
                          )}
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div 
                            className={`h-full rounded-full transition-all ${challenge.fromMentor ? 'bg-purple-500' : 'bg-blue-500'}`}
                            style={{ width: `${challenge.progress}%` }}
                          />
                        </div>
                        <span className="text-sm font-medium text-gray-600 w-20 text-right">
                          {typeof challenge.currentValue === 'number' && challenge.currentValue % 1 !== 0 
                            ? challenge.currentValue.toFixed(1) 
                            : challenge.currentValue} / {challenge.targetValue}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Completed Challenges */}
            {completedChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-emerald-700 mb-3">‚úÖ Completed ({completedChallenges.length})</h3>
                <div className="space-y-2">
                  {completedChallenges.map(challenge => (
                    <div key={challenge.id} className={`rounded-lg p-3 flex items-center justify-between ${challenge.fromMentor ? 'bg-purple-50' : 'bg-emerald-50'}`}>
                      <div className="flex items-center gap-2">
                        <span className={`text-sm ${challenge.fromMentor ? 'text-purple-800' : 'text-emerald-800'}`}>{challenge.name}</span>
                        {challenge.fromMentor && (
                          <span className="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-600">Mentor</span>
                        )}
                      </div>
                      {!isReadOnly && !challenge.fromMentor && (
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-emerald-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Failed Challenges */}
            {failedChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-red-700 mb-3">‚ùå Failed ({failedChallenges.length})</h3>
                <div className="space-y-2">
                  {failedChallenges.map(challenge => (
                    <div key={challenge.id} className="bg-red-50 rounded-lg p-3 flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-red-800">{challenge.name}</span>
                        {challenge.fromMentor && (
                          <span className="text-xs px-1.5 py-0.5 rounded bg-red-100 text-red-600">Mentor</span>
                        )}
                      </div>
                      {!isReadOnly && !challenge.fromMentor && (
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-red-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Empty State */}
            {challengesWithProgress.length === 0 && (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  üèÜ
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No challenges yet</h3>
                <p className="text-gray-500 mb-4">Create challenges to push yourself and track achievements</p>
                <button
                  onClick={() => setChallengeModalOpen(true)}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Create Your First Challenge</span>
                </button>
              </div>
            )}
          </div>

          {/* Yearly Goal Modal */}
          {yearlyGoalModalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setYearlyGoalModalOpen(false)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">{currentYear} Yearly Goal</h2>
                  </div>
                  <div className="p-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Profit Target for {currentYear}
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                      <input
                        type="number"
                        value={yearlyGoalInput}
                        onChange={(e) => { setYearlyGoalInput(e.target.value); setError(''); }}
                        placeholder="100000"
                        className={`w-full pl-8 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${error ? 'border-red-500' : 'border-gray-300'}`}
                        autoFocus
                      />
                    </div>
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    {yearlyGoalInput && parseFloat(yearlyGoalInput) > 0 && (
                      <div className="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                        <p>This breaks down to approximately:</p>
                        <ul className="mt-2 space-y-1">
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 252)}</strong> per trading day</li>
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 52)}</strong> per week</li>
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 12)}</strong> per month</li>
                        </ul>
                      </div>
                    )}
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex gap-3 rounded-b-xl">
                    <button onClick={() => setYearlyGoalModalOpen(false)} className="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onClick={saveYearlyGoal} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Save Goal</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Challenge Modal */}
          {challengeModalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setChallengeModalOpen(false)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">New Challenge</h2>
                  </div>

                  {/* Tabs */}
                  <div className="flex border-b border-gray-200">
                    <button
                      onClick={() => setChallengeTab('tried')}
                      className={`flex-1 px-4 py-3 text-sm font-medium ${challengeTab === 'tried' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      üèÜ Tried & True
                    </button>
                    <button
                      onClick={() => setChallengeTab('custom')}
                      className={`flex-1 px-4 py-3 text-sm font-medium ${challengeTab === 'custom' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      ‚öôÔ∏è Custom
                    </button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6">
                    {challengeTab === 'tried' ? (
                      <div className="space-y-6">
                        {/* Profit Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üí∞ Profit-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.profit.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.amount !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Amount"
                                        value={templateValues[template.id]?.amount ?? template.defaults.amount}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], amount: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-24"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.date !== undefined && (
                                      <input
                                        type="date"
                                        value={templateValues[template.id]?.date ?? ''}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], date: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Consistency Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üìà Consistency-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.consistency.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.percent !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="%"
                                        value={templateValues[template.id]?.percent ?? template.defaults.percent}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], percent: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-16"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Risk Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üõ°Ô∏è Risk/Discipline-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.risk.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.amount !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Amount"
                                        value={templateValues[template.id]?.amount ?? template.defaults.amount}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], amount: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-24"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Volume Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üìä Volume-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.volume.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.weeks !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Weeks"
                                        value={templateValues[template.id]?.weeks ?? template.defaults.weeks}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], weeks: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.date !== undefined && (
                                      <input
                                        type="date"
                                        value={templateValues[template.id]?.date ?? ''}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], date: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Custom Challenge Builder */
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Challenge Type</label>
                          <select
                            value={customChallenge.condition}
                            onChange={(e) => setCustomChallenge({ ...customChallenge, condition: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <optgroup label="Profit">
                              <option value="by_date">Make $X by date</option>
                              <option value="in_trades">Make $X in N trades</option>
                              <option value="streak_days">Make $X for N days in a row</option>
                              <option value="single_day">Make $X in a single day</option>
                              <option value="single_trade">Make $X in a single trade</option>
                            </optgroup>
                            <optgroup label="Consistency">
                              <option value="profitable_days">Be profitable N days in a row</option>
                              <option value="win_rate">Stay above X% win rate for N trades</option>
                            </optgroup>
                            <optgroup label="Risk/Discipline">
                              <option value="max_loss_days">No losses greater than $X for N days</option>
                              <option value="no_mistakes">Complete N trades with no mistakes</option>
                            </optgroup>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {['by_date', 'in_trades', 'streak_days', 'single_day', 'single_trade', 'max_loss_days'].includes(customChallenge.condition) ? 'Amount ($)' : 
                             customChallenge.condition === 'win_rate' ? 'Win Rate (%)' : 
                             'Number of Days/Trades'}
                          </label>
                          <input
                            type="number"
                            value={customChallenge.value}
                            onChange={(e) => setCustomChallenge({ ...customChallenge, value: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder={['by_date', 'in_trades', 'streak_days', 'single_day', 'single_trade', 'max_loss_days'].includes(customChallenge.condition) ? '5000' : '10'}
                          />
                        </div>

                        {['in_trades', 'streak_days', 'win_rate', 'max_loss_days'].includes(customChallenge.condition) && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {customChallenge.condition === 'in_trades' || customChallenge.condition === 'win_rate' ? 'Number of Trades' : 'Number of Days'}
                            </label>
                            <input
                              type="number"
                              value={customChallenge.timeValue}
                              onChange={(e) => setCustomChallenge({ ...customChallenge, timeValue: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="10"
                            />
                          </div>
                        )}

                        {customChallenge.condition === 'by_date' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input
                              type="date"
                              value={customChallenge.endDate}
                              onChange={(e) => setCustomChallenge({ ...customChallenge, endDate: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        )}

                        {error && <p className="text-red-500 text-sm">{error}</p>}
                      </div>
                    )}
                  </div>

                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex gap-3">
                    <button
                      onClick={() => { setChallengeModalOpen(false); setSelectedTemplate(null); setError(''); }}
                      className="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={challengeTab === 'tried' ? createChallengeFromTemplate : createCustomChallenge}
                      disabled={challengeTab === 'tried' && !selectedTemplate}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Start Challenge
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // PROFILE PAGE
    // =============================================================================
    function ProfilePage({ state, setState, isMobile, userProfile, onSignOut, onUpdate, readOnly }) {
      const currentYear = new Date().getFullYear();

      // Calculate all-time stats
      const allTimeStats = useMemo(() => {
        const allTrades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) }));
        const closedTrades = allTrades.filter(t => !t.derived.isOpen);
        
        const totalTrades = closedTrades.length;
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const winRate = totalTrades > 0 ? ((wins.length / totalTrades) * 100).toFixed(1) : 0;
        
        const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / wins.length : 0;
        const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / losses.length) : 0;
        const profitFactor = avgLoss > 0 && losses.length > 0 ? (wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0))).toFixed(2) : wins.length > 0 ? '‚àû' : '0';
        
        const biggestWin = wins.length > 0 ? Math.max(...wins.map(t => t.derived.pnlFinal)) : 0;
        const biggestLoss = losses.length > 0 ? Math.min(...losses.map(t => t.derived.pnlFinal)) : 0;
        
        // Trading days
        const tradingDays = new Set(closedTrades.map(t => t.exitDate || t.entryDate)).size;
        
        // Best and worst day
        const dailyPnL = {};
        closedTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
        });
        const days = Object.entries(dailyPnL);
        const bestDay = days.length > 0 ? days.reduce((best, curr) => curr[1] > best[1] ? curr : best, days[0]) : null;
        const worstDay = days.length > 0 ? days.reduce((worst, curr) => curr[1] < worst[1] ? curr : worst, days[0]) : null;
        
        // Average daily P&L
        const avgDailyPnL = tradingDays > 0 ? totalPnL / tradingDays : 0;

        // Green days vs red days
        const greenDays = days.filter(([_, pnl]) => pnl > 0).length;
        const redDays = days.filter(([_, pnl]) => pnl < 0).length;
        
        return {
          totalTrades,
          wins: wins.length,
          losses: losses.length,
          totalPnL,
          winRate,
          avgWin,
          avgLoss,
          profitFactor,
          biggestWin,
          biggestLoss,
          tradingDays,
          bestDay,
          worstDay,
          avgDailyPnL,
          greenDays,
          redDays,
        };
      }, [state.trades]);

      // Challenge stats
      const challengeStats = useMemo(() => {
        const challenges = state.challenges || [];
        let completedCount = 0;
        let failedCount = 0;
        const completedList = [];
        const failedList = [];

        challenges.forEach(challenge => {
          const trades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) })).filter(t => !t.derived.isOpen);
          const challengeTrades = trades.filter(t => (t.exitDate || t.entryDate) >= challenge.startDate);
          let isComplete = false;
          let isFailed = false;
          const now = new Date();

          switch (challenge.condition) {
            case 'by_date': {
              const pnl = challengeTrades.filter(t => (t.exitDate || t.entryDate) <= challenge.endDate)
                .reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = pnl >= challenge.targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'single_day': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              isComplete = Object.values(dailyPnL).length > 0 && Math.max(...Object.values(dailyPnL)) >= challenge.targetValue;
              break;
            }
            case 'single_trade': {
              isComplete = challengeTrades.length > 0 && Math.max(...challengeTrades.map(t => t.derived.pnlFinal || 0)) >= challenge.targetValue;
              break;
            }
            case 'in_trades': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              const pnl = limitedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = pnl >= challenge.targetValue && limitedTrades.length <= challenge.tradeLimit;
              isFailed = challengeTrades.length >= challenge.tradeLimit && pnl < challenge.targetValue;
              break;
            }
            case 'profitable_days':
            case 'streak_days': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              const threshold = challenge.condition === 'profitable_days' ? 0 : challenge.targetValue;
              sortedDays.forEach(([_, pnl]) => {
                if (pnl > threshold) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'no_mistakes': {
              const cleanTrades = challengeTrades.filter(t => !t.mistakeIds || t.mistakeIds.length === 0);
              isComplete = cleanTrades.length >= challenge.tradeLimit;
              break;
            }
          }

          if (isComplete) {
            completedCount++;
            completedList.push(challenge);
          } else if (isFailed) {
            failedCount++;
            failedList.push(challenge);
          }
        });

        const successRate = (completedCount + failedCount) > 0 
          ? ((completedCount / (completedCount + failedCount)) * 100).toFixed(0) 
          : 0;

        return {
          total: challenges.length,
          completed: completedCount,
          failed: failedCount,
          active: challenges.length - completedCount - failedCount,
          successRate,
          completedList,
          failedList,
        };
      }, [state.challenges, state.trades]);

      // Delete challenge from history
      const deleteChallenge = (challengeId) => {
        setState({
          ...state,
          challenges: state.challenges.filter(c => c.id !== challengeId),
        });
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Profile</h1>
            <p className="text-sm text-gray-500 mt-1">{readOnly ? 'Viewing trader statistics' : 'Your trading stats and challenge history'}</p>
          </div>

          {/* User Profile Card - only show if logged in user viewing their own profile */}
          {userProfile && !readOnly && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="relative group">
                    {userProfile.photoURL ? (
                      <img 
                        src={userProfile.photoURL} 
                        alt={userProfile.displayName}
                        className="w-16 h-16 rounded-full object-cover"
                      />
                    ) : (
                      <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-2xl font-bold text-blue-600">
                        {userProfile.displayName?.charAt(0)?.toUpperCase() || '?'}
                      </div>
                    )}
                    <label className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                      <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                      <input
                        type="file"
                        accept="image/*"
                        className="hidden"
                        onChange={async (e) => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          
                          // Compress and convert to base64
                          const compressImage = (file, maxWidth = 200, quality = 0.8) => {
                            return new Promise((resolve) => {
                              const reader = new FileReader();
                              reader.onload = (e) => {
                                const img = new Image();
                                img.onload = () => {
                                  const canvas = document.createElement('canvas');
                                  const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                                  canvas.width = img.width * ratio;
                                  canvas.height = img.height * ratio;
                                  const ctx = canvas.getContext('2d');
                                  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                  resolve(canvas.toDataURL('image/jpeg', quality));
                                };
                                img.src = e.target.result;
                              };
                              reader.readAsDataURL(file);
                            });
                          };
                          
                          try {
                            const compressedDataUrl = await compressImage(file);
                            await db.collection('users').doc(userProfile.uid).update({
                              photoURL: compressedDataUrl
                            });
                            if (onUpdate) onUpdate();
                          } catch (err) {
                            console.error('Failed to upload photo:', err);
                            alert('Failed to upload photo. Please try again.');
                          }
                        }}
                      />
                    </label>
                  </div>
                  <div>
                    <h2 className="text-xl font-bold text-gray-900">{userProfile.displayName}</h2>
                    <p className="text-gray-500">{userProfile.email}</p>
                    <span className={`inline-block mt-1 px-2 py-0.5 text-xs rounded-full font-medium ${
                      userProfile.role === 'mentor' 
                        ? 'bg-purple-100 text-purple-700' 
                        : 'bg-blue-100 text-blue-700'
                    }`}>
                      {userProfile.role === 'mentor' ? 'üë®‚Äçüè´ Mentor' : 'üìà Trader'}
                    </span>
                    {userProfile.mentorName && (
                      <div className="flex items-center gap-2 mt-1">
                        <p className="text-sm text-gray-500">
                          Mentored by: <span className="font-medium">{userProfile.mentorName}</span>
                        </p>
                        <button
                          onClick={async () => {
                            if (!confirm('Are you sure you want to disconnect from your mentor?')) return;
                            try {
                              // Remove mentor from trader's profile
                              await db.collection('users').doc(userProfile.uid).update({
                                mentorId: firebase.firestore.FieldValue.delete(),
                                mentorName: firebase.firestore.FieldValue.delete(),
                              });
                              // Remove from mentor's student list
                              if (userProfile.mentorId) {
                                await db.collection('mentorships')
                                  .doc(userProfile.mentorId)
                                  .collection('students')
                                  .doc(userProfile.uid)
                                  .delete();
                              }
                              // Reload profile
                              if (onUpdate) onUpdate();
                            } catch (err) {
                              console.error('Failed to remove mentor:', err);
                              alert('Failed to remove mentor. Please try again.');
                            }
                          }}
                          className="text-xs text-red-500 hover:text-red-700 hover:underline"
                        >
                          Remove
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                {onSignOut && (
                  <button
                    onClick={onSignOut}
                    className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                      <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                      <polyline points="16 17 21 12 16 7" />
                      <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Sign Out
                  </button>
                )}
              </div>
            </div>
          )}

          {/* All-Time Stats */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="font-semibold text-gray-900">All-Time Statistics</h2>
            </div>
            <div className="p-4 md:p-6">
              {/* Main Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                <div className="bg-gray-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-gray-500 uppercase mb-1">Total P&L</p>
                  <p className={`text-lg sm:text-xl md:text-2xl font-bold truncate ${allTimeStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrency(allTimeStats.totalPnL)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-gray-500 uppercase mb-1">Trades</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">{allTimeStats.totalTrades}</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-gray-500 uppercase mb-1">Win Rate</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">{allTimeStats.winRate}%</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-gray-500 uppercase mb-1">Profit Factor</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">{allTimeStats.profitFactor}</p>
                </div>
              </div>

              {/* Secondary Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 md:gap-3">
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">W / L</p>
                  <p className="text-base md:text-lg font-semibold">
                    <span className="text-emerald-600">{allTimeStats.wins}</span>
                    {' / '}
                    <span className="text-red-600">{allTimeStats.losses}</span>
                  </p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Avg Win</p>
                  <p className="text-base md:text-lg font-semibold text-emerald-600 truncate">{formatCurrencyShort(allTimeStats.avgWin)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Avg Loss</p>
                  <p className="text-base md:text-lg font-semibold text-red-600 truncate">-{formatCurrencyShort(allTimeStats.avgLoss)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Best Win</p>
                  <p className="text-base md:text-lg font-semibold text-emerald-600 truncate">{formatCurrencyShort(allTimeStats.biggestWin)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Worst Loss</p>
                  <p className="text-base md:text-lg font-semibold text-red-600 truncate">{formatCurrencyShort(allTimeStats.biggestLoss)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Days</p>
                  <p className="text-base md:text-lg font-semibold text-gray-900">{allTimeStats.tradingDays}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">G / R Days</p>
                  <p className="text-base md:text-lg font-semibold">
                    <span className="text-emerald-600">{allTimeStats.greenDays}</span>
                    {' / '}
                    <span className="text-red-600">{allTimeStats.redDays}</span>
                  </p>
                </div>
                <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                  <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Avg Daily</p>
                  <p className={`text-base md:text-lg font-semibold truncate ${allTimeStats.avgDailyPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(allTimeStats.avgDailyPnL)}
                  </p>
                </div>
                {allTimeStats.bestDay && (
                  <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                    <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Best Day</p>
                    <p className="text-base md:text-lg font-semibold text-emerald-600 truncate">{formatCurrencyShort(allTimeStats.bestDay[1])}</p>
                    <p className="text-[9px] md:text-[10px] text-gray-400 truncate">{allTimeStats.bestDay[0]}</p>
                  </div>
                )}
                {allTimeStats.worstDay && (
                  <div className="border border-gray-200 rounded-lg p-2 md:p-3">
                    <p className="text-[9px] md:text-[10px] text-gray-500 uppercase">Worst Day</p>
                    <p className="text-base md:text-lg font-semibold text-red-600 truncate">{formatCurrencyShort(allTimeStats.worstDay[1])}</p>
                    <p className="text-[9px] md:text-[10px] text-gray-400 truncate">{allTimeStats.worstDay[0]}</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Challenge Stats */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="font-semibold text-gray-900">Challenge History</h2>
            </div>
            <div className="p-4 md:p-6">
              {/* Challenge Summary */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                <div className="bg-blue-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-blue-600 uppercase mb-1">Total</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-blue-900">{challengeStats.total}</p>
                </div>
                <div className="bg-emerald-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-emerald-600 uppercase mb-1">Completed</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-emerald-700">{challengeStats.completed}</p>
                </div>
                <div className="bg-red-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-red-600 uppercase mb-1">Failed</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-red-700">{challengeStats.failed}</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3 md:p-4 text-center">
                  <p className="text-[10px] md:text-xs text-gray-600 uppercase mb-1">Success</p>
                  <p className="text-lg sm:text-xl md:text-2xl font-bold text-gray-900">{challengeStats.successRate}%</p>
                </div>
              </div>

              {/* Completed Challenges List */}
              {challengeStats.completedList.length > 0 && (
                <div className="mb-4">
                  <h3 className="text-sm font-medium text-emerald-700 mb-2">‚úÖ Completed Challenges</h3>
                  <div className="space-y-2">
                    {challengeStats.completedList.map(challenge => (
                      <div key={challenge.id} className="flex items-center justify-between bg-emerald-50 rounded-lg p-3">
                        <div>
                          <p className="text-sm font-medium text-emerald-800">{challenge.name}</p>
                          <p className="text-xs text-emerald-600">Started: {challenge.startDate}</p>
                        </div>
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-emerald-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Failed Challenges List */}
              {challengeStats.failedList.length > 0 && (
                <div>
                  <h3 className="text-sm font-medium text-red-700 mb-2">‚ùå Failed Challenges</h3>
                  <div className="space-y-2">
                    {challengeStats.failedList.map(challenge => (
                      <div key={challenge.id} className="flex items-center justify-between bg-red-50 rounded-lg p-3">
                        <div>
                          <p className="text-sm font-medium text-red-800">{challenge.name}</p>
                          <p className="text-xs text-red-600">Started: {challenge.startDate}</p>
                        </div>
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-red-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {challengeStats.total === 0 && (
                <div className="text-center py-8 text-gray-500">
                  <p>No challenges yet. Create one from the Goals page!</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // SIDEBAR (Desktop) & BOTTOM NAV (Mobile)
    // =============================================================================
    function Sidebar({ isExpanded, setIsExpanded, activePage, setActivePage, isMobile, navItems }) {
      const items = navItems || NAV_ITEMS;
      const [showMoreMenu, setShowMoreMenu] = React.useState(false);
      
      // Mobile bottom navigation
      if (isMobile) {
        // Show first 4 items + More button
        const mainItems = items.slice(0, 4);
        const moreItems = items.slice(4);
        const isMoreActive = moreItems.some(item => item.id === activePage);
        
        return (
          <>
            {/* More Menu Overlay */}
            {showMoreMenu && (
              <div className="fixed inset-0 z-40" onClick={() => setShowMoreMenu(false)}>
                <div className="absolute bottom-20 left-4 right-4 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden">
                  <div className="p-2">
                    {moreItems.map((item) => {
                      const isActive = activePage === item.id;
                      return (
                        <button
                          key={item.id}
                          onClick={(e) => {
                            e.stopPropagation();
                            setActivePage(item.id);
                            setShowMoreMenu(false);
                          }}
                          className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-colors ${
                            isActive ? 'bg-blue-50 text-blue-600' : 'text-gray-700 hover:bg-gray-50'
                          }`}
                        >
                          <span className="w-6 h-6 flex items-center justify-center">
                            {Icons[item.icon]}
                          </span>
                          <span className="font-medium">{item.label}</span>
                          {isActive && (
                            <svg className="w-5 h-5 ml-auto text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                          )}
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            )}
            
            {/* Bottom Navigation Bar */}
            <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30">
              <div className="flex justify-around items-center h-16 px-2 pb-safe">
                {mainItems.map((item) => {
                  const isActive = activePage === item.id;
                  return (
                    <button
                      key={item.id}
                      onClick={() => {
                        setActivePage(item.id);
                        setShowMoreMenu(false);
                      }}
                      className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                        isActive ? 'text-blue-600' : 'text-gray-500'
                      }`}
                    >
                      <span className={`${isActive ? 'scale-110' : ''} transition-transform`}>
                        {Icons[item.icon]}
                      </span>
                      <span className="text-[10px] mt-1 font-medium">{item.label}</span>
                    </button>
                  );
                })}
                
                {/* More Button */}
                {moreItems.length > 0 && (
                  <button
                    onClick={() => setShowMoreMenu(!showMoreMenu)}
                    className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                      isMoreActive || showMoreMenu ? 'text-blue-600' : 'text-gray-500'
                    }`}
                  >
                    <span className={`${isMoreActive || showMoreMenu ? 'scale-110' : ''} transition-transform`}>
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                        <circle cx="12" cy="12" r="1" fill="currentColor" />
                        <circle cx="12" cy="5" r="1" fill="currentColor" />
                        <circle cx="12" cy="19" r="1" fill="currentColor" />
                      </svg>
                    </span>
                    <span className="text-[10px] mt-1 font-medium">More</span>
                  </button>
                )}
              </div>
            </nav>
          </>
        );
      }

      // Desktop sidebar
      return (
        <aside className={`fixed left-0 top-0 h-full bg-slate-900 text-white transition-all duration-300 ease-in-out z-30 ${isExpanded ? 'w-56' : 'w-16'} flex flex-col`}>
          <div className="h-14 flex items-center justify-between px-4 border-b border-slate-700">
            {isExpanded ? (
              <div className="flex items-center gap-2">
                <svg viewBox="0 0 32 32" fill="none" className="w-8 h-8 flex-shrink-0">
                  <line x1="8" y1="6" x2="8" y2="20" stroke="#22c55e" strokeWidth="1.5"/>
                  <rect x="6" y="9" width="4" height="7" fill="#22c55e" rx="0.5"/>
                  <line x1="16" y1="10" x2="16" y2="28" stroke="#ef4444" strokeWidth="1.5"/>
                  <rect x="14" y="14" width="4" height="10" fill="#ef4444" rx="0.5"/>
                  <line x1="24" y1="3" x2="24" y2="18" stroke="#22c55e" strokeWidth="1.5"/>
                  <rect x="22" y="5" width="4" height="8" fill="#22c55e" rx="0.5"/>
                  <path d="M4 24 L10 16 L16 20 L22 14 L28 8" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" fill="none" opacity="0.3"/>
                  <path d="M4 24 L10 16 L16 20 L22 14 L28 8" stroke="url(#sidebarGrad)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                  <path d="M23 8 L28 8 L28 13" stroke="white" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" fill="none" opacity="0.3"/>
                  <path d="M23 8 L28 8 L28 13" stroke="#22c55e" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                  <defs>
                    <linearGradient id="sidebarGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stopColor="#ef4444"/>
                      <stop offset="100%" stopColor="#22c55e"/>
                    </linearGradient>
                  </defs>
                </svg>
                <span className="font-bold text-lg tracking-tight"><span className="text-white">oh</span><span className="text-blue-400">Yaaa</span></span>
              </div>
            ) : (
              <svg viewBox="0 0 32 32" fill="none" className="w-8 h-8 mx-auto">
                <line x1="8" y1="6" x2="8" y2="20" stroke="#22c55e" strokeWidth="1.5"/>
                <rect x="6" y="9" width="4" height="7" fill="#22c55e" rx="0.5"/>
                <line x1="16" y1="10" x2="16" y2="28" stroke="#ef4444" strokeWidth="1.5"/>
                <rect x="14" y="14" width="4" height="10" fill="#ef4444" rx="0.5"/>
                <line x1="24" y1="3" x2="24" y2="18" stroke="#22c55e" strokeWidth="1.5"/>
                <rect x="22" y="5" width="4" height="8" fill="#22c55e" rx="0.5"/>
                <path d="M4 24 L10 16 L16 20 L22 14 L28 8" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" fill="none" opacity="0.3"/>
                <path d="M4 24 L10 16 L16 20 L22 14 L28 8" stroke="url(#sidebarGradSmall)" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                <path d="M23 8 L28 8 L28 13" stroke="white" strokeWidth="3.5" strokeLinecap="round" strokeLinejoin="round" fill="none" opacity="0.3"/>
                <path d="M23 8 L28 8 L28 13" stroke="#22c55e" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                <defs>
                  <linearGradient id="sidebarGradSmall" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#ef4444"/>
                    <stop offset="100%" stopColor="#22c55e"/>
                  </linearGradient>
                </defs>
              </svg>
            )}
            <button onClick={() => setIsExpanded(!isExpanded)} className="p-1.5 rounded-lg hover:bg-slate-800 transition-colors ml-auto">
              {isExpanded ? Icons.chevronLeft : Icons.chevronRight}
            </button>
          </div>
          <nav className="flex-1 py-4">
            <ul className="space-y-1 px-2">
              {items.map((item) => {
                const isActive = activePage === item.id;
                return (
                  <li key={item.id}>
                    <button
                      onClick={() => setActivePage(item.id)}
                      className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors duration-150
                        ${isActive ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}`}
                    >
                      <span className="flex-shrink-0">{Icons[item.icon]}</span>
                      {isExpanded && <span className="text-sm font-medium truncate">{item.label}</span>}
                    </button>
                  </li>
                );
              })}
            </ul>
          </nav>
        </aside>
      );
    }

    // =============================================================================
    // TOP BAR
    // =============================================================================
    function TopBar({ storageInfo, sidebarExpanded, isMobile, userProfile, onSignOut, notifications = [], onMarkAsRead, onMarkAllAsRead, onNotificationClick }) {
      const { megabytes, percentUsed, nearLimit } = storageInfo;
      const limitMB = (STORAGE_LIMIT_BYTES / (1024 * 1024)).toFixed(2);
      const [showMenu, setShowMenu] = useState(false);
      const [showNotifications, setShowNotifications] = useState(false);

      const unreadCount = notifications.filter(n => !n.read).length;

      const getNotificationIcon = (type) => {
        switch (type) {
          // Student notifications (from mentor)
          case 'feedback': return 'üí¨';
          case 'flag': return 'üö©';
          case 'checkin': return 'üìã';
          case 'assignment': return 'üìù';
          case 'question_answered': return 'üí°';
          case 'assignment_reviewed': return '‚úÖ';
          case 'session': return 'üìÖ';
          case 'session_reminder': return '‚è∞';
          
          // Mentor notifications (from student)
          case 'question_asked': return '‚ùì';
          case 'assignment_completed': return 'üìã';
          case 'student_daily_target': return 'üéØ';
          case 'student_challenge_complete': return 'üèÖ';
          case 'student_milestone': return 'üéâ';
          case 'invite_accepted': return 'ü§ù';
          
          // Self notifications (achievements)
          case 'daily_target_hit': return 'üéØ';
          case 'daily_target_exceeded': return 'üî•';
          case 'weekly_goal_progress': return 'üìà';
          case 'monthly_goal_progress': return 'üèÜ';
          case 'yearly_goal_progress': return '‚≠ê';
          case 'challenge_progress': return 'üí™';
          case 'challenge_completed': return 'üèÖ';
          case 'challenge_failed': return 'üòî';
          case 'win_streak': return 'üî•';
          case 'profitable_week': return 'üíö';
          case 'profitable_month': return 'üí∞';
          case 'new_personal_best': return 'üèÜ';
          case 'trading_milestone': return 'üéâ';
          
          // Email reports
          case 'weekly_recap': return 'üìä';
          case 'monthly_report': return 'üìà';
          
          default: return 'üîî';
        }
      };

      const formatTimeAgo = (timestamp) => {
        if (!timestamp?.toDate) return '';
        const now = new Date();
        const date = timestamp.toDate();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      };

      const NotificationBell = () => {
        const [selectedIds, setSelectedIds] = React.useState([]);
        const [isOpen, setIsOpen] = React.useState(false);
        
        const toggleSelect = (id, e) => {
          e.stopPropagation();
          setSelectedIds(prev => 
            prev.includes(id) ? prev.filter(i => i !== id) : [...prev, id]
          );
        };
        
        const markSelectedAsRead = () => {
          selectedIds.forEach(id => onMarkAsRead?.(id));
          setSelectedIds([]);
        };
        
        const handleOpen = () => {
          setIsOpen(!isOpen);
          setSelectedIds([]);
        };
        
        const handleClose = () => {
          setIsOpen(false);
          setSelectedIds([]);
        };
        
        return (
          <>
            <button
              onClick={handleOpen}
              className="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" />
                <path d="M13.73 21a2 2 0 01-3.46 0" />
              </svg>
              {unreadCount > 0 && (
                <span className="absolute -top-0.5 -right-0.5 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                  {unreadCount > 9 ? '9+' : unreadCount}
                </span>
              )}
            </button>

            {isOpen && (
              <div className="fixed inset-0 z-[100]">
                {/* Backdrop */}
                <div className="fixed inset-0 bg-black/20" onClick={handleClose} />
                
                {/* Dropdown */}
                <div className={`fixed ${isMobile ? 'left-4 right-4 top-16' : 'right-4 top-14 w-96'} bg-white rounded-xl shadow-2xl border border-gray-200 max-h-[70vh] flex flex-col`}>
                  {/* Header */}
                  <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <h3 className="font-semibold text-gray-900">Notifications</h3>
                    <div className="flex items-center gap-2">
                      {selectedIds.length > 0 && (
                        <button
                          onClick={markSelectedAsRead}
                          className="text-xs text-blue-600 hover:text-blue-700 font-medium"
                        >
                          Mark selected ({selectedIds.length})
                        </button>
                      )}
                      {unreadCount > 0 && selectedIds.length === 0 && (
                        <button
                          onClick={() => { onMarkAllAsRead?.(); }}
                          className="text-xs text-blue-600 hover:text-blue-700 font-medium"
                        >
                          Mark all as read
                        </button>
                      )}
                      <button onClick={handleClose} className="p-1 hover:bg-gray-100 rounded">
                        <svg className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  
                  {/* Notifications List */}
                  <div className="overflow-y-auto flex-1">
                    {notifications.length === 0 ? (
                      <div className="px-4 py-8 text-center text-gray-500">
                        <div className="text-3xl mb-2">üîî</div>
                        <p>No notifications yet</p>
                      </div>
                    ) : (
                      <div className="divide-y divide-gray-100">
                        {notifications.slice(0, 20).map(notification => (
                          <div
                            key={notification.id}
                            onClick={() => {
                              if (!notification.read) {
                                onMarkAsRead?.(notification.id);
                              }
                              onNotificationClick?.(notification);
                              handleClose();
                            }}
                            className={`px-4 py-3 cursor-pointer transition-colors ${
                              selectedIds.includes(notification.id)
                                ? 'bg-blue-100'
                                : !notification.read 
                                  ? 'bg-blue-50/50 hover:bg-blue-50' 
                                  : 'hover:bg-gray-50'
                            }`}
                          >
                            <div className="flex items-start gap-3">
                              {/* Checkbox */}
                              <div 
                                onClick={(e) => toggleSelect(notification.id, e)}
                                className={`flex-shrink-0 w-5 h-5 mt-0.5 border-2 rounded cursor-pointer flex items-center justify-center transition-colors ${
                                  selectedIds.includes(notification.id)
                                    ? 'bg-blue-600 border-blue-600'
                                    : 'border-gray-300 hover:border-blue-400'
                                }`}
                              >
                                {selectedIds.includes(notification.id) && (
                                  <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="3">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                                  </svg>
                                )}
                              </div>
                              <span className="text-xl flex-shrink-0">{getNotificationIcon(notification.type)}</span>
                              <div className="flex-1 min-w-0">
                                <p className={`text-sm ${!notification.read ? 'font-medium text-gray-900' : 'text-gray-700'}`}>
                                  {notification.title}
                                </p>
                                <p className="text-xs text-gray-500 mt-0.5 line-clamp-2">{notification.message}</p>
                                <p className="text-xs text-gray-400 mt-1">{formatTimeAgo(notification.createdAt)}</p>
                              </div>
                              {!notification.read && (
                                <span className="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2" />
                              )}
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </>
        );
      };

      if (isMobile) {
        return (
          <header className="fixed top-0 left-0 right-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-20">
            <span className="font-bold text-lg"><span className="text-slate-900">oh</span><span className="text-blue-600">Yaaa</span></span>
            <div className="flex items-center gap-2">
              {userProfile && <NotificationBell />}
              {userProfile && (
                <div className="relative">
                  <button
                    onClick={() => setShowMenu(!showMenu)}
                    className="flex items-center"
                  >
                    <Avatar user={userProfile} size="sm" />
                  </button>
                  {showMenu && (
                    <>
                      <div className="fixed inset-0" onClick={() => setShowMenu(false)} />
                      <div className="absolute right-0 top-10 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[160px] z-50">
                        <div className="px-4 py-2 border-b border-gray-100">
                          <p className="font-medium text-gray-900 text-sm">{userProfile.displayName}</p>
                          <p className="text-xs text-gray-500">{userProfile.email}</p>
                          <p className="text-xs text-blue-600 capitalize">{userProfile.role}</p>
                        </div>
                        <button
                          onClick={() => { setShowMenu(false); onSignOut(); }}
                          className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50"
                        >
                          Sign Out
                        </button>
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>
          </header>
        );
      }

      return (
        <header className={`fixed top-0 right-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-20 transition-all duration-300 ease-in-out ${sidebarExpanded ? 'left-56' : 'left-16'}`}>
          <div className="flex-1" />
          <div className="flex items-center gap-3">
            {nearLimit && (
              <div className="flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">
                <span className="text-amber-600">{Icons.warning}</span>
                <span>Storage {percentUsed}% full</span>
              </div>
            )}
            {userProfile && <NotificationBell />}
            {userProfile && (
              <div className="relative">
                <button
                  onClick={() => setShowMenu(!showMenu)}
                  className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <Avatar user={userProfile} size="sm" />
                  <div className="text-left hidden md:block">
                    <p className="text-sm font-medium text-gray-900">{userProfile.displayName}</p>
                    <p className="text-xs text-gray-500 capitalize">{userProfile.role}</p>
                  </div>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4 text-gray-400">
                    <path d="M6 9l6 6 6-6" />
                  </svg>
                </button>
                {showMenu && (
                  <>
                    <div className="fixed inset-0" onClick={() => setShowMenu(false)} />
                    <div className="absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[200px] z-50">
                      <div className="px-4 py-2 border-b border-gray-100">
                        <p className="font-medium text-gray-900">{userProfile.displayName}</p>
                        <p className="text-sm text-gray-500">{userProfile.email}</p>
                      </div>
                      <button
                        onClick={() => { setShowMenu(false); onSignOut(); }}
                        className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                          <polyline points="16 17 21 12 16 7" />
                          <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        Sign Out
                      </button>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </header>
      );
    }

    // =============================================================================
    // AUTH SCREENS
    // =============================================================================
    function AuthScreen({ onAuthSuccess }) {
      const [mode, setMode] = useState('login'); // 'login', 'signup', 'reset', 'verify'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [displayName, setDisplayName] = useState('');
      const [accountType, setAccountType] = useState('trader'); // 'trader' or 'mentor'
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [message, setMessage] = useState('');
      const [verificationCode, setVerificationCode] = useState(['', '', '', '', '', '']);
      const [pendingUid, setPendingUid] = useState(null);
      const codeInputRefs = [useRef(), useRef(), useRef(), useRef(), useRef(), useRef()];

      // Cloud Functions base URL
      const FUNCTIONS_BASE = 'https://us-central1-trading-journal-86e97.cloudfunctions.net';

      // Handle verification code input
      const handleCodeChange = (index, value) => {
        if (value.length > 1) {
          // Handle paste
          const digits = value.replace(/\D/g, '').slice(0, 6).split('');
          const newCode = [...verificationCode];
          digits.forEach((digit, i) => {
            if (index + i < 6) newCode[index + i] = digit;
          });
          setVerificationCode(newCode);
          const nextIndex = Math.min(index + digits.length, 5);
          codeInputRefs[nextIndex]?.current?.focus();
        } else {
          const newCode = [...verificationCode];
          newCode[index] = value.replace(/\D/g, '');
          setVerificationCode(newCode);
          if (value && index < 5) {
            codeInputRefs[index + 1]?.current?.focus();
          }
        }
      };

      const handleCodeKeyDown = (index, e) => {
        if (e.key === 'Backspace' && !verificationCode[index] && index > 0) {
          codeInputRefs[index - 1]?.current?.focus();
        }
      };

      // Password complexity validation
      const validatePassword = (pwd) => {
        const requirements = {
          length: pwd.length >= 8,
          uppercase: /[A-Z]/.test(pwd),
          lowercase: /[a-z]/.test(pwd),
          number: /[0-9]/.test(pwd),
          special: /[!@#$%^&*(),.?":{}|<>]/.test(pwd),
        };
        const passed = Object.values(requirements).filter(Boolean).length;
        return { requirements, passed, isValid: passed >= 4 && requirements.length };
      };

      const passwordValidation = validatePassword(password);

      const handleSignup = async (e) => {
        e.preventDefault();
        setError('');

        if (password !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }

        if (!passwordValidation.isValid) {
          setError('Password does not meet complexity requirements');
          return;
        }

        if (!displayName.trim()) {
          setError('Please enter your name');
          return;
        }

        setLoading(true);

        try {
          // Create auth user
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          // Update display name
          await user.updateProfile({ displayName: displayName.trim() });

          // Create user document in Firestore (emailVerified: false initially)
          await db.collection('users').doc(user.uid).set({
            email: user.email,
            displayName: displayName.trim(),
            role: accountType,
            emailVerified: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          // Initialize empty journal data
          await db.collection('users').doc(user.uid).collection('journalData').doc('state').set({
            trades: [],
            setups: [],
            mistakes: [],
            dailyNotes: {},
            yearlyGoal: null,
            challenges: [],
          });

          // If mentor, create mentorships collection
          if (accountType === 'mentor') {
            await db.collection('mentorships').doc(user.uid).set({
              mentorName: displayName.trim(),
              mentorEmail: user.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          // Send verification code via Cloud Function
          const response = await fetch(`${FUNCTIONS_BASE}/sendVerificationCode`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: user.email,
              displayName: displayName.trim(),
              uid: user.uid,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to send verification code');
          }

          // Store UID for verification
          setPendingUid(user.uid);

          // Sign out until verified
          await auth.signOut();
          
          // Show verification code input
          setMode('verify');
          setVerificationCode(['', '', '', '', '', '']);
          setMessage(`Enter the 6-digit code sent to ${email}`);

        } catch (err) {
          setError(getAuthErrorMessage(err.code) || err.message);
        } finally {
          setLoading(false);
        }
      };

      // Verify the code
      const handleVerifyCode = async () => {
        const code = verificationCode.join('');
        if (code.length !== 6) {
          setError('Please enter all 6 digits');
          return;
        }

        setLoading(true);
        setError('');

        try {
          const response = await fetch(`${FUNCTIONS_BASE}/verifyCode`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              uid: pendingUid,
              code: code,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            setError(result.error || 'Verification failed');
            return;
          }

          // Success! Send welcome email
          try {
            const welcomeEmailData = emailTemplates.welcome(email, displayName.trim());
            await sendEmail(welcomeEmailData);
          } catch (emailErr) {
            console.log('Welcome email failed:', emailErr);
          }

          // Auto-login the user
          await auth.signInWithEmailAndPassword(email, password);
          // onAuthSuccess will be triggered by auth state change

        } catch (err) {
          setError('Failed to verify code. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const handleResendVerification = async () => {
        setError('');
        setLoading(true);
        
        try {
          const response = await fetch(`${FUNCTIONS_BASE}/sendVerificationCode`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: email,
              displayName: displayName.trim(),
              uid: pendingUid,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to resend code');
          }

          setVerificationCode(['', '', '', '', '', '']);
          setMessage('New verification code sent! Check your email.');
        } catch (err) {
          setError('Failed to resend code. Please try again.');
        } finally {
          setLoading(false);
        }
      };

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          // Check if email is verified in Firestore
          const userDoc = await db.collection('users').doc(user.uid).get();
          const userData = userDoc.data();
          
          if (!userData?.emailVerified) {
            await auth.signOut();
            setError('Your email has not been verified. Please check your inbox for the verification code you received when you signed up.');
            return;
          }
          
          // onAuthSuccess will be triggered by auth state change
        } catch (err) {
          setError(getAuthErrorMessage(err.code));
        } finally {
          setLoading(false);
        }
      };

      const handleReset = async (e) => {
        e.preventDefault();
        setError('');
        setMessage('');
        setLoading(true);

        try {
          await auth.sendPasswordResetEmail(email);
          setMessage('Password reset email sent! Check your inbox.');
        } catch (err) {
          setError(getAuthErrorMessage(err.code));
        } finally {
          setLoading(false);
        }
      };

      const getAuthErrorMessage = (code) => {
        switch (code) {
          case 'auth/email-already-in-use':
            return 'An account with this email already exists';
          case 'auth/invalid-email':
            return 'Invalid email address';
          case 'auth/operation-not-allowed':
            return 'Email/password accounts are not enabled';
          case 'auth/weak-password':
            return 'Password is too weak';
          case 'auth/user-disabled':
            return 'This account has been disabled';
          case 'auth/user-not-found':
            return 'No account found with this email';
          case 'auth/wrong-password':
            return 'Incorrect password';
          case 'auth/invalid-credential':
            return 'Invalid email or password';
          case 'auth/too-many-requests':
            return 'Too many attempts. Please try again later';
          default:
            return 'An error occurred. Please try again';
        }
      };

      // Animated background candlesticks
      const Candlestick = ({ x, delay, height, isGreen, wickTop, wickBottom }) => (
        <g style={{ animation: `floatCandle 4s ease-in-out ${delay}s infinite` }}>
          {/* Wick */}
          <line 
            x1={x + 6} y1={wickTop} x2={x + 6} y2={wickBottom} 
            stroke={isGreen ? '#22c55e' : '#ef4444'} 
            strokeWidth="2" 
            opacity="0.6"
          />
          {/* Body */}
          <rect 
            x={x} 
            y={isGreen ? wickTop + 10 : wickTop + 10} 
            width="12" 
            height={height} 
            fill={isGreen ? '#22c55e' : '#ef4444'} 
            rx="2"
            opacity="0.7"
          />
        </g>
      );

      return (
        <div className="min-h-screen relative overflow-hidden">
          {/* Animated gradient background */}
          <div className="absolute inset-0 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
            {/* Animated gradient orbs */}
            <div className="absolute top-1/4 -left-20 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl animate-pulse" />
            <div className="absolute bottom-1/4 -right-20 w-96 h-96 bg-emerald-500/20 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />
            <div className="absolute top-3/4 left-1/3 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '2s' }} />
          </div>

          {/* Floating candlestick chart background */}
          <svg className="absolute inset-0 w-full h-full opacity-20" preserveAspectRatio="xMidYMid slice">
            <defs>
              <style>{`
                @keyframes floatCandle {
                  0%, 100% { transform: translateY(0px); }
                  50% { transform: translateY(-15px); }
                }
              `}</style>
            </defs>
            {/* Left side candles */}
            <Candlestick x={50} delay={0} height={60} isGreen={true} wickTop={30} wickBottom={120} />
            <Candlestick x={80} delay={0.5} height={45} isGreen={false} wickTop={50} wickBottom={130} />
            <Candlestick x={110} delay={1} height={70} isGreen={true} wickTop={20} wickBottom={110} />
            <Candlestick x={140} delay={1.5} height={35} isGreen={true} wickTop={60} wickBottom={120} />
            
            {/* Right side candles */}
            <Candlestick x={1150} delay={0.3} height={55} isGreen={false} wickTop={40} wickBottom={125} />
            <Candlestick x={1180} delay={0.8} height={65} isGreen={true} wickTop={25} wickBottom={115} />
            <Candlestick x={1210} delay={1.3} height={40} isGreen={false} wickTop={55} wickBottom={130} />
            <Candlestick x={1240} delay={1.8} height={50} isGreen={true} wickTop={35} wickBottom={120} />
            
            {/* Bottom candles */}
            <Candlestick x={200} delay={0.2} height={50} isGreen={true} wickTop={450} wickBottom={530} />
            <Candlestick x={250} delay={0.7} height={40} isGreen={false} wickTop={470} wickBottom={540} />
            <Candlestick x={1050} delay={0.4} height={55} isGreen={true} wickTop={440} wickBottom={525} />
            <Candlestick x={1100} delay={0.9} height={45} isGreen={false} wickTop={460} wickBottom={535} />
            
            {/* Animated trend line */}
            <path 
              d="M0 400 Q200 350, 400 380 T800 320 T1200 360 T1600 300" 
              fill="none" 
              stroke="url(#trendGradient)" 
              strokeWidth="3"
              opacity="0.4"
              strokeDasharray="10 5"
              style={{ animation: 'dash 20s linear infinite' }}
            />
            <defs>
              <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="#ef4444" />
                <stop offset="50%" stopColor="#eab308" />
                <stop offset="100%" stopColor="#22c55e" />
              </linearGradient>
              <style>{`
                @keyframes dash {
                  to { stroke-dashoffset: -1000; }
                }
              `}</style>
            </defs>
          </svg>

          {/* Grid pattern overlay */}
          <div 
            className="absolute inset-0 opacity-[0.03]"
            style={{
              backgroundImage: 'linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px)',
              backgroundSize: '50px 50px'
            }}
          />

          {/* Main content */}
          <div className="relative z-10 min-h-screen flex items-center justify-center p-4">
            <div className="w-full max-w-md">
              {/* Logo and tagline */}
              <div className="text-center mb-8">
                <div className="inline-block">
                  <svg viewBox="0 0 280 70" fill="none" className="w-64 h-16 mx-auto drop-shadow-2xl">
                    {/* Animated candlesticks */}
                    <g style={{ animation: 'floatCandle 3s ease-in-out infinite' }}>
                      <line x1="20" y1="10" x2="20" y2="55" stroke="#22c55e" strokeWidth="3"/>
                      <rect x="13" y="20" width="14" height="22" fill="#22c55e" rx="2"/>
                    </g>
                    
                    <g style={{ animation: 'floatCandle 3s ease-in-out 0.5s infinite' }}>
                      <line x1="42" y1="22" x2="42" y2="62" stroke="#ef4444" strokeWidth="3"/>
                      <rect x="35" y="32" width="14" height="20" fill="#ef4444" rx="2"/>
                    </g>
                    
                    <g style={{ animation: 'floatCandle 3s ease-in-out 1s infinite' }}>
                      <line x1="64" y1="5" x2="64" y2="48" stroke="#22c55e" strokeWidth="3"/>
                      <rect x="57" y="12" width="14" height="18" fill="#22c55e" rx="2"/>
                    </g>
                    
                    {/* Trend line with glow */}
                    <path d="M13 52 L35 38 L57 44 L75 30 L90 18" stroke="rgba(34, 197, 94, 0.3)" strokeWidth="8" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                    <path d="M13 52 L35 38 L57 44 L75 30 L90 18" stroke="url(#heroGrad)" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                    
                    {/* Arrow */}
                    <path d="M82 18 L90 18 L90 26" stroke="#22c55e" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
                    
                    {/* ohYaaa text with shadow */}
                    <text x="105" y="48" fontFamily="system-ui, -apple-system, sans-serif" fontSize="38" fontWeight="800" letterSpacing="-1">
                      <tspan fill="white" style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))' }}>oh</tspan>
                      <tspan fill="#60a5fa" style={{ filter: 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))' }}>Yaaa</tspan>
                    </text>
                    
                    <defs>
                      <linearGradient id="heroGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stopColor="#ef4444"/>
                        <stop offset="100%" stopColor="#22c55e"/>
                      </linearGradient>
                    </defs>
                  </svg>
                </div>
                <p className="text-slate-400 mt-3 text-lg">Your trading journey starts here</p>
              </div>

              {/* Glass card */}
              <div className="backdrop-blur-xl bg-white/10 rounded-3xl shadow-2xl border border-white/20 overflow-hidden">
                {/* Tab navigation */}
                {(mode === 'login' || mode === 'signup') && (
                  <div className="flex border-b border-white/10">
                    <button
                      onClick={() => { setMode('login'); setError(''); setMessage(''); }}
                      className={`flex-1 py-4 text-sm font-semibold transition-all ${
                        mode === 'login' 
                          ? 'text-white bg-white/10 border-b-2 border-blue-400' 
                          : 'text-slate-400 hover:text-white hover:bg-white/5'
                      }`}
                    >
                      Sign In
                    </button>
                    <button
                      onClick={() => { setMode('signup'); setError(''); setMessage(''); }}
                      className={`flex-1 py-4 text-sm font-semibold transition-all ${
                        mode === 'signup' 
                          ? 'text-white bg-white/10 border-b-2 border-blue-400' 
                          : 'text-slate-400 hover:text-white hover:bg-white/5'
                      }`}
                    >
                      Create Account
                    </button>
                  </div>
                )}

                {mode === 'reset' && (
                  <div className="px-8 pt-6 pb-2">
                    <button
                      onClick={() => { setMode('login'); setError(''); setMessage(''); }}
                      className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm"
                    >
                      <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" />
                      </svg>
                      Back to sign in
                    </button>
                    <h2 className="text-xl font-bold text-white mt-4">Reset Password</h2>
                    <p className="text-slate-400 text-sm mt-1">Enter your email to receive a reset link</p>
                  </div>
                )}

                {mode === 'verify' && (
                  <div className="px-8 pt-6 pb-2 text-center">
                    <h2 className="text-xl font-bold text-white">Verify Your Email</h2>
                  </div>
                )}

                {/* Form */}
                <div className="p-8">
                  {error && (
                    <div className="mb-6 p-4 bg-red-500/20 border border-red-500/30 rounded-xl text-red-200 text-sm flex items-center gap-3">
                      <svg className="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                      </svg>
                      {error}
                    </div>
                  )}

                  {message && (
                    <div className="mb-6 p-4 bg-emerald-500/20 border border-emerald-500/30 rounded-xl text-emerald-200 text-sm flex items-center gap-3">
                      <svg className="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                      </svg>
                      {message}
                    </div>
                  )}

                  {mode === 'login' && (
                    <form onSubmit={handleLogin} className="space-y-5">
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg className="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                          </div>
                          <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                            placeholder="you@example.com"
                            required
                          />
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Password</label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg className="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                              <path d="M7 11V7a5 5 0 0110 0v4" />
                            </svg>
                          </div>
                          <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                          />
                        </div>
                      </div>
                      <div className="flex justify-end">
                        <button
                          type="button"
                          onClick={() => { setMode('reset'); setError(''); setMessage(''); }}
                          className="text-sm text-blue-400 hover:text-blue-300 transition-colors"
                        >
                          Forgot password?
                        </button>
                      </div>
                      <button
                        type="submit"
                        disabled={loading}
                        className="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-semibold hover:from-blue-500 hover:to-blue-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
                      >
                        {loading ? (
                          <>
                            <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                            Signing in...
                          </>
                        ) : (
                          <>
                            Sign In
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                          </>
                        )}
                      </button>
                    </form>
                  )}

                  {mode === 'signup' && (
                    <form onSubmit={handleSignup} className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Name</label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg className="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                          </div>
                          <input
                            type="text"
                            value={displayName}
                            onChange={(e) => setDisplayName(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                            placeholder="John Doe"
                            required
                          />
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg className="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                          </div>
                          <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                            placeholder="you@example.com"
                            required
                          />
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2">Password</label>
                          <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className={`w-full px-4 py-3 bg-white/5 border rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all ${
                              password && !passwordValidation.isValid ? 'border-amber-500/50' : 'border-white/10'
                            }`}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2">Confirm</label>
                          <input
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            className={`w-full px-4 py-3 bg-white/5 border rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 transition-all ${
                              confirmPassword && password !== confirmPassword ? 'border-red-500/50' : 'border-white/10'
                            }`}
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                          />
                        </div>
                      </div>

                      {/* Password Requirements */}
                      {password && (
                        <div className="bg-white/5 rounded-xl p-3 border border-white/10">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-xs font-medium text-slate-400">Password Strength</span>
                            <span className={`text-xs font-semibold ${
                              passwordValidation.passed >= 4 ? 'text-emerald-400' : 
                              passwordValidation.passed >= 2 ? 'text-amber-400' : 'text-red-400'
                            }`}>
                              {passwordValidation.passed >= 4 ? 'Strong' : passwordValidation.passed >= 2 ? 'Medium' : 'Weak'}
                            </span>
                          </div>
                          <div className="h-1.5 bg-white/10 rounded-full overflow-hidden mb-3">
                            <div 
                              className={`h-full transition-all duration-300 ${
                                passwordValidation.passed >= 4 ? 'bg-emerald-500' : 
                                passwordValidation.passed >= 2 ? 'bg-amber-500' : 'bg-red-500'
                              }`}
                              style={{ width: `${(passwordValidation.passed / 5) * 100}%` }}
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                            <div className={`flex items-center gap-1.5 text-xs ${passwordValidation.requirements.length ? 'text-emerald-400' : 'text-slate-500'}`}>
                              {passwordValidation.requirements.length ? '‚úì' : '‚óã'} 8+ characters
                            </div>
                            <div className={`flex items-center gap-1.5 text-xs ${passwordValidation.requirements.uppercase ? 'text-emerald-400' : 'text-slate-500'}`}>
                              {passwordValidation.requirements.uppercase ? '‚úì' : '‚óã'} Uppercase
                            </div>
                            <div className={`flex items-center gap-1.5 text-xs ${passwordValidation.requirements.lowercase ? 'text-emerald-400' : 'text-slate-500'}`}>
                              {passwordValidation.requirements.lowercase ? '‚úì' : '‚óã'} Lowercase
                            </div>
                            <div className={`flex items-center gap-1.5 text-xs ${passwordValidation.requirements.number ? 'text-emerald-400' : 'text-slate-500'}`}>
                              {passwordValidation.requirements.number ? '‚úì' : '‚óã'} Number
                            </div>
                            <div className={`flex items-center gap-1.5 text-xs ${passwordValidation.requirements.special ? 'text-emerald-400' : 'text-slate-500'}`}>
                              {passwordValidation.requirements.special ? '‚úì' : '‚óã'} Special char
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Password Match Indicator */}
                      {confirmPassword && password !== confirmPassword && (
                        <p className="text-red-400 text-xs flex items-center gap-1">
                          <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="8" x2="12" y2="12" />
                            <line x1="12" y1="16" x2="12.01" y2="16" />
                          </svg>
                          Passwords do not match
                        </p>
                      )}

                      {/* Account Type Selection */}
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-3">I am a...</label>
                        <div className="grid grid-cols-2 gap-3">
                          <button
                            type="button"
                            onClick={() => setAccountType('trader')}
                            className={`p-4 rounded-xl border-2 transition-all ${
                              accountType === 'trader'
                                ? 'border-blue-500 bg-blue-500/20 text-white'
                                : 'border-white/10 bg-white/5 text-slate-400 hover:border-white/20 hover:bg-white/10'
                            }`}
                          >
                            <div className="text-3xl mb-2">üìà</div>
                            <div className="font-semibold">Trader</div>
                            <div className="text-xs opacity-70 mt-1">Track & improve</div>
                          </button>
                          <button
                            type="button"
                            onClick={() => setAccountType('mentor')}
                            className={`p-4 rounded-xl border-2 transition-all ${
                              accountType === 'mentor'
                                ? 'border-blue-500 bg-blue-500/20 text-white'
                                : 'border-white/10 bg-white/5 text-slate-400 hover:border-white/20 hover:bg-white/10'
                            }`}
                          >
                            <div className="text-3xl mb-2">üéØ</div>
                            <div className="font-semibold">Mentor</div>
                            <div className="text-xs opacity-70 mt-1">Guide students</div>
                          </button>
                        </div>
                      </div>

                      <button
                        type="submit"
                        disabled={loading || !passwordValidation.isValid || password !== confirmPassword}
                        className="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-xl font-semibold hover:from-emerald-500 hover:to-emerald-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25 flex items-center justify-center gap-2 mt-2"
                      >
                        {loading ? (
                          <>
                            <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                            Creating account...
                          </>
                        ) : (
                          <>
                            Get Started
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                          </>
                        )}
                      </button>
                    </form>
                  )}

                  {/* Email Verification Screen */}
                  {mode === 'verify' && (
                    <div className="text-center py-4">
                      <div className="w-20 h-20 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg className="w-10 h-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                          <path strokeLinecap="round" strokeLinejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                      </div>
                      <h3 className="text-xl font-bold text-white mb-2">Enter Verification Code</h3>
                      <p className="text-slate-400 mb-2">
                        We sent a 6-digit code to
                      </p>
                      <p className="text-white font-medium mb-6">{email}</p>
                      
                      {/* 6-digit code input */}
                      <div className="flex justify-center gap-2 mb-6">
                        {verificationCode.map((digit, index) => (
                          <input
                            key={index}
                            ref={codeInputRefs[index]}
                            type="text"
                            inputMode="numeric"
                            maxLength={6}
                            value={digit}
                            onChange={(e) => handleCodeChange(index, e.target.value)}
                            onKeyDown={(e) => handleCodeKeyDown(index, e)}
                            onPaste={(e) => {
                              e.preventDefault();
                              const pastedData = e.clipboardData.getData('text');
                              handleCodeChange(index, pastedData);
                            }}
                            className="w-12 h-14 text-center text-2xl font-bold bg-white/5 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all"
                          />
                        ))}
                      </div>

                      <p className="text-sm text-slate-500 mb-6">
                        Code expires in 10 minutes
                      </p>
                      
                      <div className="space-y-3">
                        <button
                          onClick={handleVerifyCode}
                          disabled={loading || verificationCode.join('').length !== 6}
                          className="w-full py-3.5 bg-gradient-to-r from-emerald-600 to-emerald-500 text-white rounded-xl font-semibold hover:from-emerald-500 hover:to-emerald-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-emerald-500/25 flex items-center justify-center gap-2"
                        >
                          {loading ? (
                            <>
                              <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                              Verifying...
                            </>
                          ) : (
                            <>
                              Verify Email
                              <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                              </svg>
                            </>
                          )}
                        </button>
                        <button
                          onClick={handleResendVerification}
                          disabled={loading}
                          className="w-full py-3 bg-white/5 border border-white/10 text-slate-300 rounded-xl font-medium hover:bg-white/10 transition-all disabled:opacity-50"
                        >
                          {loading ? 'Sending...' : 'Resend Code'}
                        </button>
                        <button
                          onClick={() => { setMode('login'); setError(''); setMessage(''); setVerificationCode(['', '', '', '', '', '']); }}
                          className="w-full py-2 text-slate-500 hover:text-slate-300 text-sm transition-colors"
                        >
                          Back to Sign In
                        </button>
                      </div>
                    </div>
                  )}

                  {mode === 'reset' && (
                    <form onSubmit={handleReset} className="space-y-5">
                      <div>
                        <label className="block text-sm font-medium text-slate-300 mb-2">Email</label>
                        <div className="relative">
                          <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <svg className="w-5 h-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                          </div>
                          <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full pl-12 pr-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all"
                            placeholder="you@example.com"
                            required
                          />
                        </div>
                      </div>
                      <button
                        type="submit"
                        disabled={loading}
                        className="w-full py-3.5 bg-gradient-to-r from-blue-600 to-blue-500 text-white rounded-xl font-semibold hover:from-blue-500 hover:to-blue-400 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
                      >
                        {loading ? (
                          <>
                            <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                            Sending...
                          </>
                        ) : (
                          <>
                            Send Reset Link
                            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                              <path strokeLinecap="round" strokeLinejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                          </>
                        )}
                      </button>
                    </form>
                  )}
                </div>
              </div>

              {/* Bottom tagline */}
              <div className="text-center mt-8">
                <p className="text-slate-500 text-sm">
                  Track trades ‚Ä¢ Analyze performance ‚Ä¢ Grow profits
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // CHECK-INS PAGE (Student's view of their weekly check-ins)
    // =============================================================================
    function CheckinsPage({ 
      checkins, 
      userProfile,
      isMobile,
    }) {
      const [expandedCheckin, setExpandedCheckin] = useState(null);

      // Get the most recent check-in
      const latestCheckin = checkins[0];
      const olderCheckins = checkins.slice(1);

      // Find current week's focus from most recent check-in
      const currentFocus = latestCheckin?.focusForNextWeek;

      if (!userProfile?.mentorId) {
        return (
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
              üìÖ
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">No Check-ins</h3>
            <p className="text-gray-500">Connect with a mentor to receive weekly check-ins and feedback.</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Weekly Check-ins</h1>
            <p className="text-sm text-gray-500 mt-1">
              From your mentor: {userProfile.mentorName}
            </p>
          </div>

          {/* Current Focus Banner */}
          {currentFocus && (
            <div className="bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl p-4 text-white">
              <div className="flex items-center gap-2 mb-1">
                <span className="text-xl">üî•</span>
                <h2 className="font-semibold">This Week's Focus</h2>
              </div>
              <p className="text-orange-100">{currentFocus}</p>
            </div>
          )}

          {/* Latest Check-in */}
          {latestCheckin ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 className="font-semibold text-gray-900">
                  Latest: Week of {formatWeekRange(latestCheckin.weekStart, latestCheckin.weekEnd)}
                </h2>
              </div>
              <div className="p-6 space-y-4">
                {/* Stats */}
                {latestCheckin.stats && latestCheckin.stats.totalTrades > 0 && (
                  <div className="space-y-4">
                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Week P&L</p>
                        <p className={`text-lg font-bold ${(latestCheckin.stats.totalPnL || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {formatCurrency(latestCheckin.stats.totalPnL || 0)}
                        </p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1"># Trades</p>
                        <p className="text-lg font-bold text-gray-900">{latestCheckin.stats.totalTrades}</p>
                        <p className="text-[10px] text-gray-500">{latestCheckin.stats.tradingDays || 0} days</p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Win Rate</p>
                        <p className="text-lg font-bold text-gray-900">{(latestCheckin.stats.winRate || 0).toFixed(0)}%</p>
                        <p className="text-[10px] text-gray-500">
                          <span className="text-emerald-600">{latestCheckin.stats.wins || 0}W</span>
                          {' / '}
                          <span className="text-red-600">{latestCheckin.stats.losses || 0}L</span>
                        </p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">R:R Ratio</p>
                        <p className="text-lg font-bold text-gray-900">{latestCheckin.stats.riskRewardRatio || '0.00'}:1</p>
                      </div>
                    </div>

                    {/* Second row */}
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Avg Win</p>
                        <p className="text-lg font-bold text-emerald-600">{formatCurrencyShort(latestCheckin.stats.avgWin || 0)}</p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Avg Loss</p>
                        <p className="text-lg font-bold text-red-600">-{formatCurrencyShort(latestCheckin.stats.avgLoss || 0)}</p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Days</p>
                        <p className="text-lg font-bold text-gray-900">
                          <span className="text-emerald-600">{latestCheckin.stats.greenDays || 0}üü¢</span>
                          {' '}
                          <span className="text-red-600">{latestCheckin.stats.redDays || 0}üî¥</span>
                        </p>
                      </div>
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1">Avg Rating</p>
                        {latestCheckin.stats.ratedTradesCount > 0 ? (
                          <div className="flex items-center gap-1">
                            <span className="text-lg font-bold text-gray-900">{(latestCheckin.stats.avgRating || 0).toFixed(1)}</span>
                            <span className="text-amber-400">‚òÖ</span>
                          </div>
                        ) : (
                          <p className="text-sm text-gray-400">No ratings</p>
                        )}
                      </div>
                    </div>

                    {/* Daily Breakdown */}
                    {latestCheckin.stats.dailyBreakdown && latestCheckin.stats.dailyBreakdown.length > 0 && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs font-medium text-gray-700 mb-2">üìÖ Daily Breakdown</p>
                        <div className="space-y-1">
                          {latestCheckin.stats.dailyBreakdown.map(day => (
                            <div key={day.date} className="flex items-center justify-between text-sm">
                              <span className="text-gray-600">{new Date(day.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</span>
                              <div className="flex items-center gap-3">
                                <span className="text-gray-500">{day.trades} trades</span>
                                <span className="text-gray-500">{day.winRate}% WR</span>
                                <span className={`font-medium ${day.pnl >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                  {formatCurrency(day.pnl)}
                                </span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Setups Used */}
                    {latestCheckin.stats.setupData && latestCheckin.stats.setupData.length > 0 && (
                      <div className="bg-gray-50 rounded-lg p-3">
                        <p className="text-xs font-medium text-gray-700 mb-2">üéØ Setups Used</p>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-gray-500">
                                <th className="pb-1">Setup</th>
                                <th className="pb-1 text-center">Trades</th>
                                <th className="pb-1 text-center">W/L</th>
                                <th className="pb-1 text-center">WR</th>
                                <th className="pb-1 text-right">P&L</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                              {latestCheckin.stats.setupData.map(s => (
                                <tr key={s.id}>
                                  <td className="py-1 font-medium text-gray-900">{s.name}</td>
                                  <td className="py-1 text-center text-gray-600">{s.total}</td>
                                  <td className="py-1 text-center">
                                    <span className="text-emerald-600">{s.wins}</span>/<span className="text-red-600">{s.losses}</span>
                                  </td>
                                  <td className="py-1 text-center text-gray-600">{s.winRate}%</td>
                                  <td className={`py-1 text-right font-medium ${s.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {formatCurrency(s.totalPnL)}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}

                    {/* Mistakes */}
                    {latestCheckin.stats.mistakeData && latestCheckin.stats.mistakeData.length > 0 && (
                      <div className="bg-red-50 rounded-lg p-3">
                        <p className="text-xs font-medium text-red-700 mb-2">
                          ‚ö†Ô∏è Mistakes ({latestCheckin.stats.totalMistakeOccurrences || 0} occurrences, {formatCurrency(latestCheckin.stats.totalMistakeLoss || 0)} cost)
                        </p>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-red-600">
                                <th className="pb-1">Mistake</th>
                                <th className="pb-1 text-center">Count</th>
                                <th className="pb-1 text-center">Loss/Win</th>
                                <th className="pb-1 text-right">Cost</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-red-100">
                              {latestCheckin.stats.mistakeData.map(m => (
                                <tr key={m.id}>
                                  <td className="py-1 font-medium text-gray-900">{m.name}</td>
                                  <td className="py-1 text-center text-gray-600">{m.totalOccurrences}</td>
                                  <td className="py-1 text-center">
                                    <span className="text-red-600">{m.losingTrades}</span>/<span className="text-emerald-600">{m.profitableTrades}</span>
                                  </td>
                                  <td className="py-1 text-right font-medium text-red-600">
                                    {formatCurrency(m.totalLossAmount)}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Summary */}
                {latestCheckin.summary && (
                  <div>
                    <h3 className="text-sm font-medium text-gray-700 mb-1">Summary</h3>
                    <p className="text-gray-600 whitespace-pre-wrap">{latestCheckin.summary}</p>
                  </div>
                )}

                {/* What Went Well */}
                {latestCheckin.whatWentWell && (
                  <div className="bg-emerald-50 rounded-lg p-4">
                    <h3 className="text-sm font-medium text-emerald-700 mb-1">üí™ What Went Well</h3>
                    <p className="text-emerald-800 whitespace-pre-wrap">{latestCheckin.whatWentWell}</p>
                  </div>
                )}

                {/* Areas to Improve */}
                {latestCheckin.areasToImprove && (
                  <div className="bg-amber-50 rounded-lg p-4">
                    <h3 className="text-sm font-medium text-amber-700 mb-1">üéØ Areas to Improve</h3>
                    <p className="text-amber-800 whitespace-pre-wrap">{latestCheckin.areasToImprove}</p>
                  </div>
                )}
              </div>
            </div>
          ) : (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                üìÖ
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">No check-ins yet</h3>
              <p className="text-gray-500">Your mentor will post weekly check-ins to track your progress.</p>
            </div>
          )}

          {/* Previous Check-ins */}
          {olderCheckins.length > 0 && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200">
                <h2 className="font-semibold text-gray-900">Previous Check-ins ({olderCheckins.length})</h2>
              </div>
              <div className="divide-y divide-gray-100">
                {olderCheckins.map(checkin => {
                  const isExpanded = expandedCheckin === checkin.id;
                  const stats = checkin.stats || {};
                  
                  return (
                    <div key={checkin.id} className="p-4">
                      <button
                        onClick={() => setExpandedCheckin(isExpanded ? null : checkin.id)}
                        className="w-full flex items-center justify-between text-left"
                      >
                        <div>
                          <h3 className="font-medium text-gray-900">
                            Week of {formatWeekRange(checkin.weekStart, checkin.weekEnd)}
                          </h3>
                          <div className="flex items-center gap-3 mt-1 text-sm text-gray-500">
                            <span>{stats.totalTrades || 0} trades</span>
                            <span>|</span>
                            <span>{(stats.winRate || 0).toFixed(0)}% WR</span>
                            <span>|</span>
                            <span className={(stats.totalPnL || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}>
                              {formatCurrency(stats.totalPnL || 0)}
                            </span>
                          </div>
                        </div>
                        <svg 
                          className={`w-5 h-5 text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                          fill="none" 
                          stroke="currentColor" 
                          viewBox="0 0 24 24"
                        >
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>

                      {isExpanded && (
                        <div className="mt-4 space-y-3 pl-4 border-l-2 border-gray-200">
                          {checkin.summary && (
                            <div>
                              <h4 className="text-xs font-medium text-gray-500 mb-1">Summary</h4>
                              <p className="text-sm text-gray-600">{checkin.summary}</p>
                            </div>
                          )}
                          {checkin.whatWentWell && (
                            <div>
                              <h4 className="text-xs font-medium text-emerald-600 mb-1">üí™ What Went Well</h4>
                              <p className="text-sm text-gray-600">{checkin.whatWentWell}</p>
                            </div>
                          )}
                          {checkin.areasToImprove && (
                            <div>
                              <h4 className="text-xs font-medium text-amber-600 mb-1">üéØ Areas to Improve</h4>
                              <p className="text-sm text-gray-600">{checkin.areasToImprove}</p>
                            </div>
                          )}
                          {checkin.focusForNextWeek && (
                            <div>
                              <h4 className="text-xs font-medium text-orange-600 mb-1">üî• Focus</h4>
                              <p className="text-sm text-gray-600">{checkin.focusForNextWeek}</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // SESSIONS PAGE (Student's view of their sessions)
    // =============================================================================
    function SessionsPage({ 
      sessions, 
      userProfile,
      isMobile,
    }) {
      if (!userProfile?.mentorId) {
        return (
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
              üìÖ
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">No Sessions</h3>
            <p className="text-gray-500">Connect with a mentor to schedule review sessions.</p>
          </div>
        );
      }

      const formatDateTime = (timestamp) => {
        if (!timestamp?.toDate) return 'Unknown';
        const date = timestamp.toDate();
        return date.toLocaleDateString('en-US', { 
          weekday: 'long',
          month: 'long', 
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
        });
      };

      const getStatusBadge = (status) => {
        switch (status) {
          case 'requested':
            return <span className="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded">Requested</span>;
          case 'confirmed':
            return <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded">Confirmed</span>;
          case 'completed':
            return <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Completed</span>;
          case 'cancelled':
            return <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-500 rounded">Cancelled</span>;
          default:
            return null;
        }
      };

      // Split sessions
      const now = new Date();
      const upcomingSessions = sessions
        .filter(s => s.dateTime?.toDate && s.dateTime.toDate() >= now && s.status !== 'cancelled' && s.status !== 'completed')
        .sort((a, b) => a.dateTime.toDate() - b.dateTime.toDate());
      
      const pastSessions = sessions
        .filter(s => s.dateTime?.toDate && (s.dateTime.toDate() < now || s.status === 'completed' || s.status === 'cancelled'))
        .sort((a, b) => b.dateTime.toDate() - a.dateTime.toDate());

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Sessions</h1>
            <p className="text-sm text-gray-500 mt-1">
              Review sessions with your mentor: {userProfile.mentorName}
            </p>
          </div>

          {/* Upcoming Sessions */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
              <h2 className="font-semibold text-gray-900 flex items-center gap-2">
                <span>üìÜ</span>
                <span>Upcoming Sessions</span>
                {upcomingSessions.length > 0 && (
                  <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-medium">
                    {upcomingSessions.length}
                  </span>
                )}
              </h2>
            </div>
            
            {upcomingSessions.length === 0 ? (
              <div className="px-6 py-8 text-center text-gray-500">
                <p>No upcoming sessions scheduled</p>
                <p className="text-sm mt-1">Your mentor will schedule sessions when needed</p>
              </div>
            ) : (
              <div className="divide-y divide-gray-100">
                {upcomingSessions.map(session => (
                  <div key={session.id} className="px-6 py-4">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-semibold text-gray-900">{formatDateTime(session.dateTime)}</span>
                          {getStatusBadge(session.status)}
                        </div>
                        <p className="text-gray-600">{session.topic}</p>
                        <p className="text-sm text-gray-500 mt-1">Duration: {session.duration} minutes</p>
                        {session.videoLink && (
                          <a 
                            href={session.videoLink} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-1 mt-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700"
                          >
                            üîó Join Video Call
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Past Sessions */}
          {pastSessions.length > 0 && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200">
                <h2 className="font-semibold text-gray-900 flex items-center gap-2">
                  <span>üìã</span>
                  <span>Past Sessions</span>
                </h2>
              </div>
              
              <div className="divide-y divide-gray-100">
                {pastSessions.map(session => (
                  <div key={session.id} className="px-6 py-4">
                    <div className="flex items-start gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`font-medium ${session.status === 'cancelled' ? 'text-gray-400 line-through' : 'text-gray-900'}`}>
                            {formatDateTime(session.dateTime)}
                          </span>
                          {getStatusBadge(session.status)}
                        </div>
                        <p className={session.status === 'cancelled' ? 'text-gray-400' : 'text-gray-600'}>{session.topic}</p>
                        {session.notes && (
                          <div className="mt-2 p-3 bg-green-50 rounded-lg border border-green-100">
                            <p className="text-sm font-medium text-green-800 mb-1">üìù Session Notes:</p>
                            <p className="text-sm text-green-700">{session.notes}</p>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // ASSIGNMENTS PAGE (Student's view of their assignments)
    // =============================================================================
    function AssignmentsPage({ 
      assignments, 
      journalState,
      userProfile,
      isMobile,
      onUpdateAssignment,
    }) {
      const [viewingAssignment, setViewingAssignment] = useState(null);
      const [notesText, setNotesText] = useState('');
      const [filter, setFilter] = useState('active');

      // Calculate challenge progress
      const calculateChallengeProgress = (challenge, trades) => {
        if (!challenge || !trades) return { current: 0, progress: 0, status: 'active' };

        const startDate = challenge.startDate;
        const endDate = challenge.endDate || todayISO();
        
        const relevantTrades = trades.filter(t => 
          t.entryDate >= startDate && t.entryDate <= endDate
        ).map(t => ({ ...t, derived: calcTradeDerived(t) }));

        const closedTrades = relevantTrades.filter(t => !t.derived.isOpen);

        switch (challenge.type) {
          case 'profit':
            const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
            return { 
              current: totalPnL, 
              progress: Math.min(100, (totalPnL / challenge.target) * 100),
              status: totalPnL >= challenge.target ? 'completed' : 'active'
            };
            
          case 'winrate':
            const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
            const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length) * 100 : 0;
            const tradesNeeded = challenge.tradesRequired || 20;
            return { 
              current: winRate,
              tradesCompleted: closedTrades.length,
              tradesRequired: tradesNeeded,
              progress: Math.min(100, (closedTrades.length / tradesNeeded) * 100),
              status: closedTrades.length >= tradesNeeded ? (winRate >= challenge.target ? 'completed' : 'failed') : 'active'
            };
            
          case 'trades':
            return { 
              current: relevantTrades.length, 
              progress: Math.min(100, (relevantTrades.length / challenge.target) * 100),
              status: relevantTrades.length >= challenge.target ? 'completed' : 'active'
            };
            
          case 'streak':
            const dailyPnL = {};
            closedTrades.forEach(t => {
              const date = t.exitDate || t.entryDate;
              dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
            });
            const sortedDays = Object.keys(dailyPnL).sort();
            let maxStreak = 0, currentStreak = 0;
            sortedDays.forEach(day => {
              if (dailyPnL[day] > 0) {
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);
              } else {
                currentStreak = 0;
              }
            });
            return { 
              current: maxStreak, 
              progress: Math.min(100, (maxStreak / challenge.target) * 100),
              status: maxStreak >= challenge.target ? 'completed' : 'active'
            };
            
          case 'max_loss':
            const losses = closedTrades.filter(t => (t.derived.pnlFinal || 0) < 0);
            const maxLoss = losses.length > 0 ? Math.min(...losses.map(t => t.derived.pnlFinal)) : 0;
            const withinLimit = Math.abs(maxLoss) <= challenge.target;
            return { 
              current: maxLoss, 
              progress: withinLimit ? 100 : 0,
              status: withinLimit ? 'active' : 'failed'
            };
            
          default:
            return { current: 0, progress: 0, status: 'active' };
        }
      };

      // Filter assignments
      const activeAssignments = assignments.filter(a => ['assigned', 'in_progress'].includes(a.status));
      const completedAssignments = assignments.filter(a => ['completed', 'reviewed'].includes(a.status));
      const filteredAssignments = filter === 'active' ? activeAssignments : completedAssignments;

      // Get days until due
      const getDaysUntilDue = (dueDate) => {
        if (!dueDate) return null;
        const today = new Date(todayISO());
        const due = new Date(dueDate);
        const diffTime = due - today;
        return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      };

      const handleStartWorking = async (assignment) => {
        if (assignment.status === 'assigned') {
          await onUpdateAssignment(assignment.id, { status: 'in_progress' });
        }
      };

      const handleSaveNotes = async (assignmentId) => {
        await onUpdateAssignment(assignmentId, { studentNotes: notesText });
      };

      const handleMarkComplete = async (assignmentId) => {
        await onUpdateAssignment(assignmentId, { 
          status: 'completed',
          completedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        setViewingAssignment(null);
      };

      if (!userProfile?.mentorId) {
        return (
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
            <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
              üìã
            </div>
            <h3 className="text-lg font-medium text-gray-900 mb-2">No Assignments</h3>
            <p className="text-gray-500">Connect with a mentor to receive assignments and guidance.</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">My Assignments</h1>
            <p className="text-sm text-gray-500 mt-1">
              From your mentor: {userProfile.mentorName}
            </p>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
              <p className="text-sm text-gray-500">Active</p>
              <p className="text-2xl font-bold text-blue-600">{activeAssignments.length}</p>
            </div>
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
              <p className="text-sm text-gray-500">Completed</p>
              <p className="text-2xl font-bold text-green-600">{completedAssignments.length}</p>
            </div>
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
              <p className="text-sm text-gray-500">With Challenges</p>
              <p className="text-2xl font-bold text-purple-600">{assignments.filter(a => a.hasChallenge).length}</p>
            </div>
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
              <p className="text-sm text-gray-500">Due Soon</p>
              <p className="text-2xl font-bold text-orange-600">
                {activeAssignments.filter(a => {
                  const days = getDaysUntilDue(a.dueDate);
                  return days !== null && days <= 3 && days >= 0;
                }).length}
              </p>
            </div>
          </div>

          {/* Filter Tabs */}
          <div className="flex gap-2">
            <button
              onClick={() => setFilter('active')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filter === 'active'
                  ? 'bg-blue-100 text-blue-700'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Active ({activeAssignments.length})
            </button>
            <button
              onClick={() => setFilter('completed')}
              className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                filter === 'completed'
                  ? 'bg-green-100 text-green-700'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              Completed ({completedAssignments.length})
            </button>
          </div>

          {/* Assignments List */}
          {filteredAssignments.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                {filter === 'active' ? 'üìã' : '‚úÖ'}
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                {filter === 'active' ? 'No active assignments' : 'No completed assignments yet'}
              </h3>
              <p className="text-gray-500">
                {filter === 'active' 
                  ? 'Your mentor will assign tasks to help your trading development.'
                  : 'Complete assignments to see them here.'}
              </p>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredAssignments.map(assignment => {
                const catInfo = ASSIGNMENT_CATEGORIES[assignment.category] || ASSIGNMENT_CATEGORIES.other;
                const daysUntil = getDaysUntilDue(assignment.dueDate);
                const challengeProgress = assignment.hasChallenge && assignment.challenge
                  ? calculateChallengeProgress(assignment.challenge, journalState?.trades || [])
                  : null;

                return (
                  <div 
                    key={assignment.id}
                    className={`bg-white rounded-xl border shadow-sm p-4 cursor-pointer transition-colors ${
                      assignment.status === 'reviewed' 
                        ? 'border-purple-200 bg-purple-50/30' 
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                    onClick={() => {
                      setViewingAssignment(assignment);
                      setNotesText(assignment.studentNotes || '');
                      handleStartWorking(assignment);
                    }}
                  >
                    <div className="flex items-start gap-3">
                      {/* Category Icon */}
                      <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${catInfo.bgColor}`}>
                        {catInfo.icon}
                      </div>

                      <div className="flex-1 min-w-0">
                        {/* Title & Status */}
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="font-semibold text-gray-900 truncate">{assignment.title}</h3>
                          <span className={`px-2 py-0.5 text-xs rounded-full font-medium ${
                            assignment.status === 'assigned' ? 'bg-gray-100 text-gray-600' :
                            assignment.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                            assignment.status === 'completed' ? 'bg-green-100 text-green-700' :
                            'bg-purple-100 text-purple-700'
                          }`}>
                            {assignment.status === 'in_progress' ? 'In Progress' : 
                             assignment.status === 'reviewed' ? '‚úì Reviewed' :
                             assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}
                          </span>
                        </div>

                        {/* Due Date */}
                        {assignment.dueDate && filter === 'active' && (
                          <p className={`text-sm ${
                            daysUntil !== null && daysUntil < 0 ? 'text-red-600 font-medium' :
                            daysUntil !== null && daysUntil <= 3 ? 'text-orange-600' :
                            'text-gray-500'
                          }`}>
                            {daysUntil !== null && daysUntil < 0 
                              ? `‚ö†Ô∏è ${Math.abs(daysUntil)} days overdue`
                              : daysUntil === 0 
                                ? '‚è∞ Due today!'
                                : `Due: ${assignment.dueDate} (${daysUntil} day${daysUntil !== 1 ? 's' : ''} left)`
                            }
                          </p>
                        )}

                        {/* Challenge Progress */}
                        {assignment.hasChallenge && challengeProgress && (
                          <div className="mt-3">
                            <div className="flex items-center justify-between text-sm mb-1">
                              <span className="text-gray-600">
                                {HOMEWORK_CHALLENGE_TYPES[assignment.challenge.type]?.label}
                              </span>
                              <span className={`font-medium ${
                                challengeProgress.status === 'completed' ? 'text-green-600' :
                                challengeProgress.status === 'failed' ? 'text-red-600' :
                                'text-blue-600'
                              }`}>
                                {Math.round(challengeProgress.progress)}%
                              </span>
                            </div>
                            <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  challengeProgress.status === 'completed' ? 'bg-green-500' :
                                  challengeProgress.status === 'failed' ? 'bg-red-500' :
                                  'bg-blue-500'
                                }`}
                                style={{ width: `${Math.min(100, challengeProgress.progress)}%` }}
                              />
                            </div>
                          </div>
                        )}

                        {/* Mentor Review Badge */}
                        {assignment.mentorReview && (
                          <div className="mt-2 flex items-center gap-1 text-sm text-purple-600">
                            <span>üí¨</span>
                            <span>Mentor reviewed this</span>
                          </div>
                        )}
                      </div>

                      {/* Arrow */}
                      <svg className="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                      </svg>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* View Assignment Modal */}
          {viewingAssignment && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setViewingAssignment(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl flex items-center justify-between">
                    <h2 className="text-lg font-semibold text-gray-900">Assignment Details</h2>
                    <button onClick={() => setViewingAssignment(null)} className="p-2 hover:bg-gray-100 rounded-lg">
                      {Icons.x}
                    </button>
                  </div>
                  <div className="p-6 space-y-4">
                    {/* Header */}
                    <div className="flex items-start gap-3">
                      <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${
                        ASSIGNMENT_CATEGORIES[viewingAssignment.category]?.bgColor || 'bg-gray-100'
                      }`}>
                        {ASSIGNMENT_CATEGORIES[viewingAssignment.category]?.icon || 'üìù'}
                      </div>
                      <div>
                        <h3 className="text-xl font-semibold text-gray-900">{viewingAssignment.title}</h3>
                        <p className="text-sm text-gray-500">
                          From {viewingAssignment.mentorName}
                        </p>
                      </div>
                    </div>

                    {/* Description */}
                    {viewingAssignment.description && (
                      <div className="bg-gray-50 rounded-lg p-4">
                        <p className="text-gray-700 whitespace-pre-wrap">{viewingAssignment.description}</p>
                      </div>
                    )}

                    {/* Challenge Progress */}
                    {viewingAssignment.hasChallenge && viewingAssignment.challenge && (
                      <div className="bg-blue-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-blue-700 mb-2">üìä Challenge Progress</h4>
                        {(() => {
                          const progress = calculateChallengeProgress(viewingAssignment.challenge, journalState?.trades || []);
                          return (
                            <>
                              <p className="text-sm text-blue-600 mb-2">
                                {HOMEWORK_CHALLENGE_TYPES[viewingAssignment.challenge.type]?.label}: 
                                {viewingAssignment.challenge.type === 'winrate' 
                                  ? ` ${viewingAssignment.challenge.target}% over ${viewingAssignment.challenge.tradesRequired} trades`
                                  : ` ${viewingAssignment.challenge.target} ${HOMEWORK_CHALLENGE_TYPES[viewingAssignment.challenge.type]?.unit || ''}`
                                }
                              </p>
                              <div className="h-3 bg-blue-200 rounded-full overflow-hidden mb-2">
                                <div 
                                  className={`h-full ${
                                    progress.status === 'completed' ? 'bg-green-500' :
                                    progress.status === 'failed' ? 'bg-red-500' :
                                    'bg-blue-500'
                                  }`}
                                  style={{ width: `${Math.min(100, progress.progress)}%` }}
                                />
                              </div>
                              <p className="text-sm font-medium text-blue-900">
                                Current: {viewingAssignment.challenge.type === 'profit' || viewingAssignment.challenge.type === 'max_loss'
                                  ? formatCurrency(progress.current)
                                  : viewingAssignment.challenge.type === 'winrate'
                                    ? `${progress.current?.toFixed(1)}% (${progress.tradesCompleted}/${progress.tradesRequired} trades)`
                                    : progress.current
                                }
                                {' '}
                                <span className={`${
                                  progress.status === 'completed' ? 'text-green-600' :
                                  progress.status === 'failed' ? 'text-red-600' :
                                  'text-blue-600'
                                }`}>
                                  ({progress.status === 'completed' ? '‚úì Complete!' :
                                    progress.status === 'failed' ? '‚úó Not met' :
                                    `${Math.round(progress.progress)}%`})
                                </span>
                              </p>
                            </>
                          );
                        })()}
                      </div>
                    )}

                    {/* My Notes */}
                    {viewingAssignment.status !== 'reviewed' && (
                      <div>
                        <h4 className="text-sm font-medium text-gray-700 mb-2">My Notes & Progress</h4>
                        <textarea
                          value={notesText}
                          onChange={(e) => setNotesText(e.target.value)}
                          placeholder="Add your notes, reflections, or questions..."
                          rows={4}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <button
                          onClick={() => handleSaveNotes(viewingAssignment.id)}
                          className="mt-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm"
                        >
                          Save Notes
                        </button>
                      </div>
                    )}

                    {/* Saved Notes (for reviewed assignments) */}
                    {viewingAssignment.status === 'reviewed' && viewingAssignment.studentNotes && (
                      <div className="bg-gray-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-gray-700 mb-1">My Notes</h4>
                        <p className="text-gray-600 whitespace-pre-wrap">{viewingAssignment.studentNotes}</p>
                      </div>
                    )}

                    {/* Mentor Review */}
                    {viewingAssignment.mentorReview && (
                      <div className="bg-purple-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-purple-700 mb-1">üí¨ Mentor's Review</h4>
                        <p className="text-purple-900 whitespace-pre-wrap">{viewingAssignment.mentorReview}</p>
                      </div>
                    )}

                    {/* Actions */}
                    {['assigned', 'in_progress'].includes(viewingAssignment.status) && (
                      <div className="border-t border-gray-200 pt-4">
                        <button
                          onClick={() => handleMarkComplete(viewingAssignment.id)}
                          className="w-full py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center justify-center gap-2"
                        >
                          <span>‚úì</span>
                          <span>Mark as Complete</span>
                        </button>
                        <p className="text-xs text-gray-500 text-center mt-2">
                          Your mentor will review and provide feedback
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // MENTOR ASSIGNMENTS TAB (Mentor view of student's assignments)
    // =============================================================================
    function MentorAssignmentsTab({ 
      assignments, 
      studentData, 
      selectedStudent,
      onCreateAssignment, 
      onUpdateAssignment, 
      onDeleteAssignment,
      calculateChallengeProgress,
      isMobile 
    }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [filter, setFilter] = useState('all'); // all, active, completed
      const [viewingAssignment, setViewingAssignment] = useState(null);
      const [reviewText, setReviewText] = useState('');
      
      // Form state for creating assignment
      const [formData, setFormData] = useState({
        title: '',
        description: '',
        category: 'practice',
        dueDate: '',
        hasChallenge: false,
        challengeType: 'profit',
        challengeTarget: '',
        challengeTradesRequired: '20',
        challengeEndDate: '',
      });

      const resetForm = () => {
        setFormData({
          title: '',
          description: '',
          category: 'practice',
          dueDate: '',
          hasChallenge: false,
          challengeType: 'profit',
          challengeTarget: '',
          challengeTradesRequired: '20',
          challengeEndDate: '',
        });
      };

      const handleCreateAssignment = async () => {
        if (!formData.title.trim()) return;

        const assignmentData = {
          title: formData.title.trim(),
          description: formData.description.trim(),
          category: formData.category,
          dueDate: formData.dueDate || null,
          hasChallenge: formData.hasChallenge,
          challenge: formData.hasChallenge ? {
            type: formData.challengeType,
            target: parseFloat(formData.challengeTarget) || 0,
            tradesRequired: formData.challengeType === 'winrate' ? parseInt(formData.challengeTradesRequired) || 20 : null,
            startDate: todayISO(),
            endDate: formData.challengeEndDate || null,
            status: 'active',
          } : null,
        };

        const success = await onCreateAssignment(assignmentData);
        if (success) {
          setModalOpen(false);
          resetForm();
        }
      };

      const handleAddReview = async (assignmentId) => {
        if (!reviewText.trim()) return;
        await onUpdateAssignment(assignmentId, { 
          mentorReview: reviewText.trim(),
          status: 'reviewed'
        });
        setReviewText('');
        setViewingAssignment(null);
      };

      // Filter assignments
      const filteredAssignments = assignments.filter(a => {
        if (filter === 'active') return ['assigned', 'in_progress'].includes(a.status);
        if (filter === 'completed') return ['completed', 'reviewed'].includes(a.status);
        return true;
      });

      // Get days until due
      const getDaysUntilDue = (dueDate) => {
        if (!dueDate) return null;
        const today = new Date(todayISO());
        const due = new Date(dueDate);
        const diffTime = due - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Assignments</h1>
              <p className="text-sm text-gray-500 mt-1">
                {assignments.length} assignment{assignments.length !== 1 ? 's' : ''} for {selectedStudent?.displayName}
              </p>
            </div>
            <button
              onClick={() => setModalOpen(true)}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              {Icons.plus}
              <span>New Assignment</span>
            </button>
          </div>

          {/* Filters */}
          <div className="flex gap-2">
            {['all', 'active', 'completed'].map(f => (
              <button
                key={f}
                onClick={() => setFilter(f)}
                className={`px-3 py-1.5 text-sm rounded-lg font-medium transition-colors ${
                  filter === f 
                    ? 'bg-blue-100 text-blue-700' 
                    : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                }`}
              >
                {f.charAt(0).toUpperCase() + f.slice(1)}
              </button>
            ))}
          </div>

          {/* Assignments List */}
          {filteredAssignments.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                üìã
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">No assignments yet</h3>
              <p className="text-gray-500 mb-4">Create an assignment to help guide your student's learning</p>
              <button
                onClick={() => setModalOpen(true)}
                className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                {Icons.plus}
                <span>Create First Assignment</span>
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {filteredAssignments.map(assignment => {
                const catInfo = ASSIGNMENT_CATEGORIES[assignment.category] || ASSIGNMENT_CATEGORIES.other;
                const daysUntil = getDaysUntilDue(assignment.dueDate);
                const challengeProgress = assignment.hasChallenge && assignment.challenge
                  ? calculateChallengeProgress(assignment.challenge, studentData?.trades || [])
                  : null;

                return (
                  <div 
                    key={assignment.id}
                    className="bg-white rounded-xl border border-gray-200 shadow-sm p-4 hover:border-gray-300 transition-colors cursor-pointer"
                    onClick={() => setViewingAssignment(assignment)}
                  >
                    <div className="flex items-start gap-3">
                      {/* Category Icon */}
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center text-xl ${catInfo.bgColor}`}>
                        {catInfo.icon}
                      </div>

                      <div className="flex-1 min-w-0">
                        {/* Title & Status */}
                        <div className="flex items-center gap-2 mb-1">
                          <h3 className="font-medium text-gray-900 truncate">{assignment.title}</h3>
                          <span className={`px-2 py-0.5 text-xs rounded-full font-medium ${
                            assignment.status === 'assigned' ? 'bg-gray-100 text-gray-600' :
                            assignment.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                            assignment.status === 'completed' ? 'bg-green-100 text-green-700' :
                            'bg-purple-100 text-purple-700'
                          }`}>
                            {assignment.status === 'in_progress' ? 'In Progress' : 
                             assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}
                          </span>
                        </div>

                        {/* Due Date */}
                        {assignment.dueDate && (
                          <p className={`text-sm ${
                            daysUntil !== null && daysUntil < 0 ? 'text-red-600' :
                            daysUntil !== null && daysUntil <= 3 ? 'text-orange-600' :
                            'text-gray-500'
                          }`}>
                            Due: {assignment.dueDate}
                            {daysUntil !== null && (
                              <span className="ml-1">
                                ({daysUntil < 0 ? `${Math.abs(daysUntil)} days overdue` : 
                                  daysUntil === 0 ? 'Today' : 
                                  `${daysUntil} day${daysUntil !== 1 ? 's' : ''} left`})
                              </span>
                            )}
                          </p>
                        )}

                        {/* Challenge Progress */}
                        {assignment.hasChallenge && challengeProgress && (
                          <div className="mt-2">
                            <div className="flex items-center gap-2 text-sm">
                              <span className="text-gray-600">
                                {HOMEWORK_CHALLENGE_TYPES[assignment.challenge.type]?.label}: 
                              </span>
                              <span className="font-medium">
                                {assignment.challenge.type === 'profit' || assignment.challenge.type === 'max_loss' 
                                  ? formatCurrency(challengeProgress.current)
                                  : assignment.challenge.type === 'winrate'
                                    ? `${challengeProgress.current?.toFixed(1)}% (${challengeProgress.tradesCompleted}/${challengeProgress.tradesRequired} trades)`
                                    : `${challengeProgress.current}/${assignment.challenge.target}`
                                }
                              </span>
                              <span className={`text-xs px-1.5 py-0.5 rounded ${
                                challengeProgress.status === 'completed' ? 'bg-green-100 text-green-700' :
                                challengeProgress.status === 'failed' ? 'bg-red-100 text-red-700' :
                                'bg-blue-100 text-blue-700'
                              }`}>
                                {challengeProgress.status === 'completed' ? '‚úì Complete' :
                                 challengeProgress.status === 'failed' ? '‚úó Failed' :
                                 `${Math.round(challengeProgress.progress)}%`}
                              </span>
                            </div>
                            <div className="mt-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                              <div 
                                className={`h-full transition-all ${
                                  challengeProgress.status === 'completed' ? 'bg-green-500' :
                                  challengeProgress.status === 'failed' ? 'bg-red-500' :
                                  'bg-blue-500'
                                }`}
                                style={{ width: `${Math.min(100, challengeProgress.progress)}%` }}
                              />
                            </div>
                          </div>
                        )}

                        {/* Student Notes Preview */}
                        {assignment.studentNotes && (
                          <p className="text-sm text-gray-500 mt-2 truncate">
                            üí¨ Student: "{assignment.studentNotes}"
                          </p>
                        )}
                      </div>

                      {/* Actions */}
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          if (confirm('Delete this assignment?')) {
                            onDeleteAssignment(assignment.id);
                          }
                        }}
                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                      >
                        {Icons.trash}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* Create Assignment Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => { setModalOpen(false); resetForm(); }} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl">
                    <h2 className="text-lg font-semibold text-gray-900">Create Assignment</h2>
                  </div>
                  <div className="p-6 space-y-4">
                    {/* Title */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Title <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={formData.title}
                        onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                        placeholder="e.g., Focus on A+ setups this week"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Category */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                      <div className="flex flex-wrap gap-2">
                        {Object.entries(ASSIGNMENT_CATEGORIES).map(([key, val]) => (
                          <button
                            key={key}
                            type="button"
                            onClick={() => setFormData({ ...formData, category: key })}
                            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm border transition-colors ${
                              formData.category === key
                                ? `${val.bgColor} ${val.textColor} border-current`
                                : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                            }`}
                          >
                            <span>{val.icon}</span>
                            <span>{val.label}</span>
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* Description */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
                      <textarea
                        value={formData.description}
                        onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                        placeholder="Provide details about what they should focus on..."
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Due Date */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Due Date (optional)</label>
                      <input
                        type="date"
                        value={formData.dueDate}
                        onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
                        min={todayISO()}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Challenge Toggle */}
                    <div className="border-t border-gray-200 pt-4">
                      <label className="flex items-center gap-2 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={formData.hasChallenge}
                          onChange={(e) => setFormData({ ...formData, hasChallenge: e.target.checked })}
                          className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500"
                        />
                        <span className="text-sm font-medium text-gray-700">Attach a Measurable Challenge</span>
                      </label>
                    </div>

                    {/* Challenge Options */}
                    {formData.hasChallenge && (
                      <div className="bg-gray-50 rounded-lg p-4 space-y-4">
                        {/* Challenge Type */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Challenge Type</label>
                          <select
                            value={formData.challengeType}
                            onChange={(e) => setFormData({ ...formData, challengeType: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          >
                            {Object.entries(HOMEWORK_CHALLENGE_TYPES).map(([key, val]) => (
                              <option key={key} value={key}>{val.label} - {val.metric}</option>
                            ))}
                          </select>
                        </div>

                        {/* Target Value */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Target {HOMEWORK_CHALLENGE_TYPES[formData.challengeType]?.unit && 
                              `(${HOMEWORK_CHALLENGE_TYPES[formData.challengeType].unit})`}
                          </label>
                          <input
                            type="number"
                            value={formData.challengeTarget}
                            onChange={(e) => setFormData({ ...formData, challengeTarget: e.target.value })}
                            placeholder={formData.challengeType === 'profit' ? '500' : 
                                        formData.challengeType === 'winrate' ? '60' : '10'}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                        </div>

                        {/* Trades Required (for win rate) */}
                        {formData.challengeType === 'winrate' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Over how many trades?
                            </label>
                            <input
                              type="number"
                              value={formData.challengeTradesRequired}
                              onChange={(e) => setFormData({ ...formData, challengeTradesRequired: e.target.value })}
                              placeholder="20"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>
                        )}

                        {/* Challenge End Date */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">End Date (optional)</label>
                          <input
                            type="date"
                            value={formData.challengeEndDate}
                            onChange={(e) => setFormData({ ...formData, challengeEndDate: e.target.value })}
                            min={todayISO()}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 rounded-b-xl flex justify-end gap-3">
                    <button
                      onClick={() => { setModalOpen(false); resetForm(); }}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleCreateAssignment}
                      disabled={!formData.title.trim()}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                    >
                      Create Assignment
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* View Assignment Modal */}
          {viewingAssignment && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setViewingAssignment(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl flex items-center justify-between">
                    <h2 className="text-lg font-semibold text-gray-900">Assignment Details</h2>
                    <button onClick={() => setViewingAssignment(null)} className="p-2 hover:bg-gray-100 rounded-lg">
                      {Icons.x}
                    </button>
                  </div>
                  <div className="p-6 space-y-4">
                    {/* Header */}
                    <div className="flex items-start gap-3">
                      <div className={`w-12 h-12 rounded-lg flex items-center justify-center text-2xl ${
                        ASSIGNMENT_CATEGORIES[viewingAssignment.category]?.bgColor || 'bg-gray-100'
                      }`}>
                        {ASSIGNMENT_CATEGORIES[viewingAssignment.category]?.icon || 'üìù'}
                      </div>
                      <div>
                        <h3 className="text-xl font-semibold text-gray-900">{viewingAssignment.title}</h3>
                        <p className="text-sm text-gray-500">
                          Created {viewingAssignment.createdAt?.toDate?.().toLocaleDateString() || 'recently'}
                        </p>
                      </div>
                    </div>

                    {/* Description */}
                    {viewingAssignment.description && (
                      <div>
                        <h4 className="text-sm font-medium text-gray-700 mb-1">Description</h4>
                        <p className="text-gray-600 whitespace-pre-wrap">{viewingAssignment.description}</p>
                      </div>
                    )}

                    {/* Status & Due Date */}
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <h4 className="text-sm font-medium text-gray-700 mb-1">Status</h4>
                        <span className={`inline-flex px-2 py-1 text-sm rounded-full font-medium ${
                          viewingAssignment.status === 'assigned' ? 'bg-gray-100 text-gray-600' :
                          viewingAssignment.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                          viewingAssignment.status === 'completed' ? 'bg-green-100 text-green-700' :
                          'bg-purple-100 text-purple-700'
                        }`}>
                          {viewingAssignment.status === 'in_progress' ? 'In Progress' : 
                           viewingAssignment.status.charAt(0).toUpperCase() + viewingAssignment.status.slice(1)}
                        </span>
                      </div>
                      {viewingAssignment.dueDate && (
                        <div>
                          <h4 className="text-sm font-medium text-gray-700 mb-1">Due Date</h4>
                          <p className="text-gray-600">{viewingAssignment.dueDate}</p>
                        </div>
                      )}
                    </div>

                    {/* Challenge Progress */}
                    {viewingAssignment.hasChallenge && viewingAssignment.challenge && (
                      <div className="bg-gray-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-gray-700 mb-2">Challenge Progress</h4>
                        {(() => {
                          const progress = calculateChallengeProgress(viewingAssignment.challenge, studentData?.trades || []);
                          return (
                            <>
                              <p className="text-sm text-gray-600 mb-2">
                                {HOMEWORK_CHALLENGE_TYPES[viewingAssignment.challenge.type]?.label}: 
                                {viewingAssignment.challenge.type === 'winrate' 
                                  ? ` ${viewingAssignment.challenge.target}% over ${viewingAssignment.challenge.tradesRequired} trades`
                                  : ` ${viewingAssignment.challenge.target} ${HOMEWORK_CHALLENGE_TYPES[viewingAssignment.challenge.type]?.unit || ''}`
                                }
                              </p>
                              <div className="h-3 bg-gray-200 rounded-full overflow-hidden mb-2">
                                <div 
                                  className={`h-full ${
                                    progress.status === 'completed' ? 'bg-green-500' :
                                    progress.status === 'failed' ? 'bg-red-500' :
                                    'bg-blue-500'
                                  }`}
                                  style={{ width: `${Math.min(100, progress.progress)}%` }}
                                />
                              </div>
                              <p className="text-sm font-medium">
                                Current: {viewingAssignment.challenge.type === 'profit' || viewingAssignment.challenge.type === 'max_loss'
                                  ? formatCurrency(progress.current)
                                  : viewingAssignment.challenge.type === 'winrate'
                                    ? `${progress.current?.toFixed(1)}% (${progress.tradesCompleted}/${progress.tradesRequired} trades)`
                                    : progress.current
                                }
                                {' '}
                                <span className={`${
                                  progress.status === 'completed' ? 'text-green-600' :
                                  progress.status === 'failed' ? 'text-red-600' :
                                  'text-blue-600'
                                }`}>
                                  ({progress.status === 'completed' ? '‚úì Complete' :
                                    progress.status === 'failed' ? '‚úó Failed' :
                                    `${Math.round(progress.progress)}%`})
                                </span>
                              </p>
                            </>
                          );
                        })()}
                      </div>
                    )}

                    {/* Student Notes */}
                    {viewingAssignment.studentNotes && (
                      <div className="bg-blue-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-blue-700 mb-1">Student's Notes</h4>
                        <p className="text-blue-900 whitespace-pre-wrap">{viewingAssignment.studentNotes}</p>
                      </div>
                    )}

                    {/* Mentor Review */}
                    {viewingAssignment.status === 'completed' && !viewingAssignment.mentorReview && (
                      <div className="border-t border-gray-200 pt-4">
                        <h4 className="text-sm font-medium text-gray-700 mb-2">Add Your Review</h4>
                        <textarea
                          value={reviewText}
                          onChange={(e) => setReviewText(e.target.value)}
                          placeholder="Provide feedback on their work..."
                          rows={3}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <button
                          onClick={() => handleAddReview(viewingAssignment.id)}
                          disabled={!reviewText.trim()}
                          className="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                        >
                          Submit Review
                        </button>
                      </div>
                    )}

                    {viewingAssignment.mentorReview && (
                      <div className="bg-purple-50 rounded-lg p-4">
                        <h4 className="text-sm font-medium text-purple-700 mb-1">Your Review</h4>
                        <p className="text-purple-900 whitespace-pre-wrap">{viewingAssignment.mentorReview}</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // MENTOR CHECK-INS TAB (Mentor view of weekly check-ins)
    // =============================================================================
    function MentorCheckinsTab({ 
      checkins, 
      studentData, 
      selectedStudent,
      onCreateCheckin, 
      onDeleteCheckin,
      onCreateAssignment,
      isMobile 
    }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingCheckin, setEditingCheckin] = useState(null);
      const [selectedWeek, setSelectedWeek] = useState(getWeekBounds());
      
      // Form state
      const [formData, setFormData] = useState({
        summary: '',
        whatWentWell: '',
        areasToImprove: '',
        focusForNextWeek: '',
      });

      // Assignment form state
      const [showAssignmentForm, setShowAssignmentForm] = useState(false);
      const [assignmentData, setAssignmentData] = useState({
        title: '',
        description: '',
        type: 'homework',
        dueDate: '',
        hasChallenge: false,
        challengeType: 'profit',
        challengeTarget: '',
        challengeTradesRequired: 10,
        challengeStartDate: todayISO(),
        challengeEndDate: '',
      });

      const recentWeeks = getRecentWeeks(12);

      // Calculate stats for selected week (including setups and mistakes)
      const weekStats = useMemo(() => {
        if (!studentData?.trades) return null;
        return calculateWeekStats(
          studentData.trades, 
          selectedWeek.start, 
          selectedWeek.end,
          studentData.setups || [],
          studentData.mistakes || []
        );
      }, [studentData?.trades, studentData?.setups, studentData?.mistakes, selectedWeek]);

      const resetForm = () => {
        setFormData({
          summary: '',
          whatWentWell: '',
          areasToImprove: '',
          focusForNextWeek: '',
        });
        setEditingCheckin(null);
        setShowAssignmentForm(false);
        setAssignmentData({
          title: '',
          description: '',
          type: 'homework',
          dueDate: '',
          hasChallenge: false,
          challengeType: 'profit',
          challengeTarget: '',
          challengeTradesRequired: 10,
          challengeStartDate: todayISO(),
          challengeEndDate: '',
        });
      };

      const openNewCheckin = () => {
        resetForm();
        setSelectedWeek(getWeekBounds());
        setModalOpen(true);
      };

      const openEditCheckin = (checkin) => {
        setEditingCheckin(checkin);
        setSelectedWeek({ start: checkin.weekStart, end: checkin.weekEnd });
        setFormData({
          summary: checkin.summary || '',
          whatWentWell: checkin.whatWentWell || '',
          areasToImprove: checkin.areasToImprove || '',
          focusForNextWeek: checkin.focusForNextWeek || '',
        });
        setModalOpen(true);
      };

      const handleSaveCheckin = async () => {
        const checkinData = {
          weekStart: selectedWeek.start,
          weekEnd: selectedWeek.end,
          stats: weekStats,
          summary: formData.summary.trim(),
          whatWentWell: formData.whatWentWell.trim(),
          areasToImprove: formData.areasToImprove.trim(),
          focusForNextWeek: formData.focusForNextWeek.trim(),
        };

        const success = await onCreateCheckin(checkinData);
        if (success) {
          setModalOpen(false);
          resetForm();
        }
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Weekly Check-ins</h1>
              <p className="text-sm text-gray-500 mt-1">
                {checkins.length} check-in{checkins.length !== 1 ? 's' : ''} for {selectedStudent?.displayName}
              </p>
            </div>
            <button
              onClick={openNewCheckin}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              {Icons.plus}
              <span>New Check-in</span>
            </button>
          </div>

          {/* Check-ins List */}
          {checkins.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                üìÖ
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">No check-ins yet</h3>
              <p className="text-gray-500 mb-4">Create your first weekly check-in to track progress</p>
              <button
                onClick={openNewCheckin}
                className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                {Icons.plus}
                <span>Create First Check-in</span>
              </button>
            </div>
          ) : (
            <div className="space-y-4">
              {checkins.map(checkin => {
                const stats = checkin.stats || {};
                return (
                  <div 
                    key={checkin.id}
                    className="bg-white rounded-xl border border-gray-200 shadow-sm p-4 hover:border-gray-300 transition-colors cursor-pointer"
                    onClick={() => openEditCheckin(checkin)}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h3 className="font-semibold text-gray-900">
                          Week of {formatWeekRange(checkin.weekStart, checkin.weekEnd)}
                        </h3>
                        <div className="flex items-center gap-3 mt-1 text-sm text-gray-600">
                          <span>üìä {stats.totalTrades || 0} trades</span>
                          <span>|</span>
                          <span>{(stats.winRate || 0).toFixed(0)}% WR</span>
                          <span>|</span>
                          <span className={stats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}>
                            {formatCurrency(stats.totalPnL || 0)}
                          </span>
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          if (confirm('Delete this check-in?')) {
                            onDeleteCheckin(checkin.id);
                          }
                        }}
                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                      >
                        {Icons.trash}
                      </button>
                    </div>

                    {checkin.summary && (
                      <p className="text-gray-600 text-sm mb-2 line-clamp-2">"{checkin.summary}"</p>
                    )}

                    {checkin.focusForNextWeek && (
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-orange-500">üî•</span>
                        <span className="text-gray-600">Focus: {checkin.focusForNextWeek}</span>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}

          {/* Create/Edit Check-in Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => { setModalOpen(false); resetForm(); }} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-xl">
                    <h2 className="text-lg font-semibold text-gray-900">
                      {editingCheckin ? 'Edit Check-in' : 'New Weekly Check-in'}
                    </h2>
                  </div>
                  <div className="p-6 space-y-4">
                    {/* Week Selector */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Week</label>
                      <select
                        value={`${selectedWeek.start}|${selectedWeek.end}`}
                        onChange={(e) => {
                          const [start, end] = e.target.value.split('|');
                          setSelectedWeek({ start, end });
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        {recentWeeks.map(week => (
                          <option key={week.start} value={`${week.start}|${week.end}`}>
                            {formatWeekRange(week.start, week.end)}
                          </option>
                        ))}
                      </select>
                    </div>

                    {/* Week Stats - Exact Calendar View Layout */}
                    {weekStats && weekStats.totalTrades > 0 ? (
                      <div className="space-y-4">
                        {/* Summary Cards - 7 columns like calendar */}
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-7 gap-2">
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Week P&L</p>
                            <p className={`text-lg font-bold truncate ${weekStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                              {formatCurrencyShort(weekStats.totalPnL)}
                            </p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate"># Trades</p>
                            <p className="text-lg font-bold text-gray-900">{weekStats.totalTrades}</p>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">{weekStats.tradingDays} days traded</p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Win Rate</p>
                            <p className="text-lg font-bold text-gray-900">{weekStats.winRate.toFixed(1)}%</p>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">
                              <span className="text-emerald-600">{weekStats.wins}W</span>
                              {' / '}
                              <span className="text-red-600">{weekStats.losses}L</span>
                            </p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">R:R</p>
                            <p className="text-lg font-bold text-gray-900">{weekStats.riskRewardRatio}:1</p>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">
                              {formatCurrencyShort(weekStats.avgWin)}/{formatCurrencyShort(weekStats.avgLoss)}
                            </p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Win</p>
                            <p className="text-lg font-bold text-emerald-600 truncate">+{formatCurrencyShort(weekStats.avgWin)}</p>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">{weekStats.wins} win{weekStats.wins !== 1 ? 's' : ''}</p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Loss</p>
                            <p className="text-lg font-bold text-red-600 truncate">-{formatCurrencyShort(weekStats.avgLoss)}</p>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">{weekStats.losses} loss{weekStats.losses !== 1 ? 'es' : ''}</p>
                          </div>
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                            <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Rating</p>
                            {weekStats.ratedTradesCount > 0 ? (
                              <>
                                <div className="flex items-center gap-1">
                                  <span className="text-lg font-bold text-gray-900">{weekStats.avgRating.toFixed(1)}</span>
                                  <span className="text-amber-400">‚òÖ</span>
                                </div>
                                <p className="text-[10px] text-gray-500 mt-1 truncate">{weekStats.ratedTradesCount} rated</p>
                              </>
                            ) : (
                              <p className="text-xs text-gray-400 italic">No ratings</p>
                            )}
                          </div>
                        </div>

                        {/* Charts Row - 4 columns like calendar */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          {/* P&L by Asset Type */}
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Asset</h3>
                            <SimplePieChart data={weekStats.assetPieData} />
                          </div>

                          {/* P&L by Ticker */}
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Ticker</h3>
                            <SimpleBarChart data={weekStats.tickerPnLData} />
                          </div>

                          {/* Trade P&L Distribution */}
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 className="text-sm font-semibold text-gray-900 mb-3">Trade P&L</h3>
                            <SimpleBarChart data={weekStats.tradePnLData} />
                          </div>

                          {/* Setups Used */}
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                            <h3 className="text-sm font-semibold text-gray-900 mb-3">Setups Used</h3>
                            <SetupBarChart data={weekStats.setupData} />
                          </div>
                        </div>

                        {/* Setups Analysis Table */}
                        {weekStats.setupData && weekStats.setupData.length > 0 && (
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                              <h3 className="text-sm font-semibold text-gray-900">Setups Used on Week of {formatWeekRange(selectedWeek.start, selectedWeek.end)}</h3>
                            </div>
                            <div className="p-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                {/* Setup Pie Chart */}
                                <div>
                                  <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Trade Count</h4>
                                  <SimplePieChart data={weekStats.setupData.map(s => ({ label: s.name, value: s.total }))} />
                                </div>
                                {/* Setup P&L Bar Chart */}
                                <div>
                                  <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By P&L</h4>
                                  <SimpleBarChart data={weekStats.setupData.map(s => ({ label: s.name, value: s.totalPnL }))} />
                                </div>
                              </div>
                              {/* Setup Details Table */}
                              <div className="mt-4 pt-4 border-t border-gray-100">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="text-left text-xs text-gray-500 uppercase">
                                      <th className="pb-2">Setup</th>
                                      <th className="pb-2 text-center">Trades</th>
                                      <th className="pb-2 text-center">W/L</th>
                                      <th className="pb-2 text-center">Win Rate</th>
                                      <th className="pb-2 text-right">P&L</th>
                                    </tr>
                                  </thead>
                                  <tbody className="divide-y divide-gray-100">
                                    {weekStats.setupData.map(s => (
                                      <tr key={s.id}>
                                        <td className="py-2 font-medium text-gray-900">{s.name}</td>
                                        <td className="py-2 text-center text-gray-600">{s.total}</td>
                                        <td className="py-2 text-center">
                                          <span className="text-emerald-600">{s.wins}W</span>
                                          {' / '}
                                          <span className="text-red-600">{s.losses}L</span>
                                        </td>
                                        <td className="py-2 text-center text-gray-600">{s.winRate}%</td>
                                        <td className={`py-2 text-right font-semibold ${s.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                          {formatCurrency(s.totalPnL)}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* Mistakes Analysis */}
                        {weekStats.mistakeData && weekStats.mistakeData.length > 0 && (
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                              <div className="flex items-center justify-between">
                                <h3 className="text-sm font-semibold text-gray-900">Mistakes on Week of {formatWeekRange(selectedWeek.start, selectedWeek.end)}</h3>
                                <span className="text-xs text-gray-500">Loss amounts only include losing trades</span>
                              </div>
                            </div>
                            <div className="p-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* Mistake Pie Chart */}
                                <div>
                                  <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Frequency</h4>
                                  <SimplePieChart data={weekStats.mistakeData.map(m => ({ label: m.name, value: m.totalOccurrences }))} />
                                </div>
                                {/* Mistake Loss Bar Chart */}
                                <div>
                                  <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Loss Amount</h4>
                                  {(() => {
                                    const lossData = weekStats.mistakeData
                                      .filter(m => m.totalLossAmount < 0)
                                      .sort((a, b) => a.totalLossAmount - b.totalLossAmount)
                                      .map(m => ({ label: m.name, value: Math.abs(m.totalLossAmount) }));
                                    if (lossData.length === 0) {
                                      return <div className="h-24 flex items-center justify-center text-gray-400 text-sm">No losses from mistakes</div>;
                                    }
                                    const maxVal = Math.max(...lossData.map(d => d.value), 1);
                                    return (
                                      <div className="space-y-2">
                                        {lossData.map((d, i) => (
                                          <div key={i} className="flex items-center gap-2">
                                            <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
                                            <div className="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                                              <div className="h-full rounded bg-red-500" style={{ width: `${(d.value / maxVal) * 100}%` }} />
                                            </div>
                                            <span className="text-xs font-medium w-16 text-right text-red-600">-{formatCurrencyShort(d.value)}</span>
                                          </div>
                                        ))}
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>
                              {/* Mistake Details Table */}
                              <div className="mt-4 pt-4 border-t border-gray-100">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="text-left text-xs text-gray-500 uppercase">
                                      <th className="pb-2">Mistake</th>
                                      <th className="pb-2 text-center">Occurrences</th>
                                      <th className="pb-2 text-center">Losing / Profitable</th>
                                      <th className="pb-2 text-right">Total Loss</th>
                                    </tr>
                                  </thead>
                                  <tbody className="divide-y divide-gray-100">
                                    {weekStats.mistakeData.map(m => (
                                      <tr key={m.id}>
                                        <td className="py-2 font-medium text-gray-900">{m.name}</td>
                                        <td className="py-2 text-center text-gray-600">{m.totalOccurrences}x</td>
                                        <td className="py-2 text-center">
                                          <span className="text-red-600">{m.losingTrades}</span>
                                          {' / '}
                                          <span className="text-emerald-600">{m.profitableTrades}</span>
                                        </td>
                                        <td className="py-2 text-right font-semibold text-red-600">
                                          {m.totalLossAmount < 0 ? formatCurrency(m.totalLossAmount) : '-'}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* Trades Table */}
                        {weekStats.trades && weekStats.trades.length > 0 && (
                          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                            <div className="px-4 py-3 border-b border-gray-200">
                              <h3 className="text-sm font-semibold text-gray-900">
                                Trades ({weekStats.trades.length})
                              </h3>
                            </div>
                            <div className="overflow-x-auto">
                              <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                  <tr>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">#</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ticker</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Setup</th>
                                    <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mistakes</th>
                                  </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                  {[...weekStats.trades]
                                    .sort((a, b) => {
                                      const dateA = a.exitDate || a.entryDate;
                                      const dateB = b.exitDate || b.entryDate;
                                      return dateA.localeCompare(dateB) || (a.createdAt || '').localeCompare(b.createdAt || '');
                                    })
                                    .map((trade, index) => {
                                      const setupName = trade.setupId 
                                        ? (studentData?.setups?.find(s => s.id === trade.setupId)?.name || '-')
                                        : '-';
                                      const mistakeNames = trade.mistakeIds && trade.mistakeIds.length > 0
                                        ? trade.mistakeIds.map(id => studentData?.mistakes?.find(m => m.id === id)?.name || '').filter(Boolean).join(', ')
                                        : '-';
                                      
                                      return (
                                        <tr key={trade.id} className="hover:bg-gray-50">
                                          <td className="px-3 py-2 text-sm font-medium text-gray-400">{index + 1}</td>
                                          <td className="px-3 py-2 text-sm text-gray-600">{trade.exitDate || trade.entryDate}</td>
                                          <td className="px-3 py-2 text-sm font-medium text-gray-900">{trade.ticker}</td>
                                          <td className="px-3 py-2 text-sm">
                                            <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                              trade.positionType === 'long' 
                                                ? 'bg-emerald-100 text-emerald-700' 
                                                : 'bg-red-100 text-red-700'
                                            }`}>
                                              {trade.positionType?.toUpperCase() || '-'}
                                            </span>
                                          </td>
                                          <td className="px-3 py-2 text-sm text-gray-600">{trade.positionSize || '-'}</td>
                                          <td className="px-3 py-2 text-sm">
                                            {trade.derived?.isOpen ? (
                                              <span className="text-gray-400">Open</span>
                                            ) : (
                                              <span className={`font-medium ${(trade.derived?.pnlFinal || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                                {formatCurrency(trade.derived?.pnlFinal || 0)}
                                              </span>
                                            )}
                                          </td>
                                          <td className="px-3 py-2">
                                            {trade.rating ? (
                                              <div className="flex items-center gap-0.5">
                                                {[1, 2, 3, 4, 5].map(star => (
                                                  <span key={star} className={`text-xs ${star <= trade.rating ? 'text-amber-400' : 'text-gray-300'}`}>‚òÖ</span>
                                                ))}
                                              </div>
                                            ) : (
                                              <span className="text-gray-300 text-xs">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</span>
                                            )}
                                          </td>
                                          <td className="px-3 py-2 text-sm text-gray-600 max-w-[100px] truncate" title={setupName}>
                                            {setupName}
                                          </td>
                                          <td className="px-3 py-2 text-sm text-gray-600 max-w-[120px] truncate" title={mistakeNames}>
                                            {mistakeNames}
                                          </td>
                                        </tr>
                                      );
                                    })}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}
                      </div>
                    ) : weekStats && weekStats.totalTrades === 0 ? (
                      <div className="bg-gray-50 rounded-lg p-6 text-center">
                        <p className="text-gray-500">No trades this week</p>
                      </div>
                    ) : null}

                    {/* Summary */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Overall Summary</label>
                      <textarea
                        value={formData.summary}
                        onChange={(e) => setFormData({ ...formData, summary: e.target.value })}
                        placeholder="How did this week go overall?"
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* What Went Well */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">üí™ What Went Well</label>
                      <textarea
                        value={formData.whatWentWell}
                        onChange={(e) => setFormData({ ...formData, whatWentWell: e.target.value })}
                        placeholder="Positives from this week..."
                        rows={2}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Areas to Improve */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">üéØ Areas to Improve</label>
                      <textarea
                        value={formData.areasToImprove}
                        onChange={(e) => setFormData({ ...formData, areasToImprove: e.target.value })}
                        placeholder="What needs work..."
                        rows={2}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Focus for Next Week */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">üî• Focus for Next Week</label>
                      <textarea
                        value={formData.focusForNextWeek}
                        onChange={(e) => setFormData({ ...formData, focusForNextWeek: e.target.value })}
                        placeholder="Key priorities for the coming week..."
                        rows={2}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      />
                    </div>

                    {/* Assignment/Challenge Creation */}
                    <div className="border-t border-gray-200 pt-4">
                      <button
                        type="button"
                        onClick={() => setShowAssignmentForm(!showAssignmentForm)}
                        className="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium"
                      >
                        {showAssignmentForm ? Icons.minus : Icons.plus}
                        <span>{showAssignmentForm ? 'Cancel Assignment' : 'Add Homework Assignment'}</span>
                      </button>

                      {showAssignmentForm && (
                        <div className="mt-4 p-4 bg-blue-50 rounded-lg space-y-4">
                          <h4 className="font-medium text-gray-900">üìù New Homework Assignment</h4>
                          
                          {/* Title */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                            <input
                              type="text"
                              value={assignmentData.title}
                              onChange={(e) => setAssignmentData({ ...assignmentData, title: e.target.value })}
                              placeholder="e.g., Read Trading in the Zone Ch. 5"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          {/* Description */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                            <textarea
                              value={assignmentData.description}
                              onChange={(e) => setAssignmentData({ ...assignmentData, description: e.target.value })}
                              placeholder="Details or instructions..."
                              rows={2}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          {/* Due Date */}
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Due Date (optional)</label>
                            <input
                              type="date"
                              value={assignmentData.dueDate}
                              onChange={(e) => setAssignmentData({ ...assignmentData, dueDate: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          {/* Add Challenge Toggle */}
                          <div className="border-t border-blue-200 pt-4">
                            <label className="flex items-center gap-3 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={assignmentData.hasChallenge}
                                onChange={(e) => setAssignmentData({ ...assignmentData, hasChallenge: e.target.checked })}
                                className="w-5 h-5 text-blue-600 rounded focus:ring-blue-500"
                              />
                              <span className="font-medium text-gray-900">üéØ Add a Challenge</span>
                            </label>
                            <p className="text-xs text-gray-500 mt-1 ml-8">Track a measurable goal like profit target, win rate, etc.</p>
                          </div>

                          {/* Challenge Settings (shown when checkbox is checked) */}
                          {assignmentData.hasChallenge && (
                            <div className="ml-4 pl-4 border-l-2 border-blue-300 space-y-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Challenge Type</label>
                                <select
                                  value={assignmentData.challengeType}
                                  onChange={(e) => setAssignmentData({ ...assignmentData, challengeType: e.target.value })}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                  {Object.entries(HOMEWORK_CHALLENGE_TYPES).map(([id, type]) => (
                                    <option key={id} value={id}>{type.label}</option>
                                  ))}
                                </select>
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">
                                    Target {HOMEWORK_CHALLENGE_TYPES[assignmentData.challengeType]?.unit || ''}
                                  </label>
                                  <input
                                    type="number"
                                    value={assignmentData.challengeTarget}
                                    onChange={(e) => setAssignmentData({ ...assignmentData, challengeTarget: e.target.value })}
                                    placeholder={assignmentData.challengeType === 'profit' ? '500' : assignmentData.challengeType === 'winrate' ? '60' : '10'}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  />
                                </div>
                                {assignmentData.challengeType === 'winrate' && (
                                  <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Min Trades</label>
                                    <input
                                      type="number"
                                      value={assignmentData.challengeTradesRequired}
                                      onChange={(e) => setAssignmentData({ ...assignmentData, challengeTradesRequired: parseInt(e.target.value) || 10 })}
                                      placeholder="10"
                                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                  </div>
                                )}
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                  <input
                                    type="date"
                                    value={assignmentData.challengeStartDate}
                                    onChange={(e) => setAssignmentData({ ...assignmentData, challengeStartDate: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                  <input
                                    type="date"
                                    value={assignmentData.challengeEndDate}
                                    onChange={(e) => setAssignmentData({ ...assignmentData, challengeEndDate: e.target.value })}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                  />
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 rounded-b-xl flex justify-end gap-3">
                    <button
                      onClick={() => { setModalOpen(false); resetForm(); }}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={async () => {
                        // Save check-in
                        const checkinData = {
                          weekStart: selectedWeek.start,
                          weekEnd: selectedWeek.end,
                          stats: weekStats,
                          summary: formData.summary.trim(),
                          whatWentWell: formData.whatWentWell.trim(),
                          areasToImprove: formData.areasToImprove.trim(),
                          focusForNextWeek: formData.focusForNextWeek.trim(),
                        };
                        const checkinSuccess = await onCreateCheckin(checkinData);
                        
                        // Also create assignment if form is filled
                        if (showAssignmentForm && assignmentData.title.trim() && onCreateAssignment) {
                          const assignmentPayload = {
                            title: assignmentData.title.trim(),
                            description: assignmentData.description.trim(),
                            type: 'homework',
                            dueDate: assignmentData.dueDate || null,
                            hasChallenge: assignmentData.hasChallenge,
                            challenge: assignmentData.hasChallenge ? {
                              type: assignmentData.challengeType,
                              target: parseFloat(assignmentData.challengeTarget) || 0,
                              tradesRequired: assignmentData.challengeTradesRequired,
                              startDate: assignmentData.challengeStartDate,
                              endDate: assignmentData.challengeEndDate,
                            } : null,
                          };
                          await onCreateAssignment(assignmentPayload);
                        }
                        
                        if (checkinSuccess) {
                          setModalOpen(false);
                          resetForm();
                        }
                      }}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                    >
                      {editingCheckin ? 'Update Check-in' : (showAssignmentForm && assignmentData.title ? 'Save Check-in & Assignment' : 'Save Check-in')}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // MENTOR SESSIONS TAB
    // =============================================================================
    function MentorSessionsTab({
      sessions,
      selectedStudent,
      userProfile,
      onCreateSession,
      onUpdateStatus,
      onDeleteSession,
      isMobile,
    }) {
      const [showForm, setShowForm] = useState(false);
      const [formData, setFormData] = useState({
        date: '',
        time: '',
        duration: 30,
        topic: '',
        videoLink: '',
      });
      const [saving, setSaving] = useState(false);
      const [editingSession, setEditingSession] = useState(null);
      const [notesModalOpen, setNotesModalOpen] = useState(false);
      const [notesSession, setNotesSession] = useState(null);
      const [sessionNotes, setSessionNotes] = useState('');

      const resetForm = () => {
        setFormData({
          date: '',
          time: '',
          duration: 30,
          topic: '',
          videoLink: '',
        });
        setShowForm(false);
        setEditingSession(null);
      };

      const handleSubmit = async () => {
        if (!formData.date || !formData.time || !formData.topic.trim()) return;
        
        setSaving(true);
        try {
          const dateTime = new Date(`${formData.date}T${formData.time}`);
          const success = await onCreateSession({
            dateTime: firebase.firestore.Timestamp.fromDate(dateTime),
            duration: formData.duration,
            topic: formData.topic.trim(),
            videoLink: formData.videoLink.trim() || null,
          });
          
          if (success) {
            resetForm();
          }
        } catch (err) {
          console.error('Error creating session:', err);
        }
        setSaving(false);
      };

      const handleComplete = async (session) => {
        setNotesSession(session);
        setSessionNotes(session.notes || '');
        setNotesModalOpen(true);
      };

      const saveNotesAndComplete = async () => {
        if (!notesSession) return;
        await onUpdateStatus(notesSession.id, 'completed', sessionNotes);
        setNotesModalOpen(false);
        setNotesSession(null);
        setSessionNotes('');
      };

      // Split sessions into upcoming and past
      const now = new Date();
      const upcomingSessions = sessions
        .filter(s => s.dateTime?.toDate && s.dateTime.toDate() >= now && s.status !== 'cancelled' && s.status !== 'completed')
        .sort((a, b) => a.dateTime.toDate() - b.dateTime.toDate());
      
      const pastSessions = sessions
        .filter(s => s.dateTime?.toDate && (s.dateTime.toDate() < now || s.status === 'completed' || s.status === 'cancelled'))
        .sort((a, b) => b.dateTime.toDate() - a.dateTime.toDate());

      const formatDateTime = (timestamp) => {
        if (!timestamp?.toDate) return 'Unknown';
        const date = timestamp.toDate();
        return date.toLocaleDateString('en-US', { 
          weekday: 'short',
          month: 'short', 
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
        });
      };

      const getStatusBadge = (status) => {
        switch (status) {
          case 'requested':
            return <span className="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-700 rounded">Requested</span>;
          case 'confirmed':
            return <span className="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded">Confirmed</span>;
          case 'completed':
            return <span className="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded">Completed</span>;
          case 'cancelled':
            return <span className="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-500 rounded">Cancelled</span>;
          default:
            return null;
        }
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-gray-900">üìÖ Sessions with {selectedStudent?.displayName}</h2>
            <button
              onClick={() => setShowForm(!showForm)}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"
            >
              {showForm ? Icons.minus : Icons.plus}
              <span>{showForm ? 'Cancel' : 'Schedule Session'}</span>
            </button>
          </div>

          {/* Schedule Form */}
          {showForm && (
            <div className="bg-blue-50 rounded-xl p-6 border border-blue-200">
              <h3 className="font-semibold text-gray-900 mb-4">üìÖ Schedule New Session</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Date */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                  <input
                    type="date"
                    value={formData.date}
                    onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                    min={todayISO()}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Time */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Time *</label>
                  <input
                    type="time"
                    value={formData.time}
                    onChange={(e) => setFormData({ ...formData, time: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>

                {/* Duration */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                  <select
                    value={formData.duration}
                    onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  >
                    <option value={15}>15 minutes</option>
                    <option value={30}>30 minutes</option>
                    <option value={45}>45 minutes</option>
                    <option value={60}>1 hour</option>
                    <option value={90}>1.5 hours</option>
                  </select>
                </div>

                {/* Video Link */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Video Link (optional)</label>
                  <input
                    type="url"
                    value={formData.videoLink}
                    onChange={(e) => setFormData({ ...formData, videoLink: e.target.value })}
                    placeholder="https://zoom.us/j/..."
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>

              {/* Topic */}
              <div className="mt-4">
                <label className="block text-sm font-medium text-gray-700 mb-1">Topic / Agenda *</label>
                <textarea
                  value={formData.topic}
                  onChange={(e) => setFormData({ ...formData, topic: e.target.value })}
                  placeholder="What will you discuss in this session?"
                  rows={2}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>

              {/* Submit */}
              <div className="mt-4 flex justify-end gap-3">
                <button
                  onClick={resetForm}
                  className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSubmit}
                  disabled={saving || !formData.date || !formData.time || !formData.topic.trim()}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
                >
                  {saving ? 'Scheduling...' : 'Schedule Session'}
                </button>
              </div>
            </div>
          )}

          {/* Upcoming Sessions */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
              <h3 className="font-semibold text-gray-900 flex items-center gap-2">
                <span>üìÜ</span>
                <span>Upcoming Sessions</span>
                {upcomingSessions.length > 0 && (
                  <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-medium">
                    {upcomingSessions.length}
                  </span>
                )}
              </h3>
            </div>
            
            {upcomingSessions.length === 0 ? (
              <div className="px-6 py-8 text-center text-gray-500">
                <p>No upcoming sessions scheduled</p>
              </div>
            ) : (
              <div className="divide-y divide-gray-100">
                {upcomingSessions.map(session => (
                  <div key={session.id} className="px-6 py-4 hover:bg-gray-50">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="font-medium text-gray-900">{formatDateTime(session.dateTime)}</span>
                          <span className="text-gray-400">‚Ä¢</span>
                          <span className="text-sm text-gray-500">{session.duration} min</span>
                          {getStatusBadge(session.status)}
                        </div>
                        <p className="text-gray-600">{session.topic}</p>
                        {session.videoLink && (
                          <a 
                            href={session.videoLink} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-1 mt-2 text-sm text-blue-600 hover:text-blue-700"
                          >
                            üîó Join Video Call
                          </a>
                        )}
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          onClick={() => handleComplete(session)}
                          className="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700"
                        >
                          Complete
                        </button>
                        <button
                          onClick={() => {
                            if (confirm('Cancel this session?')) {
                              onUpdateStatus(session.id, 'cancelled');
                            }
                          }}
                          className="px-3 py-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 text-sm rounded-lg"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Past Sessions */}
          {pastSessions.length > 0 && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200">
                <h3 className="font-semibold text-gray-900 flex items-center gap-2">
                  <span>üìã</span>
                  <span>Past Sessions</span>
                </h3>
              </div>
              
              <div className="divide-y divide-gray-100">
                {pastSessions.map(session => (
                  <div key={session.id} className="px-6 py-4 hover:bg-gray-50">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <span className={`font-medium ${session.status === 'cancelled' ? 'text-gray-400 line-through' : 'text-gray-900'}`}>
                            {formatDateTime(session.dateTime)}
                          </span>
                          <span className="text-gray-400">‚Ä¢</span>
                          <span className="text-sm text-gray-500">{session.duration} min</span>
                          {getStatusBadge(session.status)}
                        </div>
                        <p className={`${session.status === 'cancelled' ? 'text-gray-400' : 'text-gray-600'}`}>{session.topic}</p>
                        {session.notes && (
                          <div className="mt-2 p-2 bg-gray-50 rounded text-sm text-gray-600">
                            <span className="font-medium">Notes:</span> {session.notes}
                          </div>
                        )}
                      </div>
                      <button
                        onClick={() => {
                          if (confirm('Delete this session?')) {
                            onDeleteSession(session.id);
                          }
                        }}
                        className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg"
                      >
                        {Icons.trash}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Notes Modal */}
          {notesModalOpen && notesSession && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl shadow-xl max-w-lg w-full">
                <div className="px-6 py-4 border-b border-gray-200">
                  <h3 className="font-semibold text-gray-900">Complete Session</h3>
                  <p className="text-sm text-gray-500 mt-1">{formatDateTime(notesSession.dateTime)} - {notesSession.topic}</p>
                </div>
                <div className="p-6">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Session Notes (optional)</label>
                  <textarea
                    value={sessionNotes}
                    onChange={(e) => setSessionNotes(e.target.value)}
                    placeholder="Key takeaways, action items, areas to focus on..."
                    rows={4}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
                <div className="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
                  <button
                    onClick={() => {
                      setNotesModalOpen(false);
                      setNotesSession(null);
                      setSessionNotes('');
                    }}
                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={saveNotesAndComplete}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                  >
                    Mark as Completed
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // STUDENTS PAGE (FOR MENTORS)
    // =============================================================================
    function StudentsPage({ userProfile, isMobile }) {
      const [students, setStudents] = useState([]);
      const [inviteEmail, setInviteEmail] = useState('');
      const [loading, setLoading] = useState(true);
      const [inviting, setInviting] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [studentData, setStudentData] = useState(null);
      const [loadingStudentData, setLoadingStudentData] = useState(false);
      const [activeJournalTab, setActiveJournalTab] = useState('dashboard');
      const [selectedDate, setSelectedDate] = useState(todayISO());
      
      // Mentor dashboard state
      const [dashboardView, setDashboardView] = useState('dashboard'); // 'dashboard' or 'list'
      const [allStudentData, setAllStudentData] = useState({}); // { studentId: { trades, assignments, checkins } }
      const [loadingDashboard, setLoadingDashboard] = useState(true);
      
      // Feedback state
      const [tradeFeedback, setTradeFeedback] = useState([]);
      const [tradeFlags, setTradeFlags] = useState([]);
      
      // Trade Questions state
      const [tradeQuestions, setTradeQuestions] = useState([]);
      
      // Assignments state
      const [assignments, setAssignments] = useState([]);
      const [assignmentModalOpen, setAssignmentModalOpen] = useState(false);
      
      // Check-ins state
      const [weeklyCheckins, setWeeklyCheckins] = useState([]);
      
      // Sessions state
      const [sessions, setSessions] = useState([]);

      // Journal tabs for mentor view
      const journalTabs = [
        { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
        { id: 'tradelog', label: 'Trade Log', icon: 'tradelog' },
        { id: 'calendar', label: 'Calendar', icon: 'calendar' },
        { id: 'goals', label: 'Goals', icon: 'goals' },
        { id: 'setups', label: 'Setups', icon: 'setups' },
        { id: 'mistakes', label: 'Mistakes', icon: 'mistakes' },
        { id: 'assignments', label: 'Assignments', icon: 'assignments' },
        { id: 'checkins', label: 'Check-ins', icon: 'checkins' },
        { id: 'sessions', label: 'Sessions', icon: 'sessions' },
      ];

      // Load students (check both 'students' and 'mentees' collections for backwards compatibility)
      useEffect(() => {
        if (!userProfile?.uid) return;

        // Try 'mentees' collection first (legacy), then 'students'
        const unsubscribers = [];
        let allStudents = { mentees: [], students: [] };
        
        const updateStudentList = () => {
          const combined = [...allStudents.mentees, ...allStudents.students];
          // Remove duplicates by id
          const unique = combined.filter((v, i, a) => a.findIndex(t => t.id === v.id) === i);
          setStudents(unique);
          setLoading(false);
        };

        // Listen to 'mentees' subcollection
        const unsubMentees = db.collection('mentorships')
          .doc(userProfile.uid)
          .collection('mentees')
          .onSnapshot((snapshot) => {
            allStudents.mentees = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            updateStudentList();
          }, (error) => {
            console.log('Mentees collection not found or error:', error.message);
            allStudents.mentees = [];
            updateStudentList();
          });
        unsubscribers.push(unsubMentees);

        // Listen to 'students' subcollection
        const unsubStudents = db.collection('mentorships')
          .doc(userProfile.uid)
          .collection('students')
          .onSnapshot((snapshot) => {
            allStudents.students = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            updateStudentList();
          }, (error) => {
            console.log('Students collection not found or error:', error.message);
            allStudents.students = [];
            updateStudentList();
          });
        unsubscribers.push(unsubStudents);

        return () => unsubscribers.forEach(unsub => unsub());
      }, [userProfile?.uid]);

      // Load all student data for dashboard view
      useEffect(() => {
        if (students.length === 0) {
          setLoadingDashboard(false);
          return;
        }

        const unsubscribers = [];

        students.forEach(student => {
          // Subscribe to each student's journal data
          const unsubJournal = db.collection('users')
            .doc(student.id)
            .collection('journalData')
            .doc('state')
            .onSnapshot((doc) => {
              if (doc.exists) {
                setAllStudentData(prev => ({
                  ...prev,
                  [student.id]: {
                    ...prev[student.id],
                    trades: doc.data().trades || [],
                  }
                }));
              }
            });
          unsubscribers.push(unsubJournal);

          // Subscribe to assignments
          const unsubAssignments = db.collection('users')
            .doc(student.id)
            .collection('assignments')
            .onSnapshot((snapshot) => {
              setAllStudentData(prev => ({
                ...prev,
                [student.id]: {
                  ...prev[student.id],
                  assignments: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                }
              }));
            });
          unsubscribers.push(unsubAssignments);

          // Subscribe to check-ins
          const unsubCheckins = db.collection('users')
            .doc(student.id)
            .collection('weeklyCheckins')
            .orderBy('weekStart', 'desc')
            .onSnapshot((snapshot) => {
              setAllStudentData(prev => ({
                ...prev,
                [student.id]: {
                  ...prev[student.id],
                  checkins: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                }
              }));
            });
          unsubscribers.push(unsubCheckins);

          // Subscribe to trade questions (with error handling)
          const unsubQuestions = db.collection('users')
            .doc(student.id)
            .collection('tradeQuestions')
            .orderBy('createdAt', 'desc')
            .onSnapshot(
              (snapshot) => {
                setAllStudentData(prev => ({
                  ...prev,
                  [student.id]: {
                    ...prev[student.id],
                    questions: snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                  }
                }));
              },
              (error) => {
                console.log('Trade questions subscription error (update Firestore rules):', error.message);
                // Set empty questions array on error so it doesn't break the app
                setAllStudentData(prev => ({
                  ...prev,
                  [student.id]: {
                    ...prev[student.id],
                    questions: [],
                  }
                }));
              }
            );
          unsubscribers.push(unsubQuestions);
        });

        setLoadingDashboard(false);

        return () => {
          unsubscribers.forEach(unsub => unsub());
        };
      }, [students]);

      // Load feedback, assignments, and checkins when student selected
      useEffect(() => {
        if (!selectedStudent?.id) {
          setTradeFeedback([]);
          setTradeFlags([]);
          setAssignments([]);
          setWeeklyCheckins([]);
          setSessions([]);
          return;
        }

        // Subscribe to feedback
        const unsubFeedback = db.collection('users')
          .doc(selectedStudent.id)
          .collection('tradeFeedback')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            setTradeFeedback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to flags
        const unsubFlags = db.collection('users')
          .doc(selectedStudent.id)
          .collection('tradeFlags')
          .onSnapshot((snapshot) => {
            setTradeFlags(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to assignments
        const unsubAssignments = db.collection('users')
          .doc(selectedStudent.id)
          .collection('assignments')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            setAssignments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to weekly check-ins
        const unsubCheckins = db.collection('users')
          .doc(selectedStudent.id)
          .collection('weeklyCheckins')
          .orderBy('weekStart', 'desc')
          .onSnapshot((snapshot) => {
            setWeeklyCheckins(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to trade questions (with error handling)
        const unsubQuestions = db.collection('users')
          .doc(selectedStudent.id)
          .collection('tradeQuestions')
          .orderBy('createdAt', 'desc')
          .onSnapshot(
            (snapshot) => {
              setTradeQuestions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            },
            (error) => {
              console.log('Trade questions error (update Firestore rules):', error.message);
              setTradeQuestions([]);
            }
          );

        // Subscribe to sessions (with error handling)
        const unsubSessions = db.collection('users')
          .doc(selectedStudent.id)
          .collection('sessions')
          .orderBy('dateTime', 'desc')
          .onSnapshot(
            (snapshot) => {
              setSessions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            },
            (error) => {
              console.log('Sessions error (update Firestore rules):', error.message);
              setSessions([]);
            }
          );

        return () => {
          unsubFeedback();
          unsubFlags();
          unsubAssignments();
          unsubCheckins();
          unsubQuestions();
          unsubSessions();
        };
      }, [selectedStudent?.id]);

      // Helper to create notification for student
      const createNotification = async (studentId, type, title, message, link = null) => {
        try {
          await db.collection('users')
            .doc(studentId)
            .collection('notifications')
            .add({
              type,
              title,
              message,
              link,
              read: false,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
        } catch (err) {
          console.error('Failed to create notification:', err);
        }
      };

      // Add feedback to a trade
      const addFeedback = async (tradeId, type, content) => {
        if (!selectedStudent?.id || !content.trim()) return;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('tradeFeedback')
            .add({
              tradeId,
              mentorId: userProfile.uid,
              mentorName: userProfile.displayName,
              type,
              content: content.trim(),
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              read: false,
            });

          // Create notification
          await createNotification(
            selectedStudent.id,
            'feedback',
            `${userProfile.displayName} left feedback`,
            content.trim().substring(0, 100) + (content.length > 100 ? '...' : ''),
            'tradelog'
          );

          return true;
        } catch (err) {
          console.error('Failed to add feedback:', err);
          return false;
        }
      };

      // Add/update flag on a trade
      const addFlag = async (tradeId, flagType, note = '') => {
        if (!selectedStudent?.id) return;

        try {
          // Check if flag already exists for this trade
          const existingFlag = tradeFlags.find(f => f.tradeId === tradeId);
          
          if (existingFlag) {
            // Update existing flag
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('tradeFlags')
              .doc(existingFlag.id)
              .update({
                flagType,
                note,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          } else {
            // Create new flag
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('tradeFlags')
              .add({
                tradeId,
                mentorId: userProfile.uid,
                mentorName: userProfile.displayName,
                flagType,
                note,
                status: 'open',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            // Create notification for new flag
            const flagLabels = { discuss: 'Let\'s Discuss', great: 'Great Trade!', risk: 'Risk Concern', violation: 'Rule Violation' };
            await createNotification(
              selectedStudent.id,
              'flag',
              `${userProfile.displayName} flagged a trade`,
              `${flagLabels[flagType] || 'Flagged for review'}${note ? ': ' + note.substring(0, 50) : ''}`,
              'tradelog'
            );
          }
          return true;
        } catch (err) {
          console.error('Failed to add flag:', err);
          return false;
        }
      };

      // Remove flag from a trade
      const removeFlag = async (tradeId) => {
        if (!selectedStudent?.id) return;

        try {
          const existingFlag = tradeFlags.find(f => f.tradeId === tradeId);
          if (existingFlag) {
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('tradeFlags')
              .doc(existingFlag.id)
              .delete();
          }
          return true;
        } catch (err) {
          console.error('Failed to remove flag:', err);
          return false;
        }
      };

      // Resolve/reopen flag
      const toggleFlagStatus = async (tradeId) => {
        if (!selectedStudent?.id) return;

        try {
          const existingFlag = tradeFlags.find(f => f.tradeId === tradeId);
          if (existingFlag) {
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('tradeFlags')
              .doc(existingFlag.id)
              .update({
                status: existingFlag.status === 'open' ? 'resolved' : 'open',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          }
          return true;
        } catch (err) {
          console.error('Failed to toggle flag status:', err);
          return false;
        }
      };

      // Answer a trade question (mentor)
      const answerQuestion = async (questionId, answer) => {
        if (!selectedStudent?.id || !answer.trim()) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('tradeQuestions')
            .doc(questionId)
            .update({
              answer: answer.trim(),
              answeredAt: firebase.firestore.FieldValue.serverTimestamp(),
              mentorId: userProfile.uid,
              mentorName: userProfile.displayName,
              status: 'answered',
            });

          // Create notification
          await createNotification(
            selectedStudent.id,
            'question_answered',
            `${userProfile.displayName} answered your question`,
            answer.trim().substring(0, 100) + (answer.length > 100 ? '...' : ''),
            'tradelog'
          );

          return true;
        } catch (err) {
          console.error('Failed to answer question:', err);
          return false;
        }
      };

      // Resolve a question
      const resolveQuestion = async (questionId) => {
        if (!selectedStudent?.id) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('tradeQuestions')
            .doc(questionId)
            .update({
              status: 'resolved',
              resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          return true;
        } catch (err) {
          console.error('Failed to resolve question:', err);
          return false;
        }
      };

      // Create a session (mentor)
      const createSession = async (sessionData) => {
        if (!selectedStudent?.id) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('sessions')
            .add({
              ...sessionData,
              scheduledBy: 'mentor',
              scheduledById: userProfile.uid,
              scheduledByName: userProfile.displayName,
              studentId: selectedStudent.id,
              studentName: selectedStudent.displayName,
              status: 'confirmed', // Mentor-created sessions are auto-confirmed
              notes: '',
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Create notification
          const sessionDate = sessionData.dateTime?.toDate ? sessionData.dateTime.toDate() : new Date();
          await createNotification(
            selectedStudent.id,
            'session',
            `${userProfile.displayName} scheduled a session`,
            `${sessionDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })} - ${sessionData.topic}`,
            'sessions'
          );

          return true;
        } catch (err) {
          console.error('Failed to create session:', err);
          return false;
        }
      };

      // Update session status
      const updateSessionStatus = async (sessionId, status, notes = null) => {
        if (!selectedStudent?.id) return false;

        try {
          const updateData = {
            status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          if (notes !== null) {
            updateData.notes = notes;
          }
          if (status === 'completed') {
            updateData.completedAt = firebase.firestore.FieldValue.serverTimestamp();
          }
          
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('sessions')
            .doc(sessionId)
            .update(updateData);
          return true;
        } catch (err) {
          console.error('Failed to update session:', err);
          return false;
        }
      };

      // Delete session
      const deleteSession = async (sessionId) => {
        if (!selectedStudent?.id) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('sessions')
            .doc(sessionId)
            .delete();
          return true;
        } catch (err) {
          console.error('Failed to delete session:', err);
          return false;
        }
      };

      // Create assignment
      const createAssignment = async (assignmentData) => {
        if (!selectedStudent?.id) return false;

        try {
          // Create the assignment
          const assignmentRef = await db.collection('users')
            .doc(selectedStudent.id)
            .collection('assignments')
            .add({
              ...assignmentData,
              mentorId: userProfile.uid,
              mentorName: userProfile.displayName,
              status: 'assigned',
              studentNotes: '',
              mentorReview: null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              completedAt: null,
            });

          // If assignment has a challenge, also add it to the student's challenges in journalState
          if (assignmentData.hasChallenge && assignmentData.challenge) {
            const challengeTypeLabels = {
              profit: 'Profit Target',
              winrate: 'Win Rate',
              trades: 'Trade Count',
              streak: 'Profitable Streak',
              max_loss: 'Max Loss Limit',
            };
            
            const challenge = {
              id: generateId(),
              assignmentId: assignmentRef.id, // Link back to assignment
              fromMentor: true,
              mentorName: userProfile.displayName,
              name: `${assignmentData.title} (${challengeTypeLabels[assignmentData.challenge.type] || 'Challenge'})`,
              type: assignmentData.challenge.type,
              condition: assignmentData.challenge.type === 'winrate' ? 'win_rate' : 
                        assignmentData.challenge.type === 'profit' ? 'by_date' :
                        assignmentData.challenge.type === 'trades' ? 'in_trades' :
                        assignmentData.challenge.type === 'streak' ? 'profitable_days' :
                        assignmentData.challenge.type === 'max_loss' ? 'max_loss_days' : 'custom',
              targetValue: assignmentData.challenge.type === 'profit' ? assignmentData.challenge.target : 0,
              targetPercent: assignmentData.challenge.type === 'winrate' ? assignmentData.challenge.target : 0,
              tradeLimit: assignmentData.challenge.tradesRequired || 0,
              streakDays: assignmentData.challenge.type === 'streak' ? assignmentData.challenge.target : 0,
              maxLossAmount: assignmentData.challenge.type === 'max_loss' ? assignmentData.challenge.target : 0,
              endDate: assignmentData.challenge.endDate || assignmentData.dueDate || '',
              startDate: todayISO(),
              createdAt: nowISO(),
            };

            // Get current student journalState and add the challenge
            const stateDoc = await db.collection('users')
              .doc(selectedStudent.id)
              .collection('journalData')
              .doc('state')
              .get();

            const currentState = stateDoc.exists ? stateDoc.data() : { challenges: [] };
            const updatedChallenges = [...(currentState.challenges || []), challenge];

            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('journalData')
              .doc('state')
              .set({
                ...currentState,
                challenges: updatedChallenges,
              }, { merge: true });
          }

          // Create notification
          await createNotification(
            selectedStudent.id,
            'assignment',
            `${userProfile.displayName} assigned you homework`,
            assignmentData.title + (assignmentData.hasChallenge ? ' (includes challenge)' : ''),
            'assignments'
          );

          return true;
        } catch (err) {
          console.error('Failed to create assignment:', err);
          return false;
        }
      };

      // Update assignment (for mentor review)
      const updateAssignment = async (assignmentId, updates) => {
        if (!selectedStudent?.id) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('assignments')
            .doc(assignmentId)
            .update({
              ...updates,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Create notification if mentor is reviewing
          if (updates.mentorReview) {
            await createNotification(
              selectedStudent.id,
              'assignment_reviewed',
              `${userProfile.displayName} reviewed your assignment`,
              updates.mentorReview.feedback?.substring(0, 100) || 'Check your assignment for feedback',
              'assignments'
            );
          }

          return true;
        } catch (err) {
          console.error('Failed to update assignment:', err);
          return false;
        }
      };

      // Delete assignment
      const deleteAssignment = async (assignmentId) => {
        if (!selectedStudent?.id) return false;

        try {
          // First get the assignment to check if it has a linked challenge
          const assignmentDoc = await db.collection('users')
            .doc(selectedStudent.id)
            .collection('assignments')
            .doc(assignmentId)
            .get();
          
          const assignment = assignmentDoc.data();

          // Delete the assignment
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('assignments')
            .doc(assignmentId)
            .delete();

          // If it had a challenge, also remove from journalState
          if (assignment?.hasChallenge) {
            const stateDoc = await db.collection('users')
              .doc(selectedStudent.id)
              .collection('journalData')
              .doc('state')
              .get();

            if (stateDoc.exists) {
              const currentState = stateDoc.data();
              const updatedChallenges = (currentState.challenges || []).filter(
                c => c.assignmentId !== assignmentId
              );

              await db.collection('users')
                .doc(selectedStudent.id)
                .collection('journalData')
                .doc('state')
                .update({ challenges: updatedChallenges });
            }
          }

          return true;
        } catch (err) {
          console.error('Failed to delete assignment:', err);
          return false;
        }
      };

      // Create weekly check-in
      const createCheckin = async (checkinData) => {
        if (!selectedStudent?.id) return false;

        try {
          // Check if checkin for this week already exists
          const existingCheckin = weeklyCheckins.find(c => c.weekStart === checkinData.weekStart);
          
          if (existingCheckin) {
            // Update existing
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('weeklyCheckins')
              .doc(existingCheckin.id)
              .update({
                ...checkinData,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          } else {
            // Create new
            await db.collection('users')
              .doc(selectedStudent.id)
              .collection('weeklyCheckins')
              .add({
                ...checkinData,
                mentorId: userProfile.uid,
                mentorName: userProfile.displayName,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            // Create notification for new check-in
            await createNotification(
              selectedStudent.id,
              'checkin',
              `${userProfile.displayName} wrote your weekly check-in`,
              checkinData.focusForNextWeek ? `Focus: ${checkinData.focusForNextWeek.substring(0, 60)}...` : 'View your weekly review',
              'checkins'
            );
          }
          return true;
        } catch (err) {
          console.error('Failed to create check-in:', err);
          return false;
        }
      };

      // Delete weekly check-in
      const deleteCheckin = async (checkinId) => {
        if (!selectedStudent?.id) return false;

        try {
          await db.collection('users')
            .doc(selectedStudent.id)
            .collection('weeklyCheckins')
            .doc(checkinId)
            .delete();
          return true;
        } catch (err) {
          console.error('Failed to delete check-in:', err);
          return false;
        }
      };

      // Calculate challenge progress
      const calculateChallengeProgress = (challenge, trades) => {
        if (!challenge || !trades) return { current: 0, progress: 0, status: 'active' };

        const startDate = challenge.startDate;
        const endDate = challenge.endDate || todayISO();
        
        // Filter trades within date range
        const relevantTrades = trades.filter(t => 
          t.entryDate >= startDate && t.entryDate <= endDate
        ).map(t => ({ ...t, derived: calcTradeDerived(t) }));

        const closedTrades = relevantTrades.filter(t => !t.derived.isOpen);

        switch (challenge.type) {
          case 'profit':
            const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
            return { 
              current: totalPnL, 
              progress: Math.min(100, (totalPnL / challenge.target) * 100),
              status: totalPnL >= challenge.target ? 'completed' : 'active'
            };
            
          case 'winrate':
            const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
            const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length) * 100 : 0;
            const tradesNeeded = challenge.tradesRequired || 20;
            return { 
              current: winRate,
              tradesCompleted: closedTrades.length,
              tradesRequired: tradesNeeded,
              progress: Math.min(100, (closedTrades.length / tradesNeeded) * 100),
              status: closedTrades.length >= tradesNeeded ? (winRate >= challenge.target ? 'completed' : 'failed') : 'active'
            };
            
          case 'trades':
            return { 
              current: relevantTrades.length, 
              progress: Math.min(100, (relevantTrades.length / challenge.target) * 100),
              status: relevantTrades.length >= challenge.target ? 'completed' : 'active'
            };
            
          case 'streak':
            // Calculate consecutive profitable days
            const dailyPnL = {};
            closedTrades.forEach(t => {
              const date = t.exitDate || t.entryDate;
              dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
            });
            const sortedDays = Object.keys(dailyPnL).sort();
            let maxStreak = 0, currentStreak = 0;
            sortedDays.forEach(day => {
              if (dailyPnL[day] > 0) {
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);
              } else {
                currentStreak = 0;
              }
            });
            return { 
              current: maxStreak, 
              progress: Math.min(100, (maxStreak / challenge.target) * 100),
              status: maxStreak >= challenge.target ? 'completed' : 'active'
            };
            
          case 'max_loss':
            const losses = closedTrades.filter(t => (t.derived.pnlFinal || 0) < 0);
            const maxLoss = losses.length > 0 ? Math.min(...losses.map(t => t.derived.pnlFinal)) : 0;
            const withinLimit = Math.abs(maxLoss) <= challenge.target;
            return { 
              current: maxLoss, 
              progress: withinLimit ? 100 : 0,
              status: withinLimit ? 'active' : 'failed'
            };
            
          default:
            return { current: 0, progress: 0, status: 'active' };
        }
      };

      // Send invite
      const handleInvite = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        setInviting(true);

        try {
          // Find user by email
          const usersSnapshot = await db.collection('users')
            .where('email', '==', inviteEmail.toLowerCase().trim())
            .get();

          if (usersSnapshot.empty) {
            setError('No user found with that email. They need to create an account first.');
            setInviting(false);
            return;
          }

          const studentDoc = usersSnapshot.docs[0];
          const studentUserData = studentDoc.data();

          if (studentUserData.role === 'mentor') {
            setError('That user is a mentor account, not a trader.');
            setInviting(false);
            return;
          }

          if (studentUserData.mentorId) {
            setError('That trader already has a mentor connected.');
            setInviting(false);
            return;
          }

          // Check if already invited
          const existingStudent = students.find(m => m.email === inviteEmail.toLowerCase().trim());
          if (existingStudent) {
            setError('You have already invited this trader.');
            setInviting(false);
            return;
          }

          // Add to mentor's students
          await db.collection('mentorships')
            .doc(userProfile.uid)
            .collection('students')
            .doc(studentDoc.id)
            .set({
              email: studentUserData.email,
              displayName: studentUserData.displayName,
              photoURL: studentUserData.photoURL || null,
              status: 'pending',
              invitedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Update student's user doc with pending mentor
          await db.collection('users').doc(studentDoc.id).update({
            pendingMentorId: userProfile.uid,
            pendingMentorName: userProfile.displayName,
            pendingMentorEmail: userProfile.email,
          });

          // Send email notification to student
          const emailData = emailTemplates.mentorInvite(userProfile.displayName, studentUserData.email);
          await sendEmail(emailData);

          setSuccess(`Invite sent to ${studentUserData.displayName}!`);
          setInviteEmail('');
        } catch (err) {
          console.error('Invite error:', err);
          setError('Failed to send invite. Please try again.');
        } finally {
          setInviting(false);
        }
      };

      // Load student data when selected
      const loadStudentData = async (student) => {
        if (student.status !== 'active') {
          setError('This student has not accepted your invite yet.');
          return;
        }

        setLoadingStudentData(true);
        setSelectedStudent(student);
        setActiveJournalTab('dashboard');

        try {
          const stateDoc = await db.collection('users')
            .doc(student.id)
            .collection('journalData')
            .doc('state')
            .get();

          if (stateDoc.exists) {
            setStudentData(stateDoc.data());
          } else {
            setStudentData(EMPTY_STATE);
          }
        } catch (err) {
          console.error('Failed to load student data:', err);
          setError('Failed to load student data.');
        } finally {
          setLoadingStudentData(false);
        }
      };

      // Remove student
      const removeStudent = async (studentId) => {
        if (!confirm('Are you sure you want to remove this student?')) return;

        try {
          // Remove from mentor's list
          await db.collection('mentorships')
            .doc(userProfile.uid)
            .collection('students')
            .doc(studentId)
            .delete();

          // Update student's user doc
          await db.collection('users').doc(studentId).update({
            mentorId: firebase.firestore.FieldValue.delete(),
            mentorName: firebase.firestore.FieldValue.delete(),
            pendingMentorId: firebase.firestore.FieldValue.delete(),
            pendingMentorName: firebase.firestore.FieldValue.delete(),
            pendingMentorEmail: firebase.firestore.FieldValue.delete(),
          });

          if (selectedStudent?.id === studentId) {
            setSelectedStudent(null);
            setStudentData(null);
          }
        } catch (err) {
          console.error('Failed to remove student:', err);
          setError('Failed to remove student.');
        }
      };

      // Back to student list
      const handleBackToList = () => {
        setSelectedStudent(null);
        setStudentData(null);
        setActiveJournalTab('dashboard');
        setTradeFeedback([]);
        setTradeFlags([]);
      };

      // Calculate dashboard data (must be before any returns to satisfy hooks rules)
      const currentWeek = getWeekBounds();
      
      const dashboardData = useMemo(() => {
        const studentsNeedingCheckin = [];
        const studentsNeedingAttention = [];
        const completedAssignmentsToReview = [];
        const overdueAssignments = [];
        const pendingQuestions = [];
        const recentActivity = [];
        
        let totalTradesThisWeek = 0;
        let totalPnLThisWeek = 0;
        let totalWinsThisWeek = 0;
        let totalClosedTradesThisWeek = 0;

        students.forEach(student => {
          const data = allStudentData[student.id] || {};
          const trades = data.trades || [];
          const assignments = data.assignments || [];
          const checkins = data.checkins || [];
          const questions = data.questions || [];

          // Check if weekly check-in is needed for current week
          const hasCurrentWeekCheckin = checkins.some(c => c.weekStart === currentWeek.start);
          if (!hasCurrentWeekCheckin && student.status === 'active') {
            studentsNeedingCheckin.push({
              ...student,
              weekStats: calculateWeekStats(trades, currentWeek.start, currentWeek.end),
            });
          }

          // Check for pending questions (status === 'asked')
          questions.forEach(q => {
            if (q.status === 'asked') {
              pendingQuestions.push({
                student,
                question: q,
              });
            }
          });

          // Calculate this week's stats for this student
          const weekStats = calculateWeekStats(trades, currentWeek.start, currentWeek.end);
          totalTradesThisWeek += weekStats.totalTrades;
          totalPnLThisWeek += weekStats.totalPnL;
          
          // Count wins for average win rate calculation
          const weekTrades = trades.filter(t => {
            const date = t.exitDate || t.entryDate;
            return date >= currentWeek.start && date <= currentWeek.end;
          }).map(t => ({ ...t, derived: calcTradeDerived(t) }));
          const closedWeekTrades = weekTrades.filter(t => !t.derived.isOpen);
          totalClosedTradesThisWeek += closedWeekTrades.length;
          totalWinsThisWeek += closedWeekTrades.filter(t => t.derived.winLoss === 'W').length;

          // Check for red days (2+ losing days this week)
          const dailyPnL = {};
          closedWeekTrades.forEach(t => {
            const date = t.exitDate || t.entryDate;
            dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
          });
          const redDays = Object.values(dailyPnL).filter(pnl => pnl < 0).length;
          if (redDays >= 2) {
            studentsNeedingAttention.push({
              type: 'red_days',
              student,
              count: redDays,
              message: `had ${redDays} red days this week`,
            });
          }

          // Check for overdue assignments
          const today = todayISO();
          assignments.forEach(a => {
            if (a.dueDate && a.dueDate < today && ['assigned', 'in_progress'].includes(a.status)) {
              overdueAssignments.push({
                student,
                assignment: a,
              });
            }
            
            // Check for completed assignments awaiting review
            if (a.status === 'completed' && !a.mentorReview) {
              completedAssignmentsToReview.push({
                student,
                assignment: a,
              });
            }

            // Add to recent activity
            if (a.completedAt) {
              recentActivity.push({
                type: 'assignment_completed',
                student,
                assignment: a,
                timestamp: a.completedAt?.toDate?.() || new Date(),
                message: `completed "${a.title}"`,
              });
            }
          });

          // Check if student hasn't traded in 5+ days
          if (trades.length > 0) {
            const sortedTrades = [...trades].sort((a, b) => 
              (b.exitDate || b.entryDate).localeCompare(a.exitDate || a.entryDate)
            );
            const lastTradeDate = sortedTrades[0]?.exitDate || sortedTrades[0]?.entryDate;
            if (lastTradeDate) {
              const daysSinceLastTrade = Math.floor((new Date() - new Date(lastTradeDate)) / (1000 * 60 * 60 * 24));
              if (daysSinceLastTrade >= 5) {
                studentsNeedingAttention.push({
                  type: 'inactive',
                  student,
                  days: daysSinceLastTrade,
                  message: `hasn't traded in ${daysSinceLastTrade} days`,
                });
              }
            }
          }
        });

        // Add overdue assignments to attention
        overdueAssignments.forEach(({ student, assignment }) => {
          studentsNeedingAttention.push({
            type: 'overdue',
            student,
            assignment,
            message: `has overdue assignment "${assignment.title}"`,
          });
        });

        // Sort recent activity by timestamp
        recentActivity.sort((a, b) => b.timestamp - a.timestamp);

        const avgWinRate = totalClosedTradesThisWeek > 0 
          ? (totalWinsThisWeek / totalClosedTradesThisWeek) * 100 
          : 0;

        return {
          studentsNeedingCheckin,
          studentsNeedingAttention,
          completedAssignmentsToReview,
          pendingQuestions,
          recentActivity: recentActivity.slice(0, 10),
          totalTradesThisWeek,
          totalPnLThisWeek,
          avgWinRate,
        };
      }, [students, allStudentData, currentWeek.start, currentWeek.end]);

      // Helper to get student status
      const getStudentStatus = (studentId) => {
        const data = allStudentData[studentId] || {};
        const trades = data.trades || [];
        const weekStats = calculateWeekStats(trades, currentWeek.start, currentWeek.end);
        
        if (weekStats.totalTrades === 0) return { color: 'gray', label: 'No trades' };
        if (weekStats.totalPnL > 0 || weekStats.winRate > 55) return { color: 'green', label: 'On Track' };
        if (weekStats.totalPnL >= -50 && weekStats.winRate >= 45) return { color: 'yellow', label: 'Break-even' };
        return { color: 'red', label: 'Struggling' };
      };

      // Render the active journal tab content
      const renderJournalContent = () => {
        if (loadingStudentData) {
          return (
            <div className="flex items-center justify-center h-64">
              <div className="text-center">
                <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p className="text-gray-500">Loading journal...</p>
              </div>
            </div>
          );
        }

        if (!studentData) return null;

        // Read-only setState that does nothing
        const readOnlySetState = () => {};

        switch (activeJournalTab) {
          case 'dashboard':
            return (
              <DashboardPage 
                state={studentData} 
                setState={readOnlySetState}
                setActivePage={() => {}}
                setSelectedDate={setSelectedDate}
                isMobile={isMobile}
                isReadOnly={true}
              />
            );
          case 'tradelog':
            return (
              <TradeLogPage 
                state={studentData} 
                setState={readOnlySetState}
                isMobile={isMobile}
                isReadOnly={true}
                isMentorView={true}
                tradeFeedback={tradeFeedback}
                tradeFlags={tradeFlags}
                onAddFeedback={addFeedback}
                onAddFlag={addFlag}
                onRemoveFlag={removeFlag}
                onToggleFlagStatus={toggleFlagStatus}
                tradeQuestions={tradeQuestions}
                onAnswerQuestion={answerQuestion}
                onResolveQuestion={resolveQuestion}
                userProfile={userProfile}
              />
            );
          case 'calendar':
            return (
              <CalendarPage 
                state={studentData} 
                setState={readOnlySetState}
                selectedDate={selectedDate}
                setSelectedDate={setSelectedDate}
                isMobile={isMobile}
                isReadOnly={true}
              />
            );
          case 'goals':
            return (
              <GoalsPage 
                state={studentData} 
                setState={readOnlySetState}
                isMobile={isMobile}
                isReadOnly={true}
              />
            );
          case 'setups':
            return (
              <SetupsPage 
                state={studentData} 
                setState={readOnlySetState}
                isMobile={isMobile}
                isReadOnly={true}
              />
            );
          case 'mistakes':
            return (
              <MistakesPage 
                state={studentData} 
                setState={readOnlySetState}
                isMobile={isMobile}
                isReadOnly={true}
              />
            );
          case 'assignments':
            return (
              <MentorAssignmentsTab
                assignments={assignments}
                studentData={studentData}
                selectedStudent={selectedStudent}
                onCreateAssignment={createAssignment}
                onUpdateAssignment={updateAssignment}
                onDeleteAssignment={deleteAssignment}
                calculateChallengeProgress={calculateChallengeProgress}
                isMobile={isMobile}
              />
            );
          case 'checkins':
            return (
              <MentorCheckinsTab
                checkins={weeklyCheckins}
                studentData={studentData}
                selectedStudent={selectedStudent}
                onCreateCheckin={createCheckin}
                onDeleteCheckin={deleteCheckin}
                onCreateAssignment={createAssignment}
                isMobile={isMobile}
              />
            );
          case 'sessions':
            return (
              <MentorSessionsTab
                sessions={sessions}
                selectedStudent={selectedStudent}
                userProfile={userProfile}
                onCreateSession={createSession}
                onUpdateStatus={updateSessionStatus}
                onDeleteSession={deleteSession}
                isMobile={isMobile}
              />
            );
          default:
            return null;
        }
      };

      // If viewing a student's journal, show full journal view
      if (selectedStudent) {
        return (
          <div className="space-y-4">
            {/* Header Bar */}
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm">
              <div className="px-4 py-3 flex items-center justify-between flex-wrap gap-3">
                {/* Back Button */}
                <button
                  onClick={handleBackToList}
                  className="flex items-center gap-2 text-gray-600 hover:text-gray-900 font-medium"
                >
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                    <path d="M19 12H5M12 19l-7-7 7-7" />
                  </svg>
                  <span className="hidden sm:inline">Back to Students</span>
                </button>

                {/* Student Info */}
                <div className="flex items-center gap-3">
                  <Avatar user={selectedStudent} size="md" />
                  <div>
                    <h2 className="font-semibold text-gray-900">{selectedStudent.displayName}'s Journal</h2>
                    <p className="text-xs text-gray-500">{selectedStudent.email}</p>
                  </div>
                </div>

                {/* Read-Only Badge */}
                <div className="flex items-center gap-2 bg-amber-50 text-amber-700 px-3 py-1.5 rounded-full text-sm font-medium border border-amber-200">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0110 0v4" />
                  </svg>
                  <span>Read-Only</span>
                </div>
              </div>

              {/* Sub-Navigation Tabs */}
              <div className="border-t border-gray-200 px-4">
                <div className="flex gap-1 overflow-x-auto hide-scrollbar">
                  {journalTabs.map(tab => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveJournalTab(tab.id)}
                      className={`px-4 py-3 font-medium text-sm whitespace-nowrap border-b-2 transition-colors ${
                        activeJournalTab === tab.id
                          ? 'text-blue-600 border-blue-600'
                          : 'text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300'
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Journal Content */}
            <div>
              {renderJournalContent()}
            </div>
          </div>
        );
      }

      // Student List/Dashboard View
      return (
        <div className="space-y-6">
          {/* Header with View Toggle */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                {dashboardView === 'dashboard' ? 'Mentor Dashboard' : 'My Students'}
              </h1>
              <p className="text-sm text-gray-500 mt-1">
                {students.length} student{students.length !== 1 ? 's' : ''} ‚Ä¢ Week of {formatWeekRange(currentWeek.start, currentWeek.end)}
              </p>
            </div>
            <div className="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
              <button
                onClick={() => setDashboardView('dashboard')}
                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                  dashboardView === 'dashboard' 
                    ? 'bg-white text-gray-900 shadow-sm' 
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                Dashboard
              </button>
              <button
                onClick={() => setDashboardView('list')}
                className={`px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${
                  dashboardView === 'list' 
                    ? 'bg-white text-gray-900 shadow-sm' 
                    : 'text-gray-600 hover:text-gray-900'
                }`}
              >
                List View
              </button>
            </div>
          </div>

          {dashboardView === 'dashboard' ? (
            <>
              {/* Stats Cards */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <p className="text-sm text-gray-500">Students</p>
                  <p className="text-2xl font-bold text-gray-900">{students.length}</p>
                </div>
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <p className="text-sm text-gray-500">Week P&L</p>
                  <p className={`text-2xl font-bold ${dashboardData.totalPnLThisWeek >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrency(dashboardData.totalPnLThisWeek)}
                  </p>
                </div>
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <p className="text-sm text-gray-500">Avg Win Rate</p>
                  <p className="text-2xl font-bold text-blue-600">{dashboardData.avgWinRate.toFixed(0)}%</p>
                </div>
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <p className="text-sm text-gray-500">Need Attention</p>
                  <p className="text-2xl font-bold text-orange-600">{dashboardData.studentsNeedingAttention.length}</p>
                </div>
              </div>

              {/* Weekly Check-in Alerts */}
              {dashboardData.studentsNeedingCheckin.length > 0 && (
                <div className="bg-gradient-to-r from-blue-500 to-indigo-500 rounded-xl p-4 text-white">
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-xl">üìÖ</span>
                    <h2 className="font-semibold">Weekly Check-ins Due</h2>
                    <span className="ml-auto bg-white/20 px-2 py-0.5 rounded-full text-sm">
                      {dashboardData.studentsNeedingCheckin.length} pending
                    </span>
                  </div>
                  <div className="space-y-2">
                    {dashboardData.studentsNeedingCheckin.map(student => (
                      <div 
                        key={student.id}
                        className="bg-white/10 rounded-lg p-3 flex items-center justify-between"
                      >
                        <div className="flex items-center gap-3">
                          {student.photoURL ? (
                            <img src={student.photoURL} alt={student.displayName} className="w-8 h-8 rounded-full object-cover" />
                          ) : (
                            <div className="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center font-bold">
                              {student.displayName?.charAt(0)?.toUpperCase() || '?'}
                            </div>
                          )}
                          <div>
                            <p className="font-medium">{student.displayName}</p>
                            <p className="text-sm text-blue-100">
                              {student.weekStats?.totalTrades || 0} trades ‚Ä¢ {formatCurrency(student.weekStats?.totalPnL || 0)}
                            </p>
                          </div>
                        </div>
                        <button
                          onClick={() => {
                            loadStudentData(student);
                            setActiveJournalTab('checkins');
                          }}
                          className="px-3 py-1.5 bg-white text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-50"
                        >
                          Write Check-in
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Assignments to Review */}
              {dashboardData.completedAssignmentsToReview.length > 0 && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                    <span className="text-lg">‚úÖ</span>
                    <h2 className="font-semibold text-gray-900">Assignments to Review</h2>
                    <span className="ml-auto bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-sm font-medium">
                      {dashboardData.completedAssignmentsToReview.length}
                    </span>
                  </div>
                  <div className="divide-y divide-gray-100">
                    {dashboardData.completedAssignmentsToReview.map(({ student, assignment }) => (
                      <div key={assignment.id} className="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                        <div>
                          <p className="font-medium text-gray-900">{assignment.title}</p>
                          <p className="text-sm text-gray-500">Completed by {student.displayName}</p>
                        </div>
                        <button
                          onClick={() => {
                            loadStudentData(student);
                            setActiveJournalTab('assignments');
                          }}
                          className="px-3 py-1.5 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700"
                        >
                          Review
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Pending Questions */}
              {dashboardData.pendingQuestions && dashboardData.pendingQuestions.length > 0 && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                    <span className="text-lg">‚ùì</span>
                    <h2 className="font-semibold text-gray-900">Questions Awaiting Answers</h2>
                    <span className="ml-auto bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-sm font-medium">
                      {dashboardData.pendingQuestions.length}
                    </span>
                  </div>
                  <div className="divide-y divide-gray-100">
                    {dashboardData.pendingQuestions.map(({ student, question }) => (
                      <div key={question.id} className="px-6 py-3 hover:bg-gray-50">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <p className="font-medium text-gray-900">{student.displayName}</p>
                              <span className="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded">
                                {question.questionType === 'entry' ? 'Entry' :
                                 question.questionType === 'exit' ? 'Exit' :
                                 question.questionType === 'improvement' ? 'Improvement' : 'General'}
                              </span>
                            </div>
                            <p className="text-sm text-gray-600 line-clamp-2">"{question.question}"</p>
                            <p className="text-xs text-gray-400 mt-1">
                              {question.createdAt?.toDate ? question.createdAt.toDate().toLocaleDateString() : 'Recently'}
                            </p>
                          </div>
                          <button
                            onClick={() => {
                              loadStudentData(student);
                              setActiveJournalTab('tradelog');
                            }}
                            className="ml-4 px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700"
                          >
                            Answer
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Needs Attention */}
              {dashboardData.studentsNeedingAttention.length > 0 && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-200 flex items-center gap-2">
                    <span className="text-lg">‚ö†Ô∏è</span>
                    <h2 className="font-semibold text-gray-900">Needs Attention</h2>
                  </div>
                  <div className="divide-y divide-gray-100">
                    {dashboardData.studentsNeedingAttention.map((alert, idx) => (
                      <div key={idx} className="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                        <div className="flex items-center gap-3">
                          <span className={`text-lg ${
                            alert.type === 'red_days' ? 'üî¥' : 
                            alert.type === 'overdue' ? 'üìã' : 'üí§'
                          }`}>
                            {alert.type === 'red_days' ? 'üî¥' : alert.type === 'overdue' ? 'üìã' : 'üí§'}
                          </span>
                          <div>
                            <p className="font-medium text-gray-900">{alert.student.displayName}</p>
                            <p className="text-sm text-gray-500">{alert.message}</p>
                          </div>
                        </div>
                        <button
                          onClick={() => loadStudentData(alert.student)}
                          className="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200"
                        >
                          View
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Student Performance Table */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div className="px-6 py-4 border-b border-gray-200">
                  <h2 className="font-semibold text-gray-900">üìä Student Performance This Week</h2>
                </div>
                {students.length === 0 ? (
                  <div className="p-8 text-center text-gray-500">No students yet</div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Trades</th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Win Rate</th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">P&L</th>
                          <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Action</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-200">
                        {students.filter(m => m.status === 'active').map(student => {
                          const data = allStudentData[student.id] || {};
                          const weekStats = calculateWeekStats(data.trades || [], currentWeek.start, currentWeek.end);
                          const status = getStudentStatus(student.id);
                          
                          return (
                            <tr key={student.id} className="hover:bg-gray-50">
                              <td className="px-6 py-4">
                                <div className="flex items-center gap-3">
                                  <Avatar user={student} size="sm" />
                                  <span className="font-medium text-gray-900">{student.displayName}</span>
                                </div>
                              </td>
                              <td className="px-6 py-4 text-center text-gray-900">{weekStats.totalTrades}</td>
                              <td className="px-6 py-4 text-center text-gray-900">{weekStats.winRate.toFixed(0)}%</td>
                              <td className={`px-6 py-4 text-center font-medium ${weekStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                {formatCurrency(weekStats.totalPnL)}
                              </td>
                              <td className="px-6 py-4 text-center">
                                <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${
                                  status.color === 'green' ? 'bg-emerald-100 text-emerald-700' :
                                  status.color === 'yellow' ? 'bg-yellow-100 text-yellow-700' :
                                  status.color === 'red' ? 'bg-red-100 text-red-700' :
                                  'bg-gray-100 text-gray-600'
                                }`}>
                                  <span>{status.color === 'green' ? 'üü¢' : status.color === 'yellow' ? 'üü°' : status.color === 'red' ? 'üî¥' : '‚ö™'}</span>
                                  {status.label}
                                </span>
                              </td>
                              <td className="px-6 py-4 text-right">
                                <button
                                  onClick={() => loadStudentData(student)}
                                  className="text-blue-600 hover:text-blue-700 font-medium text-sm"
                                >
                                  View ‚Üí
                                </button>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              {/* Recent Activity */}
              {dashboardData.recentActivity.length > 0 && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="font-semibold text-gray-900">üìù Recent Activity</h2>
                  </div>
                  <div className="divide-y divide-gray-100">
                    {dashboardData.recentActivity.map((activity, idx) => (
                      <div key={idx} className="px-6 py-3 flex items-center gap-3">
                        <span className="text-lg">
                          {activity.type === 'assignment_completed' ? '‚úÖ' : 'üìå'}
                        </span>
                        <div className="flex-1">
                          <span className="font-medium text-gray-900">{activity.student.displayName}</span>
                          <span className="text-gray-600"> {activity.message}</span>
                        </div>
                        <span className="text-sm text-gray-400">
                          {activity.timestamp.toLocaleDateString()}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </>
          ) : (
            <>
              {/* Invite Section */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                <h2 className="font-semibold text-gray-900 mb-4">Invite a Trader</h2>
                
                {error && (
                  <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                    {error}
                  </div>
                )}
                
                {success && (
                  <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm">
                    {success}
                  </div>
                )}

                <form onSubmit={handleInvite} className="flex gap-3">
                  <input
                    type="email"
                    value={inviteEmail}
                    onChange={(e) => setInviteEmail(e.target.value)}
                    placeholder="Enter trader's email"
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                  />
                  <button
                    type="submit"
                    disabled={inviting}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
                  >
                    {inviting ? 'Sending...' : 'Send Invite'}
                  </button>
                </form>
              </div>

              {/* Students List */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                <div className="px-6 py-4 border-b border-gray-200">
                  <h2 className="font-semibold text-gray-900">Your Students ({students.length})</h2>
                </div>

                {loading ? (
                  <div className="p-8 text-center text-gray-500">Loading...</div>
                ) : students.length === 0 ? (
                  <div className="p-12 text-center">
                    <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                      üë•
                    </div>
                    <h3 className="text-lg font-medium text-gray-900 mb-2">No students yet</h3>
                    <p className="text-gray-500">Invite traders to start mentoring them</p>
                  </div>
                ) : (
                  <div className="divide-y divide-gray-200">
                    {students.map(student => {
                      const isActive = student.status === 'active';
                      return (
                        <div key={student.id} className="px-6 py-4 hover:bg-gray-50">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <Avatar user={student} size="lg" />
                              <div>
                                <h3 className="font-medium text-gray-900">{student.displayName}</h3>
                                <p className="text-sm text-gray-500">{student.email}</p>
                              </div>
                              <span className={`px-2 py-1 text-xs rounded-full font-medium ${
                                isActive 
                                  ? 'bg-green-100 text-green-700' 
                                  : 'bg-yellow-100 text-yellow-700'
                              }`}>
                                {isActive ? 'Active' : 'Pending'}
                              </span>
                            </div>
                            <div className="flex items-center gap-2">
                              {isActive && (
                                <button
                                  onClick={() => loadStudentData(student)}
                                  className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 font-medium flex items-center gap-2"
                                >
                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" />
                                    <circle cx="12" cy="12" r="3" />
                                  </svg>
                                  View Journal
                                </button>
                              )}
                              <button
                                onClick={() => removeStudent(student.id)}
                                className="p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-lg"
                                title="Remove student"
                              >
                                {Icons.trash}
                              </button>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            </>
          )}
        </div>
      );
    }

    // =============================================================================
    // MENTOR INVITE BANNER (FOR TRADERS)
    // =============================================================================
    function MentorInviteBanner({ userProfile, onUpdate }) {
      const [responding, setResponding] = useState(false);

      const handleResponse = async (accept) => {
        setResponding(true);

        try {
          if (accept) {
            // Accept - update trader's profile
            await db.collection('users').doc(userProfile.uid).update({
              mentorId: userProfile.pendingMentorId,
              mentorName: userProfile.pendingMentorName,
              pendingMentorId: firebase.firestore.FieldValue.delete(),
              pendingMentorName: firebase.firestore.FieldValue.delete(),
              pendingMentorEmail: firebase.firestore.FieldValue.delete(),
            });

            // Update mentor's student record
            await db.collection('mentorships')
              .doc(userProfile.pendingMentorId)
              .collection('students')
              .doc(userProfile.uid)
              .update({
                status: 'active',
                photoURL: userProfile.photoURL || null,
                acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            // Send email notification to mentor
            const emailData = emailTemplates.inviteAccepted(userProfile.pendingMentorEmail, userProfile.displayName);
            await sendEmail(emailData);

            // Create in-app notification for mentor
            await db.collection('users')
              .doc(userProfile.pendingMentorId)
              .collection('notifications')
              .add({
                type: 'invite_accepted',
                title: `${userProfile.displayName} accepted your invitation!`,
                message: 'You can now view their trades and provide feedback.',
                link: 'students',
                read: false,
                studentId: userProfile.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          } else {
            // Decline - remove pending mentor
            await db.collection('users').doc(userProfile.uid).update({
              pendingMentorId: firebase.firestore.FieldValue.delete(),
              pendingMentorName: firebase.firestore.FieldValue.delete(),
              pendingMentorEmail: firebase.firestore.FieldValue.delete(),
            });

            // Remove from mentor's list
            await db.collection('mentorships')
              .doc(userProfile.pendingMentorId)
              .collection('students')
              .doc(userProfile.uid)
              .delete();
          }

          onUpdate();
        } catch (err) {
          console.error('Failed to respond to invite:', err);
          alert('Failed to respond. Please try again.');
        } finally {
          setResponding(false);
        }
      };

      if (!userProfile.pendingMentorId) return null;

      return (
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
          <div className="flex items-center justify-between">
            <div>
              <h3 className="font-medium text-blue-900">Mentor Invitation</h3>
              <p className="text-sm text-blue-700">
                <strong>{userProfile.pendingMentorName}</strong> wants to mentor you
              </p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => handleResponse(false)}
                disabled={responding}
                className="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
              >
                Decline
              </button>
              <button
                onClick={() => handleResponse(true)}
                disabled={responding}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
              >
                {responding ? 'Accepting...' : 'Accept'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // MAIN APP
    // =============================================================================
    function App() {
      const [user, setUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [sidebarExpanded, setSidebarExpanded] = useState(true);
      const [activePage, setActivePage] = useState('dashboard');
      const [selectedDate, setSelectedDate] = useState(null);
      const [journalState, setJournalState] = useState(EMPTY_STATE);
      const [storageInfo, setStorageInfo] = useState({ bytes: 0, megabytes: 0, percentUsed: 0, nearLimit: false });
      const [isMobile, setIsMobile] = useState(false);
      const [dataLoading, setDataLoading] = useState(true);
      
      // Feedback state for students
      const [myTradeFeedback, setMyTradeFeedback] = useState([]);
      const [myTradeFlags, setMyTradeFlags] = useState([]);
      
      // Trade Questions state for students
      const [myTradeQuestions, setMyTradeQuestions] = useState([]);
      
      // Assignments state for students
      const [myAssignments, setMyAssignments] = useState([]);
      
      // Check-ins state for students
      const [myCheckins, setMyCheckins] = useState([]);
      
      // Sessions state for students
      const [mySessions, setMySessions] = useState([]);
      
      // Notifications state for students
      const [notifications, setNotifications] = useState([]);

      // Listen for auth state changes
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
          setUser(firebaseUser);
          
          if (firebaseUser) {
            // Load user profile
            const profileDoc = await db.collection('users').doc(firebaseUser.uid).get();
            if (profileDoc.exists) {
              setUserProfile({ uid: firebaseUser.uid, ...profileDoc.data() });
            }
          } else {
            setUserProfile(null);
          }
          
          setAuthLoading(false);
        });

        return () => unsubscribe();
      }, []);

      // Load feedback, assignments, and check-ins for students (users with a mentor)
      useEffect(() => {
        if (!user || !userProfile?.mentorId) {
          setMyTradeFeedback([]);
          setMyTradeFlags([]);
          setMyTradeQuestions([]);
          setMyAssignments([]);
          setMyCheckins([]);
          setMySessions([]);
          return;
        }

        // Subscribe to feedback
        const unsubFeedback = db.collection('users')
          .doc(user.uid)
          .collection('tradeFeedback')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            setMyTradeFeedback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to flags
        const unsubFlags = db.collection('users')
          .doc(user.uid)
          .collection('tradeFlags')
          .onSnapshot((snapshot) => {
            setMyTradeFlags(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to trade questions (with error handling)
        const unsubQuestions = db.collection('users')
          .doc(user.uid)
          .collection('tradeQuestions')
          .orderBy('createdAt', 'desc')
          .onSnapshot(
            (snapshot) => {
              setMyTradeQuestions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            },
            (error) => {
              console.log('Trade questions error (update Firestore rules):', error.message);
              setMyTradeQuestions([]);
            }
          );

        // Subscribe to assignments
        const unsubAssignments = db.collection('users')
          .doc(user.uid)
          .collection('assignments')
          .orderBy('createdAt', 'desc')
          .onSnapshot((snapshot) => {
            setMyAssignments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to weekly check-ins
        const unsubCheckins = db.collection('users')
          .doc(user.uid)
          .collection('weeklyCheckins')
          .orderBy('weekStart', 'desc')
          .onSnapshot((snapshot) => {
            setMyCheckins(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          });

        // Subscribe to sessions (with error handling)
        const unsubSessions = db.collection('users')
          .doc(user.uid)
          .collection('sessions')
          .orderBy('dateTime', 'desc')
          .onSnapshot(
            (snapshot) => {
              setMySessions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            },
            (error) => {
              console.log('Sessions error (update Firestore rules):', error.message);
              setMySessions([]);
            }
          );

        return () => {
          unsubFeedback();
          unsubFlags();
          unsubQuestions();
          unsubAssignments();
          unsubCheckins();
          unsubSessions();
        };
      }, [user, userProfile?.mentorId]);

      // Load notifications for ALL users (mentors and students)
      useEffect(() => {
        if (!user) {
          setNotifications([]);
          return;
        }

        const unsubNotifications = db.collection('users')
          .doc(user.uid)
          .collection('notifications')
          .orderBy('createdAt', 'desc')
          .limit(50)
          .onSnapshot(
            (snapshot) => {
              setNotifications(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            },
            (error) => {
              console.log('Notifications error (update Firestore rules):', error.message);
              setNotifications([]);
            }
          );

        return () => unsubNotifications();
      }, [user]);

      // Update assignment (for student)
      const updateMyAssignment = async (assignmentId, updates) => {
        if (!user) return false;

        try {
          // Get the assignment first to know the mentor
          const assignmentDoc = await db.collection('users')
            .doc(user.uid)
            .collection('assignments')
            .doc(assignmentId)
            .get();
          
          const assignment = assignmentDoc.data();

          await db.collection('users')
            .doc(user.uid)
            .collection('assignments')
            .doc(assignmentId)
            .update({
              ...updates,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Notify mentor if student completed the assignment
          if (updates.status === 'completed' && assignment?.mentorId) {
            await db.collection('users')
              .doc(assignment.mentorId)
              .collection('notifications')
              .add({
                type: 'assignment_completed',
                title: `${userProfile?.displayName} completed an assignment`,
                message: assignment.title || 'Assignment completed and ready for review',
                link: 'students',
                read: false,
                studentId: user.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              });
          }

          return true;
        } catch (err) {
          console.error('Failed to update assignment:', err);
          return false;
        }
      };

      // Mark feedback as read when student views it
      const markFeedbackAsRead = async (feedbackIds) => {
        if (!user || !feedbackIds.length) return;
        
        const batch = db.batch();
        feedbackIds.forEach(id => {
          const ref = db.collection('users').doc(user.uid).collection('tradeFeedback').doc(id);
          batch.update(ref, { read: true });
        });
        
        try {
          await batch.commit();
        } catch (err) {
          console.error('Failed to mark feedback as read:', err);
        }
      };

      // Ask mentor a question about a trade (student)
      const askQuestion = async (tradeId, questionType, question) => {
        if (!user || !userProfile?.mentorId || !question.trim()) return false;

        try {
          await db.collection('users')
            .doc(user.uid)
            .collection('tradeQuestions')
            .add({
              tradeId,
              studentId: user.uid,
              studentName: userProfile.displayName,
              mentorId: userProfile.mentorId,
              questionType,
              question: question.trim(),
              status: 'asked',
              answer: null,
              answeredAt: null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Notify the mentor
          const questionTypeLabels = { entry: 'Entry', exit: 'Exit', improvement: 'Improvement', general: 'General' };
          await db.collection('users')
            .doc(userProfile.mentorId)
            .collection('notifications')
            .add({
              type: 'question_asked',
              title: `${userProfile.displayName} asked a question`,
              message: `${questionTypeLabels[questionType] || 'Question'}: ${question.trim().substring(0, 80)}...`,
              link: 'students',
              read: false,
              studentId: user.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          return true;
        } catch (err) {
          console.error('Failed to ask question:', err);
          return false;
        }
      };

      // Resolve a question (both mentor and student can do this after answered)
      const resolveMyQuestion = async (questionId) => {
        if (!user) return false;

        try {
          await db.collection('users')
            .doc(user.uid)
            .collection('tradeQuestions')
            .doc(questionId)
            .update({
              status: 'resolved',
              resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          return true;
        } catch (err) {
          console.error('Failed to resolve question:', err);
          return false;
        }
      };

      // Mark a notification as read
      const markNotificationAsRead = async (notificationId) => {
        if (!user) return;

        try {
          await db.collection('users')
            .doc(user.uid)
            .collection('notifications')
            .doc(notificationId)
            .update({ read: true });
        } catch (err) {
          console.error('Failed to mark notification as read:', err);
        }
      };

      // Mark all notifications as read
      const markAllNotificationsAsRead = async () => {
        if (!user || notifications.length === 0) return;

        try {
          const batch = db.batch();
          notifications.filter(n => !n.read).forEach(n => {
            const ref = db.collection('users').doc(user.uid).collection('notifications').doc(n.id);
            batch.update(ref, { read: true });
          });
          await batch.commit();
        } catch (err) {
          console.error('Failed to mark all notifications as read:', err);
        }
      };

      // Handle notification click - navigate to relevant page
      const handleNotificationClick = (notification) => {
        // Mark as read
        if (!notification.read) {
          markNotificationAsRead(notification.id);
        }

        // Navigate based on notification type
        switch (notification.type) {
          // Trade-related
          case 'feedback':
          case 'flag':
          case 'question_answered':
          case 'win_streak':
          case 'trading_milestone':
            setActivePage('tradelog');
            break;
          
          // Check-ins
          case 'checkin':
          case 'weekly_recap':
            setActivePage('checkins');
            break;
          
          // Assignments
          case 'assignment':
          case 'assignment_reviewed':
            setActivePage('assignments');
            break;
          
          // Sessions
          case 'session':
          case 'session_reminder':
            setActivePage('sessions');
            break;
          
          // Goals & Challenges
          case 'yearly_goal_progress':
          case 'challenge_progress':
          case 'challenge_completed':
          case 'challenge_failed':
            setActivePage('goals');
            break;
          
          // Dashboard (achievements & reports)
          case 'daily_target_hit':
          case 'daily_target_exceeded':
          case 'weekly_goal_progress':
          case 'monthly_goal_progress':
          case 'profitable_week':
          case 'profitable_month':
          case 'new_personal_best':
          case 'monthly_report':
            setActivePage('dashboard');
            break;
          
          // Mentor notifications
          case 'question_asked':
          case 'assignment_completed':
          case 'student_daily_target':
          case 'student_challenge_complete':
          case 'student_milestone':
          case 'invite_accepted':
            setActivePage('students');
            break;
          
          default:
            break;
        }
      };

      // Load user's journal data from Firestore
      useEffect(() => {
        if (!user) {
          setDataLoading(false);
          return;
        }

        setDataLoading(true);

        const unsubscribe = db.collection('users')
          .doc(user.uid)
          .collection('journalData')
          .doc('state')
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              setJournalState({
                trades: data.trades || [],
                setups: data.setups || [],
                mistakes: data.mistakes || [],
                dailyNotes: data.dailyNotes || {},
                yearlyGoal: data.yearlyGoal || null,
                challenges: data.challenges || [],
              });
            } else {
              setJournalState(EMPTY_STATE);
            }
            setDataLoading(false);
          }, (error) => {
            console.error('Firestore error:', error);
            setDataLoading(false);
          });

        return () => unsubscribe();
      }, [user]);

      // Helper to create self-notification (for trader's own achievements)
      const createSelfNotification = async (type, title, message, link = 'dashboard') => {
        if (!user) return;
        try {
          await db.collection('users').doc(user.uid).collection('notifications').add({
            type, title, message, link,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch (err) {
          console.error('Failed to create notification:', err);
        }
      };

      // Helper to notify mentor about student's achievement
      const notifyMentorOfProgress = async (type, title, message) => {
        if (!userProfile?.mentorId) return;
        try {
          await db.collection('users').doc(userProfile.mentorId).collection('notifications').add({
            type, title, message,
            link: 'students',
            studentId: user.uid,
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          });
        } catch (err) {
          console.error('Failed to notify mentor:', err);
        }
      };

      // Comprehensive progress checking
      const checkProgressAndNotify = async (newState, oldState, userProfile) => {
        if (!userProfile?.uid || !newState) return;

        const today = todayISO();
        const now = new Date();
        
        // Calculate daily P&L
        const calcDailyPnL = (trades, date) => {
          return trades.filter(t => t.entryDate === date).reduce((sum, t) => {
            const derived = calcTradeDerived(t);
            return sum + (derived.pnlFinal || 0);
          }, 0);
        };

        const todayPnL = calcDailyPnL(newState.trades || [], today);
        const oldTodayPnL = calcDailyPnL(oldState?.trades || [], today);

        // Daily target check
        if (newState.yearlyGoal?.target) {
          const dailyTarget = newState.yearlyGoal.target / 252;
          const wasHit = oldTodayPnL >= dailyTarget;
          const isHit = todayPnL >= dailyTarget;
          const isExceeded = todayPnL >= dailyTarget * 1.5;
          const wasExceeded = oldTodayPnL >= dailyTarget * 1.5;

          if (!wasHit && isHit) {
            // Daily target hit - send email
            const emailData = emailTemplates.dailyTargetHit(userProfile.email, userProfile.displayName, todayPnL, dailyTarget);
            await sendEmail(emailData);
            
            // Create notification
            await createSelfNotification('daily_target_hit', 'üéØ Daily Target Hit!', 
              `You made $${todayPnL.toFixed(0)} today (target: $${dailyTarget.toFixed(0)})`);
            
            // Notify mentor if student
            if (userProfile.mentorId) {
              await notifyMentorOfProgress('student_daily_target', 
                `üéØ ${userProfile.displayName} hit daily target`,
                `Made $${todayPnL.toFixed(0)} today`);
            }
          }

          if (!wasExceeded && isExceeded) {
            await createSelfNotification('daily_target_exceeded', 'üî• Crushed It!', 
              `You exceeded your daily target by ${((todayPnL / dailyTarget - 1) * 100).toFixed(0)}%!`);
          }
        }

        // Win streak check
        const sortedTrades = [...(newState.trades || [])].sort((a, b) => 
          new Date(b.entryDate + 'T' + (b.entryTime || '00:00')) - new Date(a.entryDate + 'T' + (a.entryTime || '00:00'))
        );
        
        let currentStreak = 0;
        for (const trade of sortedTrades) {
          const derived = calcTradeDerived(trade);
          if ((derived.pnlFinal || 0) > 0) {
            currentStreak++;
          } else {
            break;
          }
        }

        // Check old streak
        const oldSortedTrades = [...(oldState?.trades || [])].sort((a, b) => 
          new Date(b.entryDate + 'T' + (b.entryTime || '00:00')) - new Date(a.entryDate + 'T' + (a.entryTime || '00:00'))
        );
        let oldStreak = 0;
        for (const trade of oldSortedTrades) {
          const derived = calcTradeDerived(trade);
          if ((derived.pnlFinal || 0) > 0) {
            oldStreak++;
          } else {
            break;
          }
        }

        // Notify on streak milestones
        const streakMilestones = [3, 5, 10, 15, 20];
        for (const milestone of streakMilestones) {
          if (currentStreak >= milestone && oldStreak < milestone) {
            await createSelfNotification('win_streak', `üî• ${milestone} Win Streak!`, 
              `You're on fire! ${milestone} consecutive winning trades.`, 'tradelog');
            break;
          }
        }

        // Trading milestone check (total trades)
        const totalTrades = (newState.trades || []).length;
        const oldTotalTrades = (oldState?.trades || []).length;
        const tradeMilestones = [10, 25, 50, 100, 250, 500, 1000];
        
        for (const milestone of tradeMilestones) {
          if (totalTrades >= milestone && oldTotalTrades < milestone) {
            await createSelfNotification('trading_milestone', `üéâ ${milestone} Trades Logged!`, 
              `Congratulations! You've logged ${milestone} trades.`, 'tradelog');
            
            if (userProfile.mentorId) {
              await notifyMentorOfProgress('student_milestone', 
                `üéâ ${userProfile.displayName} reached ${milestone} trades`,
                `Milestone: ${milestone} trades logged`);
            }
            break;
          }
        }

        // Challenge progress check
        const challenges = newState.challenges || [];
        const oldChallenges = oldState?.challenges || [];
        
        for (const challenge of challenges) {
          if (challenge.status === 'completed') continue;
          
          const oldChallenge = oldChallenges.find(c => c.id === challenge.id);
          if (!oldChallenge) continue;

          // Calculate progress for both
          const calcProgress = (ch) => {
            const startDate = ch.startDate;
            const endDate = ch.endDate;
            const relevantTrades = (newState.trades || []).filter(t => 
              t.entryDate >= startDate && (!endDate || t.entryDate <= endDate)
            );
            
            let current = 0;
            let target = 0;
            
            switch (ch.type) {
              case 'profit':
                current = relevantTrades.reduce((sum, t) => sum + (calcTradeDerived(t).pnlFinal || 0), 0);
                target = ch.targetValue || 0;
                break;
              case 'trades':
                current = relevantTrades.length;
                target = ch.tradeLimit || 0;
                break;
              case 'winrate':
                const wins = relevantTrades.filter(t => (calcTradeDerived(t).pnlFinal || 0) > 0).length;
                current = relevantTrades.length > 0 ? (wins / relevantTrades.length) * 100 : 0;
                target = ch.targetPercent || 0;
                break;
            }
            
            return target > 0 ? (current / target) * 100 : 0;
          };

          const progress = calcProgress(challenge);
          const oldProgress = calcProgress(oldChallenge);

          // Progress milestones
          const progressMilestones = [50, 75, 100];
          for (const milestone of progressMilestones) {
            if (progress >= milestone && oldProgress < milestone) {
              if (milestone === 100) {
                await createSelfNotification('challenge_completed', 'üèÖ Challenge Completed!', 
                  `You completed: ${challenge.name}`, 'goals');
                
                if (userProfile.mentorId) {
                  await notifyMentorOfProgress('student_challenge_complete', 
                    `üèÖ ${userProfile.displayName} completed a challenge`,
                    challenge.name);
                }
              } else {
                await createSelfNotification('challenge_progress', `üí™ ${milestone}% Challenge Progress`, 
                  `${challenge.name}: ${milestone}% complete`, 'goals');
              }
              break;
            }
          }
        }

        // Yearly goal progress check
        if (newState.yearlyGoal?.target) {
          const yearStart = `${now.getFullYear()}-01-01`;
          const yearTrades = (newState.trades || []).filter(t => t.entryDate >= yearStart);
          const yearPnL = yearTrades.reduce((sum, t) => sum + (calcTradeDerived(t).pnlFinal || 0), 0);
          const yearProgress = (yearPnL / newState.yearlyGoal.target) * 100;

          const oldYearTrades = (oldState?.trades || []).filter(t => t.entryDate >= yearStart);
          const oldYearPnL = oldYearTrades.reduce((sum, t) => sum + (calcTradeDerived(t).pnlFinal || 0), 0);
          const oldYearProgress = oldState?.yearlyGoal?.target ? (oldYearPnL / oldState.yearlyGoal.target) * 100 : 0;

          const goalMilestones = [25, 50, 75, 100];
          for (const milestone of goalMilestones) {
            if (yearProgress >= milestone && oldYearProgress < milestone) {
              if (milestone === 100) {
                await createSelfNotification('yearly_goal_progress', '‚≠ê Yearly Goal Achieved!', 
                  `You reached your ${now.getFullYear()} goal of $${newState.yearlyGoal.target.toLocaleString()}!`, 'goals');
              } else {
                await createSelfNotification('yearly_goal_progress', `üìà ${milestone}% of Yearly Goal`, 
                  `$${yearPnL.toFixed(0)} of $${newState.yearlyGoal.target.toLocaleString()} target`, 'goals');
              }
              break;
            }
          }
        }

        // Personal best check
        const allDailyPnLs = {};
        (newState.trades || []).forEach(t => {
          const date = t.entryDate;
          const pnl = calcTradeDerived(t).pnlFinal || 0;
          allDailyPnLs[date] = (allDailyPnLs[date] || 0) + pnl;
        });
        
        const bestDay = Math.max(...Object.values(allDailyPnLs), 0);
        const todayIsBest = allDailyPnLs[today] === bestDay && bestDay > 0;

        const oldDailyPnLs = {};
        (oldState?.trades || []).forEach(t => {
          const date = t.entryDate;
          const pnl = calcTradeDerived(t).pnlFinal || 0;
          oldDailyPnLs[date] = (oldDailyPnLs[date] || 0) + pnl;
        });
        const oldBestDay = Math.max(...Object.values(oldDailyPnLs), 0);

        if (todayIsBest && bestDay > oldBestDay && bestDay > 100) {
          await createSelfNotification('new_personal_best', 'üèÜ New Personal Best Day!', 
            `$${bestDay.toFixed(0)} - Your best trading day ever!`, 'dashboard');
        }
      };

      // Sanitize state to remove any functions and undefined values (Firestore can't store these)
      const sanitizeForFirestore = (obj, path = '') => {
        if (obj === null || obj === undefined) return null;
        if (typeof obj === 'function') {
          console.error('Found function at path:', path);
          return null;
        }
        if (typeof obj !== 'object') return obj;
        if (Array.isArray(obj)) {
          return obj.map((item, i) => sanitizeForFirestore(item, `${path}[${i}]`)).filter(item => item !== undefined);
        }
        const cleaned = {};
        for (const [key, value] of Object.entries(obj)) {
          if (typeof value === 'function') {
            console.error('Found function at path:', `${path}.${key}`);
            continue;
          }
          if (value === undefined) continue;
          cleaned[key] = sanitizeForFirestore(value, `${path}.${key}`);
        }
        return cleaned;
      };

      // Save journal state to Firestore
      const saveJournalState = async (newStateOrUpdater) => {
        if (!user) return;

        // Handle both direct state and updater function patterns
        const newState = typeof newStateOrUpdater === 'function' 
          ? newStateOrUpdater(journalState) 
          : newStateOrUpdater;

        const oldState = journalState;
        setJournalState(newState);

        try {
          // Sanitize state to remove any functions before saving
          const cleanState = sanitizeForFirestore(newState, 'root');
          
          if (!cleanState || typeof cleanState !== 'object') {
            console.error('Invalid clean state:', cleanState);
            return;
          }
          
          await db.collection('users')
            .doc(user.uid)
            .collection('journalData')
            .doc('state')
            .set(cleanState, { merge: true });
          
          // Check if daily target was hit (only if trades changed)
          if (newState.trades?.length !== oldState?.trades?.length || 
              JSON.stringify(newState.trades) !== JSON.stringify(oldState?.trades)) {
            checkProgressAndNotify(newState, oldState, userProfile);
          }
          // Save successful - no alert needed
        } catch (error) {
          console.error('Failed to save to Firestore:', error);
          // Only show alert for actual permission/network errors, not for benign issues
          if (error.code === 'permission-denied') {
            alert('Permission denied. Please sign out and sign back in.');
          } else if (error.code === 'unavailable') {
            alert('Network error. Your changes will sync when connection is restored.');
          }
          // For other errors, just log them - Firestore will retry automatically
        }
      };

      // Reload user profile
      const reloadProfile = async () => {
        if (!user) return;
        const profileDoc = await db.collection('users').doc(user.uid).get();
        if (profileDoc.exists) {
          setUserProfile({ uid: user.uid, ...profileDoc.data() });
        }
      };

      // Handle sign out
      const handleSignOut = async () => {
        try {
          await auth.signOut();
          setActivePage('dashboard');
        } catch (error) {
          console.error('Sign out error:', error);
        }
      };

      // Mobile detection
      useEffect(() => {
        const handleResize = () => {
          const mobile = window.innerWidth < 768;
          setIsMobile(mobile);
          if (window.innerWidth < 1024) setSidebarExpanded(false);
          else setSidebarExpanded(true);
        };
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // Show loading screen
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthScreen />;
      }

      // Show loading while data loads
      if (dataLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading your journal...</p>
            </div>
          </div>
        );
      }

      // Build nav items based on role (computed, not a hook)
      const getNavItems = () => {
        let items = [...NAV_ITEMS];
        
        // Add Assignments, Check-ins, and Sessions for students (users with a mentor)
        if (userProfile?.mentorId) {
          // Insert after Goals
          const goalsIndex = items.findIndex(i => i.id === 'goals');
          items.splice(goalsIndex + 1, 0, 
            { id: 'assignments', label: 'Assignments', icon: 'assignments' },
            { id: 'checkins', label: 'Check-ins', icon: 'checkins' },
            { id: 'sessions', label: 'Sessions', icon: 'sessions' }
          );
        }
        
        // Add Students for mentors
        if (userProfile?.role === 'mentor') {
          items.push({ id: 'students', label: 'Mentor Dashboard', icon: 'students' });
        }
        
        return items;
      };
      const navItems = getNavItems();

      const renderPage = () => {
        // Show mentor invite banner for traders
        const inviteBanner = userProfile?.role === 'trader' && userProfile?.pendingMentorId ? (
          <MentorInviteBanner userProfile={userProfile} onUpdate={reloadProfile} />
        ) : null;

        switch (activePage) {
          case 'dashboard':
            return <>{inviteBanner}<DashboardPage state={journalState} setState={saveJournalState} setActivePage={setActivePage} setSelectedDate={setSelectedDate} isMobile={isMobile} /></>;
          case 'tradelog':
            return <>{inviteBanner}<TradeLogPage state={journalState} setState={saveJournalState} isMobile={isMobile} myTradeFeedback={myTradeFeedback} myTradeFlags={myTradeFlags} markFeedbackAsRead={markFeedbackAsRead} tradeQuestions={myTradeQuestions} onAskQuestion={askQuestion} onResolveQuestion={resolveMyQuestion} userProfile={userProfile} /></>;
          case 'calendar':
            return <>{inviteBanner}<CalendarPage state={journalState} setState={saveJournalState} selectedDate={selectedDate} setSelectedDate={setSelectedDate} isMobile={isMobile} /></>;
          case 'goals':
            return <>{inviteBanner}<GoalsPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'assignments':
            return <>{inviteBanner}<AssignmentsPage assignments={myAssignments} journalState={journalState} userProfile={userProfile} isMobile={isMobile} onUpdateAssignment={updateMyAssignment} /></>;
          case 'checkins':
            return <>{inviteBanner}<CheckinsPage checkins={myCheckins} userProfile={userProfile} isMobile={isMobile} /></>;
          case 'sessions':
            return <>{inviteBanner}<SessionsPage sessions={mySessions} userProfile={userProfile} isMobile={isMobile} /></>;
          case 'setups':
            return <>{inviteBanner}<SetupsPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'mistakes':
            return <>{inviteBanner}<MistakesPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'profile':
            return <>{inviteBanner}<ProfilePage state={journalState} setState={saveJournalState} isMobile={isMobile} userProfile={userProfile} onSignOut={handleSignOut} onUpdate={reloadProfile} /></>;
          case 'students':
            return <StudentsPage userProfile={userProfile} isMobile={isMobile} />;
          default:
            return <>{inviteBanner}<DashboardPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
        }
      };

      return (
        <AuthContext.Provider value={{ user, userProfile, reloadProfile }}>
          <div className="min-h-screen bg-gray-50">
            {!isMobile && <Sidebar isExpanded={sidebarExpanded} setIsExpanded={setSidebarExpanded} activePage={activePage} setActivePage={setActivePage} isMobile={false} navItems={navItems} />}
            <TopBar 
              storageInfo={storageInfo} 
              sidebarExpanded={sidebarExpanded} 
              isMobile={isMobile} 
              userProfile={userProfile} 
              onSignOut={handleSignOut}
              notifications={notifications}
              onMarkAsRead={markNotificationAsRead}
              onMarkAllAsRead={markAllNotificationsAsRead}
              onNotificationClick={handleNotificationClick}
            />
            <main className={`pt-14 min-h-screen transition-all duration-300 ease-in-out ${isMobile ? 'mobile-content-padding' : (sidebarExpanded ? 'pl-56' : 'pl-16')}`}>
              <div className={`${isMobile ? 'p-3' : 'p-6'}`}>{renderPage()}</div>
            </main>
            {isMobile && <Sidebar isExpanded={false} setIsExpanded={() => {}} activePage={activePage} setActivePage={setActivePage} isMobile={true} navItems={navItems} />}
          </div>
        </AuthContext.Provider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
