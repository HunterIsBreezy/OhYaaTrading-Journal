<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Trading Journal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

    // =============================================================================
    // FIREBASE CONFIGURATION
    // =============================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCVh51PQ4IgSR7b-I6JtZgv42X2-03vJeo",
      authDomain: "trading-journal-86e97.firebaseapp.com",
      projectId: "trading-journal-86e97",
      storageBucket: "trading-journal-86e97.firebasestorage.app",
      messagingSenderId: "928347541219",
      appId: "1:928347541219:web:44f62f5034fc91e476bfd6",
      measurementId: "G-S8NTTW1NNR"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // =============================================================================
    // EMAIL CONFIGURATION (via Firebase Cloud Function)
    // =============================================================================
    
    // Send email via Firebase Cloud Function
    const sendEmail = async ({ to, subject, html }) => {
      try {
        const sendEmailFunction = firebase.functions().httpsCallable('sendEmail');
        const result = await sendEmailFunction({ to, subject, html });
        return { success: true, data: result.data };
      } catch (error) {
        console.error('Email send error:', error);
        return { success: false, error };
      }
    };

    // Email templates
    const emailTemplates = {
      mentorInvite: (mentorName, menteeEmail) => ({
        to: menteeEmail,
        subject: `${mentorName} wants to mentor you on Trading Journal`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;">Trading Journal</h1>
            </div>
            <h2 style="color: #1f2937;">You've Been Invited!</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              <strong>${mentorName}</strong> has invited you to be their mentee on Trading Journal.
            </p>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              As a mentee, your mentor will be able to view your trading journal to help guide your trading journey.
            </p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                Log In to Accept
              </a>
            </div>
            <p style="color: #6b7280; font-size: 14px;">
              Log in to your account to accept or decline this invitation.
            </p>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),
      
      inviteAccepted: (mentorEmail, menteeName) => ({
        to: mentorEmail,
        subject: `${menteeName} accepted your mentor invitation!`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;">Trading Journal</h1>
            </div>
            <h2 style="color: #1f2937;">Great News! üéâ</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              <strong>${menteeName}</strong> has accepted your mentor invitation!
            </p>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              You can now view their trading journal and help guide their trading journey.
            </p>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                View Your Mentees
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),

      welcome: (userEmail, userName) => ({
        to: userEmail,
        subject: `Welcome to Trading Journal, ${userName}!`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #1e40af; margin: 0;">Trading Journal</h1>
            </div>
            <h2 style="color: #1f2937;">Welcome, ${userName}! üëã</h2>
            <p style="color: #4b5563; font-size: 16px; line-height: 1.6;">
              Thank you for joining Trading Journal. We're excited to help you track and improve your trading performance.
            </p>
            <h3 style="color: #1f2937;">Get Started:</h3>
            <ul style="color: #4b5563; font-size: 16px; line-height: 1.8;">
              <li>üìà Log your first trade</li>
              <li>üéØ Set up your trading setups</li>
              <li>‚ö†Ô∏è Track your common mistakes</li>
              <li>üèÜ Set yearly goals and challenges</li>
            </ul>
            <div style="text-align: center; margin: 30px 0;">
              <a href="https://ohyaatradingjournal.com" 
                 style="background-color: #2563eb; color: white; padding: 12px 30px; text-decoration: none; border-radius: 8px; font-weight: bold; display: inline-block;">
                Start Trading Journal
              </a>
            </div>
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #9ca3af; font-size: 12px; text-align: center;">
              ¬© ${new Date().getFullYear()} Trading Journal. All rights reserved.
            </p>
          </div>
        `,
      }),
    };

    // =============================================================================
    // AUTH CONTEXT
    // =============================================================================
    const AuthContext = createContext(null);

    function useAuth() {
      return useContext(AuthContext);
    }

    // =============================================================================
    // CONSTANTS
    // =============================================================================
    const STORAGE_KEY = 'tradingJournal:v1';
    const STORAGE_LIMIT_BYTES = 5 * 1024 * 1024;
    const STORAGE_WARNING_PERCENT = 80;
    const BE_THRESHOLD = 0.01;
    const PNL_MISMATCH_THRESHOLD = 0.01;

    const EMPTY_STATE = {
      trades: [],
      setups: [],
      mistakes: [],
      dailyNotes: {},
      yearlyGoal: null, // { year, target, createdAt, updatedAt }
      challenges: [], // Array of challenge objects
    };

    const NAV_ITEMS = [
      { id: 'dashboard', label: 'Dashboard', icon: 'dashboard' },
      { id: 'tradelog', label: 'Trade Log', icon: 'tradelog' },
      { id: 'calendar', label: 'Calendar', icon: 'calendar' },
      { id: 'goals', label: 'Goals', icon: 'goals' },
      { id: 'setups', label: 'Setups', icon: 'setups' },
      { id: 'mistakes', label: 'Mistakes', icon: 'mistakes' },
      { id: 'profile', label: 'Profile', icon: 'profile' },
    ];

    const FILTER_OPTIONS = [
      { id: 'day', label: 'Day' },
      { id: 'week', label: 'Week' },
      { id: 'month', label: 'Month' },
      { id: 'year', label: 'Year' },
      { id: 'all', label: 'All Time' },
    ];

    const ASSET_TYPES = [
      { id: 'stock', label: 'Stock', sizeLabel: 'Shares' },
      { id: 'option', label: 'Option', sizeLabel: 'Contracts' },
      { id: 'future', label: 'Future', sizeLabel: 'Contracts' },
      { id: 'forex', label: 'Forex', sizeLabel: 'Units' },
      { id: 'crypto', label: 'Crypto', sizeLabel: 'Units' },
    ];

    const POSITION_TYPES = [
      { id: 'long', label: 'Long' },
      { id: 'short', label: 'Short' },
      { id: 'long_scalp', label: 'Long Scalp' },
      { id: 'short_scalp', label: 'Short Scalp' },
    ];

    // =============================================================================
    // ICONS
    // =============================================================================
    const Icons = {
      dashboard: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <rect x="3" y="3" width="7" height="7" rx="1" />
          <rect x="14" y="3" width="7" height="7" rx="1" />
          <rect x="3" y="14" width="7" height="7" rx="1" />
          <rect x="14" y="14" width="7" height="7" rx="1" />
        </svg>
      ),
      tradelog: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2" />
          <rect x="9" y="3" width="6" height="4" rx="1" />
          <path d="M9 12h6M9 16h6" />
        </svg>
      ),
      calendar: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <rect x="3" y="4" width="18" height="18" rx="2" />
          <path d="M16 2v4M8 2v4M3 10h18" />
        </svg>
      ),
      setups: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2L2 7l10 5 10-5-10-5z" />
          <path d="M2 17l10 5 10-5" />
          <path d="M2 12l10 5 10-5" />
        </svg>
      ),
      mistakes: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <circle cx="12" cy="12" r="10" />
          <path d="M12 8v4M12 16h.01" />
        </svg>
      ),
      menu: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      ),
      chevronLeft: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M15 18l-6-6 6-6" />
        </svg>
      ),
      chevronRight: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M9 18l6-6-6-6" />
        </svg>
      ),
      warning: (
        <svg viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4">
          <path d="M12 2L1 21h22L12 2zm0 4l7.53 13H4.47L12 6zm-1 5v4h2v-4h-2zm0 6v2h2v-2h-2z" />
        </svg>
      ),
      trendUp: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M23 6l-9.5 9.5-5-5L1 18" />
          <path d="M17 6h6v6" />
        </svg>
      ),
      trendDown: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M23 18l-9.5-9.5-5 5L1 6" />
          <path d="M17 18h6v-6" />
        </svg>
      ),
      plus: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 5v14M5 12h14" />
        </svg>
      ),
      x: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      ),
      edit: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
        </svg>
      ),
      trash: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
        </svg>
      ),
      upload: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
        </svg>
      ),
      starEmpty: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      ),
      starFilled: (
        <svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
        </svg>
      ),
      goals: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <circle cx="12" cy="12" r="10" />
          <circle cx="12" cy="12" r="6" />
          <circle cx="12" cy="12" r="2" />
        </svg>
      ),
      profile: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
          <circle cx="12" cy="7" r="4" />
        </svg>
      ),
      mentees: (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
          <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
          <circle cx="9" cy="7" r="4" />
          <path d="M23 21v-2a4 4 0 00-3-3.87" />
          <path d="M16 3.13a4 4 0 010 7.75" />
        </svg>
      ),
    };

    // =============================================================================
    // UTILITY FUNCTIONS
    // =============================================================================
    function todayISO() {
      return new Date().toISOString().split('T')[0];
    }

    function nowISO() {
      return new Date().toISOString();
    }

    function generateId() {
      return crypto.randomUUID();
    }

    function calcTradeDerived(trade) {
      // Check if manual P&L is provided (including 0 as valid value)
      const hasManualPnl = trade.pnlManual !== null && trade.pnlManual !== undefined && String(trade.pnlManual).trim() !== '';
      
      // Trade is open only if: no exit date/price AND no manual P&L override
      const hasExit = trade.exitDate !== null && trade.exitDate !== '' && 
                      trade.exitPrice !== null && trade.exitPrice !== undefined;
      const isOpen = !hasExit && !hasManualPnl;
      
      let lengthDays = null;
      if (trade.entryDate && trade.exitDate) {
        const entry = new Date(trade.entryDate);
        const exit = new Date(trade.exitDate);
        lengthDays = Math.round((exit - entry) / (1000 * 60 * 60 * 24));
      }
      
      let pnlCalculated = null;
      if (hasExit && trade.entryPrice != null && trade.exitPrice != null && trade.positionSize != null) {
        if (trade.positionType === 'long') {
          pnlCalculated = (trade.exitPrice - trade.entryPrice) * trade.positionSize;
        } else {
          pnlCalculated = (trade.entryPrice - trade.exitPrice) * trade.positionSize;
        }
        pnlCalculated = Math.round(pnlCalculated * 100) / 100;
      }
      
      const pnlFinal = hasManualPnl ? parseFloat(trade.pnlManual) : pnlCalculated;
      
      let pnlMismatch = false;
      if (hasManualPnl && pnlCalculated !== null) {
        pnlMismatch = Math.abs(parseFloat(trade.pnlManual) - pnlCalculated) > PNL_MISMATCH_THRESHOLD;
      }
      
      let winLoss = null;
      if (pnlFinal !== null && !isNaN(pnlFinal)) {
        if (pnlFinal > BE_THRESHOLD) {
          winLoss = 'W';
        } else if (pnlFinal < -BE_THRESHOLD) {
          winLoss = 'L';
        } else {
          winLoss = 'BE';
        }
      }
      
      return { lengthDays, pnlCalculated, pnlFinal, winLoss, pnlMismatch, isOpen };
    }

    function formatCurrency(amount) {
      if (amount === null || amount === undefined) return '$0.00';
      const prefix = amount >= 0 ? '+' : '';
      return prefix + '$' + Math.abs(amount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatCurrencyShort(amount) {
      if (amount === null || amount === undefined) return '$0';
      const absAmount = Math.abs(amount);
      const prefix = amount >= 0 ? '+' : '-';
      if (absAmount >= 1000000) {
        return prefix + '$' + (absAmount / 1000000).toFixed(1) + 'M';
      } else if (absAmount >= 1000) {
        return prefix + '$' + (absAmount / 1000).toFixed(1) + 'K';
      }
      return prefix + '$' + absAmount.toFixed(0);
    }

    // =============================================================================
    // STORAGE HELPERS
    // =============================================================================
    function loadState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return { ...EMPTY_STATE };
        const parsed = JSON.parse(stored);
        if (!parsed.trades || !parsed.setups || !parsed.mistakes || !parsed.dailyNotes) {
          return { ...EMPTY_STATE };
        }
        return parsed;
      } catch (error) {
        console.error('Error loading state:', error);
        return { ...EMPTY_STATE };
      }
    }

    function saveState(state) {
      const jsonString = JSON.stringify(state);
      const storageInfo = getStorageInfo(jsonString);
      if (storageInfo.percentUsed >= 100) {
        throw new Error('Storage quota exceeded. Please export and clear old data.');
      }
      localStorage.setItem(STORAGE_KEY, jsonString);
      return storageInfo;
    }

    function getStorageInfo(jsonString) {
      const str = jsonString || localStorage.getItem(STORAGE_KEY) || '';
      const bytes = new Blob([str]).size;
      const megabytes = Math.round((bytes / (1024 * 1024)) * 100) / 100;
      const percentUsed = Math.round((bytes / STORAGE_LIMIT_BYTES) * 100);
      return {
        bytes,
        megabytes,
        percentUsed,
        nearLimit: percentUsed >= STORAGE_WARNING_PERCENT,
      };
    }

    // =============================================================================
    // SIMPLE SVG LINE CHART COMPONENT (INTERACTIVE)
    // =============================================================================
    function SimpleLineChart({ data, width = 700, height = 350, onPointClick }) {
      const [hoveredPoint, setHoveredPoint] = useState(null);
      const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
      const chartRef = React.useRef(null);

      if (!data || data.length === 0) {
        return (
          <div className="h-96 flex items-center justify-center text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl border border-gray-200">
            <div className="text-center">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="w-16 h-16 mx-auto mb-3 text-gray-300">
                <path d="M3 3v18h18" />
                <path d="M7 14l4-4 4 4 5-5" />
              </svg>
              <p className="font-medium text-gray-500">No P&L Data Yet</p>
              <p className="text-sm text-gray-400 mt-1">Complete some trades to see your performance chart</p>
            </div>
          </div>
        );
      }

      const padding = { top: 20, right: 50, bottom: 45, left: 65 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      const values = data.map(d => d.cumulative);
      const minVal = Math.min(0, ...values);
      const maxVal = Math.max(0, ...values);
      const range = maxVal - minVal || 1;
      
      // Add padding to range
      const paddedMin = minVal - (range * 0.1);
      const paddedMax = maxVal + (range * 0.1);
      const paddedRange = paddedMax - paddedMin;

      // For single point, center it
      const getX = (index) => {
        if (data.length === 1) return padding.left + chartWidth / 2;
        return padding.left + (index / (data.length - 1)) * chartWidth;
      };
      const getY = (value) => padding.top + chartHeight - ((value - paddedMin) / paddedRange) * chartHeight;

      const pathD = data.map((d, i) => {
        const x = getX(i);
        const y = getY(d.cumulative);
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
      }).join(' ');

      const zeroY = getY(0);
      const finalValue = data[data.length - 1]?.cumulative || 0;
      const startValue = data[0]?.cumulative || 0;
      const isPositive = finalValue >= 0;
      const changePercent = startValue !== 0 ? ((finalValue - startValue) / Math.abs(startValue) * 100).toFixed(1) : 0;

      // Area path
      const areaPath = pathD + ` L ${getX(data.length - 1)} ${zeroY} L ${padding.left} ${zeroY} Z`;

      // Y-axis labels
      const yLabels = [];
      const numYLabels = 5;
      for (let i = 0; i <= numYLabels; i++) {
        const value = paddedMin + (paddedRange * (numYLabels - i) / numYLabels);
        yLabels.push({
          value: Math.round(value),
          y: padding.top + (chartHeight * i / numYLabels),
        });
      }

      // X-axis labels
      const xLabels = [];
      const maxXLabels = Math.min(data.length, 7);
      const step = Math.max(1, Math.floor((data.length - 1) / (maxXLabels - 1)));
      for (let i = 0; i < data.length; i += step) {
        xLabels.push({ date: data[i].date, x: getX(i) });
      }
      if (xLabels.length > 0 && data.length > 1 && xLabels[xLabels.length - 1].date !== data[data.length - 1].date) {
        xLabels.push({ date: data[data.length - 1].date, x: getX(data.length - 1) });
      }

      // Stats
      const highestPoint = Math.max(...values);
      const lowestPoint = Math.min(...values);
      const avgValue = values.reduce((a, b) => a + b, 0) / values.length;

      // Find closest point to mouse - improved to always find a point
      const handleMouseMove = (e) => {
        if (!chartRef.current) return;
        const rect = chartRef.current.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        // Convert to SVG coordinates
        const svgX = (mouseX / rect.width) * width;
        const svgY = (mouseY / rect.height) * height;
        
        setMousePos({ x: mouseX, y: mouseY });

        // Find closest data point by X distance only
        let closestIdx = 0;
        let closestDist = Infinity;
        data.forEach((d, i) => {
          const px = getX(i);
          const dist = Math.abs(svgX - px);
          if (dist < closestDist) {
            closestDist = dist;
            closestIdx = i;
          }
        });

        // Show tooltip if within the general chart area (with generous padding)
        if (svgX >= padding.left - 30 && svgX <= width - padding.right + 30 && 
            svgY >= padding.top - 20 && svgY <= height - padding.bottom + 20) {
          setHoveredPoint(closestIdx);
        } else {
          setHoveredPoint(null);
        }
      };

      const handleMouseLeave = () => {
        setHoveredPoint(null);
      };

      const handleClick = (idx) => {
        if (onPointClick && data[idx]) {
          onPointClick(data[idx]);
        }
      };

      const hoveredData = hoveredPoint !== null ? data[hoveredPoint] : null;
      const prevData = hoveredPoint !== null && hoveredPoint > 0 ? data[hoveredPoint - 1] : null;
      const dayChange = hoveredData && prevData ? hoveredData.cumulative - prevData.cumulative : 
                        hoveredData && hoveredPoint === 0 ? hoveredData.cumulative : null;

      return (
        <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
          {/* Header */}
          <div className="px-3 md:px-6 py-3 md:py-4 bg-gradient-to-r from-gray-50 to-white border-b border-gray-100">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
              <div>
                <p className="text-[10px] md:text-xs font-medium text-gray-500 uppercase tracking-wider mb-0.5 md:mb-1">Cumulative P&L</p>
                <div className="flex items-baseline gap-2 md:gap-3">
                  <span className={`text-xl md:text-3xl font-bold ${isPositive ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrency(finalValue)}
                  </span>
                  <span className={`inline-flex items-center px-1.5 md:px-2 py-0.5 rounded-full text-[10px] md:text-xs font-medium ${
                    isPositive ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'
                  }`}>
                    {isPositive ? '‚Üë' : '‚Üì'} {Math.abs(changePercent)}%
                  </span>
                </div>
              </div>
              <div className="flex gap-3 md:gap-6 text-right">
                <div>
                  <p className="text-[10px] md:text-xs text-gray-500">Peak</p>
                  <p className="text-xs md:text-sm font-semibold text-emerald-600">{formatCurrencyShort(highestPoint)}</p>
                </div>
                <div>
                  <p className="text-[10px] md:text-xs text-gray-500">Trough</p>
                  <p className="text-xs md:text-sm font-semibold text-red-600">{formatCurrencyShort(lowestPoint)}</p>
                </div>
                <div className="hidden sm:block">
                  <p className="text-[10px] md:text-xs text-gray-500">Average</p>
                  <p className={`text-xs md:text-sm font-semibold ${avgValue >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(avgValue)}
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Chart */}
          <div className="px-1 md:px-2 py-2 relative" ref={chartRef}>
            <svg 
              viewBox={`0 0 ${width} ${height}`} 
              className="w-full cursor-crosshair" 
              style={{ height: '280px' }}
              onMouseMove={handleMouseMove}
              onMouseLeave={handleMouseLeave}
              preserveAspectRatio="xMidYMid meet"
            >
              <defs>
                <linearGradient id="areaGradientPos" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="#10b981" stopOpacity="0.4" />
                  <stop offset="100%" stopColor="#10b981" stopOpacity="0.02" />
                </linearGradient>
                <linearGradient id="areaGradientNeg" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="#ef4444" stopOpacity="0.02" />
                  <stop offset="100%" stopColor="#ef4444" stopOpacity="0.4" />
                </linearGradient>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                  <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>

              {/* Background */}
              <rect x={padding.left} y={padding.top} width={chartWidth} height={chartHeight} fill="#fafbfc" rx="4" />

              {/* Horizontal grid lines */}
              {yLabels.map((label, i) => (
                <g key={i}>
                  <line
                    x1={padding.left}
                    y1={label.y}
                    x2={width - padding.right}
                    y2={label.y}
                    stroke={Math.abs(label.value) < 1 ? '#64748b' : '#e5e7eb'}
                    strokeWidth={Math.abs(label.value) < 1 ? 1.5 : 1}
                    strokeDasharray={Math.abs(label.value) < 1 ? '0' : '4,4'}
                  />
                  <text
                    x={padding.left - 8}
                    y={label.y + 4}
                    textAnchor="end"
                    fontSize="10"
                    fill="#6b7280"
                    fontWeight="500"
                  >
                    {formatCurrencyShort(label.value)}
                  </text>
                </g>
              ))}

              {/* Area fill */}
              <path
                d={areaPath}
                fill={isPositive ? 'url(#areaGradientPos)' : 'url(#areaGradientNeg)'}
              />

              {/* Main line with glow */}
              <path
                d={pathD}
                fill="none"
                stroke={isPositive ? '#10b981' : '#ef4444'}
                strokeWidth="3"
                strokeLinecap="round"
                strokeLinejoin="round"
                filter="url(#glow)"
              />

              {/* Vertical hover line */}
              {hoveredPoint !== null && (
                <line
                  x1={getX(hoveredPoint)}
                  y1={padding.top}
                  x2={getX(hoveredPoint)}
                  y2={height - padding.bottom}
                  stroke="#6366f1"
                  strokeWidth="1.5"
                  strokeDasharray="4,4"
                  opacity="0.8"
                />
              )}

              {/* Data points */}
              {data.map((d, i) => {
                const x = getX(i);
                const y = getY(d.cumulative);
                const ptPositive = d.cumulative >= 0;
                const isLast = i === data.length - 1;
                const isHovered = i === hoveredPoint;
                return (
                  <g 
                    key={i} 
                    onClick={() => handleClick(i)}
                    style={{ cursor: onPointClick ? 'pointer' : 'crosshair' }}
                  >
                    {/* Outer glow for last point or hovered */}
                    {(isLast || isHovered) && (
                      <circle 
                        cx={x} 
                        cy={y} 
                        r={isHovered ? 14 : 10} 
                        fill={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                        opacity="0.25"
                      >
                        {isLast && !isHovered && (
                          <>
                            <animate attributeName="r" values="8;12;8" dur="2s" repeatCount="indefinite" />
                            <animate attributeName="opacity" values="0.3;0.1;0.3" dur="2s" repeatCount="indefinite" />
                          </>
                        )}
                      </circle>
                    )}
                    <circle 
                      cx={x} 
                      cy={y} 
                      r={isHovered ? 9 : (isLast ? 7 : 5)} 
                      fill="white" 
                      stroke={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                      strokeWidth="2.5" 
                    />
                    <circle 
                      cx={x} 
                      cy={y} 
                      r={isHovered ? 5 : (isLast ? 4 : 3)} 
                      fill={isHovered ? '#6366f1' : (ptPositive ? '#10b981' : '#ef4444')} 
                    />
                  </g>
                );
              })}

              {/* X-axis labels */}
              {xLabels.map((label, i) => (
                <text
                  key={i}
                  x={label.x}
                  y={height - padding.bottom + 18}
                  textAnchor="middle"
                  fontSize="10"
                  fill="#6b7280"
                  fontWeight="500"
                >
                  {label.date.slice(5)}
                </text>
              ))}
            </svg>

            {/* Tooltip */}
            {hoveredData && (
              <div 
                className="absolute pointer-events-none bg-gray-900 text-white px-4 py-3 rounded-lg shadow-xl text-sm z-10 border border-gray-700"
                style={{
                  left: Math.min(Math.max(mousePos.x - 75, 10), (chartRef.current?.offsetWidth || 400) - 170),
                  top: Math.max(mousePos.y - 90, 10),
                }}
              >
                <p className="font-semibold text-gray-300 text-xs mb-1">{hoveredData.date}</p>
                <p className={`text-xl font-bold ${hoveredData.cumulative >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                  {formatCurrency(hoveredData.cumulative)}
                </p>
                {dayChange !== null && (
                  <p className={`text-xs mt-1 ${dayChange >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                    {dayChange >= 0 ? '+' : ''}{formatCurrency(dayChange)} this day
                  </p>
                )}
                {onPointClick && (
                  <p className="text-xs text-indigo-400 mt-2 font-medium">Click to view details ‚Üí</p>
                )}
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="px-3 md:px-6 py-2 md:py-3 bg-gray-50 border-t border-gray-100 flex items-center justify-between">
            <div className="flex items-center gap-2 md:gap-4">
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-1.5 md:w-2 h-1.5 md:h-2 rounded-full bg-emerald-500" />
                <span className="text-[10px] md:text-xs text-gray-600">Profit</span>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <div className="w-1.5 md:w-2 h-1.5 md:h-2 rounded-full bg-red-500" />
                <span className="text-[10px] md:text-xs text-gray-600">Loss</span>
              </div>
            </div>
            <div className="text-[10px] md:text-xs text-gray-500">
              {data.length} trade{data.length !== 1 ? 's' : ''}
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // STAR RATING COMPONENT
    // =============================================================================
    function StarRating({ value, onChange, readonly = false, size = 'md' }) {
      const [hoverValue, setHoverValue] = useState(0);
      
      const sizeClasses = {
        sm: 'w-4 h-4',
        md: 'w-6 h-6',
        lg: 'w-8 h-8',
      };
      
      const starSize = sizeClasses[size] || sizeClasses.md;
      
      return (
        <div className="flex gap-1">
          {[1, 2, 3, 4, 5].map((star) => {
            const isFilled = star <= (hoverValue || value);
            return (
              <button
                key={star}
                type="button"
                onClick={() => !readonly && onChange(star === value ? 0 : star)}
                onMouseEnter={() => !readonly && setHoverValue(star)}
                onMouseLeave={() => !readonly && setHoverValue(0)}
                disabled={readonly}
                className={`${readonly ? 'cursor-default' : 'cursor-pointer hover:scale-110'} transition-transform ${
                  isFilled ? 'text-amber-400' : 'text-gray-300'
                }`}
              >
                <svg viewBox="0 0 24 24" fill={isFilled ? 'currentColor' : 'none'} stroke="currentColor" strokeWidth="2" className={starSize}>
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
              </button>
            );
          })}
        </div>
      );
    }

    // =============================================================================
    // TRADE ENTRY MODAL
    // =============================================================================
    function TradeModal({ isOpen, onClose, trade, state, setState }) {
      const isEdit = trade !== null && trade.id !== undefined;
      const fileInputRef = useRef(null);

      const emptyForm = {
        entryDate: todayISO(),
        ticker: '',
        assetType: 'stock',
        positionType: 'long',
        positionSize: '',
        entryPrice: '',
        exitDate: '',
        exitPrice: '',
        pnlManual: '',
        setupId: '',
        mistakeIds: [],
        notes: '',
        screenshot: null,
        rating: 0,
      };

      const [form, setForm] = useState(emptyForm);
      const [errors, setErrors] = useState({});
      const [showTickerDropdown, setShowTickerDropdown] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

      // Initialize form when modal opens
      useEffect(() => {
        if (isOpen) {
          if (trade && trade.id) {
            // Editing existing trade
            setForm({
              entryDate: trade.entryDate || todayISO(),
              ticker: trade.ticker || '',
              assetType: trade.assetType || 'stock',
              positionType: trade.positionType || 'long',
              positionSize: trade.positionSize?.toString() || '',
              entryPrice: trade.entryPrice?.toString() || '',
              exitDate: trade.exitDate || '',
              exitPrice: trade.exitPrice?.toString() || '',
              pnlManual: trade.pnlManual?.toString() || '',
              setupId: trade.setupId || '',
              mistakeIds: trade.mistakeIds || [],
              notes: trade.notes || '',
              screenshot: trade.screenshot || null,
              rating: trade.rating || 0,
            });
          } else if (trade && trade.entryDate) {
            // New trade with pre-filled date
            setForm({
              ...emptyForm,
              entryDate: trade.entryDate,
            });
          } else {
            // New trade with today's date
            setForm(emptyForm);
          }
          setErrors({});
          setShowDeleteConfirm(false);
        }
      }, [isOpen, trade]);

      // Get unique previous tickers (most recent first)
      const previousTickers = useMemo(() => {
        // Get tickers in order of most recent trade first
        const tickersByDate = state.trades
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))
          .map(t => t.ticker);
        
        // Remove duplicates while preserving order (most recent first)
        const uniqueTickers = [...new Set(tickersByDate)];
        
        // If user is typing, filter by input
        if (form.ticker) {
          return uniqueTickers
            .filter(t => t.toLowerCase().includes(form.ticker.toLowerCase()))
            .slice(0, 10);
        }
        
        // Otherwise show most recent 10
        return uniqueTickers.slice(0, 10);
      }, [state.trades, form.ticker]);

      // Get size label based on asset type
      const sizeLabel = ASSET_TYPES.find(a => a.id === form.assetType)?.sizeLabel || 'Shares';

      // Calculate derived values live
      const liveCalc = useMemo(() => {
        const hasExit = form.exitDate && form.exitPrice;
        let lengthDays = null;
        let pnlCalculated = null;

        if (hasExit && form.entryDate) {
          const entry = new Date(form.entryDate);
          const exit = new Date(form.exitDate);
          lengthDays = Math.round((exit - entry) / (1000 * 60 * 60 * 24));
        }

        if (hasExit && form.entryPrice && form.positionSize) {
          const entryP = parseFloat(form.entryPrice);
          const exitP = parseFloat(form.exitPrice);
          const size = parseFloat(form.positionSize);

          if (!isNaN(entryP) && !isNaN(exitP) && !isNaN(size)) {
            if (form.positionType === 'long') {
              pnlCalculated = (exitP - entryP) * size;
            } else {
              pnlCalculated = (entryP - exitP) * size;
            }
            pnlCalculated = Math.round(pnlCalculated * 100) / 100;
          }
        }

        // Check mismatch
        let pnlMismatch = false;
        if (form.pnlManual !== '' && pnlCalculated !== null) {
          const manual = parseFloat(form.pnlManual);
          if (!isNaN(manual)) {
            pnlMismatch = Math.abs(manual - pnlCalculated) > PNL_MISMATCH_THRESHOLD;
          }
        }

        return { lengthDays, pnlCalculated, pnlMismatch };
      }, [form]);

      // Handle input changes
      const handleChange = (field, value) => {
        setForm(prev => ({ ...prev, [field]: value }));
        if (errors[field]) {
          setErrors(prev => ({ ...prev, [field]: null }));
        }
      };

      // Handle ticker selection - auto-fill asset type and size from most recent trade
      const selectTicker = (ticker) => {
        // Find most recent trade with this ticker
        const previousTrade = state.trades
          .filter(t => t.ticker.toUpperCase() === ticker.toUpperCase())
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
        
        if (previousTrade) {
          setForm(prev => ({
            ...prev,
            ticker: ticker,
            assetType: previousTrade.assetType || prev.assetType,
            positionSize: previousTrade.positionSize?.toString() || prev.positionSize,
          }));
        } else {
          handleChange('ticker', ticker);
        }
        setShowTickerDropdown(false);
      };

      // Handle asset type change - auto-fill size from most recent trade with same ticker + asset type
      const handleAssetTypeChange = (assetType) => {
        // Find most recent trade with current ticker and this asset type
        const previousTrade = state.trades
          .filter(t => 
            t.ticker.toUpperCase() === form.ticker.toUpperCase() && 
            t.assetType === assetType
          )
          .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
        
        if (previousTrade && previousTrade.positionSize) {
          setForm(prev => ({
            ...prev,
            assetType: assetType,
            positionSize: previousTrade.positionSize.toString(),
          }));
        } else {
          // No previous trade with this combo, just try asset type alone
          const anyPreviousTrade = state.trades
            .filter(t => t.assetType === assetType)
            .sort((a, b) => (b.entryDate || '').localeCompare(a.entryDate || ''))[0];
          
          setForm(prev => ({
            ...prev,
            assetType: assetType,
            positionSize: anyPreviousTrade?.positionSize?.toString() || prev.positionSize,
          }));
        }
      };

      // Handle mistake toggle
      const toggleMistake = (mistakeId) => {
        setForm(prev => ({
          ...prev,
          mistakeIds: prev.mistakeIds.includes(mistakeId)
            ? prev.mistakeIds.filter(id => id !== mistakeId)
            : [...prev.mistakeIds, mistakeId]
        }));
      };

      // Handle screenshot upload with compression
      const handleScreenshotUpload = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        // Check if it's an image
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file.');
          return;
        }

        try {
          const compressedBase64 = await compressImage(file, 200 * 1024); // 200KB max
          handleChange('screenshot', compressedBase64);
        } catch (error) {
          alert(error.message);
        }
        
        // Reset input so same file can be selected again
        e.target.value = '';
      };

      // Compress image to target size using canvas
      const compressImage = (file, maxSizeBytes) => {
        return new Promise((resolve, reject) => {
          const img = new Image();
          const reader = new FileReader();

          reader.onload = (e) => {
            img.src = e.target.result;
          };

          reader.onerror = () => reject(new Error('Failed to read file'));

          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let { width, height } = img;
            const maxDimension = 1920; // Max width/height

            // Scale down if too large
            if (width > maxDimension || height > maxDimension) {
              if (width > height) {
                height = Math.round((height * maxDimension) / width);
                width = maxDimension;
              } else {
                width = Math.round((width * maxDimension) / height);
                height = maxDimension;
              }
            }

            // Try different quality levels
            const tryCompress = (currentWidth, currentHeight, quality) => {
              canvas.width = currentWidth;
              canvas.height = currentHeight;
              ctx.fillStyle = '#FFFFFF';
              ctx.fillRect(0, 0, currentWidth, currentHeight);
              ctx.drawImage(img, 0, 0, currentWidth, currentHeight);

              const base64 = canvas.toDataURL('image/jpeg', quality);
              const sizeBytes = Math.round((base64.length - 'data:image/jpeg;base64,'.length) * 0.75);

              return { base64, sizeBytes };
            };

            // Start with original dimensions and high quality
            let currentWidth = width;
            let currentHeight = height;
            let quality = 0.9;
            let result = tryCompress(currentWidth, currentHeight, quality);

            // Reduce quality first
            while (result.sizeBytes > maxSizeBytes && quality > 0.1) {
              quality -= 0.1;
              result = tryCompress(currentWidth, currentHeight, quality);
            }

            // If still too large, reduce dimensions
            while (result.sizeBytes > maxSizeBytes && currentWidth > 200) {
              currentWidth = Math.round(currentWidth * 0.8);
              currentHeight = Math.round(currentHeight * 0.8);
              quality = 0.8; // Reset quality for smaller size
              result = tryCompress(currentWidth, currentHeight, quality);

              // Try reducing quality again at new size
              while (result.sizeBytes > maxSizeBytes && quality > 0.1) {
                quality -= 0.1;
                result = tryCompress(currentWidth, currentHeight, quality);
              }
            }

            if (result.sizeBytes > maxSizeBytes) {
              reject(new Error('Unable to compress image below 200KB. Please use a smaller image.'));
            } else {
              resolve(result.base64);
            }
          };

          img.onerror = () => reject(new Error('Failed to load image'));

          reader.readAsDataURL(file);
        });
      };

      // Validate form
      const validate = () => {
        const newErrors = {};

        if (!form.entryDate) newErrors.entryDate = 'Required';
        if (!form.ticker.trim()) newErrors.ticker = 'Required';
        if (!form.assetType) newErrors.assetType = 'Required';
        if (!form.positionType) newErrors.positionType = 'Required';
        
        if (!form.positionSize) {
          newErrors.positionSize = 'Required';
        } else if (parseFloat(form.positionSize) <= 0) {
          newErrors.positionSize = 'Must be > 0';
        }

        if (form.entryPrice && parseFloat(form.entryPrice) < 0) {
          newErrors.entryPrice = 'Must be >= 0';
        }

        if (form.exitPrice && parseFloat(form.exitPrice) < 0) {
          newErrors.exitPrice = 'Must be >= 0';
        }

        if (form.exitDate && form.entryDate && form.exitDate < form.entryDate) {
          newErrors.exitDate = 'Must be >= entry date';
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
      };

      // Handle save
      const handleSave = () => {
        if (!validate()) return;

        const now = nowISO();
        const tradeData = {
          id: trade?.id || generateId(),
          entryDate: form.entryDate,
          ticker: form.ticker.toUpperCase().trim(),
          assetType: form.assetType,
          positionType: form.positionType,
          positionSize: parseFloat(form.positionSize),
          entryPrice: form.entryPrice ? parseFloat(form.entryPrice) : null,
          exitDate: form.exitDate || null,
          exitPrice: form.exitPrice ? parseFloat(form.exitPrice) : null,
          pnlManual: form.pnlManual ? parseFloat(form.pnlManual) : null,
          setupId: form.setupId || null,
          mistakeIds: form.mistakeIds,
          notes: form.notes,
          screenshot: form.screenshot,
          rating: form.rating || 0,
          createdAt: trade?.createdAt || now,
          updatedAt: now,
        };

        if (isEdit) {
          setState(prev => ({
            ...prev,
            trades: prev.trades.map(t => t.id === trade.id ? tradeData : t)
          }));
        } else {
          setState(prev => ({
            ...prev,
            trades: [...prev.trades, tradeData]
          }));
        }

        onClose();
      };

      // Handle delete
      const handleDelete = () => {
        setState(prev => ({
          ...prev,
          trades: prev.trades.filter(t => t.id !== trade.id)
        }));
        onClose();
      };

      if (!isOpen) return null;

      const mismatchRing = liveCalc.pnlMismatch ? 'ring-2 ring-red-500' : '';

      return (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="fixed inset-0 bg-black/50" onClick={onClose} />
          <div className="relative min-h-screen flex items-start md:items-center justify-center p-2 md:p-4 pt-4 md:pt-4">
            <div className="relative bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[92vh] overflow-y-auto">
              {/* Header */}
              <div className="sticky top-0 bg-white border-b border-gray-200 px-4 md:px-6 py-3 md:py-4 flex items-center justify-between rounded-t-xl z-10">
                <h2 className="text-lg md:text-xl font-semibold text-gray-900">
                  {isEdit ? 'Edit Trade' : 'Add Trade'}
                </h2>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
                  {Icons.x}
                </button>
              </div>

              {/* Form */}
              <div className="p-4 md:p-6 space-y-4 md:space-y-6">
                {/* Row 1: Entry Date, Ticker */}
                <div className="grid grid-cols-2 gap-3 md:gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Entry Date <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="date"
                      value={form.entryDate}
                      onChange={(e) => handleChange('entryDate', e.target.value)}
                      max={todayISO()}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.entryDate ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {errors.entryDate && <p className="text-red-500 text-xs mt-1">{errors.entryDate}</p>}
                  </div>

                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Ticker <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      value={form.ticker}
                      onChange={(e) => {
                        handleChange('ticker', e.target.value.toUpperCase());
                        setShowTickerDropdown(true);
                      }}
                      onFocus={() => setShowTickerDropdown(true)}
                      onBlur={() => setTimeout(() => setShowTickerDropdown(false), 200)}
                      placeholder="AAPL"
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.ticker ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {showTickerDropdown && previousTickers.length > 0 && (
                      <div className="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                        <div className="px-3 py-1.5 text-xs text-gray-500 border-b border-gray-100">
                          Recent tickers
                        </div>
                        {previousTickers.map(ticker => (
                          <button
                            key={ticker}
                            type="button"
                            onClick={() => selectTicker(ticker)}
                            className="w-full px-3 py-2 text-left hover:bg-gray-100 text-sm"
                          >
                            {ticker}
                          </button>
                        ))}
                      </div>
                    )}
                    {errors.ticker && <p className="text-red-500 text-xs mt-1">{errors.ticker}</p>}
                  </div>
                </div>

                {/* Row 2: Asset Type, Position Type */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Asset Type <span className="text-red-500">*</span>
                    </label>
                    <select
                      value={form.assetType}
                      onChange={(e) => handleAssetTypeChange(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      {ASSET_TYPES.map(type => (
                        <option key={type.id} value={type.id}>{type.label}</option>
                      ))}
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Position Type <span className="text-red-500">*</span>
                    </label>
                    <div className="flex gap-2">
                      {POSITION_TYPES.map(type => (
                        <button
                          key={type.id}
                          type="button"
                          onClick={() => handleChange('positionType', type.id)}
                          className={`flex-1 py-2 px-4 rounded-lg border font-medium transition-colors ${
                            form.positionType === type.id
                              ? type.id === 'long' 
                                ? 'bg-emerald-100 border-emerald-500 text-emerald-700'
                                : 'bg-red-100 border-red-500 text-red-700'
                              : 'border-gray-300 text-gray-600 hover:bg-gray-50'
                          }`}
                        >
                          {type.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Row 3: Position Size, Entry Price */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      {sizeLabel} <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="number"
                      value={form.positionSize}
                      onChange={(e) => handleChange('positionSize', e.target.value)}
                      placeholder="100"
                      step="any"
                      min="0"
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.positionSize ? 'border-red-500' : 'border-gray-300'
                      } ${mismatchRing}`}
                    />
                    {errors.positionSize && <p className="text-red-500 text-xs mt-1">{errors.positionSize}</p>}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Entry Price
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                      <input
                        type="number"
                        value={form.entryPrice}
                        onChange={(e) => handleChange('entryPrice', e.target.value)}
                        placeholder="0.00"
                        step="any"
                        min="0"
                        className={`w-full pl-7 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          errors.entryPrice ? 'border-red-500' : 'border-gray-300'
                        } ${mismatchRing}`}
                      />
                    </div>
                    {errors.entryPrice && <p className="text-red-500 text-xs mt-1">{errors.entryPrice}</p>}
                  </div>
                </div>

                {/* Row 4: Exit Date, Exit Price */}
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Exit Date
                    </label>
                    <input
                      type="date"
                      value={form.exitDate}
                      onChange={(e) => handleChange('exitDate', e.target.value)}
                      min={form.entryDate}
                      max={todayISO()}
                      className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        errors.exitDate ? 'border-red-500' : 'border-gray-300'
                      }`}
                    />
                    {errors.exitDate && <p className="text-red-500 text-xs mt-1">{errors.exitDate}</p>}
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      Exit Price
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                      <input
                        type="number"
                        value={form.exitPrice}
                        onChange={(e) => handleChange('exitPrice', e.target.value)}
                        placeholder="0.00"
                        step="any"
                        min="0"
                        className={`w-full pl-7 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          errors.exitPrice ? 'border-red-500' : 'border-gray-300'
                        } ${mismatchRing}`}
                      />
                    </div>
                    {errors.exitPrice && <p className="text-red-500 text-xs mt-1">{errors.exitPrice}</p>}
                  </div>
                </div>

                {/* Live Calculations */}
                {(liveCalc.lengthDays !== null || liveCalc.pnlCalculated !== null) && (
                  <div className="bg-gray-50 rounded-lg p-4 flex gap-6">
                    {liveCalc.lengthDays !== null && (
                      <div>
                        <p className="text-xs text-gray-500">Length of Trade</p>
                        <p className="text-lg font-semibold text-gray-900">{liveCalc.lengthDays} days</p>
                      </div>
                    )}
                    {liveCalc.pnlCalculated !== null && (
                      <div>
                        <p className="text-xs text-gray-500">Calculated P&L</p>
                        <p className={`text-lg font-semibold ${liveCalc.pnlCalculated >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {formatCurrency(liveCalc.pnlCalculated)}
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* P&L Manual Override */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Manual P&L Override
                    {liveCalc.pnlMismatch && (
                      <span className="ml-2 text-red-500 text-xs">‚ö† Mismatch with calculated P&L</span>
                    )}
                  </label>
                  <div className="relative">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                    <input
                      type="number"
                      value={form.pnlManual}
                      onChange={(e) => handleChange('pnlManual', e.target.value)}
                      placeholder="Leave empty to use calculated"
                      step="any"
                      className={`w-full pl-7 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                        liveCalc.pnlMismatch ? 'border-amber-500 bg-amber-50' : 'border-gray-300'
                      }`}
                    />
                  </div>
                </div>

                {/* Setup Dropdown */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Setup
                  </label>
                  <select
                    value={form.setupId}
                    onChange={(e) => handleChange('setupId', e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  >
                    <option value="">No setup selected</option>
                    {state.setups.map(setup => (
                      <option key={setup.id} value={setup.id}>{setup.name}</option>
                    ))}
                  </select>
                </div>

                {/* Mistakes Multi-select */}
                {state.mistakes.length > 0 && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Mistakes
                    </label>
                    <div className="flex flex-wrap gap-2">
                      {state.mistakes.map(mistake => (
                        <button
                          key={mistake.id}
                          type="button"
                          onClick={() => toggleMistake(mistake.id)}
                          className={`px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${
                            form.mistakeIds.includes(mistake.id)
                              ? 'bg-red-100 text-red-700 border-2 border-red-300'
                              : 'bg-gray-100 text-gray-600 border-2 border-transparent hover:bg-gray-200'
                          }`}
                        >
                          {mistake.name}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Screenshot Upload */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Screenshot
                  </label>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept="image/*"
                    onChange={handleScreenshotUpload}
                    className="hidden"
                  />
                  {form.screenshot ? (
                    <div className="relative">
                      <img 
                        src={form.screenshot} 
                        alt="Trade screenshot" 
                        className="w-full max-h-48 object-contain rounded-lg border border-gray-200 bg-gray-50"
                      />
                      <div className="absolute top-2 right-2 flex gap-2">
                        <span className="px-2 py-1 bg-black/60 text-white text-xs rounded">
                          {Math.round((form.screenshot.length - 'data:image/jpeg;base64,'.length) * 0.75 / 1024)}KB
                        </span>
                        <button
                          type="button"
                          onClick={() => handleChange('screenshot', null)}
                          className="p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                        >
                          {Icons.x}
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button
                      type="button"
                      onClick={() => fileInputRef.current?.click()}
                      className="w-full py-8 border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 transition-colors flex flex-col items-center gap-2 text-gray-500"
                    >
                      {Icons.upload}
                      <span className="text-sm">Click to upload (auto-compressed to max 200KB)</span>
                    </button>
                  )}
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Notes
                  </label>
                  <textarea
                    value={form.notes}
                    onChange={(e) => handleChange('notes', e.target.value)}
                    placeholder="Trade notes, observations, lessons learned..."
                    rows={3}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                  />
                </div>

                {/* Trade Rating */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Trade Rating
                  </label>
                  <div className="flex items-center gap-3">
                    <StarRating 
                      value={form.rating} 
                      onChange={(rating) => handleChange('rating', rating)} 
                      size="lg"
                    />
                    {form.rating > 0 && (
                      <span className="text-sm text-gray-500">
                        {form.rating === 1 && 'Poor'}
                        {form.rating === 2 && 'Below Average'}
                        {form.rating === 3 && 'Average'}
                        {form.rating === 4 && 'Good'}
                        {form.rating === 5 && 'Excellent'}
                      </span>
                    )}
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="sticky bottom-0 bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-between rounded-b-xl">
                <div>
                  {isEdit && (
                    showDeleteConfirm ? (
                      <div className="flex items-center gap-2">
                        <span className="text-sm text-red-600">Delete this trade?</span>
                        <button
                          type="button"
                          onClick={handleDelete}
                          className="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700"
                        >
                          Yes, Delete
                        </button>
                        <button
                          type="button"
                          onClick={() => setShowDeleteConfirm(false)}
                          className="px-3 py-1.5 bg-gray-200 text-gray-700 text-sm rounded-lg hover:bg-gray-300"
                        >
                          Cancel
                        </button>
                      </div>
                    ) : (
                      <button
                        type="button"
                        onClick={() => setShowDeleteConfirm(true)}
                        className="flex items-center gap-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                      >
                        {Icons.trash}
                        <span>Delete</span>
                      </button>
                    )
                  )}
                </div>
                <div className="flex gap-3">
                  <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                  >
                    Cancel
                  </button>
                  <button
                    type="button"
                    onClick={handleSave}
                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    {isEdit ? 'Save Changes' : 'Add Trade'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // DASHBOARD PAGE
    // =============================================================================
    function DashboardPage({ state, setState, setActivePage, setSelectedDate, isMobile }) {
      const [filter, setFilter] = useState('week');
      const [dailyNote, setDailyNote] = useState('');
      const [showDatePicker, setShowDatePicker] = useState(false);
      const [customStartDate, setCustomStartDate] = useState(null);
      const datePickerRef = React.useRef(null);
      const today = todayISO();

      useEffect(() => {
        if (state.dailyNotes[today]) {
          setDailyNote(state.dailyNotes[today].note || '');
        }
      }, [state.dailyNotes, today]);

      // Close date picker when clicking outside
      useEffect(() => {
        const handleClickOutside = (e) => {
          if (datePickerRef.current && !datePickerRef.current.contains(e.target)) {
            setShowDatePicker(false);
          }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
      }, []);

      // Reset to current period when filter changes
      useEffect(() => {
        setCustomStartDate(null);
      }, [filter]);

      const getDateRange = (filterType) => {
        const now = new Date();
        const todayStr = todayISO();
        
        switch (filterType) {
          case 'day':
            return { start: todayStr, end: todayStr };
          case 'week':
            // Get start of week (Sunday) and end of week (Saturday)
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - dayOfWeek);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return { 
              start: weekStart.toISOString().split('T')[0], 
              end: weekEnd.toISOString().split('T')[0] 
            };
          case 'month':
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
            return { start: monthStart, end: monthEnd };
          case 'year':
            const yearStart = `${now.getFullYear()}-01-01`;
            const yearEnd = `${now.getFullYear()}-12-31`;
            return { start: yearStart, end: yearEnd };
          case 'all':
          default:
            return { start: '1900-01-01', end: '2100-12-31' };
        }
      };

      const metrics = useMemo(() => {
        // Calculate the actual range (considering custom date selection)
        let range;
        if (customStartDate && filter !== 'all') {
          const start = new Date(customStartDate);
          let end = new Date(customStartDate);
          
          switch (filter) {
            case 'day':
              break;
            case 'week':
              end.setDate(start.getDate() + 6);
              break;
            case 'month':
              end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
              break;
            case 'year':
              end = new Date(start.getFullYear(), 11, 31);
              break;
          }
          range = {
            start: customStartDate,
            end: end.toISOString().split('T')[0]
          };
        } else {
          range = getDateRange(filter);
        }
        
        const closedTrades = state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            if (t.derived.isOpen) return false;
            // Use exitDate if available and not empty, otherwise use entryDate for filtering
            const dateToCheck = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
            if (!dateToCheck) return false;
            return dateToCheck >= range.start && dateToCheck <= range.end;
          });

        const totalTrades = closedTrades.length;
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');

        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const winRate = totalTrades > 0 ? ((wins.length / totalTrades) * 100).toFixed(1) : 0;

        const avgWin = wins.length > 0 
          ? wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / wins.length 
          : 0;
        const avgLoss = losses.length > 0 
          ? Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / losses.length)
          : 0;
        const avgWinLossRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';

        const dailyPnL = {};
        const dailyTradeCounts = {};
        const dailyWins = {};
        const dailyLosses = {};
        closedTrades.forEach(t => {
          // Use exitDate if available, otherwise use entryDate
          const date = t.exitDate || t.entryDate;
          if (!dailyPnL[date]) dailyPnL[date] = 0;
          if (!dailyTradeCounts[date]) dailyTradeCounts[date] = 0;
          if (!dailyWins[date]) dailyWins[date] = 0;
          if (!dailyLosses[date]) dailyLosses[date] = 0;
          dailyPnL[date] += t.derived.pnlFinal || 0;
          dailyTradeCounts[date]++;
          if (t.derived.winLoss === 'W') dailyWins[date]++;
          if (t.derived.winLoss === 'L') dailyLosses[date]++;
        });

        const days = Object.entries(dailyPnL);
        const bestDay = days.length > 0 ? days.reduce((best, curr) => curr[1] > best[1] ? curr : best, days[0]) : null;
        const worstDay = days.length > 0 ? days.reduce((worst, curr) => curr[1] < worst[1] ? curr : worst, days[0]) : null;

        const biggestWin = wins.length > 0 
          ? wins.reduce((best, curr) => curr.derived.pnlFinal > best.derived.pnlFinal ? curr : best, wins[0])
          : null;
        const biggestLoss = losses.length > 0 
          ? losses.reduce((worst, curr) => curr.derived.pnlFinal < worst.derived.pnlFinal ? curr : worst, losses[0])
          : null;

        const sortedTrades = [...closedTrades].sort((a, b) => {
          const dateA = a.exitDate || a.entryDate;
          const dateB = b.exitDate || b.entryDate;
          return dateA.localeCompare(dateB);
        });
        let cumulative = 0;
        const chartByDate = {};
        sortedTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          cumulative += t.derived.pnlFinal || 0;
          chartByDate[date] = Math.round(cumulative * 100) / 100;
        });
        const chartData = Object.entries(chartByDate).map(([date, cumulative]) => ({ date, cumulative }));

        // Setup analytics (filtered by date range)
        const setupStats = {};
        state.setups.forEach(setup => {
          setupStats[setup.id] = {
            id: setup.id,
            name: setup.name,
            totalTrades: 0,
            wins: 0,
            losses: 0,
            totalPnL: 0,
            winRate: 0,
          };
        });
        closedTrades.forEach(trade => {
          if (!trade.setupId || !setupStats[trade.setupId]) return;
          setupStats[trade.setupId].totalTrades++;
          setupStats[trade.setupId].totalPnL += trade.derived.pnlFinal || 0;
          if (trade.derived.winLoss === 'W') setupStats[trade.setupId].wins++;
          if (trade.derived.winLoss === 'L') setupStats[trade.setupId].losses++;
        });
        Object.values(setupStats).forEach(setup => {
          const totalClosed = setup.wins + setup.losses;
          setup.winRate = totalClosed > 0 ? Math.round((setup.wins / totalClosed) * 100) : 0;
        });
        const setupAnalytics = Object.values(setupStats);

        // Mistake analytics (filtered by date range) - ONLY count losses
        const mistakeStats = {};
        state.mistakes.forEach(mistake => {
          mistakeStats[mistake.id] = {
            id: mistake.id,
            name: mistake.name,
            totalOccurrences: 0,
            losingTrades: 0,
            profitableTrades: 0,
            totalLossAmount: 0,
          };
        });
        closedTrades.forEach(trade => {
          if (!trade.mistakeIds || trade.mistakeIds.length === 0) return;
          const pnl = trade.derived.pnlFinal || 0;
          trade.mistakeIds.forEach(mistakeId => {
            if (!mistakeStats[mistakeId]) return;
            mistakeStats[mistakeId].totalOccurrences++;
            if (pnl < 0) {
              mistakeStats[mistakeId].losingTrades++;
              mistakeStats[mistakeId].totalLossAmount += pnl;
            } else {
              mistakeStats[mistakeId].profitableTrades++;
            }
          });
        });
        const mistakeAnalytics = Object.values(mistakeStats);

        // Calculate average daily trades
        const tradeCounts = Object.values(dailyTradeCounts);
        const avgDailyTrades = tradeCounts.length > 0 
          ? tradeCounts.reduce((a, b) => a + b, 0) / tradeCounts.length 
          : 0;

        return {
          totalTrades, totalPnL, wins: wins.length, losses: losses.length, winRate,
          avgWin, avgLoss, avgWinLossRatio, riskRewardRatio, avgDailyTrades,
          dailyPnL, dailyTradeCounts, dailyWins, dailyLosses, bestDay, worstDay, biggestWin, biggestLoss, chartData,
          setupAnalytics, mistakeAnalytics,
        };
      }, [state.trades, state.setups, state.mistakes, filter, customStartDate]);

      const calendarData = useMemo(() => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();
        const firstDay = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = firstDay.getDay();

        const days = [];
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push({ day: null, pnl: null, trades: 0, wins: 0, losses: 0 });
        }
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const pnl = metrics.dailyPnL[dateStr] || null;
          const trades = metrics.dailyTradeCounts[dateStr] || 0;
          const wins = metrics.dailyWins[dateStr] || 0;
          const losses = metrics.dailyLosses[dateStr] || 0;
          days.push({ day: d, date: dateStr, pnl, trades, wins, losses });
        }

        return { year, month, monthName: firstDay.toLocaleString('default', { month: 'long' }), days };
      }, [metrics.dailyPnL, metrics.dailyTradeCounts, metrics.dailyWins, metrics.dailyLosses]);

      // Goal progress calculation (based on yearly goal)
      const goalProgress = useMemo(() => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const TRADING_DAYS_PER_YEAR = 252;
        
        // Check for yearly goal
        const yearlyGoal = state.yearlyGoal;
        if (!yearlyGoal || yearlyGoal.year !== currentYear) return null;
        
        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        // Calculate year P&L and build cumulative by date
        const yearTrades = state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            if (t.derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .sort((a, b) => {
            const dateA = a.exitDate || a.entryDate;
            const dateB = b.exitDate || b.entryDate;
            return dateA.localeCompare(dateB);
          });
        
        // Build cumulative P&L by date
        const cumulativeByDate = {};
        let runningTotal = 0;
        yearTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          runningTotal += t.derived.pnlFinal || 0;
          cumulativeByDate[date] = runningTotal;
        });
        
        const yearPnL = runningTotal;
        
        // Calculate progress percentage
        const progress = yearlyGoal.target > 0 ? (yearPnL / yearlyGoal.target) * 100 : 0;
        const isComplete = yearPnL >= yearlyGoal.target;
        const remaining = yearlyGoal.target - yearPnL;
        
        // Calculate days remaining
        const endOfYear = new Date(currentYear, 11, 31);
        const calendarDaysRemaining = Math.ceil((endOfYear - now) / (1000 * 60 * 60 * 24));
        const tradingDaysRemaining = Math.round(calendarDaysRemaining * (TRADING_DAYS_PER_YEAR / 365));
        const tradingDaysPassed = TRADING_DAYS_PER_YEAR - tradingDaysRemaining;
        
        // Calculate pace
        const expectedPnL = (yearlyGoal.target / TRADING_DAYS_PER_YEAR) * tradingDaysPassed;
        const paceStatus = yearPnL >= expectedPnL ? 'ahead' : 'behind';
        const paceDifference = yearPnL - expectedPnL;
        
        // Calculate targets for different periods (based on 252 trading days)
        const dailyTarget = yearlyGoal.target / TRADING_DAYS_PER_YEAR;
        const weeklyTarget = yearlyGoal.target / 52;
        const monthlyTarget = yearlyGoal.target / 12;
        const quarterlyTarget = yearlyGoal.target / 4;
        
        // Calculate remaining targets (to hit goal)
        const remainingDailyTarget = tradingDaysRemaining > 0 ? remaining / tradingDaysRemaining : 0;
        const weeksRemaining = Math.ceil(calendarDaysRemaining / 7);
        const remainingWeeklyTarget = weeksRemaining > 0 ? remaining / weeksRemaining : 0;
        
        // Build pace line data for calendar
        const paceByDate = {};
        let dayCount = 0;
        for (let d = new Date(currentYear, 0, 1); d <= endOfYear; d.setDate(d.getDate() + 1)) {
          const day = d.getDay();
          if (day !== 0 && day !== 6) { // Skip weekends for trading days
            dayCount++;
            const dateStr = d.toISOString().split('T')[0];
            paceByDate[dateStr] = dailyTarget * dayCount;
          }
        }
        
        return {
          goal: yearlyGoal,
          yearPnL,
          progress: Math.min(progress, 100),
          progressRaw: progress,
          isComplete,
          remaining,
          paceStatus,
          paceDifference,
          dailyTarget,
          weeklyTarget,
          monthlyTarget,
          quarterlyTarget,
          remainingDailyTarget,
          remainingWeeklyTarget,
          daysRemaining: calendarDaysRemaining,
          tradingDaysRemaining,
          weeksRemaining,
          yearLabel: `${currentYear}`,
          yearStartStr: yearStart,
          yearEndStr: yearEnd,
          cumulativeByDate,
          paceByDate,
        };
      }, [state.yearlyGoal, state.trades]);

      const handleSaveDailyNote = () => {
        const updatedNotes = {
          ...state.dailyNotes,
          [today]: {
            date: today,
            note: dailyNote,
            emotionalState: state.dailyNotes[today]?.emotionalState || null,
            updatedAt: nowISO(),
          },
        };
        setState({ ...state, dailyNotes: updatedNotes });
      };

      const handleDayClick = (dateStr) => {
        if (dateStr) {
          setSelectedDate(dateStr);
          setActivePage('calendar');
        }
      };

      // Get the actual date range being used
      const currentRange = useMemo(() => {
        if (customStartDate && filter !== 'all') {
          const start = new Date(customStartDate);
          let end = new Date(customStartDate);
          
          switch (filter) {
            case 'day':
              // end is same as start
              break;
            case 'week':
              end.setDate(start.getDate() + 6);
              break;
            case 'month':
              end = new Date(start.getFullYear(), start.getMonth() + 1, 0);
              break;
            case 'year':
              end = new Date(start.getFullYear(), 11, 31);
              break;
          }
          return {
            start: customStartDate,
            end: end.toISOString().split('T')[0]
          };
        }
        return getDateRange(filter);
      }, [filter, customStartDate]);

      // Format date range for display
      const formatDateRange = () => {
        const start = new Date(currentRange.start + 'T12:00:00');
        const end = new Date(currentRange.end + 'T12:00:00');
        
        const formatDate = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const formatShort = (d) => d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        if (filter === 'day') {
          return formatDate(start);
        } else if (filter === 'all') {
          return 'All Time';
        } else if (start.getFullYear() === end.getFullYear()) {
          return `${formatShort(start)} - ${formatShort(end)}, ${start.getFullYear()}`;
        } else {
          return `${formatDate(start)} - ${formatDate(end)}`;
        }
      };

      // Handle date selection from mini calendar
      const handleDateSelect = (dateStr) => {
        const selectedDate = new Date(dateStr + 'T12:00:00');
        
        switch (filter) {
          case 'day':
            setCustomStartDate(dateStr);
            break;
          case 'week':
            // Set to Sunday of selected week
            const dayOfWeek = selectedDate.getDay();
            const sunday = new Date(selectedDate);
            sunday.setDate(selectedDate.getDate() - dayOfWeek);
            setCustomStartDate(sunday.toISOString().split('T')[0]);
            break;
          case 'month':
            // Set to first of month
            const monthStart = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
            setCustomStartDate(monthStart.toISOString().split('T')[0]);
            break;
          case 'year':
            // Set to Jan 1 of year
            setCustomStartDate(`${selectedDate.getFullYear()}-01-01`);
            break;
          default:
            setCustomStartDate(null);
        }
        setShowDatePicker(false);
      };

      // Mini Calendar for date picker
      const MiniCalendar = () => {
        const [viewMonth, setViewMonth] = useState(() => {
          const d = customStartDate ? new Date(customStartDate + 'T12:00:00') : new Date();
          return { year: d.getFullYear(), month: d.getMonth() };
        });

        const daysInMonth = new Date(viewMonth.year, viewMonth.month + 1, 0).getDate();
        const firstDayOfWeek = new Date(viewMonth.year, viewMonth.month, 1).getDay();
        const monthName = new Date(viewMonth.year, viewMonth.month, 1).toLocaleString('default', { month: 'long' });

        const days = [];
        for (let i = 0; i < firstDayOfWeek; i++) days.push(null);
        for (let d = 1; d <= daysInMonth; d++) days.push(d);

        const isInRange = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr >= currentRange.start && dateStr <= currentRange.end;
        };

        const isRangeStart = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr === currentRange.start;
        };

        const isRangeEnd = (day) => {
          if (!day) return false;
          const dateStr = `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          return dateStr === currentRange.end;
        };

        return (
          <div className="p-3">
            <div className="flex items-center justify-between mb-3">
              <button
                onClick={() => setViewMonth(prev => prev.month === 0 
                  ? { year: prev.year - 1, month: 11 } 
                  : { ...prev, month: prev.month - 1 })}
                className="p-1 hover:bg-gray-100 rounded"
              >
                {Icons.chevronLeft}
              </button>
              <span className="font-semibold text-gray-900">{monthName} {viewMonth.year}</span>
              <button
                onClick={() => setViewMonth(prev => prev.month === 11 
                  ? { year: prev.year + 1, month: 0 } 
                  : { ...prev, month: prev.month + 1 })}
                className="p-1 hover:bg-gray-100 rounded"
              >
                {Icons.chevronRight}
              </button>
            </div>
            <div className="grid grid-cols-7 gap-0.5 text-center">
              {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => (
                <div key={i} className="text-xs text-gray-500 py-1">{d}</div>
              ))}
              {days.map((day, i) => {
                const dateStr = day ? `${viewMonth.year}-${String(viewMonth.month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : null;
                const inRange = isInRange(day);
                const isStart = isRangeStart(day);
                const isEnd = isRangeEnd(day);
                
                return (
                  <button
                    key={i}
                    onClick={() => day && handleDateSelect(dateStr)}
                    disabled={!day}
                    className={`
                      text-xs py-1.5 transition-colors
                      ${!day ? 'invisible' : 'hover:bg-blue-100 cursor-pointer'}
                      ${inRange ? 'bg-blue-100 text-blue-900' : 'text-gray-700'}
                      ${isStart ? 'rounded-l-md bg-blue-500 text-white hover:bg-blue-600' : ''}
                      ${isEnd ? 'rounded-r-md bg-blue-500 text-white hover:bg-blue-600' : ''}
                      ${isStart && isEnd ? 'rounded-md' : ''}
                    `}
                  >
                    {day}
                  </button>
                );
              })}
            </div>
            {filter !== 'all' && (
              <div className="mt-3 pt-3 border-t border-gray-100">
                <button
                  onClick={() => { setCustomStartDate(null); setShowDatePicker(false); }}
                  className="w-full text-xs text-blue-600 hover:text-blue-700 font-medium"
                >
                  Reset to Current {filter.charAt(0).toUpperCase() + filter.slice(1)}
                </button>
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header with filters */}
          <div className="flex flex-col gap-3">
            <div className="flex items-center justify-between">
              <h1 className="text-xl md:text-2xl font-bold text-gray-900">Dashboard</h1>
              {/* Date Range Display with Picker */}
              <div className="relative" ref={datePickerRef}>
                <button
                  onClick={() => filter !== 'all' && setShowDatePicker(!showDatePicker)}
                  className={`flex items-center gap-1 text-xs md:text-sm ${
                    filter === 'all' ? 'text-gray-500 cursor-default' : 'text-blue-600 hover:text-blue-700 cursor-pointer'
                  }`}
                >
                  {Icons.calendar}
                  <span className="font-medium hidden sm:inline">{formatDateRange()}</span>
                  <span className="font-medium sm:hidden">{filter === 'all' ? 'All' : formatDateRange().split(',')[0]}</span>
                  {filter !== 'all' && (
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-3 h-3 md:w-4 md:h-4">
                      <path d="M6 9l6 6 6-6" />
                    </svg>
                  )}
                </button>
                {showDatePicker && filter !== 'all' && (
                  <div className="absolute top-full right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 z-50 min-w-[280px]">
                    <MiniCalendar />
                  </div>
                )}
              </div>
            </div>
            {/* Filter buttons - scrollable on mobile */}
            <div className="flex gap-1 bg-gray-100 p-1 rounded-lg overflow-x-auto no-scrollbar">
              {FILTER_OPTIONS.map(opt => (
                <button
                  key={opt.id}
                  onClick={() => setFilter(opt.id)}
                  className={`px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm font-medium rounded-md transition-colors whitespace-nowrap flex-shrink-0 ${
                    filter === opt.id ? 'bg-white text-gray-900 shadow-sm' : 'text-gray-600 hover:text-gray-900'
                  }`}
                >
                  {opt.label}
                </button>
              ))}
            </div>
          </div>

          {/* Stats Grid - 2 columns on mobile, 5 on desktop */}
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2 md:gap-4">
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm col-span-2 md:col-span-1">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Total P&L</p>
              <p className={`text-2xl md:text-3xl font-bold ${metrics.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                {formatCurrency(metrics.totalPnL)}
              </p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Win/Loss</p>
              <p className="text-lg md:text-xl font-bold text-gray-900">
                <span className="text-emerald-600">{metrics.wins}W</span>{' / '}<span className="text-red-600">{metrics.losses}L</span>
              </p>
              <p className="text-xs md:text-sm text-gray-500 mt-1">{metrics.winRate}% Win Rate</p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Avg W/L Ratio</p>
              <p className="text-lg md:text-xl font-bold text-gray-900">{metrics.avgWinLossRatio}:1</p>
              <p className="text-[10px] md:text-xs text-gray-500 mt-1 truncate">
                {formatCurrencyShort(metrics.avgWin)} / {formatCurrencyShort(metrics.avgLoss)}
              </p>
            </div>
            <div className="bg-white p-3 md:p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-xs md:text-sm font-medium text-gray-500 mb-1">Total Trades</p>
              <p className="text-2xl md:text-3xl font-bold text-gray-900">{metrics.totalTrades}</p>
              {metrics.avgDailyTrades > 0 && (
                <p className="text-xs text-gray-500 mt-1">
                  avg {metrics.avgDailyTrades.toFixed(1)}/day
                </p>
              )}
            </div>
            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
              <p className="text-sm font-medium text-gray-500 mb-1">Risk/Reward</p>
              <p className="text-3xl font-bold text-gray-900">{metrics.riskRewardRatio}:1</p>
            </div>
          </div>

          {/* Goal Progress Card */}
          {goalProgress && (
            <div className={`rounded-xl border-2 p-4 md:p-6 ${
              goalProgress.isComplete 
                ? 'bg-emerald-50 border-emerald-300' 
                : goalProgress.paceStatus === 'ahead' 
                  ? 'bg-blue-50 border-blue-300'
                  : 'bg-amber-50 border-amber-300'
            }`}>
              <div className="flex flex-col lg:flex-row lg:items-center gap-4 lg:gap-8">
                {/* Progress Ring */}
                <div className="flex items-center gap-4">
                  <div className="relative w-20 h-20 md:w-24 md:h-24 flex-shrink-0">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle
                        cx="50%"
                        cy="50%"
                        r="45%"
                        fill="none"
                        stroke="#e5e7eb"
                        strokeWidth="8"
                      />
                      <circle
                        cx="50%"
                        cy="50%"
                        r="45%"
                        fill="none"
                        stroke={goalProgress.isComplete ? '#10b981' : goalProgress.paceStatus === 'ahead' ? '#3b82f6' : '#f59e0b'}
                        strokeWidth="8"
                        strokeLinecap="round"
                        strokeDasharray={`${goalProgress.progress * 2.83} 283`}
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className={`text-lg md:text-xl font-bold ${
                        goalProgress.isComplete ? 'text-emerald-600' : goalProgress.paceStatus === 'ahead' ? 'text-blue-600' : 'text-amber-600'
                      }`}>
                        {goalProgress.progress.toFixed(0)}%
                      </span>
                    </div>
                  </div>
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-semibold px-2 py-0.5 rounded ${
                        goalProgress.isComplete 
                          ? 'bg-emerald-200 text-emerald-800' 
                          : goalProgress.paceStatus === 'ahead'
                            ? 'bg-blue-200 text-blue-800'
                            : 'bg-amber-200 text-amber-800'
                      }`}>
                        {goalProgress.yearLabel} Goal
                      </span>
                      {goalProgress.isComplete && <span className="text-lg">üéØ</span>}
                    </div>
                    <p className="text-sm text-gray-600 mt-1">
                      {goalProgress.isComplete 
                        ? 'Goal achieved!' 
                        : goalProgress.paceStatus === 'ahead' 
                          ? 'On track' 
                          : 'Behind pace'}
                    </p>
                  </div>
                </div>
                
                {/* Stats */}
                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">Target</p>
                    <p className="text-base md:text-lg font-bold text-gray-900">{formatCurrencyShort(goalProgress.goal.target)}</p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">Current</p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.yearPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                      {formatCurrencyShort(goalProgress.yearPnL)}
                    </p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">
                      {goalProgress.isComplete ? 'Exceeded' : 'Remaining'}
                    </p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.isComplete ? 'text-emerald-600' : 'text-gray-900'}`}>
                      {formatCurrencyShort(Math.abs(goalProgress.remaining))}
                    </p>
                  </div>
                  <div>
                    <p className="text-[10px] md:text-xs text-gray-500 uppercase">
                      {goalProgress.paceStatus === 'ahead' ? 'Ahead by' : 'Behind by'}
                    </p>
                    <p className={`text-base md:text-lg font-bold ${goalProgress.paceStatus === 'ahead' ? 'text-emerald-600' : 'text-red-600'}`}>
                      {formatCurrencyShort(Math.abs(goalProgress.paceDifference))}
                    </p>
                  </div>
                </div>
                
                {/* Period Target based on filter */}
                <div className={`p-3 rounded-lg ${
                  goalProgress.isComplete 
                    ? 'bg-emerald-100' 
                    : goalProgress.paceStatus === 'ahead'
                      ? 'bg-blue-100'
                      : 'bg-amber-100'
                } flex-shrink-0`}>
                  <p className="text-[10px] md:text-xs text-gray-600 uppercase mb-1">
                    {filter === 'day' ? 'Daily' : filter === 'week' ? 'Weekly' : filter === 'month' ? 'Monthly' : filter === 'year' ? 'Quarterly' : 'Weekly'} Target
                  </p>
                  <p className="text-lg md:text-xl font-bold text-gray-900">
                    {formatCurrencyShort(
                      filter === 'day' ? goalProgress.dailyTarget :
                      filter === 'month' ? goalProgress.monthlyTarget :
                      filter === 'year' ? goalProgress.quarterlyTarget :
                      goalProgress.weeklyTarget
                    )}
                  </p>
                  {!goalProgress.isComplete && goalProgress.tradingDaysRemaining > 0 && (
                    <p className="text-[10px] text-gray-500 mt-1">
                      Need {formatCurrencyShort(goalProgress.remainingDailyTarget)}/day
                    </p>
                  )}
                </div>
              </div>
            </div>
          )}

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">{calendarData.monthName} {calendarData.year}</h2>
              <div className="grid grid-cols-7 gap-1">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                  <div key={day} className="text-center text-xs font-medium text-gray-500 py-2">{day}</div>
                ))}
                {calendarData.days.map((d, i) => {
                  const winRate = d.trades > 0 && (d.wins + d.losses) > 0 
                    ? Math.round((d.wins / (d.wins + d.losses)) * 100) 
                    : null;
                  
                  // Calculate if day met its daily goal target (only for days with trades)
                  let metDailyGoal = null;
                  if (goalProgress && d.day && d.trades > 0 && d.date >= goalProgress.yearStartStr && d.date <= goalProgress.yearEndStr) {
                    metDailyGoal = d.pnl >= goalProgress.dailyTarget;
                  }
                  
                  return (
                    <div
                      key={i}
                      onClick={() => d.day && handleDayClick(d.date)}
                      className={`
                        min-h-[60px] md:min-h-[72px] p-1 rounded-lg flex flex-col items-center justify-start
                        ${d.day ? 'cursor-pointer hover:ring-2 hover:ring-blue-400' : ''}
                        ${!d.day ? 'bg-transparent' : ''}
                        ${d.day && d.trades === 0 ? 'bg-gray-50' : ''}
                        ${d.day && d.trades > 0 && d.pnl > 0 ? 'bg-emerald-100 border border-emerald-300' : ''}
                        ${d.day && d.trades > 0 && d.pnl < 0 ? 'bg-red-100 border border-red-300' : ''}
                        ${d.day && d.trades > 0 && d.pnl === 0 ? 'bg-gray-200' : ''}
                      `}
                    >
                      {d.day && (
                        <>
                          <span className="text-xs md:text-sm font-semibold text-gray-700">{d.day}</span>
                          {d.trades > 0 && (
                            <div className="flex flex-col items-center leading-tight">
                              <span className={`text-[10px] md:text-xs font-bold ${d.pnl >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>
                                {formatCurrencyShort(d.pnl)}
                              </span>
                              <span className="text-[8px] md:text-[10px] text-gray-500">{d.wins}W/{d.losses}L</span>
                            </div>
                          )}
                          {/* Goal indicator - only on trading days */}
                          {metDailyGoal !== null && (
                            <span className="text-[8px]" title={metDailyGoal ? 'Hit daily goal' : 'Missed daily goal'}>
                              {metDailyGoal ? '‚úÖ' : '‚ùå'}
                            </span>
                          )}
                        </>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col">
              <h2 className="text-lg font-semibold text-gray-900 mb-2">Today's Notes</h2>
              <p className="text-sm text-gray-500 mb-3">{today}</p>
              <textarea
                value={dailyNote}
                onChange={(e) => setDailyNote(e.target.value)}
                placeholder="Jot down your thoughts for today..."
                className="w-full flex-1 min-h-[280px] p-3 border border-gray-200 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
              <button
                onClick={handleSaveDailyNote}
                className="mt-3 w-full py-2 px-4 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
              >
                Save Note
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-2 bg-emerald-100 rounded-lg text-emerald-600">{Icons.trendUp}</div>
                <p className="text-sm font-medium text-gray-500">Biggest Win</p>
              </div>
              {metrics.biggestWin ? (
                <>
                  <p className="text-xl font-bold text-emerald-600">{formatCurrency(metrics.biggestWin.derived.pnlFinal)}</p>
                  <p className="text-sm text-gray-500">{metrics.biggestWin.ticker} ‚Ä¢ {metrics.biggestWin.exitDate || metrics.biggestWin.entryDate}</p>
                </>
              ) : (
                <p className="text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-2 bg-red-100 rounded-lg text-red-600">{Icons.trendDown}</div>
                <p className="text-sm font-medium text-gray-500">Biggest Loss</p>
              </div>
              {metrics.biggestLoss ? (
                <>
                  <p className="text-xl font-bold text-red-600">{formatCurrency(metrics.biggestLoss.derived.pnlFinal)}</p>
                  <p className="text-sm text-gray-500">{metrics.biggestLoss.ticker} ‚Ä¢ {metrics.biggestLoss.exitDate || metrics.biggestLoss.entryDate}</p>
                </>
              ) : (
                <p className="text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-2 bg-emerald-100 rounded-lg text-emerald-600">{Icons.trendUp}</div>
                <p className="text-sm font-medium text-gray-500">Best Day</p>
              </div>
              {metrics.bestDay ? (
                <>
                  <p className="text-xl font-bold text-emerald-600">{formatCurrency(metrics.bestDay[1])}</p>
                  <p className="text-sm text-gray-500">{metrics.bestDay[0]}</p>
                </>
              ) : (
                <p className="text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
            <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
              <div className="flex items-center gap-2 mb-2">
                <div className="p-2 bg-red-100 rounded-lg text-red-600">{Icons.trendDown}</div>
                <p className="text-sm font-medium text-gray-500">Worst Day</p>
              </div>
              {metrics.worstDay ? (
                <>
                  <p className="text-xl font-bold text-red-600">{formatCurrency(metrics.worstDay[1])}</p>
                  <p className="text-sm text-gray-500">{metrics.worstDay[0]}</p>
                </>
              ) : (
                <p className="text-sm text-gray-400 italic">No trades yet</p>
              )}
            </div>
          </div>

          {/* Cumulative P&L Chart */}
          <SimpleLineChart 
            data={metrics.chartData} 
            onPointClick={(point) => {
              setSelectedDate(point.date);
              setActivePage('calendar');
            }}
          />

          {/* Setups Performance */}
          {metrics.setupAnalytics.some(s => s.totalTrades > 0) && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Setups Performance</h2>
                  <p className="text-xs text-gray-500 mt-0.5">Filtered by selected time range</p>
                </div>
                <button
                  onClick={() => setActivePage('setups')}
                  className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  View All ‚Üí
                </button>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Setup Charts */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Trade Count</h4>
                    <SimplePieChart data={metrics.setupAnalytics.filter(s => s.totalTrades > 0).map(s => ({ label: s.name, value: s.totalTrades }))} />
                  </div>
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Total P&L</h4>
                    <SimpleBarChart data={metrics.setupAnalytics.filter(s => s.totalTrades > 0).sort((a, b) => b.totalPnL - a.totalPnL).map(s => ({ label: s.name, value: s.totalPnL }))} />
                  </div>
                </div>

                {/* Setup Top Lists */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6 pt-6 border-t border-gray-100">
                  {/* Top Profit */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Top Profit</p>
                    {metrics.setupAnalytics.filter(s => s.totalPnL > 0).sort((a, b) => b.totalPnL - a.totalPnL).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-emerald-600">{formatCurrencyShort(s.totalPnL)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalPnL > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Top Loss */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Worst Loss</p>
                    {metrics.setupAnalytics.filter(s => s.totalPnL < 0).sort((a, b) => a.totalPnL - b.totalPnL).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-red-600">{formatCurrencyShort(s.totalPnL)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalPnL < 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Most Used */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Used</p>
                    {metrics.setupAnalytics.filter(s => s.totalTrades > 0).sort((a, b) => b.totalTrades - a.totalTrades).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-blue-600">{s.totalTrades}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.setupAnalytics.filter(s => s.totalTrades > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Best Win Rate */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Best Win Rate</p>
                    {metrics.setupAnalytics.filter(s => s.totalTrades >= 3).sort((a, b) => b.winRate - a.winRate).slice(0, 3).map((s, i) => (
                      <div key={s.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[80px]" title={s.name}>{i + 1}. {s.name}</span>
                        <span className="text-xs font-semibold text-amber-600">{s.winRate}%</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">Min 3 trades</p>}
                    {metrics.setupAnalytics.filter(s => s.totalTrades >= 3).length === 0 && <p className="text-xs text-gray-400 italic">Min 3 trades</p>}
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Mistakes Analysis */}
          {metrics.mistakeAnalytics.some(m => m.totalOccurrences > 0) && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Mistakes Analysis</h2>
                  <p className="text-xs text-gray-500 mt-0.5">Filtered by selected time range ‚Ä¢ Loss amounts only include losing trades</p>
                </div>
                <button
                  onClick={() => setActivePage('mistakes')}
                  className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                >
                  View All ‚Üí
                </button>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Mistake Charts */}
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Frequency</h4>
                    <SimplePieChart data={metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).sort((a, b) => b.totalOccurrences - a.totalOccurrences).map(m => ({ label: m.name, value: m.totalOccurrences }))} />
                  </div>
                  <div>
                    <h4 className="text-sm font-medium text-gray-700 mb-3">By Loss Amount (Losses Only)</h4>
                    {(() => {
                      const lossData = metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).sort((a, b) => a.totalLossAmount - b.totalLossAmount).map(m => ({ label: m.name, value: Math.abs(m.totalLossAmount) }));
                      if (lossData.length === 0) {
                        return <div className="h-32 flex items-center justify-center text-gray-400 text-sm">No loss data</div>;
                      }
                      const maxVal = Math.max(...lossData.map(d => d.value), 1);
                      return (
                        <div className="space-y-2">
                          {lossData.map((d, i) => (
                            <div key={i} className="flex items-center gap-2">
                              <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
                              <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                                <div className="h-full rounded bg-red-500" style={{ width: `${(d.value / maxVal) * 100}%` }} />
                              </div>
                              <span className="text-xs font-medium w-16 text-right text-red-600">-{formatCurrencyShort(d.value)}</span>
                            </div>
                          ))}
                        </div>
                      );
                    })()}
                  </div>
                </div>

                {/* Mistake Top Lists */}
                <div className="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-gray-100">
                  {/* Most Frequent */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Frequent</p>
                    {metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).sort((a, b) => b.totalOccurrences - a.totalOccurrences).slice(0, 3).map((m, i) => (
                      <div key={m.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[120px]" title={m.name}>{i + 1}. {m.name}</span>
                        <span className="text-xs font-semibold text-amber-600">{m.totalOccurrences}x</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.mistakeAnalytics.filter(m => m.totalOccurrences > 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                  {/* Most Costly */}
                  <div>
                    <p className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Most Costly</p>
                    {metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).sort((a, b) => a.totalLossAmount - b.totalLossAmount).slice(0, 3).map((m, i) => (
                      <div key={m.id} className="flex items-center justify-between py-1">
                        <span className="text-xs text-gray-600 truncate max-w-[120px]" title={m.name}>{i + 1}. {m.name}</span>
                        <span className="text-xs font-semibold text-red-600">{formatCurrencyShort(m.totalLossAmount)}</span>
                      </div>
                    )) || <p className="text-xs text-gray-400 italic">None</p>}
                    {metrics.mistakeAnalytics.filter(m => m.totalLossAmount < 0).length === 0 && <p className="text-xs text-gray-400 italic">None</p>}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // IMAGE MODAL COMPONENT
    // =============================================================================
    function ImageModal({ isOpen, onClose, src, title, trade, state, setState, getSetupName, getMistakeNames }) {
      const [notes, setNotes] = useState(trade?.notes || '');
      
      // Update notes when trade changes
      useEffect(() => {
        setNotes(trade?.notes || '');
      }, [trade]);

      if (!isOpen || !src) return null;

      const handleSaveNotes = () => {
        if (trade && setState) {
          setState(prev => ({
            ...prev,
            trades: prev.trades.map(t => 
              t.id === trade.id 
                ? { ...t, notes: notes, updatedAt: nowISO() }
                : t
            )
          }));
        }
        onClose();
      };

      // Calculate derived data if not already present
      const derivedTrade = trade ? { ...trade, derived: trade.derived || calcTradeDerived(trade) } : null;

      return (
        <div className="fixed inset-0 z-50 overflow-y-auto">
          <div className="fixed inset-0 bg-black/80" onClick={onClose} />
          <div className="relative min-h-screen flex items-center justify-center p-4">
            <div className="relative bg-white rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col">
              <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                <h3 className="text-sm font-semibold text-gray-900">{title}</h3>
                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                    <path d="M18 6L6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="flex flex-col lg:flex-row flex-1 overflow-hidden">
                {/* Screenshot */}
                <div className="flex-1 p-4 overflow-auto">
                  <img src={src} alt={title} className="w-full rounded-lg" />
                </div>
                {/* Trade Notes Panel */}
                {trade && setState && (
                  <div className="lg:w-96 border-t lg:border-t-0 lg:border-l border-gray-200 p-4 bg-gray-50 flex flex-col overflow-auto">
                    <h4 className="text-sm font-semibold text-gray-900 mb-3 flex-shrink-0">Trade Notes</h4>
                    <textarea
                      value={notes}
                      onChange={(e) => setNotes(e.target.value)}
                      placeholder="Add notes for this trade..."
                      className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 flex-shrink-0"
                      style={{ minHeight: '200px', resize: 'none' }}
                    />
                    <button
                      onClick={handleSaveNotes}
                      className="mt-2 w-full px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors flex-shrink-0"
                    >
                      Save Notes
                    </button>
                    {derivedTrade && (
                      <div className="mt-4 pt-4 border-t border-gray-200 space-y-2 flex-shrink-0">
                        <div className="flex justify-between text-sm">
                          <span className="text-gray-500">P&L</span>
                          <span className={`font-medium ${(derivedTrade.derived?.pnlFinal || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                            {formatCurrency(derivedTrade.derived?.pnlFinal)}
                          </span>
                        </div>
                        {getSetupName && (
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-500">Setup</span>
                            <span className="text-gray-900">{getSetupName(derivedTrade.setupId)}</span>
                          </div>
                        )}
                        {getMistakeNames && (
                          <div className="flex justify-between text-sm">
                            <span className="text-gray-500">Mistakes</span>
                            <span className="text-gray-900 text-right max-w-[150px]">{getMistakeNames(derivedTrade.mistakeIds)}</span>
                          </div>
                        )}
                        {derivedTrade.rating > 0 && (
                          <div className="flex justify-between text-sm items-center">
                            <span className="text-gray-500">Rating</span>
                            <StarRating value={derivedTrade.rating} readonly size="sm" />
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // NOTES MODAL COMPONENT
    // =============================================================================
    function NotesModal({ isOpen, onClose, notes, title }) {
      if (!isOpen || !notes) return null;

      // Calculate modal size based on notes length
      const getModalWidth = () => {
        if (notes.length < 200) return 'max-w-sm';
        if (notes.length < 500) return 'max-w-md';
        if (notes.length < 1000) return 'max-w-lg';
        return 'max-w-xl';
      };

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="fixed inset-0 bg-black/50" />
          <div 
            className={`relative ${getModalWidth()} w-full bg-white rounded-xl shadow-xl`} 
            onClick={(e) => e.stopPropagation()}
          >
            {/* Header */}
            <div className="flex items-center justify-between px-4 py-3 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">{title || 'Trade Notes'}</h3>
              <button
                onClick={onClose}
                className="p-1 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5 text-gray-500">
                  <path d="M18 6L6 18M6 6l12 12" />
                </svg>
              </button>
            </div>
            {/* Content */}
            <div className="p-4 max-h-[60vh] overflow-y-auto">
              <p className="text-gray-700 whitespace-pre-wrap text-sm leading-relaxed">{notes}</p>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // TRADE LOG PAGE
    // =============================================================================
    function TradeLogPage({ state, setState, isMobile }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingTrade, setEditingTrade] = useState(null);
      const [sortField, setSortField] = useState('entryDate');
      const [sortDir, setSortDir] = useState('desc');
      const [imageModalOpen, setImageModalOpen] = useState(false);
      const [imageModalData, setImageModalData] = useState({ src: null, title: '' });
      const [notesModalOpen, setNotesModalOpen] = useState(false);
      const [notesModalData, setNotesModalData] = useState({ notes: '', title: '' });
      const [showFilters, setShowFilters] = useState(false);
      
      // Filter state
      const [filters, setFilters] = useState({
        dateStart: '',
        dateEnd: '',
        tickers: [], // Changed to array for multi-select
        assetTypes: [], // Changed to array for multi-select
        positionTypes: [], // Changed to array for multi-select
        setupIds: [], // Changed to array for multi-select
        mistakeIds: [], // Changed to array for multi-select
        ratings: [], // Array for multi-select ratings
        results: [], // Array for multi-select results (W, L, BE, open)
      });

      // Track which dropdowns are open
      const [openDropdown, setOpenDropdown] = useState(null);

      // Get unique tickers for filter dropdown
      const uniqueTickers = useMemo(() => {
        return [...new Set(state.trades.map(t => t.ticker))].sort();
      }, [state.trades]);

      // Filter and sort trades
      const filteredTrades = useMemo(() => {
        return state.trades
          .map(t => ({ ...t, derived: calcTradeDerived(t) }))
          .filter(t => {
            // Date range filter
            if (filters.dateStart && t.entryDate < filters.dateStart) return false;
            if (filters.dateEnd && t.entryDate > filters.dateEnd) return false;
            
            // Ticker filter (multi-select)
            if (filters.tickers.length > 0 && !filters.tickers.includes(t.ticker)) return false;
            
            // Asset type filter (multi-select)
            if (filters.assetTypes.length > 0 && !filters.assetTypes.includes(t.assetType)) return false;
            
            // Position type filter (multi-select)
            if (filters.positionTypes.length > 0 && !filters.positionTypes.includes(t.positionType)) return false;
            
            // Setup filter (multi-select)
            if (filters.setupIds.length > 0 && !filters.setupIds.includes(t.setupId)) return false;
            
            // Mistake filter (multi-select) - trade must have at least one of the selected mistakes
            if (filters.mistakeIds.length > 0 && !t.mistakeIds.some(id => filters.mistakeIds.includes(id))) return false;
            
            // Rating filter (multi-select)
            if (filters.ratings.length > 0 && !filters.ratings.includes(t.rating || 0)) return false;
            
            // Result filter (multi-select)
            if (filters.results.length > 0) {
              const tradeResult = t.derived.isOpen ? 'open' : t.derived.winLoss;
              if (!filters.results.includes(tradeResult)) return false;
            }
            
            return true;
          })
          .sort((a, b) => {
            let aVal, bVal;
            
            switch (sortField) {
              case 'entryDate':
                aVal = a.entryDate || '';
                bVal = b.entryDate || '';
                break;
              case 'exitDate':
                aVal = a.exitDate || '';
                bVal = b.exitDate || '';
                break;
              case 'ticker':
                aVal = a.ticker || '';
                bVal = b.ticker || '';
                break;
              case 'assetType':
                aVal = a.assetType || '';
                bVal = b.assetType || '';
                break;
              case 'positionType':
                aVal = a.positionType || '';
                bVal = b.positionType || '';
                break;
              case 'positionSize':
                aVal = a.positionSize || 0;
                bVal = b.positionSize || 0;
                break;
              case 'entryPrice':
                aVal = a.entryPrice || 0;
                bVal = b.entryPrice || 0;
                break;
              case 'exitPrice':
                aVal = a.exitPrice || 0;
                bVal = b.exitPrice || 0;
                break;
              case 'length':
                aVal = a.derived.lengthDays || 0;
                bVal = b.derived.lengthDays || 0;
                break;
              case 'pnl':
                aVal = a.derived.pnlFinal || 0;
                bVal = b.derived.pnlFinal || 0;
                break;
              case 'rating':
                aVal = a.rating || 0;
                bVal = b.rating || 0;
                break;
              case 'setup':
                const setupA = state.setups.find(s => s.id === a.setupId);
                const setupB = state.setups.find(s => s.id === b.setupId);
                aVal = setupA?.name || '';
                bVal = setupB?.name || '';
                break;
              case 'mistakes':
                aVal = a.mistakeIds.length;
                bVal = b.mistakeIds.length;
                break;
              default:
                aVal = a.entryDate || '';
                bVal = b.entryDate || '';
            }
            
            if (sortDir === 'asc') {
              return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
            }
            return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
          });
      }, [state.trades, state.setups, filters, sortField, sortDir]);

      // Calculate summary stats for filtered trades
      const summaryStats = useMemo(() => {
        const closedTrades = filteredTrades.filter(t => !t.derived.isOpen);
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const grossProfit = wins.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const grossLoss = Math.abs(losses.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0));
        
        const winRate = closedTrades.length > 0 ? ((wins.length / closedTrades.length) * 100).toFixed(1) : 0;
        const profitFactor = grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : grossProfit > 0 ? '‚àû' : '0.00';
        const avgTrade = closedTrades.length > 0 ? totalPnL / closedTrades.length : 0;
        
        const avgWin = wins.length > 0 ? grossProfit / wins.length : 0;
        const avgLoss = losses.length > 0 ? grossLoss / losses.length : 0;
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';
        
        // Best and worst trades
        const bestTrade = closedTrades.length > 0
          ? closedTrades.reduce((best, t) => (t.derived.pnlFinal || 0) > (best.derived.pnlFinal || 0) ? t : best, closedTrades[0])
          : null;
        const worstTrade = closedTrades.length > 0
          ? closedTrades.reduce((worst, t) => (t.derived.pnlFinal || 0) < (worst.derived.pnlFinal || 0) ? t : worst, closedTrades[0])
          : null;
        
        // Top ticker by P&L
        const pnlByTicker = {};
        closedTrades.forEach(t => {
          if (!pnlByTicker[t.ticker]) pnlByTicker[t.ticker] = { pnl: 0, count: 0 };
          pnlByTicker[t.ticker].pnl += t.derived.pnlFinal || 0;
          pnlByTicker[t.ticker].count++;
        });
        const topTicker = Object.entries(pnlByTicker)
          .sort((a, b) => b[1].pnl - a[1].pnl)[0];
        
        // Top setup by P&L
        const pnlBySetup = {};
        closedTrades.forEach(t => {
          if (!t.setupId) return;
          const setup = state.setups.find(s => s.id === t.setupId);
          if (!setup) return;
          if (!pnlBySetup[setup.id]) pnlBySetup[setup.id] = { name: setup.name, pnl: 0, count: 0 };
          pnlBySetup[setup.id].pnl += t.derived.pnlFinal || 0;
          pnlBySetup[setup.id].count++;
        });
        const topSetup = Object.values(pnlBySetup)
          .sort((a, b) => b.pnl - a.pnl)[0];
        
        // Average rating
        const ratedTrades = closedTrades.filter(t => t.rating && t.rating > 0);
        const avgRating = ratedTrades.length > 0
          ? ratedTrades.reduce((sum, t) => sum + t.rating, 0) / ratedTrades.length
          : 0;
        
        // Average hold time
        const tradesWithLength = closedTrades.filter(t => t.derived.lengthDays !== null);
        const avgHoldDays = tradesWithLength.length > 0
          ? tradesWithLength.reduce((sum, t) => sum + t.derived.lengthDays, 0) / tradesWithLength.length
          : 0;
        
        return {
          total: filteredTrades.length,
          closedCount: closedTrades.length,
          openCount: filteredTrades.length - closedTrades.length,
          totalPnL,
          wins: wins.length,
          losses: losses.length,
          winRate,
          profitFactor,
          avgTrade,
          avgWin,
          avgLoss,
          riskRewardRatio,
          bestTrade,
          worstTrade,
          topTicker: topTicker ? { ticker: topTicker[0], pnl: topTicker[1].pnl, count: topTicker[1].count } : null,
          topSetup,
          avgRating,
          ratedCount: ratedTrades.length,
          avgHoldDays,
        };
      }, [filteredTrades, state.setups]);

      const handleSort = (field) => {
        if (sortField === field) {
          setSortDir(prev => prev === 'asc' ? 'desc' : 'asc');
        } else {
          setSortField(field);
          setSortDir('desc');
        }
      };

      const handleFilterChange = (field, value) => {
        setFilters(prev => ({ ...prev, [field]: value }));
      };

      const resetFilters = () => {
        setFilters({
          dateStart: '',
          dateEnd: '',
          tickers: [],
          assetTypes: [],
          positionTypes: [],
          setupIds: [],
          mistakeIds: [],
          ratings: [],
          results: [],
        });
        setOpenDropdown(null);
      };

      const hasActiveFilters = 
        filters.dateStart !== '' ||
        filters.dateEnd !== '' ||
        filters.tickers.length > 0 ||
        filters.assetTypes.length > 0 ||
        filters.positionTypes.length > 0 ||
        filters.setupIds.length > 0 ||
        filters.mistakeIds.length > 0 ||
        filters.ratings.length > 0 ||
        filters.results.length > 0;

      // Toggle item in array filter
      const toggleFilterItem = (field, value) => {
        setFilters(prev => {
          const arr = prev[field];
          if (arr.includes(value)) {
            return { ...prev, [field]: arr.filter(v => v !== value) };
          }
          return { ...prev, [field]: [...arr, value] };
        });
      };

      // Multi-select dropdown component
      const MultiSelectDropdown = ({ label, field, options, renderOption }) => {
        const isOpen = openDropdown === field;
        const selected = filters[field];
        
        return (
          <div className="relative" data-dropdown="true">
            <label className="block text-xs font-medium text-gray-500 mb-1">{label}</label>
            <button
              type="button"
              onClick={(e) => {
                e.stopPropagation();
                setOpenDropdown(isOpen ? null : field);
              }}
              className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[100px] bg-white text-left flex items-center justify-between gap-2"
            >
              <span className={selected.length === 0 ? 'text-gray-500' : 'text-gray-900'}>
                {selected.length === 0 ? 'All' : `${selected.length} selected`}
              </span>
              <svg className="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
              </svg>
            </button>
            {isOpen && (
              <div 
                className="absolute z-20 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-auto"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="p-2 border-b border-gray-100">
                  <button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      setFilters(prev => ({ ...prev, [field]: [] }));
                    }}
                    className="text-xs text-blue-600 hover:text-blue-800"
                  >
                    Clear all
                  </button>
                </div>
                {options.map((option, idx) => (
                  <label
                    key={idx}
                    className="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <input
                      type="checkbox"
                      checked={selected.includes(option.value)}
                      onChange={(e) => {
                        e.stopPropagation();
                        toggleFilterItem(field, option.value);
                      }}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                    <span className="text-sm text-gray-700">{renderOption ? renderOption(option) : option.label}</span>
                  </label>
                ))}
              </div>
            )}
          </div>
        );
      };

      const openAddModal = () => {
        setEditingTrade(null);
        setModalOpen(true);
      };

      const openEditModal = (trade) => {
        setEditingTrade(trade);
        setModalOpen(true);
      };

      const openImageModal = (src, title, trade) => {
        setImageModalData({ src, title, trade });
        setImageModalOpen(true);
      };

      const openNotesModal = (notes, title) => {
        setNotesModalData({ notes, title });
        setNotesModalOpen(true);
      };

      // Helper to get setup name
      const getSetupName = (setupId) => {
        if (!setupId) return '-';
        const setup = state.setups.find(s => s.id === setupId);
        return setup?.name || '-';
      };

      // Helper to get mistake names
      const getMistakeNames = (mistakeIds) => {
        if (!mistakeIds || mistakeIds.length === 0) return '-';
        return mistakeIds
          .map(id => state.mistakes.find(m => m.id === id)?.name)
          .filter(Boolean)
          .join(', ') || '-';
      };

      // Sort indicator
      const SortIndicator = ({ field }) => {
        if (sortField !== field) return <span className="text-gray-300 ml-1">‚Üï</span>;
        return <span className="text-blue-600 ml-1">{sortDir === 'asc' ? '‚Üë' : '‚Üì'}</span>;
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <h1 className="text-xl md:text-2xl font-bold text-gray-900">Trade Log</h1>
            <button
              onClick={openAddModal}
              className="flex items-center gap-1 md:gap-2 px-3 md:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm"
            >
              {Icons.plus}
              <span className="hidden sm:inline">Add Trade</span>
              <span className="sm:hidden">Add</span>
            </button>
          </div>

          {/* Filters Toolbar */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4" onClick={(e) => {
            // Close dropdowns when clicking outside
            if (!e.target.closest('[data-dropdown]')) setOpenDropdown(null);
          }}>
            <div className="flex flex-wrap items-end gap-3">
              {/* Date Range */}
              <div className="flex gap-2 items-end">
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">From</label>
                  <input
                    type="date"
                    value={filters.dateStart}
                    onChange={(e) => handleFilterChange('dateStart', e.target.value)}
                    className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-500 mb-1">To</label>
                  <input
                    type="date"
                    value={filters.dateEnd}
                    onChange={(e) => handleFilterChange('dateEnd', e.target.value)}
                    className="px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </div>

              {/* Ticker - Multi-select */}
              <MultiSelectDropdown
                label="Ticker"
                field="tickers"
                options={uniqueTickers.map(t => ({ value: t, label: t }))}
              />

              {/* Asset Type - Multi-select */}
              <MultiSelectDropdown
                label="Asset"
                field="assetTypes"
                options={ASSET_TYPES.map(t => ({ value: t.id, label: t.label }))}
              />

              {/* Position Type - Multi-select */}
              <MultiSelectDropdown
                label="Position"
                field="positionTypes"
                options={POSITION_TYPES.map(t => ({ value: t.id, label: t.label }))}
              />

              {/* Setup - Multi-select */}
              <MultiSelectDropdown
                label="Setup"
                field="setupIds"
                options={state.setups.map(s => ({ value: s.id, label: s.name }))}
              />

              {/* Mistake - Multi-select */}
              <MultiSelectDropdown
                label="Mistake"
                field="mistakeIds"
                options={state.mistakes.map(m => ({ value: m.id, label: m.name }))}
              />

              {/* Rating - Multi-select */}
              <MultiSelectDropdown
                label="Rating"
                field="ratings"
                options={[
                  { value: 0, label: '‚òÜ No Rating' },
                  { value: 1, label: '‚òÖ 1 Star' },
                  { value: 2, label: '‚òÖ‚òÖ 2 Stars' },
                  { value: 3, label: '‚òÖ‚òÖ‚òÖ 3 Stars' },
                  { value: 4, label: '‚òÖ‚òÖ‚òÖ‚òÖ 4 Stars' },
                  { value: 5, label: '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ 5 Stars' },
                ]}
              />

              {/* Result - Multi-select */}
              <MultiSelectDropdown
                label="Result"
                field="results"
                options={[
                  { value: 'W', label: 'Win' },
                  { value: 'L', label: 'Loss' },
                  { value: 'BE', label: 'Break-even' },
                  { value: 'open', label: 'Open' },
                ]}
              />

              {/* Reset Button */}
              {hasActiveFilters && (
                <button
                  onClick={resetFilters}
                  className="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors"
                >
                  Reset Filters
                </button>
              )}
            </div>

            {/* Summary Stats */}
            <div className="mt-4 pt-4 border-t border-gray-100">
              <div className="flex items-center justify-between mb-3">
                <span className="text-sm text-gray-500">
                  Showing <span className="font-semibold text-gray-900">{summaryStats.total}</span> trades
                  {summaryStats.openCount > 0 && (
                    <span className="text-gray-400"> ({summaryStats.openCount} open)</span>
                  )}
                </span>
              </div>
              
              {/* Row 1: Core Metrics */}
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 mb-2">
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Total P&L</p>
                  <p className={`text-lg font-bold ${summaryStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(summaryStats.totalPnL)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Win Rate</p>
                  <p className="text-lg font-bold text-gray-900">{summaryStats.winRate}%</p>
                  <p className="text-[10px] text-gray-500">
                    <span className="text-emerald-600">{summaryStats.wins}W</span> / <span className="text-red-600">{summaryStats.losses}L</span>
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Profit Factor</p>
                  <p className={`text-lg font-bold ${parseFloat(summaryStats.profitFactor) >= 1 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {summaryStats.profitFactor}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">Avg Trade</p>
                  <p className={`text-lg font-bold ${summaryStats.avgTrade >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(summaryStats.avgTrade)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-gray-500 mb-1">R:R Ratio</p>
                  <p className="text-lg font-bold text-gray-900">{summaryStats.riskRewardRatio}:1</p>
                  <p className="text-[10px] text-gray-500 truncate">
                    {formatCurrencyShort(summaryStats.avgWin)}/{formatCurrencyShort(summaryStats.avgLoss)}
                  </p>
                </div>
              </div>
              
              {/* Row 2: Insights */}
              <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                <div className="bg-emerald-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-emerald-700 mb-1">Best Trade</p>
                  {summaryStats.bestTrade ? (
                    <>
                      <p className="text-lg font-bold text-emerald-600">{formatCurrencyShort(summaryStats.bestTrade.derived.pnlFinal)}</p>
                      <p className="text-[10px] text-emerald-700 truncate">{summaryStats.bestTrade.ticker}</p>
                    </>
                  ) : (
                    <p className="text-sm text-emerald-400">-</p>
                  )}
                </div>
                <div className="bg-red-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-red-700 mb-1">Worst Trade</p>
                  {summaryStats.worstTrade ? (
                    <>
                      <p className="text-lg font-bold text-red-600">{formatCurrencyShort(summaryStats.worstTrade.derived.pnlFinal)}</p>
                      <p className="text-[10px] text-red-700 truncate">{summaryStats.worstTrade.ticker}</p>
                    </>
                  ) : (
                    <p className="text-sm text-red-400">-</p>
                  )}
                </div>
                <div className="bg-blue-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-blue-700 mb-1">Top Ticker</p>
                  {summaryStats.topTicker ? (
                    <>
                      <p className="text-lg font-bold text-blue-600">{summaryStats.topTicker.ticker}</p>
                      <p className="text-[10px] text-blue-700 truncate">
                        {formatCurrencyShort(summaryStats.topTicker.pnl)} ({summaryStats.topTicker.count})
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-blue-400">-</p>
                  )}
                </div>
                <div className="bg-purple-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-purple-700 mb-1">Top Setup</p>
                  {summaryStats.topSetup ? (
                    <>
                      <p className="text-sm font-bold text-purple-600 truncate">{summaryStats.topSetup.name}</p>
                      <p className="text-[10px] text-purple-700 truncate">
                        {formatCurrencyShort(summaryStats.topSetup.pnl)} ({summaryStats.topSetup.count})
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-purple-400">-</p>
                  )}
                </div>
                <div className="bg-amber-50 rounded-lg p-3">
                  <p className="text-[10px] font-medium text-amber-700 mb-1">Avg Rating</p>
                  {summaryStats.ratedCount > 0 ? (
                    <>
                      <div className="flex items-center gap-1">
                        <p className="text-lg font-bold text-amber-600">{summaryStats.avgRating.toFixed(1)}</p>
                        <span className="text-amber-500">‚òÖ</span>
                      </div>
                      <p className="text-[10px] text-amber-700">{summaryStats.ratedCount} rated</p>
                    </>
                  ) : (
                    <p className="text-sm text-amber-400">No ratings</p>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Trades Table */}
          {filteredTrades.length === 0 ? (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
              <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                {Icons.tradelog}
              </div>
              <h3 className="text-lg font-medium text-gray-900 mb-2">
                {state.trades.length === 0 ? 'No trades yet' : 'No trades match filters'}
              </h3>
              <p className="text-gray-500 mb-4">
                {state.trades.length === 0 
                  ? 'Start tracking your trades to see your performance.'
                  : 'Try adjusting your filters to see more trades.'}
              </p>
              {state.trades.length === 0 ? (
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Trade</span>
                </button>
              ) : (
                <button
                  onClick={resetFilters}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors font-medium"
                >
                  Reset Filters
                </button>
              )}
            </div>
          ) : (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50 border-b border-gray-200">
                    <tr>
                      <th 
                        onClick={() => handleSort('entryDate')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Entry Date <SortIndicator field="entryDate" />
                      </th>
                      <th 
                        onClick={() => handleSort('ticker')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Ticker <SortIndicator field="ticker" />
                      </th>
                      <th 
                        onClick={() => handleSort('assetType')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Asset <SortIndicator field="assetType" />
                      </th>
                      <th 
                        onClick={() => handleSort('positionType')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Type <SortIndicator field="positionType" />
                      </th>
                      <th 
                        onClick={() => handleSort('positionSize')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Size <SortIndicator field="positionSize" />
                      </th>
                      <th 
                        onClick={() => handleSort('entryPrice')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Entry <SortIndicator field="entryPrice" />
                      </th>
                      <th 
                        onClick={() => handleSort('exitDate')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Exit Date <SortIndicator field="exitDate" />
                      </th>
                      <th 
                        onClick={() => handleSort('exitPrice')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Exit <SortIndicator field="exitPrice" />
                      </th>
                      <th 
                        onClick={() => handleSort('length')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Length <SortIndicator field="length" />
                      </th>
                      <th 
                        onClick={() => handleSort('pnl')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        P&L <SortIndicator field="pnl" />
                      </th>
                      <th 
                        onClick={() => handleSort('rating')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Rating <SortIndicator field="rating" />
                      </th>
                      <th 
                        onClick={() => handleSort('setup')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Setup <SortIndicator field="setup" />
                      </th>
                      <th 
                        onClick={() => handleSort('mistakes')}
                        className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 whitespace-nowrap"
                      >
                        Mistakes <SortIndicator field="mistakes" />
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        Notes
                      </th>
                      <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        Screenshot
                      </th>
                      <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredTrades.map(trade => (
                      <tr key={trade.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">{trade.entryDate}</td>
                        <td className="px-4 py-3 text-sm font-medium text-gray-900 whitespace-nowrap">{trade.ticker}</td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {ASSET_TYPES.find(a => a.id === trade.assetType)?.label || trade.assetType}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                            trade.positionType === 'long' 
                              ? 'bg-emerald-100 text-emerald-700' 
                              : 'bg-red-100 text-red-700'
                          }`}>
                            {trade.positionType.toUpperCase()}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">{trade.positionSize}</td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.entryPrice != null ? `$${trade.entryPrice.toFixed(2)}` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.exitDate || '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.exitPrice != null ? `$${trade.exitPrice.toFixed(2)}` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap">
                          {trade.derived.lengthDays != null ? `${trade.derived.lengthDays} days` : '-'}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          {trade.derived.isOpen ? (
                            <span className="text-gray-400">Open</span>
                          ) : (
                            <span className={`font-medium ${trade.derived.pnlFinal >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                              {formatCurrency(trade.derived.pnlFinal)}
                              {trade.derived.pnlMismatch && (
                                <span className="ml-1 text-amber-500" title="Manual P&L differs from calculated">‚ö†</span>
                              )}
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          <StarRating value={trade.rating || 0} readonly size="sm" />
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap max-w-[150px] truncate" title={getSetupName(trade.setupId)}>
                          {getSetupName(trade.setupId)}
                        </td>
                        <td className="px-4 py-3 text-sm text-gray-600 whitespace-nowrap max-w-[150px] truncate" title={getMistakeNames(trade.mistakeIds)}>
                          {getMistakeNames(trade.mistakeIds)}
                        </td>
                        <td className="px-4 py-3 text-sm whitespace-nowrap">
                          {trade.notes ? (
                            <button
                              onClick={() => openNotesModal(trade.notes, `${trade.ticker} - ${trade.entryDate}`)}
                              className="text-left max-w-[150px] hover:bg-gray-100 rounded px-2 py-1 -mx-2 -my-1 transition-colors group"
                              title="Click to expand"
                            >
                              <p className="text-gray-600 truncate text-xs leading-relaxed" style={{ display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden', whiteSpace: 'normal' }}>
                                {trade.notes}
                              </p>
                              {trade.notes.length > 50 && (
                                <span className="text-blue-500 text-xs group-hover:underline">more...</span>
                              )}
                            </button>
                          ) : (
                            <span className="text-gray-300">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-center whitespace-nowrap">
                          {trade.screenshot ? (
                            <button
                              onClick={() => openImageModal(trade.screenshot, `${trade.ticker} - ${trade.entryDate}`, trade)}
                              className="inline-block hover:opacity-80 transition-opacity"
                              title="Click to expand"
                            >
                              <img 
                                src={trade.screenshot} 
                                alt="Screenshot" 
                                className="w-12 h-12 object-cover rounded border border-gray-200 hover:border-blue-400 transition-colors"
                              />
                            </button>
                          ) : (
                            <span className="text-gray-300">-</span>
                          )}
                        </td>
                        <td className="px-4 py-3 text-right whitespace-nowrap">
                          <button
                            onClick={() => openEditModal(trade)}
                            className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                            title="Edit trade"
                          >
                            {Icons.edit}
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          <TradeModal
            isOpen={modalOpen}
            onClose={() => setModalOpen(false)}
            trade={editingTrade}
            state={state}
            setState={setState}
          />

          <ImageModal
            isOpen={imageModalOpen}
            onClose={() => setImageModalOpen(false)}
            src={imageModalData.src}
            title={imageModalData.title}
            trade={imageModalData.trade}
            state={state}
            setState={setState}
            getSetupName={getSetupName}
            getMistakeNames={getMistakeNames}
          />

          <NotesModal
            isOpen={notesModalOpen}
            onClose={() => setNotesModalOpen(false)}
            notes={notesModalData.notes}
            title={notesModalData.title}
          />
        </div>
      );
    }

    // =============================================================================
    // OTHER PAGE PLACEHOLDERS
    // =============================================================================
    // =============================================================================
    // SIMPLE PIE CHART COMPONENT
    // =============================================================================
    function SimplePieChart({ data, title }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-48 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const total = data.reduce((sum, d) => sum + Math.abs(d.value), 0);
      if (total === 0) {
        return (
          <div className="h-48 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
      let currentAngle = 0;

      const slices = data.map((d, i) => {
        const percentage = Math.abs(d.value) / total;
        const angle = percentage * 360;
        const startAngle = currentAngle;
        const endAngle = currentAngle + angle;
        currentAngle = endAngle;

        const startRad = (startAngle - 90) * (Math.PI / 180);
        const endRad = (endAngle - 90) * (Math.PI / 180);

        const x1 = 50 + 40 * Math.cos(startRad);
        const y1 = 50 + 40 * Math.sin(startRad);
        const x2 = 50 + 40 * Math.cos(endRad);
        const y2 = 50 + 40 * Math.sin(endRad);

        const largeArc = angle > 180 ? 1 : 0;

        const pathD = `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArc} 1 ${x2} ${y2} Z`;

        return {
          ...d,
          path: pathD,
          color: colors[i % colors.length],
          percentage: (percentage * 100).toFixed(1),
        };
      });

      return (
        <div className="flex items-center gap-4">
          <svg viewBox="0 0 100 100" className="w-32 h-32">
            {slices.map((slice, i) => (
              <path key={i} d={slice.path} fill={slice.color} stroke="white" strokeWidth="1" />
            ))}
          </svg>
          <div className="flex-1 space-y-1">
            {slices.map((slice, i) => (
              <div key={i} className="flex items-center gap-2 text-xs">
                <div className="w-3 h-3 rounded" style={{ backgroundColor: slice.color }} />
                <span className="text-gray-600">{slice.label}</span>
                <span className="text-gray-400 ml-auto">{slice.percentage}%</span>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // =============================================================================
    // SIMPLE BAR CHART COMPONENT
    // =============================================================================
    function SimpleBarChart({ data, title, showValues = true }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
            No data
          </div>
        );
      }

      const maxVal = Math.max(...data.map(d => Math.abs(d.value)), 1);

      return (
        <div className="space-y-2">
          {data.map((d, i) => (
            <div key={i} className="flex items-center gap-2">
              <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
              <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                <div
                  className={`h-full rounded ${d.value >= 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                  style={{ width: `${(Math.abs(d.value) / maxVal) * 100}%` }}
                />
              </div>
              {showValues && (
                <span className={`text-xs font-medium w-16 text-right ${d.value >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                  {formatCurrency(d.value)}
                </span>
              )}
            </div>
          ))}
        </div>
      );
    }

    // =============================================================================
    // SETUP SUCCESS BAR CHART
    // =============================================================================
    function SetupBarChart({ data }) {
      if (!data || data.length === 0) {
        return (
          <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
            No setups used
          </div>
        );
      }

      return (
        <div className="space-y-3">
          {data.map((d, i) => (
            <div key={i}>
              <div className="flex items-center justify-between text-xs mb-1">
                <span className="text-gray-700 font-medium">{d.name}</span>
                <span className="text-gray-500">{d.wins}W / {d.losses}L ({d.winRate}%)</span>
              </div>
              <div className="h-4 bg-gray-100 rounded overflow-hidden flex">
                {d.wins > 0 && (
                  <div
                    className="h-full bg-emerald-500"
                    style={{ width: `${(d.wins / d.total) * 100}%` }}
                  />
                )}
                {d.losses > 0 && (
                  <div
                    className="h-full bg-red-500"
                    style={{ width: `${(d.losses / d.total) * 100}%` }}
                  />
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // =============================================================================
    // CALENDAR PAGE
    // =============================================================================
    function CalendarPage({ state, setState, selectedDate, setSelectedDate, isMobile }) {
      const [viewDate, setViewDate] = useState(() => {
        if (selectedDate) {
          const [year, month] = selectedDate.split('-');
          return { year: parseInt(year), month: parseInt(month) - 1 };
        }
        const now = new Date();
        return { year: now.getFullYear(), month: now.getMonth() };
      });
      const [modalOpen, setModalOpen] = useState(false);
      const [editingTrade, setEditingTrade] = useState(null);
      const [dailyNote, setDailyNote] = useState('');
      const [imageModalOpen, setImageModalOpen] = useState(false);
      const [imageModalData, setImageModalData] = useState({ src: null, title: '' });

      // Get all trades with derived data
      const allTradesWithDerived = useMemo(() => {
        return state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) }));
      }, [state.trades]);

      // Calculate daily stats for the entire dataset (for averages)
      const overallStats = useMemo(() => {
        const closedTrades = allTradesWithDerived.filter(t => !t.derived.isOpen);
        const dailyPnL = {};
        const dailyTradeCount = {};
        
        closedTrades.forEach(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          if (!dailyPnL[date]) dailyPnL[date] = 0;
          if (!dailyTradeCount[date]) dailyTradeCount[date] = 0;
          dailyPnL[date] += t.derived.pnlFinal || 0;
          dailyTradeCount[date]++;
        });

        const days = Object.values(dailyPnL);
        const tradeCounts = Object.values(dailyTradeCount);
        const avgDailyPnL = days.length > 0 ? days.reduce((a, b) => a + b, 0) / days.length : 0;
        const avgDailyTrades = tradeCounts.length > 0 ? tradeCounts.reduce((a, b) => a + b, 0) / tradeCounts.length : 0;
        
        return { avgDailyPnL, avgDailyTrades, tradingDays: days.length };
      }, [allTradesWithDerived]);

      // Goal progress calculation for calendar (based on yearly goal)
      const goalProgress = useMemo(() => {
        const now = new Date();
        const currentYear = now.getFullYear();
        const TRADING_DAYS_PER_YEAR = 252;
        
        // Check for yearly goal
        const yearlyGoal = state.yearlyGoal;
        if (!yearlyGoal || yearlyGoal.year !== currentYear) return null;
        
        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        // Calculate year P&L and build cumulative by date
        const yearTrades = allTradesWithDerived
          .filter(t => {
            if (t.derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .sort((a, b) => {
            const dateA = a.exitDate || a.entryDate;
            const dateB = b.exitDate || b.entryDate;
            return dateA.localeCompare(dateB);
          });
        
        // Build cumulative P&L by date
        const cumulativeByDate = {};
        let runningTotal = 0;
        yearTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          runningTotal += t.derived.pnlFinal || 0;
          cumulativeByDate[date] = runningTotal;
        });
        
        const yearPnL = runningTotal;
        const progress = yearlyGoal.target > 0 ? (yearPnL / yearlyGoal.target) * 100 : 0;
        
        // Calculate daily target (based on 252 trading days)
        const dailyTarget = yearlyGoal.target / TRADING_DAYS_PER_YEAR;
        
        // Build pace line data for calendar
        const paceByDate = {};
        let dayCount = 0;
        const endOfYear = new Date(currentYear, 11, 31);
        for (let d = new Date(currentYear, 0, 1); d <= endOfYear; d.setDate(d.getDate() + 1)) {
          const day = d.getDay();
          if (day !== 0 && day !== 6) { // Skip weekends for trading days
            dayCount++;
            const dateStr = d.toISOString().split('T')[0];
            paceByDate[dateStr] = dailyTarget * dayCount;
          }
        }
        
        return {
          goal: yearlyGoal,
          yearPnL,
          progress: Math.min(progress, 100),
          dailyTarget,
          cumulativeByDate,
          paceByDate,
          yearStartStr: yearStart,
          yearEndStr: yearEnd,
          yearLabel: `${currentYear}`,
        };
      }, [state.yearlyGoal, allTradesWithDerived]);

      // Calculate calendar data
      const calendarData = useMemo(() => {
        const { year, month } = viewDate;
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        // Get daily stats
        const dailyStats = {};
        allTradesWithDerived.forEach(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          if (!date) return;
          
          if (!dailyStats[date]) {
            dailyStats[date] = { pnl: 0, trades: 0, wins: 0, losses: 0 };
          }
          dailyStats[date].trades++;
          if (!t.derived.isOpen) {
            dailyStats[date].pnl += t.derived.pnlFinal || 0;
            if (t.derived.winLoss === 'W') dailyStats[date].wins++;
            if (t.derived.winLoss === 'L') dailyStats[date].losses++;
          }
        });

        const days = [];
        
        // Empty cells before month starts
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push({ day: null });
        }

        // Days of the month
        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const stats = dailyStats[dateStr] || { pnl: 0, trades: 0, wins: 0, losses: 0 };
          days.push({
            day: d,
            date: dateStr,
            ...stats,
            hasNote: !!state.dailyNotes[dateStr],
          });
        }

        return {
          year,
          month,
          monthName: firstDay.toLocaleString('default', { month: 'long' }),
          days,
        };
      }, [viewDate, allTradesWithDerived, state.dailyNotes]);

      // Get trades for selected date
      const selectedDateTrades = useMemo(() => {
        if (!selectedDate) return [];
        return allTradesWithDerived.filter(t => {
          const date = (t.exitDate && t.exitDate !== '') ? t.exitDate : t.entryDate;
          return date === selectedDate;
        });
      }, [selectedDate, allTradesWithDerived]);

      // Calculate stats for selected date
      const selectedDateStats = useMemo(() => {
        if (!selectedDate || selectedDateTrades.length === 0) {
          return null;
        }

        const closedTrades = selectedDateTrades.filter(t => !t.derived.isOpen);
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        const winRate = closedTrades.length > 0 ? ((wins.length / closedTrades.length) * 100).toFixed(1) : 0;

        // Best trade
        const bestTrade = closedTrades.length > 0
          ? closedTrades.reduce((best, t) => (t.derived.pnlFinal || 0) > (best.derived.pnlFinal || 0) ? t : best, closedTrades[0])
          : null;

        // P&L by Asset Type
        const pnlByAsset = {};
        closedTrades.forEach(t => {
          const asset = ASSET_TYPES.find(a => a.id === t.assetType)?.label || t.assetType;
          if (!pnlByAsset[asset]) pnlByAsset[asset] = 0;
          pnlByAsset[asset] += t.derived.pnlFinal || 0;
        });
        const assetPieData = Object.entries(pnlByAsset).map(([label, value]) => ({ label, value }));

        // P&L by Ticker
        const pnlByTicker = {};
        closedTrades.forEach(t => {
          if (!pnlByTicker[t.ticker]) pnlByTicker[t.ticker] = 0;
          pnlByTicker[t.ticker] += t.derived.pnlFinal || 0;
        });
        const tickerPnLData = Object.entries(pnlByTicker)
          .map(([label, value]) => ({ label, value }))
          .sort((a, b) => b.value - a.value); // Sort by P&L descending (best first)

        // Individual trade P&L (for bar chart)
        const tradePnLData = closedTrades.map(t => ({
          label: t.ticker,
          value: t.derived.pnlFinal || 0,
        }));

        // Setup usage and success
        const setupStats = {};
        closedTrades.forEach(t => {
          if (!t.setupId) return;
          const setup = state.setups.find(s => s.id === t.setupId);
          if (!setup) return;
          
          if (!setupStats[setup.id]) {
            setupStats[setup.id] = { id: setup.id, name: setup.name, wins: 0, losses: 0, total: 0, totalPnL: 0 };
          }
          setupStats[setup.id].total++;
          setupStats[setup.id].totalPnL += t.derived.pnlFinal || 0;
          if (t.derived.winLoss === 'W') setupStats[setup.id].wins++;
          if (t.derived.winLoss === 'L') setupStats[setup.id].losses++;
        });
        const setupData = Object.values(setupStats).map(s => ({
          ...s,
          winRate: s.total > 0 ? ((s.wins / s.total) * 100).toFixed(0) : 0,
        }));

        // Mistake analytics - ONLY count losses towards cost
        const mistakeStats = {};
        closedTrades.forEach(t => {
          if (!t.mistakeIds || t.mistakeIds.length === 0) return;
          const pnl = t.derived.pnlFinal || 0;
          
          t.mistakeIds.forEach(mistakeId => {
            const mistake = state.mistakes.find(m => m.id === mistakeId);
            if (!mistake) return;
            
            if (!mistakeStats[mistakeId]) {
              mistakeStats[mistakeId] = {
                id: mistakeId,
                name: mistake.name,
                totalOccurrences: 0,
                losingTrades: 0,
                profitableTrades: 0,
                totalLossAmount: 0,
              };
            }
            mistakeStats[mistakeId].totalOccurrences++;
            if (pnl < 0) {
              mistakeStats[mistakeId].losingTrades++;
              mistakeStats[mistakeId].totalLossAmount += pnl;
            } else {
              mistakeStats[mistakeId].profitableTrades++;
            }
          });
        });
        const mistakeData = Object.values(mistakeStats);

        // Compare to average
        const vsAverage = overallStats.avgDailyPnL !== 0
          ? ((totalPnL - overallStats.avgDailyPnL) / Math.abs(overallStats.avgDailyPnL) * 100).toFixed(1)
          : totalPnL > 0 ? 100 : totalPnL < 0 ? -100 : 0;

        // Calculate avg win/loss and R:R ratio
        const avgWin = wins.length > 0 
          ? wins.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / wins.length 
          : 0;
        const avgLoss = losses.length > 0 
          ? Math.abs(losses.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0) / losses.length)
          : 0;
        const riskRewardRatio = avgLoss > 0 ? (avgWin / avgLoss).toFixed(2) : avgWin > 0 ? '‚àû' : '0.00';

        // Trades vs average
        const tradesVsAvg = overallStats.avgDailyTrades > 0
          ? closedTrades.length - overallStats.avgDailyTrades
          : 0;

        // Calculate average rating
        const ratedTrades = closedTrades.filter(t => t.rating && t.rating > 0);
        const avgRating = ratedTrades.length > 0
          ? ratedTrades.reduce((sum, t) => sum + t.rating, 0) / ratedTrades.length
          : 0;

        return {
          totalPnL,
          totalTrades: selectedDateTrades.length,
          closedTrades: closedTrades.length,
          wins: wins.length,
          losses: losses.length,
          winRate,
          bestTrade,
          assetPieData,
          tickerPnLData,
          tradePnLData,
          setupData,
          mistakeData,
          vsAverage,
          avgDailyPnL: overallStats.avgDailyPnL,
          avgWin,
          avgLoss,
          riskRewardRatio,
          tradesVsAvg,
          avgDailyTrades: overallStats.avgDailyTrades,
          avgRating,
          ratedTradesCount: ratedTrades.length,
        };
      }, [selectedDate, selectedDateTrades, state.setups, state.mistakes, overallStats]);

      // Load daily note when date changes
      useEffect(() => {
        if (selectedDate && state.dailyNotes[selectedDate]) {
          setDailyNote(state.dailyNotes[selectedDate].note || '');
        } else {
          setDailyNote('');
        }
        // Auto-resize textarea after note loads
        setTimeout(() => {
          const textarea = document.querySelector('textarea[placeholder*="Market conditions"]');
          if (textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.max(150, textarea.scrollHeight) + 'px';
          }
        }, 0);
      }, [selectedDate, state.dailyNotes]);

      // Navigation
      const prevMonth = () => {
        setViewDate(prev => {
          if (prev.month === 0) {
            return { year: prev.year - 1, month: 11 };
          }
          return { ...prev, month: prev.month - 1 };
        });
      };

      const nextMonth = () => {
        setViewDate(prev => {
          if (prev.month === 11) {
            return { year: prev.year + 1, month: 0 };
          }
          return { ...prev, month: prev.month + 1 };
        });
      };

      const goToToday = () => {
        const now = new Date();
        setViewDate({ year: now.getFullYear(), month: now.getMonth() });
        setSelectedDate(todayISO());
      };

      // Save daily note
      const handleSaveNote = () => {
        if (!selectedDate) return;
        
        const updatedNote = {
          date: selectedDate,
          note: dailyNote,
          emotionalState: state.dailyNotes[selectedDate]?.emotionalState || null,
          updatedAt: nowISO(),
        };

        setState({
          ...state,
          dailyNotes: {
            ...state.dailyNotes,
            [selectedDate]: updatedNote,
          },
        });
      };

      // Edit trade
      const openEditModal = (trade) => {
        setEditingTrade(trade);
        setModalOpen(true);
      };

      // Helper functions
      const getSetupName = (setupId) => {
        if (!setupId) return '-';
        const setup = state.setups.find(s => s.id === setupId);
        return setup?.name || '-';
      };

      const getMistakeNames = (mistakeIds) => {
        if (!mistakeIds || mistakeIds.length === 0) return '-';
        return mistakeIds
          .map(id => state.mistakes.find(m => m.id === id)?.name)
          .filter(Boolean)
          .join(', ') || '-';
      };

      return (
        <div className="space-y-4 md:space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <h1 className="text-xl md:text-2xl font-bold text-gray-900">Calendar</h1>
            <button
              onClick={goToToday}
              className="px-3 md:px-4 py-1.5 md:py-2 text-xs md:text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
            >
              Today
            </button>
          </div>

          {/* Goal Progress Bar */}
          {goalProgress && (
            <div className={`rounded-xl p-4 ${
              goalProgress.progress >= 100 
                ? 'bg-emerald-50 border border-emerald-200' 
                : 'bg-white border border-gray-200'
            }`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-semibold text-gray-900">{goalProgress.yearLabel} Goal</span>
                  {goalProgress.progress >= 100 && <span>üéØ</span>}
                </div>
                <span className={`text-sm font-bold ${goalProgress.progress >= 100 ? 'text-emerald-600' : 'text-blue-600'}`}>
                  {goalProgress.progress.toFixed(1)}%
                </span>
              </div>
              <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className={`h-full rounded-full transition-all ${goalProgress.progress >= 100 ? 'bg-emerald-500' : 'bg-blue-500'}`}
                  style={{ width: `${Math.min(goalProgress.progress, 100)}%` }}
                />
              </div>
              <div className="flex justify-between mt-2 text-xs text-gray-500">
                <span>{formatCurrencyShort(goalProgress.yearPnL)} earned</span>
                <span>{formatCurrencyShort(goalProgress.goal.target)} target</span>
              </div>
            </div>
          )}

          {/* Mobile: Stack calendar and details */}
          <div className={`grid gap-4 md:gap-6 ${isMobile ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-3'}`}>
            {/* Left Column: Calendar + Daily Notes */}
            <div className="lg:col-span-1 space-y-4">
              {/* Calendar */}
              <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                {/* Month Navigation */}
                <div className="flex items-center justify-between mb-4">
                  <button
                    onClick={prevMonth}
                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    {Icons.chevronLeft}
                  </button>
                  <h2 className="text-lg font-semibold text-gray-900">
                    {calendarData.monthName} {calendarData.year}
                  </h2>
                  <button
                    onClick={nextMonth}
                    className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                  >
                    {Icons.chevronRight}
                  </button>
                </div>

                {/* Calendar Grid */}
                <div className="grid grid-cols-7 gap-1">
                  {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((day, i) => (
                    <div key={i} className="text-center text-xs font-medium text-gray-500 py-2">
                      {day}
                    </div>
                  ))}
                  {calendarData.days.map((d, i) => {
                    const winRate = d.trades > 0 && (d.wins + d.losses) > 0 
                      ? Math.round((d.wins / (d.wins + d.losses)) * 100) 
                      : null;
                    
                    // Calculate if day met its daily goal target (only for days with trades)
                    let metDailyGoal = null;
                    if (goalProgress && d.day && d.trades > 0 && d.date >= goalProgress.yearStartStr && d.date <= goalProgress.yearEndStr) {
                      metDailyGoal = d.pnl >= goalProgress.dailyTarget;
                    }
                    
                    return (
                      <button
                        key={i}
                        onClick={() => d.day && setSelectedDate(d.date)}
                        disabled={!d.day}
                        className={`
                          min-h-[60px] md:min-h-[72px] p-1 rounded-lg flex flex-col items-center justify-start
                          transition-all relative
                          ${!d.day ? 'invisible' : ''}
                          ${d.date === selectedDate ? 'ring-2 ring-blue-500 bg-blue-50' : ''}
                          ${d.date === todayISO() && d.date !== selectedDate ? 'ring-1 ring-gray-300' : ''}
                          ${d.day && d.trades === 0 ? 'bg-gray-50 hover:bg-gray-100' : ''}
                          ${d.day && d.trades > 0 && d.pnl > 0 ? 'bg-emerald-100 hover:bg-emerald-200 border border-emerald-300' : ''}
                          ${d.day && d.trades > 0 && d.pnl < 0 ? 'bg-red-100 hover:bg-red-200 border border-red-300' : ''}
                          ${d.day && d.trades > 0 && d.pnl === 0 ? 'bg-gray-200 hover:bg-gray-300' : ''}
                        `}
                      >
                        {d.day && (
                          <>
                            <span className={`text-xs md:text-sm font-semibold ${d.date === todayISO() ? 'text-blue-600' : 'text-gray-700'}`}>
                              {d.day}
                            </span>
                            {d.trades > 0 && (
                              <div className="flex flex-col items-center leading-tight">
                                <span className={`text-[10px] md:text-xs font-bold ${d.pnl >= 0 ? 'text-emerald-700' : 'text-red-700'}`}>
                                  {formatCurrencyShort(d.pnl)}
                                </span>
                                <span className="text-[8px] md:text-[10px] text-gray-500">{d.wins}W/{d.losses}L</span>
                              </div>
                            )}
                            {d.hasNote && d.trades === 0 && (
                              <span className="text-[10px] text-blue-500">üìù</span>
                            )}
                            {/* Goal indicator - only on trading days */}
                            {metDailyGoal !== null && (
                              <span className="text-[8px]" title={metDailyGoal ? 'Hit daily goal' : 'Missed daily goal'}>
                                {metDailyGoal ? '‚úÖ' : '‚ùå'}
                              </span>
                            )}
                          </>
                        )}
                      </button>
                    );
                  })}
                </div>

                {/* Legend */}
                <div className="mt-4 pt-4 border-t border-gray-100 flex flex-wrap gap-3 text-xs">
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-emerald-100" />
                    <span className="text-gray-600">Profit</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-red-100" />
                    <span className="text-gray-600">Loss</span>
                  </div>
                  <div className="flex items-center gap-1">
                    <div className="w-3 h-3 rounded bg-gray-50 border border-gray-200" />
                    <span className="text-gray-600">No trades</span>
                  </div>
                  {goalProgress && (
                    <>
                      <div className="flex items-center gap-1">
                        <span className="text-[10px]">‚úÖ</span>
                        <span className="text-gray-600">Hit daily goal</span>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-[10px]">‚ùå</span>
                        <span className="text-gray-600">Missed daily goal</span>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* Daily Notes - Below Calendar in same column */}
              {selectedDate && (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <h3 className="text-sm font-semibold text-gray-900 mb-3">
                    Daily Notes
                    <span className="text-xs font-normal text-gray-500 ml-2">
                      {new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                    </span>
                  </h3>
                  <textarea
                    value={dailyNote}
                    onChange={(e) => {
                      setDailyNote(e.target.value);
                      // Auto-expand textarea
                      e.target.style.height = 'auto';
                      e.target.style.height = Math.max(150, e.target.scrollHeight) + 'px';
                    }}
                    onFocus={(e) => {
                      // Ensure proper height on focus
                      e.target.style.height = 'auto';
                      e.target.style.height = Math.max(150, e.target.scrollHeight) + 'px';
                    }}
                    placeholder="Market conditions, trading plan, lessons learned, emotions..."
                    className="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 overflow-hidden"
                    style={{ minHeight: '150px', resize: 'none' }}
                  />
                  <button
                    onClick={handleSaveNote}
                    className="mt-2 w-full px-4 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                  >
                    Save Note
                  </button>
                </div>
              )}
            </div>

            {/* Day Details */}
            <div className="lg:col-span-2 space-y-6">
              {!selectedDate ? (
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-12 text-center">
                  <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    {Icons.calendar}
                  </div>
                  <h3 className="text-lg font-medium text-gray-900 mb-2">Select a date</h3>
                  <p className="text-gray-500">Click on a day in the calendar to view details</p>
                </div>
              ) : (
                <>
                  {/* Date Header */}
                  <div className="flex items-center justify-between">
                    <h2 className="text-xl font-semibold text-gray-900">
                      {new Date(selectedDate + 'T12:00:00').toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      })}
                    </h2>
                  </div>

                  {/* Daily Goal Progress for Selected Date */}
                  {goalProgress && selectedDate >= goalProgress.yearStartStr && selectedDate <= goalProgress.yearEndStr && selectedDateStats && selectedDateStats.closedTrades > 0 && (
                    (() => {
                      const dailyPnL = selectedDateStats.totalPnL;
                      const dailyTarget = goalProgress.dailyTarget;
                      const dailyProgress = dailyTarget > 0 ? Math.min((dailyPnL / dailyTarget) * 100, 100) : 0;
                      const metGoal = dailyPnL >= dailyTarget;
                      
                      return (
                        <div className={`rounded-lg p-3 ${
                          metGoal 
                            ? 'bg-emerald-50 border border-emerald-200' 
                            : 'bg-gray-50 border border-gray-200'
                        }`}>
                          <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-2">
                              <span className="text-sm font-medium text-gray-700">Daily Goal</span>
                              <span className="text-sm">{metGoal ? '‚úÖ' : '‚ùå'}</span>
                            </div>
                            <span className={`text-sm font-bold ${metGoal ? 'text-emerald-600' : dailyPnL >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                              {dailyProgress > 0 ? dailyProgress.toFixed(0) : 0}%
                            </span>
                          </div>
                          <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div 
                              className={`h-full rounded-full transition-all ${
                                metGoal ? 'bg-emerald-500' : dailyPnL >= 0 ? 'bg-blue-500' : 'bg-red-400'
                              }`}
                              style={{ width: `${Math.max(0, Math.min(dailyProgress, 100))}%` }}
                            />
                          </div>
                          <div className="flex justify-between mt-1.5 text-xs text-gray-500">
                            <span>
                              <span className={dailyPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}>{formatCurrencyShort(dailyPnL)}</span>
                              {' / '}
                              {formatCurrencyShort(dailyTarget)} target
                            </span>
                            <span>
                              {metGoal 
                                ? `+${formatCurrencyShort(dailyPnL - dailyTarget)} over` 
                                : `${formatCurrencyShort(dailyTarget - dailyPnL)} short`
                              }
                            </span>
                          </div>
                        </div>
                      );
                    })()
                  )}

                  {/* Summary Cards */}
                  {selectedDateStats ? (
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 xl:grid-cols-7 gap-2">
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Daily P&L</p>
                        <p className={`text-lg font-bold truncate ${selectedDateStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {formatCurrencyShort(selectedDateStats.totalPnL)}
                        </p>
                        <p className={`text-[10px] mt-1 truncate ${parseFloat(selectedDateStats.vsAverage) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                          {parseFloat(selectedDateStats.vsAverage) >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(parseFloat(selectedDateStats.vsAverage))}% vs avg
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate"># Trades</p>
                        <div className="flex items-baseline gap-1">
                          <p className="text-lg font-bold text-gray-900">{selectedDateStats.closedTrades}</p>
                          {selectedDateStats.avgDailyTrades > 0 && (
                            <span className={`text-xs font-medium ${selectedDateStats.tradesVsAvg >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                              {selectedDateStats.tradesVsAvg >= 0 ? '‚Üë' : '‚Üì'}{Math.abs(selectedDateStats.tradesVsAvg).toFixed(1)}
                            </span>
                          )}
                        </div>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">avg {selectedDateStats.avgDailyTrades.toFixed(1)}/day</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Win Rate</p>
                        <p className="text-lg font-bold text-gray-900">{selectedDateStats.winRate}%</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">
                          <span className="text-emerald-600">{selectedDateStats.wins}W</span>
                          {' / '}
                          <span className="text-red-600">{selectedDateStats.losses}L</span>
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">R:R</p>
                        <p className="text-lg font-bold text-gray-900">{selectedDateStats.riskRewardRatio}:1</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">
                          {formatCurrencyShort(selectedDateStats.avgWin)}/{formatCurrencyShort(selectedDateStats.avgLoss)}
                        </p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Win</p>
                        <p className="text-lg font-bold text-emerald-600 truncate">{formatCurrencyShort(selectedDateStats.avgWin)}</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.wins} win{selectedDateStats.wins !== 1 ? 's' : ''}</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Loss</p>
                        <p className="text-lg font-bold text-red-600 truncate">-{formatCurrencyShort(selectedDateStats.avgLoss)}</p>
                        <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.losses} loss{selectedDateStats.losses !== 1 ? 'es' : ''}</p>
                      </div>
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-3">
                        <p className="text-[10px] font-medium text-gray-500 mb-1 truncate">Avg Rating</p>
                        {selectedDateStats.ratedTradesCount > 0 ? (
                          <>
                            <div className="flex items-center gap-1">
                              <span className="text-lg font-bold text-gray-900">{selectedDateStats.avgRating.toFixed(1)}</span>
                              <span className="text-amber-400">‚òÖ</span>
                            </div>
                            <p className="text-[10px] text-gray-500 mt-1 truncate">{selectedDateStats.ratedTradesCount} rated</p>
                          </>
                        ) : (
                          <p className="text-xs text-gray-400 italic">No ratings</p>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6 text-center text-gray-500">
                      No trades on this date
                    </div>
                  )}

                  {/* Charts */}
                  {selectedDateStats && selectedDateStats.closedTrades > 0 && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      {/* P&L by Asset Type */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Asset</h3>
                        <SimplePieChart data={selectedDateStats.assetPieData} />
                      </div>

                      {/* P&L by Ticker */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">P&L by Ticker</h3>
                        <SimpleBarChart data={selectedDateStats.tickerPnLData} />
                      </div>

                      {/* Trade P&L Distribution */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">Trade P&L</h3>
                        <SimpleBarChart data={selectedDateStats.tradePnLData} />
                      </div>

                      {/* Setups Used */}
                      <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                        <h3 className="text-sm font-semibold text-gray-900 mb-3">Setups Used</h3>
                        <SetupBarChart data={selectedDateStats.setupData} />
                      </div>
                    </div>
                  )}

                  {/* Trades Table */}
                  <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                      <h3 className="text-sm font-semibold text-gray-900">
                        {selectedDateTrades.length > 0 
                          ? `Trades (${selectedDateTrades.length})`
                          : 'No trades yet'
                        }
                      </h3>
                      <button
                        onClick={() => {
                          setEditingTrade({ entryDate: selectedDate });
                          setModalOpen(true);
                        }}
                        className="flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-xs font-medium"
                      >
                        {Icons.plus}
                        <span>Add Trade</span>
                      </button>
                    </div>
                    {selectedDateTrades.length > 0 ? (
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead className="bg-gray-50 border-b border-gray-200">
                            <tr>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-10">#</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ticker</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">P&L</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Rating</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Setup</th>
                              <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Mistakes</th>
                              <th className="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Screenshot</th>
                              <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-gray-200">
                            {[...selectedDateTrades]
                              .sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''))
                              .map((trade, index) => (
                              <tr key={trade.id} className="hover:bg-gray-50">
                                <td className="px-3 py-2 text-sm font-medium text-gray-400">{index + 1}</td>
                                <td className="px-3 py-2 text-sm font-medium text-gray-900">{trade.ticker}</td>
                                <td className="px-3 py-2 text-sm">
                                  <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                                    trade.positionType === 'long' 
                                      ? 'bg-emerald-100 text-emerald-700' 
                                      : 'bg-red-100 text-red-700'
                                  }`}>
                                    {trade.positionType.toUpperCase()}
                                  </span>
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600">{trade.positionSize}</td>
                                <td className="px-3 py-2 text-sm">
                                  {trade.derived.isOpen ? (
                                    <span className="text-gray-400">Open</span>
                                  ) : (
                                    <span className={`font-medium ${(trade.derived.pnlFinal || 0) >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                      {formatCurrency(trade.derived.pnlFinal)}
                                    </span>
                                  )}
                                </td>
                                <td className="px-3 py-2">
                                  <StarRating value={trade.rating || 0} readonly size="sm" />
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600 max-w-[100px] truncate">
                                  {getSetupName(trade.setupId)}
                                </td>
                                <td className="px-3 py-2 text-sm text-gray-600 max-w-[100px] truncate">
                                  {getMistakeNames(trade.mistakeIds)}
                                </td>
                                <td className="px-3 py-2 text-center">
                                  {trade.screenshot ? (
                                    <button
                                      onClick={() => {
                                        setImageModalData({ 
                                          src: trade.screenshot, 
                                          title: `${trade.ticker} - ${trade.entryDate}`,
                                          notes: trade.notes,
                                          trade: trade
                                        });
                                        setImageModalOpen(true);
                                      }}
                                      className="inline-flex items-center justify-center w-10 h-10 rounded-lg overflow-hidden border border-gray-200 hover:border-blue-400 hover:ring-2 hover:ring-blue-100 transition-all"
                                    >
                                      <img src={trade.screenshot} alt="Trade screenshot" className="w-full h-full object-cover" />
                                    </button>
                                  ) : (
                                    <span className="text-gray-300 text-xs">‚Äî</span>
                                  )}
                                </td>
                                <td className="px-3 py-2 text-right">
                                  <button
                                    onClick={() => openEditModal(trade)}
                                    className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                  >
                                    {Icons.edit}
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="p-8 text-center text-gray-500">
                        <p className="text-sm">No trades logged for this date yet.</p>
                        <p className="text-xs mt-1">Click "Add Trade" above to log your first trade.</p>
                      </div>
                    )}
                  </div>

                  {/* Setups Performance for Selected Date */}
                  {selectedDateStats && selectedDateStats.setupData && selectedDateStats.setupData.length > 0 && (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                        <h3 className="text-sm font-semibold text-gray-900">Setups Used on {selectedDate}</h3>
                      </div>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Setup Pie Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Trade Count</h4>
                            <SimplePieChart data={selectedDateStats.setupData.map(s => ({ label: s.name, value: s.total }))} />
                          </div>
                          {/* Setup Bar Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By P&L</h4>
                            <SimpleBarChart data={selectedDateStats.setupData.sort((a, b) => b.totalPnL - a.totalPnL).map(s => ({ label: s.name, value: s.totalPnL }))} />
                          </div>
                        </div>
                        {/* Setup Details Table */}
                        <div className="mt-4 pt-4 border-t border-gray-100">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-gray-500 uppercase">
                                <th className="pb-2">Setup</th>
                                <th className="pb-2 text-center">Trades</th>
                                <th className="pb-2 text-center">W/L</th>
                                <th className="pb-2 text-center">Win Rate</th>
                                <th className="pb-2 text-right">P&L</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {selectedDateStats.setupData.map(s => (
                                <tr key={s.id}>
                                  <td className="py-2 font-medium text-gray-900">{s.name}</td>
                                  <td className="py-2 text-center text-gray-600">{s.total}</td>
                                  <td className="py-2 text-center">
                                    <span className="text-emerald-600">{s.wins}W</span>
                                    {' / '}
                                    <span className="text-red-600">{s.losses}L</span>
                                  </td>
                                  <td className="py-2 text-center text-gray-600">{s.winRate}%</td>
                                  <td className={`py-2 text-right font-semibold ${s.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                    {formatCurrency(s.totalPnL)}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Mistakes Analysis for Selected Date */}
                  {selectedDateStats && selectedDateStats.mistakeData && selectedDateStats.mistakeData.length > 0 && (
                    <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 border-b border-gray-200 bg-gray-50">
                        <div className="flex items-center justify-between">
                          <h3 className="text-sm font-semibold text-gray-900">Mistakes on {selectedDate}</h3>
                          <span className="text-xs text-gray-500">Loss amounts only include losing trades</span>
                        </div>
                      </div>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Mistake Pie Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Frequency</h4>
                            <SimplePieChart data={selectedDateStats.mistakeData.map(m => ({ label: m.name, value: m.totalOccurrences }))} />
                          </div>
                          {/* Mistake Loss Bar Chart */}
                          <div>
                            <h4 className="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">By Loss Amount</h4>
                            {(() => {
                              const lossData = selectedDateStats.mistakeData
                                .filter(m => m.totalLossAmount < 0)
                                .sort((a, b) => a.totalLossAmount - b.totalLossAmount)
                                .map(m => ({ label: m.name, value: Math.abs(m.totalLossAmount) }));
                              if (lossData.length === 0) {
                                return <div className="h-24 flex items-center justify-center text-gray-400 text-sm">No losses from mistakes</div>;
                              }
                              const maxVal = Math.max(...lossData.map(d => d.value), 1);
                              return (
                                <div className="space-y-2">
                                  {lossData.map((d, i) => (
                                    <div key={i} className="flex items-center gap-2">
                                      <span className="text-xs text-gray-600 w-20 truncate" title={d.label}>{d.label}</span>
                                      <div className="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                                        <div className="h-full rounded bg-red-500" style={{ width: `${(d.value / maxVal) * 100}%` }} />
                                      </div>
                                      <span className="text-xs font-medium w-16 text-right text-red-600">-{formatCurrencyShort(d.value)}</span>
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                          </div>
                        </div>
                        {/* Mistake Details Table */}
                        <div className="mt-4 pt-4 border-t border-gray-100">
                          <table className="w-full text-sm">
                            <thead>
                              <tr className="text-left text-xs text-gray-500 uppercase">
                                <th className="pb-2">Mistake</th>
                                <th className="pb-2 text-center">Occurrences</th>
                                <th className="pb-2 text-center">Losing / Profitable</th>
                                <th className="pb-2 text-right">Total Loss</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {selectedDateStats.mistakeData.map(m => (
                                <tr key={m.id}>
                                  <td className="py-2 font-medium text-gray-900">{m.name}</td>
                                  <td className="py-2 text-center text-gray-600">{m.totalOccurrences}x</td>
                                  <td className="py-2 text-center">
                                    <span className="text-red-600">{m.losingTrades}</span>
                                    {' / '}
                                    <span className="text-emerald-600">{m.profitableTrades}</span>
                                  </td>
                                  <td className={`py-2 text-right font-semibold ${m.totalLossAmount < 0 ? 'text-red-600' : 'text-gray-400'}`}>
                                    {m.totalLossAmount < 0 ? formatCurrency(m.totalLossAmount) : '-'}
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  )}
                </>
              )}
            </div>
          </div>

          {/* Trade Modal */}
          <TradeModal
            isOpen={modalOpen}
            onClose={() => setModalOpen(false)}
            trade={editingTrade}
            state={state}
            setState={setState}
          />

          {/* Image Modal */}
          <ImageModal
            isOpen={imageModalOpen}
            onClose={() => setImageModalOpen(false)}
            src={imageModalData.src}
            title={imageModalData.title}
            trade={imageModalData.trade}
            state={state}
            setState={setState}
            getSetupName={getSetupName}
            getMistakeNames={getMistakeNames}
          />
        </div>
      );
    }

    // =============================================================================
    // SETUPS PAGE
    // =============================================================================
    function SetupsPage({ state, setState, isMobile }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingSetup, setEditingSetup] = useState(null);
      const [setupName, setSetupName] = useState('');
      const [setupDescription, setSetupDescription] = useState('');
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [error, setError] = useState('');

      // Calculate setup analytics
      const setupAnalytics = useMemo(() => {
        const analytics = {};
        
        // Initialize all setups
        state.setups.forEach(setup => {
          analytics[setup.id] = {
            id: setup.id,
            name: setup.name,
            description: setup.description || '',
            totalTrades: 0,
            wins: 0,
            losses: 0,
            totalPnL: 0,
            winRate: 0,
            avgPnL: 0,
          };
        });

        // Calculate stats from trades
        state.trades.forEach(trade => {
          if (!trade.setupId || !analytics[trade.setupId]) return;
          
          const derived = calcTradeDerived(trade);
          if (derived.isOpen) return;

          analytics[trade.setupId].totalTrades++;
          analytics[trade.setupId].totalPnL += derived.pnlFinal || 0;
          
          if (derived.winLoss === 'W') analytics[trade.setupId].wins++;
          if (derived.winLoss === 'L') analytics[trade.setupId].losses++;
        });

        // Calculate win rates and avg P&L
        Object.values(analytics).forEach(setup => {
          const totalClosed = setup.wins + setup.losses;
          setup.winRate = totalClosed > 0 ? Math.round((setup.wins / totalClosed) * 100) : 0;
          setup.avgPnL = setup.totalTrades > 0 ? setup.totalPnL / setup.totalTrades : 0;
        });

        return Object.values(analytics);
      }, [state.setups, state.trades]);

      // Charts data
      const pieData = useMemo(() => {
        return setupAnalytics
          .filter(s => s.totalTrades > 0)
          .map(s => ({ label: s.name, value: s.totalTrades }));
      }, [setupAnalytics]);

      const barData = useMemo(() => {
        return setupAnalytics
          .filter(s => s.totalTrades > 0)
          .sort((a, b) => b.totalPnL - a.totalPnL)
          .map(s => ({ label: s.name, value: s.totalPnL }));
      }, [setupAnalytics]);

      // Top lists
      const topByProfit = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalPnL > 0)
          .sort((a, b) => b.totalPnL - a.totalPnL)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByLoss = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalPnL < 0)
          .sort((a, b) => a.totalPnL - b.totalPnL)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByQuantity = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalTrades > 0)
          .sort((a, b) => b.totalTrades - a.totalTrades)
          .slice(0, 3);
      }, [setupAnalytics]);

      const topByWinRate = useMemo(() => {
        return [...setupAnalytics]
          .filter(s => s.totalTrades >= 3) // Minimum 3 trades for meaningful win rate
          .sort((a, b) => b.winRate - a.winRate)
          .slice(0, 3);
      }, [setupAnalytics]);

      // Check if setup is referenced by trades
      const getTradesUsingSetup = (setupId) => {
        return state.trades.filter(t => t.setupId === setupId);
      };

      // Modal handlers
      const openAddModal = () => {
        setEditingSetup(null);
        setSetupName('');
        setSetupDescription('');
        setError('');
        setModalOpen(true);
      };

      const openEditModal = (setup) => {
        setEditingSetup(setup);
        setSetupName(setup.name);
        setSetupDescription(setup.description || '');
        setError('');
        setModalOpen(true);
      };

      const closeModal = () => {
        setModalOpen(false);
        setEditingSetup(null);
        setSetupName('');
        setSetupDescription('');
        setError('');
      };

      const handleSave = () => {
        const trimmedName = setupName.trim();
        
        if (!trimmedName) {
          setError('Setup name is required');
          return;
        }

        // Check for duplicate names
        const duplicate = state.setups.find(s => 
          s.name.toLowerCase() === trimmedName.toLowerCase() && 
          s.id !== editingSetup?.id
        );
        if (duplicate) {
          setError('A setup with this name already exists');
          return;
        }

        if (editingSetup) {
          // Update existing
          setState({
            ...state,
            setups: state.setups.map(s => 
              s.id === editingSetup.id 
                ? { ...s, name: trimmedName, description: setupDescription.trim(), updatedAt: nowISO() }
                : s
            ),
          });
        } else {
          // Create new
          const newSetup = {
            id: generateId(),
            name: trimmedName,
            description: setupDescription.trim(),
            rules: [],
            createdAt: nowISO(),
            updatedAt: nowISO(),
          };
          setState({
            ...state,
            setups: [...state.setups, newSetup],
          });
        }

        closeModal();
      };

      const handleDelete = (setupId, nullifyTrades = false) => {
        if (nullifyTrades) {
          // Remove setup reference from all trades
          setState({
            ...state,
            setups: state.setups.filter(s => s.id !== setupId),
            trades: state.trades.map(t => 
              t.setupId === setupId ? { ...t, setupId: null } : t
            ),
          });
        } else {
          // Just delete the setup
          setState({
            ...state,
            setups: state.setups.filter(s => s.id !== setupId),
          });
        }
        setDeleteConfirm(null);
      };

      const initiateDelete = (setup) => {
        const tradesUsing = getTradesUsingSetup(setup.id);
        if (tradesUsing.length > 0) {
          setDeleteConfirm({ setup, tradesCount: tradesUsing.length });
        } else {
          handleDelete(setup.id);
        }
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Setups</h1>
              <p className="text-sm text-gray-500 mt-1">{state.setups.length} setups defined</p>
            </div>
            <button
              onClick={openAddModal}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              {Icons.plus}
              <span>Add Setup</span>
            </button>
          </div>

          {/* Analytics Section */}
          {setupAnalytics.some(s => s.totalTrades > 0) && (
            <>
              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Pie Chart - Setups by Quantity */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Setups by Trade Count</h3>
                  <SimplePieChart data={pieData} />
                </div>

                {/* Bar Chart - Setups by P&L */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4">Setups by Total P&L</h3>
                  <SimpleBarChart data={barData} />
                </div>
              </div>

              {/* Top Lists */}
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {/* Top by Profit */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-emerald-100 rounded-lg text-emerald-600">
                      {Icons.trendUp}
                    </div>
                    <h4 className="font-semibold text-gray-900">Top Profit</h4>
                  </div>
                  {topByProfit.length > 0 ? (
                    <div className="space-y-2">
                      {topByProfit.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-emerald-600">{formatCurrency(s.totalPnL)}</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No profitable setups yet</p>
                  )}
                </div>

                {/* Top by Loss */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-red-100 rounded-lg text-red-600">
                      {Icons.trendDown}
                    </div>
                    <h4 className="font-semibold text-gray-900">Worst Loss</h4>
                  </div>
                  {topByLoss.length > 0 ? (
                    <div className="space-y-2">
                      {topByLoss.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-red-600">{formatCurrency(s.totalPnL)}</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No losing setups yet</p>
                  )}
                </div>

                {/* Top by Quantity */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-blue-100 rounded-lg text-blue-600">
                      {Icons.tradelog}
                    </div>
                    <h4 className="font-semibold text-gray-900">Most Used</h4>
                  </div>
                  {topByQuantity.length > 0 ? (
                    <div className="space-y-2">
                      {topByQuantity.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-blue-600">{s.totalTrades} trades</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">No trades with setups yet</p>
                  )}
                </div>

                {/* Top by Win Rate */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <div className="p-1.5 bg-amber-100 rounded-lg text-amber-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                      </svg>
                    </div>
                    <h4 className="font-semibold text-gray-900">Best Win Rate</h4>
                  </div>
                  {topByWinRate.length > 0 ? (
                    <div className="space-y-2">
                      {topByWinRate.map((s, i) => (
                        <div key={s.id} className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <span className="text-xs font-bold text-gray-400">#{i + 1}</span>
                            <span className="text-sm text-gray-700 truncate max-w-[100px]">{s.name}</span>
                          </div>
                          <span className="text-sm font-semibold text-amber-600">{s.winRate}%</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic">Need 3+ trades per setup</p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Setups List */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">All Setups</h3>
            </div>
            
            {state.setups.length === 0 ? (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.setups}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No setups defined</h3>
                <p className="text-gray-500 mb-4">Create setups to categorize and analyze your trading strategies</p>
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Setup</span>
                </button>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {setupAnalytics.map(setup => {
                  const maxPnL = Math.max(...setupAnalytics.map(s => Math.abs(s.totalPnL)), 1);
                  const pnlBarWidth = (Math.abs(setup.totalPnL) / maxPnL) * 100;
                  const winPercent = setup.wins + setup.losses > 0 ? (setup.wins / (setup.wins + setup.losses)) * 100 : 0;
                  
                  return (
                    <div key={setup.id} className="px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div className="flex items-center justify-between gap-4">
                        {/* Left: Name & Description */}
                        <div className="flex-shrink-0 w-48">
                          <h4 className="font-medium text-gray-900">{setup.name}</h4>
                          {setup.description && (
                            <p className="text-xs text-gray-500 mt-0.5 truncate">{setup.description}</p>
                          )}
                        </div>
                        
                        {/* Middle: Stats & Bars */}
                        {setup.totalTrades > 0 ? (
                          <div className="flex-1 flex items-center gap-6">
                            {/* Trades & P&L */}
                            <div className="flex items-center gap-3 text-xs">
                              <span className="text-gray-600 font-medium whitespace-nowrap">
                                {setup.totalTrades} trades
                              </span>
                              <div className="flex items-center gap-1.5">
                                <span className={`font-semibold whitespace-nowrap ${setup.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                  {formatCurrency(setup.totalPnL)}
                                </span>
                                <div className="w-16 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                  <div 
                                    className={`h-full rounded-full ${setup.totalPnL >= 0 ? 'bg-emerald-500' : 'bg-red-500'}`}
                                    style={{ width: `${pnlBarWidth}%` }}
                                  />
                                </div>
                              </div>
                            </div>
                            
                            {/* Win Rate with integrated bar */}
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-emerald-600 font-medium w-6 text-right">{setup.wins}W</span>
                              <div className="w-24 h-2 bg-red-200 rounded-full overflow-hidden">
                                <div 
                                  className="h-full bg-emerald-500 rounded-full"
                                  style={{ width: `${winPercent}%` }}
                                />
                              </div>
                              <span className="text-xs text-red-600 font-medium w-6">{setup.losses}L</span>
                              <span className="text-xs text-gray-500 font-medium w-10">{setup.winRate}%</span>
                            </div>
                          </div>
                        ) : (
                          <div className="flex-1">
                            <span className="text-xs text-gray-400">No trades yet</span>
                          </div>
                        )}
                        
                        {/* Right: Actions */}
                        <div className="flex items-center gap-1 flex-shrink-0">
                          <button
                            onClick={() => openEditModal(state.setups.find(s => s.id === setup.id))}
                            className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Edit setup"
                          >
                            {Icons.edit}
                          </button>
                          <button
                            onClick={() => initiateDelete(state.setups.find(s => s.id === setup.id))}
                            className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Delete setup"
                          >
                            {Icons.trash}
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Add/Edit Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={closeModal} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">
                      {editingSetup ? 'Edit Setup' : 'Add Setup'}
                    </h2>
                  </div>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Name <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={setupName}
                        onChange={(e) => {
                          setSetupName(e.target.value);
                          setError('');
                        }}
                        placeholder="e.g., Breakout, Mean Reversion, Gap Fill"
                        className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          error ? 'border-red-500' : 'border-gray-300'
                        }`}
                        autoFocus
                      />
                      {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Description
                      </label>
                      <textarea
                        value={setupDescription}
                        onChange={(e) => setSetupDescription(e.target.value)}
                        placeholder="Describe the setup criteria, entry/exit rules..."
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                      />
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 rounded-b-xl">
                    <button
                      onClick={closeModal}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      {editingSetup ? 'Save Changes' : 'Add Setup'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deleteConfirm && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setDeleteConfirm(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">Delete Setup</h2>
                  </div>
                  <div className="p-6">
                    <div className="flex items-start gap-4">
                      <div className="p-3 bg-red-100 rounded-full text-red-600 flex-shrink-0">
                        {Icons.warning}
                      </div>
                      <div>
                        <p className="text-gray-900 font-medium">
                          Delete "{deleteConfirm.setup.name}"?
                        </p>
                        <p className="text-gray-500 text-sm mt-2">
                          This setup is linked to <span className="font-semibold text-gray-700">{deleteConfirm.tradesCount} trade{deleteConfirm.tradesCount !== 1 ? 's' : ''}</span>.
                        </p>
                        <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <p className="text-amber-800 text-sm font-medium">‚ö†Ô∏è This action cannot be undone</p>
                          <p className="text-amber-700 text-xs mt-1">
                            The setup will be removed from all linked trades. Your trade data (P&L, dates, etc.) will remain intact, but the setup association will be lost.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col gap-2 rounded-b-xl">
                    <button
                      onClick={() => handleDelete(deleteConfirm.setup.id, true)}
                      className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                    >
                      Delete Setup
                    </button>
                    <button
                      onClick={() => setDeleteConfirm(null)}
                      className="w-full px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // MISTAKES PAGE
    // =============================================================================
    function MistakesPage({ state, setState, isMobile }) {
      const [modalOpen, setModalOpen] = useState(false);
      const [editingMistake, setEditingMistake] = useState(null);
      const [mistakeName, setMistakeName] = useState('');
      const [mistakeDescription, setMistakeDescription] = useState('');
      const [deleteConfirm, setDeleteConfirm] = useState(null);
      const [error, setError] = useState('');

      // Calculate mistake analytics
      // CRITICAL RULE: Only count LOSSES (negative P&L) towards mistake cost
      // Profitable trades with mistakes do NOT reduce the mistake's loss amount
      const mistakeAnalytics = useMemo(() => {
        const analytics = {};
        
        // Initialize all mistakes
        state.mistakes.forEach(mistake => {
          analytics[mistake.id] = {
            id: mistake.id,
            name: mistake.name,
            description: mistake.description || '',
            totalOccurrences: 0,      // Count of trades tagged with this mistake
            losingTrades: 0,          // Count of losing trades with this mistake
            profitableTrades: 0,      // Count of profitable trades (mistake didn't cost us)
            totalLossAmount: 0,       // Sum of ONLY negative P&L (losses)
            avgLossPerOccurrence: 0,  // Average loss when this mistake occurs
          };
        });

        // Calculate stats from trades
        state.trades.forEach(trade => {
          if (!trade.mistakeIds || trade.mistakeIds.length === 0) return;
          
          const derived = calcTradeDerived(trade);
          if (derived.isOpen) return;

          const pnl = derived.pnlFinal || 0;

          // For each mistake tagged on this trade
          trade.mistakeIds.forEach(mistakeId => {
            if (!analytics[mistakeId]) return;
            
            analytics[mistakeId].totalOccurrences++;
            
            // ONLY count losses towards the mistake's cost
            if (pnl < 0) {
              analytics[mistakeId].losingTrades++;
              analytics[mistakeId].totalLossAmount += pnl; // pnl is negative, so this sums negatives
            } else {
              analytics[mistakeId].profitableTrades++;
            }
          });
        });

        // Calculate averages
        Object.values(analytics).forEach(mistake => {
          if (mistake.losingTrades > 0) {
            mistake.avgLossPerOccurrence = mistake.totalLossAmount / mistake.losingTrades;
          }
        });

        return Object.values(analytics);
      }, [state.mistakes, state.trades]);

      // Charts data
      const pieData = useMemo(() => {
        return mistakeAnalytics
          .filter(m => m.totalOccurrences > 0)
          .sort((a, b) => b.totalOccurrences - a.totalOccurrences)
          .map(m => ({ label: m.name, value: m.totalOccurrences }));
      }, [mistakeAnalytics]);

      // Bar chart: Loss amount (worst to least) - only show mistakes with losses
      const barData = useMemo(() => {
        return mistakeAnalytics
          .filter(m => m.totalLossAmount < 0) // Only mistakes that caused losses
          .sort((a, b) => a.totalLossAmount - b.totalLossAmount) // Most negative first (worst)
          .map(m => ({ 
            label: m.name, 
            value: Math.abs(m.totalLossAmount) // Show as positive for display, but it represents loss
          }));
      }, [mistakeAnalytics]);

      // Top lists
      const mostFrequent = useMemo(() => {
        return [...mistakeAnalytics]
          .filter(m => m.totalOccurrences > 0)
          .sort((a, b) => b.totalOccurrences - a.totalOccurrences)
          .slice(0, 3);
      }, [mistakeAnalytics]);

      const mostCostly = useMemo(() => {
        return [...mistakeAnalytics]
          .filter(m => m.totalLossAmount < 0)
          .sort((a, b) => a.totalLossAmount - b.totalLossAmount) // Most negative first
          .slice(0, 3);
      }, [mistakeAnalytics]);

      // Check if mistake is referenced by trades
      const getTradesUsingMistake = (mistakeId) => {
        return state.trades.filter(t => t.mistakeIds && t.mistakeIds.includes(mistakeId));
      };

      // Modal handlers
      const openAddModal = () => {
        setEditingMistake(null);
        setMistakeName('');
        setMistakeDescription('');
        setError('');
        setModalOpen(true);
      };

      const openEditModal = (mistake) => {
        setEditingMistake(mistake);
        setMistakeName(mistake.name);
        setMistakeDescription(mistake.description || '');
        setError('');
        setModalOpen(true);
      };

      const closeModal = () => {
        setModalOpen(false);
        setEditingMistake(null);
        setMistakeName('');
        setMistakeDescription('');
        setError('');
      };

      const handleSave = () => {
        const trimmedName = mistakeName.trim();
        
        if (!trimmedName) {
          setError('Mistake name is required');
          return;
        }

        // Check for duplicate names
        const duplicate = state.mistakes.find(m => 
          m.name.toLowerCase() === trimmedName.toLowerCase() && 
          m.id !== editingMistake?.id
        );
        if (duplicate) {
          setError('A mistake with this name already exists');
          return;
        }

        if (editingMistake) {
          // Update existing
          setState({
            ...state,
            mistakes: state.mistakes.map(m => 
              m.id === editingMistake.id 
                ? { ...m, name: trimmedName, description: mistakeDescription.trim(), updatedAt: nowISO() }
                : m
            ),
          });
        } else {
          // Create new
          const newMistake = {
            id: generateId(),
            name: trimmedName,
            description: mistakeDescription.trim(),
            createdAt: nowISO(),
            updatedAt: nowISO(),
          };
          setState({
            ...state,
            mistakes: [...state.mistakes, newMistake],
          });
        }

        closeModal();
      };

      const handleDelete = (mistakeId, removeFromTrades = false) => {
        if (removeFromTrades) {
          // Remove mistake reference from all trades
          setState({
            ...state,
            mistakes: state.mistakes.filter(m => m.id !== mistakeId),
            trades: state.trades.map(t => ({
              ...t,
              mistakeIds: t.mistakeIds ? t.mistakeIds.filter(id => id !== mistakeId) : [],
            })),
          });
        } else {
          // Just delete the mistake
          setState({
            ...state,
            mistakes: state.mistakes.filter(m => m.id !== mistakeId),
          });
        }
        setDeleteConfirm(null);
      };

      const initiateDelete = (mistake) => {
        const tradesUsing = getTradesUsingMistake(mistake.id);
        if (tradesUsing.length > 0) {
          setDeleteConfirm({ mistake, tradesCount: tradesUsing.length });
        } else {
          handleDelete(mistake.id);
        }
      };

      // Custom bar chart for losses (shows in red)
      const LossBarChart = ({ data }) => {
        if (!data || data.length === 0) {
          return (
            <div className="h-32 flex items-center justify-center text-gray-400 text-sm">
              No loss data
            </div>
          );
        }

        const maxVal = Math.max(...data.map(d => d.value), 1);

        return (
          <div className="space-y-2">
            {data.map((d, i) => (
              <div key={i} className="flex items-center gap-2">
                <span className="text-xs text-gray-600 w-24 truncate" title={d.label}>{d.label}</span>
                <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
                  <div
                    className="h-full rounded bg-red-500"
                    style={{ width: `${(d.value / maxVal) * 100}%` }}
                  />
                </div>
                <span className="text-xs font-medium w-20 text-right text-red-600">
                  -${d.value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                </span>
              </div>
            ))}
          </div>
        );
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Mistakes</h1>
              <p className="text-sm text-gray-500 mt-1">{state.mistakes.length} mistake types defined</p>
            </div>
            <button
              onClick={openAddModal}
              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
            >
              {Icons.plus}
              <span>Add Mistake</span>
            </button>
          </div>

          {/* Info Banner */}
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div className="flex gap-3">
              <div className="text-amber-600">{Icons.warning}</div>
              <div>
                <p className="text-sm font-medium text-amber-800">Loss Amount Calculation Rule</p>
                <p className="text-xs text-amber-700 mt-1">
                  Only <strong>losing trades</strong> contribute to a mistake's total loss amount. 
                  Profitable trades tagged with a mistake are counted in occurrences but do not reduce the loss total.
                </p>
              </div>
            </div>
          </div>

          {/* Analytics Section */}
          {mistakeAnalytics.some(m => m.totalOccurrences > 0) && (
            <>
              {/* Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Pie Chart - Mistakes by Occurrence */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-1">Mistakes by Frequency</h3>
                  <p className="text-xs text-gray-500 mb-4">Number of trades tagged with each mistake</p>
                  <SimplePieChart data={pieData} />
                </div>

                {/* Bar Chart - Mistakes by Loss Amount */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                  <h3 className="text-lg font-semibold text-gray-900 mb-1">Mistakes by Loss Amount</h3>
                  <p className="text-xs text-gray-500 mb-4">Total losses from trades with each mistake (losses only)</p>
                  <LossBarChart data={barData} />
                </div>
              </div>

              {/* Top Lists */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Most Frequent */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-2 bg-amber-100 rounded-lg text-amber-600">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                        <path d="M12 8v4M12 16h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <h4 className="font-semibold text-gray-900">Most Frequent Mistakes</h4>
                      <p className="text-xs text-gray-500">Mistakes you make most often</p>
                    </div>
                  </div>
                  {mostFrequent.length > 0 ? (
                    <div className="space-y-3">
                      {mostFrequent.map((m, i) => (
                        <div key={m.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                              i === 0 ? 'bg-amber-500 text-white' : 
                              i === 1 ? 'bg-gray-400 text-white' : 
                              'bg-amber-200 text-amber-800'
                            }`}>
                              {i + 1}
                            </span>
                            <span className="font-medium text-gray-700">{m.name}</span>
                          </div>
                          <div className="text-right">
                            <span className="text-sm font-semibold text-gray-900">{m.totalOccurrences}x</span>
                            <p className="text-xs text-gray-500">{m.losingTrades} losses, {m.profitableTrades} wins</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic text-center py-4">No mistakes logged yet</p>
                  )}
                </div>

                {/* Most Costly */}
                <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                  <div className="flex items-center gap-2 mb-4">
                    <div className="p-2 bg-red-100 rounded-lg text-red-600">
                      {Icons.trendDown}
                    </div>
                    <div>
                      <h4 className="font-semibold text-gray-900">Most Costly Mistakes</h4>
                      <p className="text-xs text-gray-500">Mistakes costing you the most money</p>
                    </div>
                  </div>
                  {mostCostly.length > 0 ? (
                    <div className="space-y-3">
                      {mostCostly.map((m, i) => (
                        <div key={m.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${
                              i === 0 ? 'bg-red-500 text-white' : 
                              i === 1 ? 'bg-red-400 text-white' : 
                              'bg-red-200 text-red-800'
                            }`}>
                              {i + 1}
                            </span>
                            <span className="font-medium text-gray-700">{m.name}</span>
                          </div>
                          <div className="text-right">
                            <span className="text-sm font-bold text-red-600">{formatCurrency(m.totalLossAmount)}</span>
                            <p className="text-xs text-gray-500">Avg: {formatCurrency(m.avgLossPerOccurrence)}/loss</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-400 italic text-center py-4">No losing trades with mistakes yet</p>
                  )}
                </div>
              </div>
            </>
          )}

          {/* Mistakes List */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">All Mistake Types</h3>
            </div>
            
            {state.mistakes.length === 0 ? (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.mistakes}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No mistake types defined</h3>
                <p className="text-gray-500 mb-4">Create mistake types to track and analyze your trading errors</p>
                <button
                  onClick={openAddModal}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Add Your First Mistake Type</span>
                </button>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {mistakeAnalytics.map(mistake => {
                  // Calculate importance score (0-3) based on total loss amount
                  const maxLoss = Math.max(...mistakeAnalytics.map(m => Math.abs(m.totalLossAmount)), 1);
                  const lossRatio = Math.abs(mistake.totalLossAmount) / maxLoss;
                  const importance = mistake.totalLossAmount >= 0 ? 0 : 
                    lossRatio >= 0.7 ? 3 : 
                    lossRatio >= 0.4 ? 2 : 
                    lossRatio > 0 ? 1 : 0;
                  
                  return (
                    <div key={mistake.id} className="px-6 py-4 hover:bg-gray-50 transition-colors">
                      <div className="flex items-center justify-between gap-4">
                        {/* Left: Importance & Name */}
                        <div className="flex items-center gap-3 flex-shrink-0 w-56">
                          {/* Importance Indicator - 3 bars */}
                          <div className="flex items-end gap-0.5" title={`Priority: ${importance === 3 ? 'Critical' : importance === 2 ? 'High' : importance === 1 ? 'Medium' : 'Low'}`}>
                            {[0, 1, 2].map(i => (
                              <div 
                                key={i} 
                                className={`w-1.5 rounded-sm ${i < importance ? (importance === 3 ? 'bg-red-500' : importance === 2 ? 'bg-orange-500' : 'bg-amber-400') : 'bg-gray-200'}`}
                                style={{ height: `${8 + (i * 4)}px` }}
                              />
                            ))}
                          </div>
                          <div className="min-w-0">
                            <h4 className="font-medium text-gray-900 truncate">{mistake.name}</h4>
                            {mistake.description && (
                              <p className="text-xs text-gray-500 mt-0.5 truncate">{mistake.description}</p>
                            )}
                          </div>
                        </div>
                        
                        {/* Middle: Stats */}
                        {mistake.totalOccurrences > 0 ? (
                          <div className="flex-1 flex items-center gap-8 text-xs">
                            {/* Occurrences */}
                            <div className="text-center min-w-[60px]">
                              <p className="text-lg font-bold text-gray-900">{mistake.totalOccurrences}</p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">times</p>
                            </div>
                            
                            {/* Total Cost */}
                            <div className="text-center min-w-[80px]">
                              <p className={`text-lg font-bold ${mistake.totalLossAmount < 0 ? 'text-red-600' : 'text-gray-400'}`}>
                                {mistake.totalLossAmount < 0 ? formatCurrencyShort(mistake.totalLossAmount) : '$0'}
                              </p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">total cost</p>
                            </div>
                            
                            {/* Avg Loss */}
                            <div className="text-center min-w-[80px]">
                              <p className={`text-lg font-bold ${mistake.avgLossPerOccurrence < 0 ? 'text-orange-600' : 'text-gray-400'}`}>
                                {mistake.avgLossPerOccurrence < 0 ? formatCurrencyShort(mistake.avgLossPerOccurrence) : '$0'}
                              </p>
                              <p className="text-[10px] text-gray-500 uppercase tracking-wide">avg/loss</p>
                            </div>
                          </div>
                        ) : (
                          <div className="flex-1">
                            <span className="text-xs text-gray-400">No occurrences yet</span>
                          </div>
                        )}
                        
                        {/* Right: Actions */}
                        <div className="flex items-center gap-1 flex-shrink-0">
                          <button
                            onClick={() => openEditModal(state.mistakes.find(m => m.id === mistake.id))}
                            className="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Edit mistake"
                          >
                            {Icons.edit}
                          </button>
                          <button
                            onClick={() => initiateDelete(state.mistakes.find(m => m.id === mistake.id))}
                            className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                            title="Delete mistake"
                          >
                            {Icons.trash}
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Add/Edit Modal */}
          {modalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={closeModal} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">
                      {editingMistake ? 'Edit Mistake' : 'Add Mistake Type'}
                    </h2>
                  </div>
                  <div className="p-6 space-y-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Name <span className="text-red-500">*</span>
                      </label>
                      <input
                        type="text"
                        value={mistakeName}
                        onChange={(e) => {
                          setMistakeName(e.target.value);
                          setError('');
                        }}
                        placeholder="e.g., FOMO, Overtrading, Moved Stop Loss"
                        className={`w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${
                          error ? 'border-red-500' : 'border-gray-300'
                        }`}
                        autoFocus
                      />
                      {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">
                        Description
                      </label>
                      <textarea
                        value={mistakeDescription}
                        onChange={(e) => setMistakeDescription(e.target.value)}
                        placeholder="Describe what this mistake looks like, how to avoid it..."
                        rows={3}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                      />
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3 rounded-b-xl">
                    <button
                      onClick={closeModal}
                      className="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      {editingMistake ? 'Save Changes' : 'Add Mistake'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Delete Confirmation Modal */}
          {deleteConfirm && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setDeleteConfirm(null)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">Delete Mistake Type</h2>
                  </div>
                  <div className="p-6">
                    <div className="flex items-start gap-4">
                      <div className="p-3 bg-red-100 rounded-full text-red-600 flex-shrink-0">
                        {Icons.warning}
                      </div>
                      <div>
                        <p className="text-gray-900 font-medium">
                          Delete "{deleteConfirm.mistake.name}"?
                        </p>
                        <p className="text-gray-500 text-sm mt-2">
                          This mistake is tagged on <span className="font-semibold text-gray-700">{deleteConfirm.tradesCount} trade{deleteConfirm.tradesCount !== 1 ? 's' : ''}</span>.
                        </p>
                        <div className="mt-3 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <p className="text-amber-800 text-sm font-medium">‚ö†Ô∏è This action cannot be undone</p>
                          <p className="text-amber-700 text-xs mt-1">
                            The mistake tag will be removed from all linked trades. Your trade data (P&L, dates, etc.) will remain intact, but the mistake association will be lost.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex flex-col gap-2 rounded-b-xl">
                    <button
                      onClick={() => handleDelete(deleteConfirm.mistake.id, true)}
                      className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                    >
                      Delete Mistake
                    </button>
                    <button
                      onClick={() => setDeleteConfirm(null)}
                      className="w-full px-4 py-2 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // GOALS PAGE
    // =============================================================================
    function GoalsPage({ state, setState, isMobile }) {
      const [yearlyGoalModalOpen, setYearlyGoalModalOpen] = useState(false);
      const [yearlyGoalInput, setYearlyGoalInput] = useState('');
      const [challengeModalOpen, setChallengeModalOpen] = useState(false);
      const [challengeTab, setChallengeTab] = useState('tried'); // 'tried' or 'custom'
      const [selectedTemplate, setSelectedTemplate] = useState(null);
      const [customChallenge, setCustomChallenge] = useState({
        metricType: 'profit',
        condition: 'by_date',
        value: '',
        timeValue: '',
        endDate: '',
      });
      const [templateValues, setTemplateValues] = useState({});
      const [error, setError] = useState('');

      const TRADING_DAYS_PER_YEAR = 252;
      const currentYear = new Date().getFullYear();

      // Challenge templates
      const CHALLENGE_TEMPLATES = {
        profit: [
          { id: 'profit_by_date', name: 'Make ${amount} by {date}', defaults: { amount: 5000, date: '' }, type: 'profit', condition: 'by_date' },
          { id: 'profit_in_trades', name: 'Make ${amount} in only {trades} trades', defaults: { amount: 5000, trades: 10 }, type: 'profit', condition: 'in_trades' },
          { id: 'profit_streak', name: 'Make ${amount} for {days} days in a row', defaults: { amount: 1000, days: 5 }, type: 'profit', condition: 'streak_days' },
          { id: 'profit_single_day', name: 'Make ${amount} in a single day', defaults: { amount: 2000 }, type: 'profit', condition: 'single_day' },
          { id: 'profit_single_trade', name: 'Make ${amount} in a single trade', defaults: { amount: 1000 }, type: 'profit', condition: 'single_trade' },
        ],
        consistency: [
          { id: 'profitable_streak', name: 'Be profitable {days} days in a row', defaults: { days: 5 }, type: 'consistency', condition: 'profitable_days' },
          { id: 'trade_streak', name: 'Trade {days} days in a row', defaults: { days: 10 }, type: 'consistency', condition: 'trading_days' },
          { id: 'win_rate', name: 'Stay above {percent}% win rate for {trades} trades', defaults: { percent: 60, trades: 20 }, type: 'consistency', condition: 'win_rate' },
        ],
        risk: [
          { id: 'max_loss_per_trade', name: 'No losses greater than ${amount} for {days} days', defaults: { amount: 500, days: 5 }, type: 'risk', condition: 'max_loss_days' },
          { id: 'max_daily_loss', name: 'Keep max daily loss under ${amount} for {days} days', defaults: { amount: 1000, days: 10 }, type: 'risk', condition: 'daily_loss_limit' },
          { id: 'no_mistakes', name: 'Complete {trades} trades with no mistakes tagged', defaults: { trades: 10 }, type: 'risk', condition: 'no_mistakes' },
        ],
        volume: [
          { id: 'trades_by_date', name: 'Complete {trades} trades by {date}', defaults: { trades: 20, date: '' }, type: 'volume', condition: 'trades_by_date' },
          { id: 'trade_every_day', name: 'Trade every market day for {weeks} weeks', defaults: { weeks: 2 }, type: 'volume', condition: 'consecutive_weeks' },
        ],
      };

      // Calculate yearly goal progress
      const yearlyGoalProgress = useMemo(() => {
        const goal = state.yearlyGoal;
        if (!goal || goal.year !== currentYear) return null;

        const yearStart = `${currentYear}-01-01`;
        const yearEnd = `${currentYear}-12-31`;
        
        const yearPnL = state.trades
          .filter(t => {
            const derived = calcTradeDerived(t);
            if (derived.isOpen) return false;
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= yearStart && exitDate <= yearEnd;
          })
          .reduce((sum, t) => sum + (calcTradeDerived(t).pnlFinal || 0), 0);

        const progress = goal.target > 0 ? (yearPnL / goal.target) * 100 : 0;
        const isComplete = yearPnL >= goal.target;

        // Calculate days remaining
        const now = new Date();
        const endOfYear = new Date(currentYear, 11, 31);
        const calendarDaysRemaining = Math.ceil((endOfYear - now) / (1000 * 60 * 60 * 24));
        
        // Estimate trading days remaining (roughly 252/365 ratio)
        const tradingDaysRemaining = Math.round(calendarDaysRemaining * (TRADING_DAYS_PER_YEAR / 365));

        // Extrapolated targets
        const dailyTarget = goal.target / TRADING_DAYS_PER_YEAR;
        const weeklyTarget = goal.target / 52;
        const monthlyTarget = goal.target / 12;
        const quarterlyTarget = goal.target / 4;

        return {
          goal,
          yearPnL,
          progress: Math.min(progress, 100),
          progressRaw: progress,
          isComplete,
          remaining: goal.target - yearPnL,
          calendarDaysRemaining,
          tradingDaysRemaining,
          dailyTarget,
          weeklyTarget,
          monthlyTarget,
          quarterlyTarget,
        };
      }, [state.yearlyGoal, state.trades, currentYear]);

      // Calculate challenge progress
      const challengesWithProgress = useMemo(() => {
        return (state.challenges || []).map(challenge => {
          let currentValue = 0;
          let targetValue = challenge.targetValue;
          let progress = 0;
          let isComplete = false;
          let isFailed = false;
          let statusText = 'In Progress';

          const now = new Date();
          const trades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) })).filter(t => !t.derived.isOpen);

          // Filter trades based on challenge start date
          const challengeTrades = trades.filter(t => {
            const exitDate = t.exitDate || t.entryDate;
            return exitDate >= challenge.startDate;
          });

          switch (challenge.condition) {
            case 'by_date': {
              currentValue = challengeTrades
                .filter(t => (t.exitDate || t.entryDate) <= challenge.endDate)
                .reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = currentValue >= targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'in_trades': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              currentValue = limitedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = currentValue >= targetValue && limitedTrades.length <= challenge.tradeLimit;
              isFailed = challengeTrades.length >= challenge.tradeLimit && currentValue < targetValue;
              break;
            }
            case 'streak_days': {
              // Check for consecutive profitable days
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              sortedDays.forEach(([date, pnl]) => {
                if (pnl >= targetValue) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'single_day': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              currentValue = Math.max(0, ...Object.values(dailyPnL));
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'single_trade': {
              currentValue = Math.max(0, ...challengeTrades.map(t => t.derived.pnlFinal || 0));
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'profitable_days': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              sortedDays.forEach(([date, pnl]) => {
                if (pnl > 0) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'trading_days': {
              const tradingDays = new Set(challengeTrades.map(t => t.exitDate || t.entryDate));
              // Check consecutive days
              const sortedDays = [...tradingDays].sort();
              let maxStreak = 0, currentStreak = 0, lastDate = null;
              sortedDays.forEach(date => {
                if (lastDate) {
                  const diff = (new Date(date) - new Date(lastDate)) / (1000 * 60 * 60 * 24);
                  if (diff === 1 || (diff <= 3 && isWeekend(lastDate))) { // Allow weekends
                    currentStreak++;
                  } else {
                    currentStreak = 1;
                  }
                } else {
                  currentStreak = 1;
                }
                maxStreak = Math.max(maxStreak, currentStreak);
                lastDate = date;
              });
              currentValue = maxStreak;
              targetValue = challenge.streakDays;
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'win_rate': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              const wins = limitedTrades.filter(t => t.derived.winLoss === 'W').length;
              currentValue = limitedTrades.length > 0 ? (wins / limitedTrades.length) * 100 : 0;
              targetValue = challenge.targetPercent;
              isComplete = limitedTrades.length >= challenge.tradeLimit && currentValue >= targetValue;
              isFailed = limitedTrades.length >= challenge.tradeLimit && currentValue < targetValue;
              break;
            }
            case 'max_loss_days': {
              const dailyMaxLoss = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                const loss = t.derived.pnlFinal < 0 ? Math.abs(t.derived.pnlFinal) : 0;
                dailyMaxLoss[date] = Math.max(dailyMaxLoss[date] || 0, loss);
              });
              const sortedDays = Object.entries(dailyMaxLoss).sort((a, b) => a[0].localeCompare(b[0]));
              let streak = 0;
              for (const [date, maxLoss] of sortedDays) {
                if (maxLoss <= challenge.maxLossAmount) {
                  streak++;
                } else {
                  streak = 0;
                }
              }
              currentValue = streak;
              targetValue = challenge.streakDays;
              isComplete = streak >= challenge.streakDays;
              break;
            }
            case 'daily_loss_limit': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let streak = 0;
              for (const [date, pnl] of sortedDays) {
                if (pnl >= -challenge.maxLossAmount) {
                  streak++;
                } else {
                  streak = 0;
                }
              }
              currentValue = streak;
              targetValue = challenge.streakDays;
              isComplete = streak >= challenge.streakDays;
              break;
            }
            case 'no_mistakes': {
              const cleanTrades = challengeTrades.filter(t => !t.mistakeIds || t.mistakeIds.length === 0);
              currentValue = cleanTrades.length;
              targetValue = challenge.tradeLimit;
              isComplete = currentValue >= targetValue;
              break;
            }
            case 'trades_by_date': {
              currentValue = challengeTrades.filter(t => (t.exitDate || t.entryDate) <= challenge.endDate).length;
              targetValue = challenge.tradeLimit;
              isComplete = currentValue >= targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'consecutive_weeks': {
              // Simplified: count weeks with at least one trade
              const weeksWithTrades = new Set();
              challengeTrades.forEach(t => {
                const date = new Date(t.exitDate || t.entryDate);
                const weekNum = Math.floor((date - new Date(currentYear, 0, 1)) / (7 * 24 * 60 * 60 * 1000));
                weeksWithTrades.add(weekNum);
              });
              currentValue = weeksWithTrades.size;
              targetValue = challenge.targetWeeks;
              isComplete = currentValue >= targetValue;
              break;
            }
          }

          progress = targetValue > 0 ? Math.min((currentValue / targetValue) * 100, 100) : 0;
          
          if (isComplete) {
            statusText = 'Completed';
          } else if (isFailed) {
            statusText = 'Failed';
          } else if (progress >= 75) {
            statusText = 'Almost There!';
          } else if (progress >= 50) {
            statusText = 'Halfway';
          }

          return {
            ...challenge,
            currentValue,
            targetValue,
            progress,
            isComplete,
            isFailed,
            statusText,
          };
        });
      }, [state.challenges, state.trades, currentYear]);

      // Helper function to check if date is weekend
      const isWeekend = (dateStr) => {
        const day = new Date(dateStr).getDay();
        return day === 0 || day === 6;
      };

      // Active and completed challenges
      const activeChallenges = challengesWithProgress.filter(c => !c.isComplete && !c.isFailed);
      const completedChallenges = challengesWithProgress.filter(c => c.isComplete);
      const failedChallenges = challengesWithProgress.filter(c => c.isFailed);

      // Save yearly goal
      const saveYearlyGoal = () => {
        const target = parseFloat(yearlyGoalInput);
        if (isNaN(target) || target <= 0) {
          setError('Please enter a valid profit target');
          return;
        }

        setState({
          ...state,
          yearlyGoal: {
            year: currentYear,
            target,
            createdAt: state.yearlyGoal?.createdAt || nowISO(),
            updatedAt: nowISO(),
          },
        });
        setYearlyGoalModalOpen(false);
        setError('');
      };

      // Create challenge from template
      const createChallengeFromTemplate = () => {
        if (!selectedTemplate) return;

        const template = Object.values(CHALLENGE_TEMPLATES).flat().find(t => t.id === selectedTemplate);
        if (!template) return;

        const values = templateValues[selectedTemplate] || template.defaults;
        
        const challenge = {
          id: generateId(),
          templateId: template.id,
          name: template.name
            .replace('{amount}', values.amount || '')
            .replace('{date}', values.date ? new Date(values.date).toLocaleDateString() : '')
            .replace('{trades}', values.trades || '')
            .replace('{days}', values.days || '')
            .replace('{percent}', values.percent || '')
            .replace('{weeks}', values.weeks || ''),
          type: template.type,
          condition: template.condition,
          targetValue: values.amount || 0,
          targetPercent: values.percent || 0,
          tradeLimit: values.trades || 0,
          streakDays: values.days || 0,
          targetWeeks: values.weeks || 0,
          maxLossAmount: values.amount || 0,
          endDate: values.date || '',
          startDate: todayISO(),
          createdAt: nowISO(),
        };

        setState({
          ...state,
          challenges: [...(state.challenges || []), challenge],
        });
        setChallengeModalOpen(false);
        setSelectedTemplate(null);
        setTemplateValues({});
      };

      // Create custom challenge
      const createCustomChallenge = () => {
        const { metricType, condition, value, timeValue, endDate } = customChallenge;
        
        if (!value || parseFloat(value) <= 0) {
          setError('Please enter a valid value');
          return;
        }

        let name = '';
        const challenge = {
          id: generateId(),
          type: metricType,
          condition,
          startDate: todayISO(),
          createdAt: nowISO(),
        };

        switch (condition) {
          case 'by_date':
            name = `Make $${value} by ${new Date(endDate).toLocaleDateString()}`;
            challenge.targetValue = parseFloat(value);
            challenge.endDate = endDate;
            break;
          case 'in_trades':
            name = `Make $${value} in ${timeValue} trades`;
            challenge.targetValue = parseFloat(value);
            challenge.tradeLimit = parseInt(timeValue);
            break;
          case 'streak_days':
            name = `Make $${value} for ${timeValue} days in a row`;
            challenge.targetValue = parseFloat(value);
            challenge.streakDays = parseInt(timeValue);
            break;
          case 'single_day':
            name = `Make $${value} in a single day`;
            challenge.targetValue = parseFloat(value);
            break;
          case 'single_trade':
            name = `Make $${value} in a single trade`;
            challenge.targetValue = parseFloat(value);
            break;
          case 'profitable_days':
            name = `Be profitable ${value} days in a row`;
            challenge.streakDays = parseInt(value);
            break;
          case 'win_rate':
            name = `Stay above ${value}% win rate for ${timeValue} trades`;
            challenge.targetPercent = parseFloat(value);
            challenge.tradeLimit = parseInt(timeValue);
            break;
          case 'max_loss_days':
            name = `No losses > $${value} for ${timeValue} days`;
            challenge.maxLossAmount = parseFloat(value);
            challenge.streakDays = parseInt(timeValue);
            break;
          case 'no_mistakes':
            name = `Complete ${value} trades with no mistakes`;
            challenge.tradeLimit = parseInt(value);
            break;
        }

        challenge.name = name;

        setState({
          ...state,
          challenges: [...(state.challenges || []), challenge],
        });
        setChallengeModalOpen(false);
        setCustomChallenge({ metricType: 'profit', condition: 'by_date', value: '', timeValue: '', endDate: '' });
        setError('');
      };

      // Delete challenge
      const deleteChallenge = (challengeId) => {
        setState({
          ...state,
          challenges: state.challenges.filter(c => c.id !== challengeId),
        });
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Goals & Challenges</h1>
              <p className="text-sm text-gray-500 mt-1">Set your yearly target and take on challenges</p>
            </div>
          </div>

          {/* Yearly Goal Section */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <h2 className="font-semibold text-gray-900">{currentYear} Yearly Goal</h2>
              <button
                onClick={() => {
                  setYearlyGoalInput(state.yearlyGoal?.target?.toString() || '');
                  setYearlyGoalModalOpen(true);
                }}
                className="text-sm text-blue-600 hover:text-blue-700 font-medium"
              >
                {state.yearlyGoal?.year === currentYear ? 'Edit' : 'Set Goal'}
              </button>
            </div>

            {yearlyGoalProgress ? (
              <div className="p-6">
                {/* Progress Section */}
                <div className="flex items-center gap-6 mb-6">
                  {/* Progress Ring */}
                  <div className="relative w-24 h-24 flex-shrink-0">
                    <svg className="w-full h-full transform -rotate-90">
                      <circle cx="50%" cy="50%" r="45%" fill="none" stroke="#e5e7eb" strokeWidth="8" />
                      <circle
                        cx="50%" cy="50%" r="45%" fill="none"
                        stroke={yearlyGoalProgress.isComplete ? '#10b981' : '#3b82f6'}
                        strokeWidth="8" strokeLinecap="round"
                        strokeDasharray={`${yearlyGoalProgress.progress * 2.83} 283`}
                      />
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <span className={`text-lg font-bold ${yearlyGoalProgress.isComplete ? 'text-emerald-600' : 'text-blue-600'}`}>
                        {yearlyGoalProgress.progress.toFixed(0)}%
                      </span>
                    </div>
                  </div>

                  {/* Stats */}
                  <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Target</p>
                      <p className="text-xl font-bold text-gray-900">{formatCurrency(yearlyGoalProgress.goal.target)}</p>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Current</p>
                      <p className={`text-xl font-bold ${yearlyGoalProgress.yearPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                        {formatCurrency(yearlyGoalProgress.yearPnL)}
                      </p>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Trading Days Left</p>
                      <p className="text-xl font-bold text-gray-900">{yearlyGoalProgress.tradingDaysRemaining}</p>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 uppercase">Calendar Days Left</p>
                      <p className="text-xl font-bold text-gray-900">{yearlyGoalProgress.calendarDaysRemaining}</p>
                    </div>
                  </div>
                </div>

                {/* Extrapolated Targets */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div className="bg-blue-50 rounded-lg p-4 text-center">
                    <p className="text-xs text-blue-600 uppercase font-medium">Daily Target</p>
                    <p className="text-lg font-bold text-blue-900">{formatCurrency(yearlyGoalProgress.dailyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-4 text-center">
                    <p className="text-xs text-blue-600 uppercase font-medium">Weekly Target</p>
                    <p className="text-lg font-bold text-blue-900">{formatCurrency(yearlyGoalProgress.weeklyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-4 text-center">
                    <p className="text-xs text-blue-600 uppercase font-medium">Monthly Target</p>
                    <p className="text-lg font-bold text-blue-900">{formatCurrency(yearlyGoalProgress.monthlyTarget)}</p>
                  </div>
                  <div className="bg-blue-50 rounded-lg p-4 text-center">
                    <p className="text-xs text-blue-600 uppercase font-medium">Quarterly Target</p>
                    <p className="text-lg font-bold text-blue-900">{formatCurrency(yearlyGoalProgress.quarterlyTarget)}</p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  {Icons.goals}
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No yearly goal set</h3>
                <p className="text-gray-500 mb-4">Set a profit target for {currentYear} to track your progress</p>
                <button
                  onClick={() => setYearlyGoalModalOpen(true)}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Set Yearly Goal</span>
                </button>
              </div>
            )}
          </div>

          {/* Challenges Section */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
              <h2 className="font-semibold text-gray-900">Challenges</h2>
              <button
                onClick={() => setChallengeModalOpen(true)}
                className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors font-medium"
              >
                {Icons.plus}
                <span>New Challenge</span>
              </button>
            </div>

            {/* Active Challenges */}
            {activeChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-gray-700 mb-3">Active ({activeChallenges.length})</h3>
                <div className="space-y-3">
                  {activeChallenges.map(challenge => (
                    <div key={challenge.id} className="bg-gray-50 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-2">
                        <h4 className="font-medium text-gray-900">{challenge.name}</h4>
                        <div className="flex items-center gap-2">
                          <span className={`text-xs px-2 py-0.5 rounded-full font-medium ${
                            challenge.progress >= 75 ? 'bg-emerald-100 text-emerald-700' :
                            challenge.progress >= 50 ? 'bg-blue-100 text-blue-700' :
                            'bg-gray-200 text-gray-600'
                          }`}>
                            {challenge.statusText}
                          </span>
                          <button
                            onClick={() => deleteChallenge(challenge.id)}
                            className="p-1 text-gray-400 hover:text-red-600"
                          >
                            {Icons.trash}
                          </button>
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                          <div 
                            className="h-full bg-blue-500 rounded-full transition-all"
                            style={{ width: `${challenge.progress}%` }}
                          />
                        </div>
                        <span className="text-sm font-medium text-gray-600 w-20 text-right">
                          {typeof challenge.currentValue === 'number' && challenge.currentValue % 1 !== 0 
                            ? challenge.currentValue.toFixed(1) 
                            : challenge.currentValue} / {challenge.targetValue}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Completed Challenges */}
            {completedChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-emerald-700 mb-3">‚úÖ Completed ({completedChallenges.length})</h3>
                <div className="space-y-2">
                  {completedChallenges.map(challenge => (
                    <div key={challenge.id} className="bg-emerald-50 rounded-lg p-3 flex items-center justify-between">
                      <span className="text-sm text-emerald-800">{challenge.name}</span>
                      <button
                        onClick={() => deleteChallenge(challenge.id)}
                        className="p-1 text-emerald-400 hover:text-red-600"
                      >
                        {Icons.trash}
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Failed Challenges */}
            {failedChallenges.length > 0 && (
              <div className="p-4 border-b border-gray-100">
                <h3 className="text-sm font-medium text-red-700 mb-3">‚ùå Failed ({failedChallenges.length})</h3>
                <div className="space-y-2">
                  {failedChallenges.map(challenge => (
                    <div key={challenge.id} className="bg-red-50 rounded-lg p-3 flex items-center justify-between">
                      <span className="text-sm text-red-800">{challenge.name}</span>
                      <button
                        onClick={() => deleteChallenge(challenge.id)}
                        className="p-1 text-red-400 hover:text-red-600"
                      >
                        {Icons.trash}
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Empty State */}
            {challengesWithProgress.length === 0 && (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  üèÜ
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No challenges yet</h3>
                <p className="text-gray-500 mb-4">Create challenges to push yourself and track achievements</p>
                <button
                  onClick={() => setChallengeModalOpen(true)}
                  className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                >
                  {Icons.plus}
                  <span>Create Your First Challenge</span>
                </button>
              </div>
            )}
          </div>

          {/* Yearly Goal Modal */}
          {yearlyGoalModalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setYearlyGoalModalOpen(false)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-md w-full">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">{currentYear} Yearly Goal</h2>
                  </div>
                  <div className="p-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Profit Target for {currentYear}
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                      <input
                        type="number"
                        value={yearlyGoalInput}
                        onChange={(e) => { setYearlyGoalInput(e.target.value); setError(''); }}
                        placeholder="100000"
                        className={`w-full pl-8 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${error ? 'border-red-500' : 'border-gray-300'}`}
                        autoFocus
                      />
                    </div>
                    {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    {yearlyGoalInput && parseFloat(yearlyGoalInput) > 0 && (
                      <div className="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                        <p>This breaks down to approximately:</p>
                        <ul className="mt-2 space-y-1">
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 252)}</strong> per trading day</li>
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 52)}</strong> per week</li>
                          <li>‚Ä¢ <strong>{formatCurrency(parseFloat(yearlyGoalInput) / 12)}</strong> per month</li>
                        </ul>
                      </div>
                    )}
                  </div>
                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex gap-3 rounded-b-xl">
                    <button onClick={() => setYearlyGoalModalOpen(false)} className="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onClick={saveYearlyGoal} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">Save Goal</button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Challenge Modal */}
          {challengeModalOpen && (
            <div className="fixed inset-0 z-50 overflow-y-auto">
              <div className="fixed inset-0 bg-black/50" onClick={() => setChallengeModalOpen(false)} />
              <div className="relative min-h-screen flex items-center justify-center p-4">
                <div className="relative bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h2 className="text-lg font-semibold text-gray-900">New Challenge</h2>
                  </div>

                  {/* Tabs */}
                  <div className="flex border-b border-gray-200">
                    <button
                      onClick={() => setChallengeTab('tried')}
                      className={`flex-1 px-4 py-3 text-sm font-medium ${challengeTab === 'tried' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      üèÜ Tried & True
                    </button>
                    <button
                      onClick={() => setChallengeTab('custom')}
                      className={`flex-1 px-4 py-3 text-sm font-medium ${challengeTab === 'custom' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                    >
                      ‚öôÔ∏è Custom
                    </button>
                  </div>

                  <div className="flex-1 overflow-y-auto p-6">
                    {challengeTab === 'tried' ? (
                      <div className="space-y-6">
                        {/* Profit Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üí∞ Profit-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.profit.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.amount !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Amount"
                                        value={templateValues[template.id]?.amount ?? template.defaults.amount}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], amount: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-24"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.date !== undefined && (
                                      <input
                                        type="date"
                                        value={templateValues[template.id]?.date ?? ''}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], date: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Consistency Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üìà Consistency-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.consistency.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.percent !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="%"
                                        value={templateValues[template.id]?.percent ?? template.defaults.percent}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], percent: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-16"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Risk Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üõ°Ô∏è Risk/Discipline-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.risk.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.amount !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Amount"
                                        value={templateValues[template.id]?.amount ?? template.defaults.amount}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], amount: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-24"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.days !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Days"
                                        value={templateValues[template.id]?.days ?? template.defaults.days}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], days: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Volume Challenges */}
                        <div>
                          <h3 className="text-sm font-semibold text-gray-700 mb-2">üìä Volume-Based</h3>
                          <div className="space-y-2">
                            {CHALLENGE_TEMPLATES.volume.map(template => (
                              <div
                                key={template.id}
                                onClick={() => setSelectedTemplate(selectedTemplate === template.id ? null : template.id)}
                                className={`p-3 rounded-lg border cursor-pointer transition-colors ${selectedTemplate === template.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-300'}`}
                              >
                                <p className="text-sm font-medium text-gray-900">{template.name.replace(/\{[^}]+\}/g, '___')}</p>
                                {selectedTemplate === template.id && (
                                  <div className="mt-3 flex flex-wrap gap-2">
                                    {template.defaults.trades !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Trades"
                                        value={templateValues[template.id]?.trades ?? template.defaults.trades}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], trades: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.weeks !== undefined && (
                                      <input
                                        type="number"
                                        placeholder="Weeks"
                                        value={templateValues[template.id]?.weeks ?? template.defaults.weeks}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], weeks: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm w-20"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                    {template.defaults.date !== undefined && (
                                      <input
                                        type="date"
                                        value={templateValues[template.id]?.date ?? ''}
                                        onChange={(e) => setTemplateValues({ ...templateValues, [template.id]: { ...templateValues[template.id], date: e.target.value } })}
                                        className="px-2 py-1 border rounded text-sm"
                                        onClick={(e) => e.stopPropagation()}
                                      />
                                    )}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Custom Challenge Builder */
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Challenge Type</label>
                          <select
                            value={customChallenge.condition}
                            onChange={(e) => setCustomChallenge({ ...customChallenge, condition: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <optgroup label="Profit">
                              <option value="by_date">Make $X by date</option>
                              <option value="in_trades">Make $X in N trades</option>
                              <option value="streak_days">Make $X for N days in a row</option>
                              <option value="single_day">Make $X in a single day</option>
                              <option value="single_trade">Make $X in a single trade</option>
                            </optgroup>
                            <optgroup label="Consistency">
                              <option value="profitable_days">Be profitable N days in a row</option>
                              <option value="win_rate">Stay above X% win rate for N trades</option>
                            </optgroup>
                            <optgroup label="Risk/Discipline">
                              <option value="max_loss_days">No losses greater than $X for N days</option>
                              <option value="no_mistakes">Complete N trades with no mistakes</option>
                            </optgroup>
                          </select>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            {['by_date', 'in_trades', 'streak_days', 'single_day', 'single_trade', 'max_loss_days'].includes(customChallenge.condition) ? 'Amount ($)' : 
                             customChallenge.condition === 'win_rate' ? 'Win Rate (%)' : 
                             'Number of Days/Trades'}
                          </label>
                          <input
                            type="number"
                            value={customChallenge.value}
                            onChange={(e) => setCustomChallenge({ ...customChallenge, value: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder={['by_date', 'in_trades', 'streak_days', 'single_day', 'single_trade', 'max_loss_days'].includes(customChallenge.condition) ? '5000' : '10'}
                          />
                        </div>

                        {['in_trades', 'streak_days', 'win_rate', 'max_loss_days'].includes(customChallenge.condition) && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              {customChallenge.condition === 'in_trades' || customChallenge.condition === 'win_rate' ? 'Number of Trades' : 'Number of Days'}
                            </label>
                            <input
                              type="number"
                              value={customChallenge.timeValue}
                              onChange={(e) => setCustomChallenge({ ...customChallenge, timeValue: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="10"
                            />
                          </div>
                        )}

                        {customChallenge.condition === 'by_date' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input
                              type="date"
                              value={customChallenge.endDate}
                              onChange={(e) => setCustomChallenge({ ...customChallenge, endDate: e.target.value })}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        )}

                        {error && <p className="text-red-500 text-sm">{error}</p>}
                      </div>
                    )}
                  </div>

                  <div className="px-6 py-4 bg-gray-50 border-t border-gray-200 flex gap-3">
                    <button
                      onClick={() => { setChallengeModalOpen(false); setSelectedTemplate(null); setError(''); }}
                      className="flex-1 px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={challengeTab === 'tried' ? createChallengeFromTemplate : createCustomChallenge}
                      disabled={challengeTab === 'tried' && !selectedTemplate}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      Start Challenge
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // =============================================================================
    // PROFILE PAGE
    // =============================================================================
    function ProfilePage({ state, setState, isMobile, userProfile, onSignOut, readOnly }) {
      const currentYear = new Date().getFullYear();

      // Calculate all-time stats
      const allTimeStats = useMemo(() => {
        const allTrades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) }));
        const closedTrades = allTrades.filter(t => !t.derived.isOpen);
        
        const totalTrades = closedTrades.length;
        const wins = closedTrades.filter(t => t.derived.winLoss === 'W');
        const losses = closedTrades.filter(t => t.derived.winLoss === 'L');
        const totalPnL = closedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
        const winRate = totalTrades > 0 ? ((wins.length / totalTrades) * 100).toFixed(1) : 0;
        
        const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / wins.length : 0;
        const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / losses.length) : 0;
        const profitFactor = avgLoss > 0 && losses.length > 0 ? (wins.reduce((sum, t) => sum + t.derived.pnlFinal, 0) / Math.abs(losses.reduce((sum, t) => sum + t.derived.pnlFinal, 0))).toFixed(2) : wins.length > 0 ? '‚àû' : '0';
        
        const biggestWin = wins.length > 0 ? Math.max(...wins.map(t => t.derived.pnlFinal)) : 0;
        const biggestLoss = losses.length > 0 ? Math.min(...losses.map(t => t.derived.pnlFinal)) : 0;
        
        // Trading days
        const tradingDays = new Set(closedTrades.map(t => t.exitDate || t.entryDate)).size;
        
        // Best and worst day
        const dailyPnL = {};
        closedTrades.forEach(t => {
          const date = t.exitDate || t.entryDate;
          dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
        });
        const days = Object.entries(dailyPnL);
        const bestDay = days.length > 0 ? days.reduce((best, curr) => curr[1] > best[1] ? curr : best, days[0]) : null;
        const worstDay = days.length > 0 ? days.reduce((worst, curr) => curr[1] < worst[1] ? curr : worst, days[0]) : null;
        
        // Average daily P&L
        const avgDailyPnL = tradingDays > 0 ? totalPnL / tradingDays : 0;

        // Green days vs red days
        const greenDays = days.filter(([_, pnl]) => pnl > 0).length;
        const redDays = days.filter(([_, pnl]) => pnl < 0).length;
        
        return {
          totalTrades,
          wins: wins.length,
          losses: losses.length,
          totalPnL,
          winRate,
          avgWin,
          avgLoss,
          profitFactor,
          biggestWin,
          biggestLoss,
          tradingDays,
          bestDay,
          worstDay,
          avgDailyPnL,
          greenDays,
          redDays,
        };
      }, [state.trades]);

      // Challenge stats
      const challengeStats = useMemo(() => {
        const challenges = state.challenges || [];
        let completedCount = 0;
        let failedCount = 0;
        const completedList = [];
        const failedList = [];

        challenges.forEach(challenge => {
          const trades = state.trades.map(t => ({ ...t, derived: calcTradeDerived(t) })).filter(t => !t.derived.isOpen);
          const challengeTrades = trades.filter(t => (t.exitDate || t.entryDate) >= challenge.startDate);
          let isComplete = false;
          let isFailed = false;
          const now = new Date();

          switch (challenge.condition) {
            case 'by_date': {
              const pnl = challengeTrades.filter(t => (t.exitDate || t.entryDate) <= challenge.endDate)
                .reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = pnl >= challenge.targetValue;
              isFailed = !isComplete && now > new Date(challenge.endDate + 'T23:59:59');
              break;
            }
            case 'single_day': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              isComplete = Object.values(dailyPnL).length > 0 && Math.max(...Object.values(dailyPnL)) >= challenge.targetValue;
              break;
            }
            case 'single_trade': {
              isComplete = challengeTrades.length > 0 && Math.max(...challengeTrades.map(t => t.derived.pnlFinal || 0)) >= challenge.targetValue;
              break;
            }
            case 'in_trades': {
              const limitedTrades = challengeTrades.slice(0, challenge.tradeLimit);
              const pnl = limitedTrades.reduce((sum, t) => sum + (t.derived.pnlFinal || 0), 0);
              isComplete = pnl >= challenge.targetValue && limitedTrades.length <= challenge.tradeLimit;
              isFailed = challengeTrades.length >= challenge.tradeLimit && pnl < challenge.targetValue;
              break;
            }
            case 'profitable_days':
            case 'streak_days': {
              const dailyPnL = {};
              challengeTrades.forEach(t => {
                const date = t.exitDate || t.entryDate;
                dailyPnL[date] = (dailyPnL[date] || 0) + (t.derived.pnlFinal || 0);
              });
              const sortedDays = Object.entries(dailyPnL).sort((a, b) => a[0].localeCompare(b[0]));
              let maxStreak = 0, currentStreak = 0;
              const threshold = challenge.condition === 'profitable_days' ? 0 : challenge.targetValue;
              sortedDays.forEach(([_, pnl]) => {
                if (pnl > threshold) {
                  currentStreak++;
                  maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                  currentStreak = 0;
                }
              });
              isComplete = maxStreak >= challenge.streakDays;
              break;
            }
            case 'no_mistakes': {
              const cleanTrades = challengeTrades.filter(t => !t.mistakeIds || t.mistakeIds.length === 0);
              isComplete = cleanTrades.length >= challenge.tradeLimit;
              break;
            }
          }

          if (isComplete) {
            completedCount++;
            completedList.push(challenge);
          } else if (isFailed) {
            failedCount++;
            failedList.push(challenge);
          }
        });

        const successRate = (completedCount + failedCount) > 0 
          ? ((completedCount / (completedCount + failedCount)) * 100).toFixed(0) 
          : 0;

        return {
          total: challenges.length,
          completed: completedCount,
          failed: failedCount,
          active: challenges.length - completedCount - failedCount,
          successRate,
          completedList,
          failedList,
        };
      }, [state.challenges, state.trades]);

      // Delete challenge from history
      const deleteChallenge = (challengeId) => {
        setState({
          ...state,
          challenges: state.challenges.filter(c => c.id !== challengeId),
        });
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Profile</h1>
            <p className="text-sm text-gray-500 mt-1">{readOnly ? 'Viewing trader statistics' : 'Your trading stats and challenge history'}</p>
          </div>

          {/* User Profile Card - only show if logged in user viewing their own profile */}
          {userProfile && !readOnly && (
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-2xl font-bold text-blue-600">
                    {userProfile.displayName?.charAt(0)?.toUpperCase() || '?'}
                  </div>
                  <div>
                    <h2 className="text-xl font-bold text-gray-900">{userProfile.displayName}</h2>
                    <p className="text-gray-500">{userProfile.email}</p>
                    <span className={`inline-block mt-1 px-2 py-0.5 text-xs rounded-full font-medium ${
                      userProfile.role === 'mentor' 
                        ? 'bg-purple-100 text-purple-700' 
                        : 'bg-blue-100 text-blue-700'
                    }`}>
                      {userProfile.role === 'mentor' ? 'üë®‚Äçüè´ Mentor' : 'üìà Trader'}
                    </span>
                    {userProfile.mentorName && (
                      <p className="text-sm text-gray-500 mt-1">
                        Mentored by: <span className="font-medium">{userProfile.mentorName}</span>
                      </p>
                    )}
                  </div>
                </div>
                {onSignOut && (
                  <button
                    onClick={onSignOut}
                    className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center gap-2"
                  >
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                      <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                      <polyline points="16 17 21 12 16 7" />
                      <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Sign Out
                  </button>
                )}
              </div>
            </div>
          )}

          {/* All-Time Stats */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="font-semibold text-gray-900">All-Time Statistics</h2>
            </div>
            <div className="p-6">
              {/* Main Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-gray-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-gray-500 uppercase mb-1">Total P&L</p>
                  <p className={`text-2xl font-bold ${allTimeStats.totalPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrency(allTimeStats.totalPnL)}
                  </p>
                </div>
                <div className="bg-gray-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-gray-500 uppercase mb-1">Total Trades</p>
                  <p className="text-2xl font-bold text-gray-900">{allTimeStats.totalTrades}</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-gray-500 uppercase mb-1">Win Rate</p>
                  <p className="text-2xl font-bold text-gray-900">{allTimeStats.winRate}%</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-gray-500 uppercase mb-1">Profit Factor</p>
                  <p className="text-2xl font-bold text-gray-900">{allTimeStats.profitFactor}</p>
                </div>
              </div>

              {/* Secondary Stats */}
              <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Wins / Losses</p>
                  <p className="text-lg font-semibold">
                    <span className="text-emerald-600">{allTimeStats.wins}</span>
                    {' / '}
                    <span className="text-red-600">{allTimeStats.losses}</span>
                  </p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Avg Win</p>
                  <p className="text-lg font-semibold text-emerald-600">{formatCurrencyShort(allTimeStats.avgWin)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Avg Loss</p>
                  <p className="text-lg font-semibold text-red-600">-{formatCurrencyShort(allTimeStats.avgLoss)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Biggest Win</p>
                  <p className="text-lg font-semibold text-emerald-600">{formatCurrencyShort(allTimeStats.biggestWin)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Biggest Loss</p>
                  <p className="text-lg font-semibold text-red-600">{formatCurrencyShort(allTimeStats.biggestLoss)}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Trading Days</p>
                  <p className="text-lg font-semibold text-gray-900">{allTimeStats.tradingDays}</p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Green / Red Days</p>
                  <p className="text-lg font-semibold">
                    <span className="text-emerald-600">{allTimeStats.greenDays}</span>
                    {' / '}
                    <span className="text-red-600">{allTimeStats.redDays}</span>
                  </p>
                </div>
                <div className="border border-gray-200 rounded-lg p-3">
                  <p className="text-[10px] text-gray-500 uppercase">Avg Daily P&L</p>
                  <p className={`text-lg font-semibold ${allTimeStats.avgDailyPnL >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                    {formatCurrencyShort(allTimeStats.avgDailyPnL)}
                  </p>
                </div>
                {allTimeStats.bestDay && (
                  <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-[10px] text-gray-500 uppercase">Best Day</p>
                    <p className="text-lg font-semibold text-emerald-600">{formatCurrencyShort(allTimeStats.bestDay[1])}</p>
                    <p className="text-[10px] text-gray-400">{allTimeStats.bestDay[0]}</p>
                  </div>
                )}
                {allTimeStats.worstDay && (
                  <div className="border border-gray-200 rounded-lg p-3">
                    <p className="text-[10px] text-gray-500 uppercase">Worst Day</p>
                    <p className="text-lg font-semibold text-red-600">{formatCurrencyShort(allTimeStats.worstDay[1])}</p>
                    <p className="text-[10px] text-gray-400">{allTimeStats.worstDay[0]}</p>
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* Challenge Stats */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="font-semibold text-gray-900">Challenge History</h2>
            </div>
            <div className="p-6">
              {/* Challenge Summary */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="bg-blue-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-blue-600 uppercase mb-1">Total Challenges</p>
                  <p className="text-2xl font-bold text-blue-900">{challengeStats.total}</p>
                </div>
                <div className="bg-emerald-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-emerald-600 uppercase mb-1">Completed</p>
                  <p className="text-2xl font-bold text-emerald-700">{challengeStats.completed}</p>
                </div>
                <div className="bg-red-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-red-600 uppercase mb-1">Failed</p>
                  <p className="text-2xl font-bold text-red-700">{challengeStats.failed}</p>
                </div>
                <div className="bg-gray-50 rounded-lg p-4 text-center">
                  <p className="text-xs text-gray-600 uppercase mb-1">Success Rate</p>
                  <p className="text-2xl font-bold text-gray-900">{challengeStats.successRate}%</p>
                </div>
              </div>

              {/* Completed Challenges List */}
              {challengeStats.completedList.length > 0 && (
                <div className="mb-4">
                  <h3 className="text-sm font-medium text-emerald-700 mb-2">‚úÖ Completed Challenges</h3>
                  <div className="space-y-2">
                    {challengeStats.completedList.map(challenge => (
                      <div key={challenge.id} className="flex items-center justify-between bg-emerald-50 rounded-lg p-3">
                        <div>
                          <p className="text-sm font-medium text-emerald-800">{challenge.name}</p>
                          <p className="text-xs text-emerald-600">Started: {challenge.startDate}</p>
                        </div>
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-emerald-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Failed Challenges List */}
              {challengeStats.failedList.length > 0 && (
                <div>
                  <h3 className="text-sm font-medium text-red-700 mb-2">‚ùå Failed Challenges</h3>
                  <div className="space-y-2">
                    {challengeStats.failedList.map(challenge => (
                      <div key={challenge.id} className="flex items-center justify-between bg-red-50 rounded-lg p-3">
                        <div>
                          <p className="text-sm font-medium text-red-800">{challenge.name}</p>
                          <p className="text-xs text-red-600">Started: {challenge.startDate}</p>
                        </div>
                        <button
                          onClick={() => deleteChallenge(challenge.id)}
                          className="p-1 text-red-400 hover:text-red-600"
                        >
                          {Icons.trash}
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {challengeStats.total === 0 && (
                <div className="text-center py-8 text-gray-500">
                  <p>No challenges yet. Create one from the Goals page!</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // SIDEBAR (Desktop) & BOTTOM NAV (Mobile)
    // =============================================================================
    function Sidebar({ isExpanded, setIsExpanded, activePage, setActivePage, isMobile, navItems }) {
      const items = navItems || NAV_ITEMS;
      
      // Mobile bottom navigation
      if (isMobile) {
        return (
          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-30 safe-area-bottom">
            <div className="flex justify-around items-center h-16">
              {items.slice(0, 5).map((item) => {
                const isActive = activePage === item.id;
                return (
                  <button
                    key={item.id}
                    onClick={() => setActivePage(item.id)}
                    className={`flex flex-col items-center justify-center flex-1 h-full transition-colors ${
                      isActive ? 'text-blue-600' : 'text-gray-500'
                    }`}
                  >
                    <span className={`${isActive ? 'scale-110' : ''} transition-transform`}>
                      {Icons[item.icon]}
                    </span>
                    <span className="text-[10px] mt-1 font-medium">{item.label}</span>
                  </button>
                );
              })}
            </div>
          </nav>
        );
      }

      // Desktop sidebar
      return (
        <aside className={`fixed left-0 top-0 h-full bg-slate-900 text-white transition-all duration-300 ease-in-out z-30 ${isExpanded ? 'w-56' : 'w-16'} flex flex-col`}>
          <div className="h-14 flex items-center justify-between px-4 border-b border-slate-700">
            {isExpanded && <span className="font-bold text-lg tracking-tight">TradeJournal</span>}
            <button onClick={() => setIsExpanded(!isExpanded)} className="p-1.5 rounded-lg hover:bg-slate-800 transition-colors ml-auto">
              {isExpanded ? Icons.chevronLeft : Icons.chevronRight}
            </button>
          </div>
          <nav className="flex-1 py-4">
            <ul className="space-y-1 px-2">
              {items.map((item) => {
                const isActive = activePage === item.id;
                return (
                  <li key={item.id}>
                    <button
                      onClick={() => setActivePage(item.id)}
                      className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-colors duration-150
                        ${isActive ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-800 hover:text-white'}`}
                    >
                      <span className="flex-shrink-0">{Icons[item.icon]}</span>
                      {isExpanded && <span className="text-sm font-medium truncate">{item.label}</span>}
                    </button>
                  </li>
                );
              })}
            </ul>
          </nav>
        </aside>
      );
    }

    // =============================================================================
    // TOP BAR
    // =============================================================================
    function TopBar({ storageInfo, sidebarExpanded, isMobile, userProfile, onSignOut }) {
      const { megabytes, percentUsed, nearLimit } = storageInfo;
      const limitMB = (STORAGE_LIMIT_BYTES / (1024 * 1024)).toFixed(2);
      const [showMenu, setShowMenu] = useState(false);

      if (isMobile) {
        return (
          <header className="fixed top-0 left-0 right-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-20">
            <span className="font-bold text-lg text-slate-900">TradeJournal</span>
            <div className="flex items-center gap-3">
              {userProfile && (
                <div className="relative">
                  <button
                    onClick={() => setShowMenu(!showMenu)}
                    className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-bold text-blue-600"
                  >
                    {userProfile.displayName?.charAt(0)?.toUpperCase() || '?'}
                  </button>
                  {showMenu && (
                    <>
                      <div className="fixed inset-0" onClick={() => setShowMenu(false)} />
                      <div className="absolute right-0 top-10 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[160px] z-50">
                        <div className="px-4 py-2 border-b border-gray-100">
                          <p className="font-medium text-gray-900 text-sm">{userProfile.displayName}</p>
                          <p className="text-xs text-gray-500">{userProfile.email}</p>
                          <p className="text-xs text-blue-600 capitalize">{userProfile.role}</p>
                        </div>
                        <button
                          onClick={() => { setShowMenu(false); onSignOut(); }}
                          className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50"
                        >
                          Sign Out
                        </button>
                      </div>
                    </>
                  )}
                </div>
              )}
            </div>
          </header>
        );
      }

      return (
        <header className={`fixed top-0 right-0 h-14 bg-white border-b border-gray-200 flex items-center justify-between px-4 z-20 transition-all duration-300 ease-in-out ${sidebarExpanded ? 'left-56' : 'left-16'}`}>
          <div className="flex-1" />
          <div className="flex items-center gap-4">
            {nearLimit && (
              <div className="flex items-center gap-1.5 px-2.5 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-medium">
                <span className="text-amber-600">{Icons.warning}</span>
                <span>Storage {percentUsed}% full</span>
              </div>
            )}
            {userProfile && (
              <div className="relative">
                <button
                  onClick={() => setShowMenu(!showMenu)}
                  className="flex items-center gap-2 px-3 py-1.5 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-sm font-bold text-blue-600">
                    {userProfile.displayName?.charAt(0)?.toUpperCase() || '?'}
                  </div>
                  <div className="text-left hidden md:block">
                    <p className="text-sm font-medium text-gray-900">{userProfile.displayName}</p>
                    <p className="text-xs text-gray-500 capitalize">{userProfile.role}</p>
                  </div>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4 text-gray-400">
                    <path d="M6 9l6 6 6-6" />
                  </svg>
                </button>
                {showMenu && (
                  <>
                    <div className="fixed inset-0" onClick={() => setShowMenu(false)} />
                    <div className="absolute right-0 top-12 bg-white rounded-lg shadow-lg border border-gray-200 py-2 min-w-[200px] z-50">
                      <div className="px-4 py-2 border-b border-gray-100">
                        <p className="font-medium text-gray-900">{userProfile.displayName}</p>
                        <p className="text-sm text-gray-500">{userProfile.email}</p>
                      </div>
                      <button
                        onClick={() => { setShowMenu(false); onSignOut(); }}
                        className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"
                      >
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-4 h-4">
                          <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" />
                          <polyline points="16 17 21 12 16 7" />
                          <line x1="21" y1="12" x2="9" y2="12" />
                        </svg>
                        Sign Out
                      </button>
                    </div>
                  </>
                )}
              </div>
            )}
          </div>
        </header>
      );
    }

    // =============================================================================
    // AUTH SCREENS
    // =============================================================================
    function AuthScreen({ onAuthSuccess }) {
      const [mode, setMode] = useState('login'); // 'login', 'signup', 'reset'
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [confirmPassword, setConfirmPassword] = useState('');
      const [displayName, setDisplayName] = useState('');
      const [accountType, setAccountType] = useState('trader'); // 'trader' or 'mentor'
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [message, setMessage] = useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await auth.signInWithEmailAndPassword(email, password);
          // onAuthSuccess will be triggered by auth state change
        } catch (err) {
          setError(getAuthErrorMessage(err.code));
        } finally {
          setLoading(false);
        }
      };

      const handleSignup = async (e) => {
        e.preventDefault();
        setError('');

        if (password !== confirmPassword) {
          setError('Passwords do not match');
          return;
        }

        if (password.length < 6) {
          setError('Password must be at least 6 characters');
          return;
        }

        if (!displayName.trim()) {
          setError('Please enter your name');
          return;
        }

        setLoading(true);

        try {
          // Create auth user
          const userCredential = await auth.createUserWithEmailAndPassword(email, password);
          const user = userCredential.user;

          // Update display name
          await user.updateProfile({ displayName: displayName.trim() });

          // Create user document in Firestore
          await db.collection('users').doc(user.uid).set({
            email: user.email,
            displayName: displayName.trim(),
            role: accountType,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          });

          // Initialize empty journal data
          await db.collection('users').doc(user.uid).collection('journalData').doc('state').set({
            trades: [],
            setups: [],
            mistakes: [],
            dailyNotes: {},
            yearlyGoal: null,
            challenges: [],
          });

          // If mentor, create mentorships collection
          if (accountType === 'mentor') {
            await db.collection('mentorships').doc(user.uid).set({
              mentorName: displayName.trim(),
              mentorEmail: user.email,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            });
          }

          // Send welcome email
          const welcomeEmailData = emailTemplates.welcome(user.email, displayName.trim());
          await sendEmail(welcomeEmailData);

        } catch (err) {
          setError(getAuthErrorMessage(err.code));
        } finally {
          setLoading(false);
        }
      };

      const handleReset = async (e) => {
        e.preventDefault();
        setError('');
        setMessage('');
        setLoading(true);

        try {
          await auth.sendPasswordResetEmail(email);
          setMessage('Password reset email sent! Check your inbox.');
        } catch (err) {
          setError(getAuthErrorMessage(err.code));
        } finally {
          setLoading(false);
        }
      };

      const getAuthErrorMessage = (code) => {
        switch (code) {
          case 'auth/email-already-in-use':
            return 'An account with this email already exists';
          case 'auth/invalid-email':
            return 'Invalid email address';
          case 'auth/operation-not-allowed':
            return 'Email/password accounts are not enabled';
          case 'auth/weak-password':
            return 'Password is too weak';
          case 'auth/user-disabled':
            return 'This account has been disabled';
          case 'auth/user-not-found':
            return 'No account found with this email';
          case 'auth/wrong-password':
            return 'Incorrect password';
          case 'auth/invalid-credential':
            return 'Invalid email or password';
          case 'auth/too-many-requests':
            return 'Too many attempts. Please try again later';
          default:
            return 'An error occurred. Please try again';
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            {/* Header */}
            <div className="bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-6 text-center">
              <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-3">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" className="w-8 h-8">
                  <path d="M3 3v18h18" />
                  <path d="M18 9l-5 5-4-4-3 3" />
                </svg>
              </div>
              <h1 className="text-2xl font-bold text-white">Trading Journal</h1>
              <p className="text-blue-100 text-sm mt-1">
                {mode === 'login' ? 'Welcome back!' : mode === 'signup' ? 'Create your account' : 'Reset your password'}
              </p>
            </div>

            {/* Form */}
            <div className="p-8">
              {error && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                  {error}
                </div>
              )}

              {message && (
                <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm">
                  {message}
                </div>
              )}

              {mode === 'login' && (
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="you@example.com"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'Signing in...' : 'Sign In'}
                  </button>
                </form>
              )}

              {mode === 'signup' && (
                <form onSubmit={handleSignup} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input
                      type="text"
                      value={displayName}
                      onChange={(e) => setDisplayName(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="John Doe"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="you@example.com"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      required
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <input
                      type="password"
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      required
                    />
                  </div>

                  {/* Account Type Selection */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Account Type</label>
                    <div className="grid grid-cols-2 gap-3">
                      <button
                        type="button"
                        onClick={() => setAccountType('trader')}
                        className={`p-4 rounded-lg border-2 transition-all ${
                          accountType === 'trader'
                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-2xl mb-1">üìà</div>
                        <div className="font-medium">Trader</div>
                        <div className="text-xs text-gray-500">Track your trades</div>
                      </button>
                      <button
                        type="button"
                        onClick={() => setAccountType('mentor')}
                        className={`p-4 rounded-lg border-2 transition-all ${
                          accountType === 'mentor'
                            ? 'border-blue-500 bg-blue-50 text-blue-700'
                            : 'border-gray-200 hover:border-gray-300'
                        }`}
                      >
                        <div className="text-2xl mb-1">üë®‚Äçüè´</div>
                        <div className="font-medium">Mentor</div>
                        <div className="text-xs text-gray-500">Guide your mentees</div>
                      </button>
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'Creating account...' : 'Create Account'}
                  </button>
                </form>
              )}

              {mode === 'reset' && (
                <form onSubmit={handleReset} className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="you@example.com"
                      required
                    />
                  </div>
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'Sending...' : 'Send Reset Email'}
                  </button>
                </form>
              )}

              {/* Footer Links */}
              <div className="mt-6 text-center text-sm">
                {mode === 'login' && (
                  <>
                    <button
                      onClick={() => { setMode('reset'); setError(''); setMessage(''); }}
                      className="text-blue-600 hover:underline"
                    >
                      Forgot password?
                    </button>
                    <div className="mt-3 text-gray-600">
                      Don't have an account?{' '}
                      <button
                        onClick={() => { setMode('signup'); setError(''); setMessage(''); }}
                        className="text-blue-600 hover:underline font-medium"
                      >
                        Sign up
                      </button>
                    </div>
                  </>
                )}

                {mode === 'signup' && (
                  <div className="text-gray-600">
                    Already have an account?{' '}
                    <button
                      onClick={() => { setMode('login'); setError(''); setMessage(''); }}
                      className="text-blue-600 hover:underline font-medium"
                    >
                      Sign in
                    </button>
                  </div>
                )}

                {mode === 'reset' && (
                  <button
                    onClick={() => { setMode('login'); setError(''); setMessage(''); }}
                    className="text-blue-600 hover:underline"
                  >
                    Back to sign in
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // MENTEES PAGE (FOR MENTORS)
    // =============================================================================
    function MenteesPage({ userProfile, isMobile }) {
      const [mentees, setMentees] = useState([]);
      const [inviteEmail, setInviteEmail] = useState('');
      const [loading, setLoading] = useState(true);
      const [inviting, setInviting] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const [selectedMentee, setSelectedMentee] = useState(null);
      const [menteeData, setMenteeData] = useState(null);
      const [loadingMenteeData, setLoadingMenteeData] = useState(false);

      // Load mentees
      useEffect(() => {
        if (!userProfile?.uid) return;

        const unsubscribe = db.collection('mentorships')
          .doc(userProfile.uid)
          .collection('mentees')
          .onSnapshot((snapshot) => {
            const menteeList = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setMentees(menteeList);
            setLoading(false);
          });

        return () => unsubscribe();
      }, [userProfile?.uid]);

      // Send invite
      const handleInvite = async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');
        setInviting(true);

        try {
          // Find user by email
          const usersSnapshot = await db.collection('users')
            .where('email', '==', inviteEmail.toLowerCase().trim())
            .get();

          if (usersSnapshot.empty) {
            setError('No user found with that email. They need to create an account first.');
            setInviting(false);
            return;
          }

          const menteeDoc = usersSnapshot.docs[0];
          const menteeUserData = menteeDoc.data();

          if (menteeUserData.role === 'mentor') {
            setError('That user is a mentor account, not a trader.');
            setInviting(false);
            return;
          }

          if (menteeUserData.mentorId) {
            setError('That trader already has a mentor connected.');
            setInviting(false);
            return;
          }

          // Check if already invited
          const existingMentee = mentees.find(m => m.email === inviteEmail.toLowerCase().trim());
          if (existingMentee) {
            setError('You have already invited this trader.');
            setInviting(false);
            return;
          }

          // Add to mentor's mentees
          await db.collection('mentorships')
            .doc(userProfile.uid)
            .collection('mentees')
            .doc(menteeDoc.id)
            .set({
              email: menteeUserData.email,
              displayName: menteeUserData.displayName,
              status: 'pending',
              invitedAt: firebase.firestore.FieldValue.serverTimestamp(),
            });

          // Update mentee's user doc with pending mentor
          await db.collection('users').doc(menteeDoc.id).update({
            pendingMentorId: userProfile.uid,
            pendingMentorName: userProfile.displayName,
            pendingMentorEmail: userProfile.email,
          });

          // Send email notification to mentee
          const emailData = emailTemplates.mentorInvite(userProfile.displayName, menteeUserData.email);
          await sendEmail(emailData);

          setSuccess(`Invite sent to ${menteeUserData.displayName}!`);
          setInviteEmail('');
        } catch (err) {
          console.error('Invite error:', err);
          setError('Failed to send invite. Please try again.');
        } finally {
          setInviting(false);
        }
      };

      // Load mentee data when selected
      const loadMenteeData = async (mentee) => {
        if (mentee.status !== 'active') {
          setError('This mentee has not accepted your invite yet.');
          return;
        }

        setLoadingMenteeData(true);
        setSelectedMentee(mentee);

        try {
          const stateDoc = await db.collection('users')
            .doc(mentee.id)
            .collection('journalData')
            .doc('state')
            .get();

          if (stateDoc.exists) {
            setMenteeData(stateDoc.data());
          } else {
            setMenteeData(EMPTY_STATE);
          }
        } catch (err) {
          console.error('Failed to load mentee data:', err);
          setError('Failed to load mentee data.');
        } finally {
          setLoadingMenteeData(false);
        }
      };

      // Remove mentee
      const removeMentee = async (menteeId) => {
        if (!confirm('Are you sure you want to remove this mentee?')) return;

        try {
          // Remove from mentor's list
          await db.collection('mentorships')
            .doc(userProfile.uid)
            .collection('mentees')
            .doc(menteeId)
            .delete();

          // Update mentee's user doc
          await db.collection('users').doc(menteeId).update({
            mentorId: firebase.firestore.FieldValue.delete(),
            mentorName: firebase.firestore.FieldValue.delete(),
            pendingMentorId: firebase.firestore.FieldValue.delete(),
            pendingMentorName: firebase.firestore.FieldValue.delete(),
            pendingMentorEmail: firebase.firestore.FieldValue.delete(),
          });

          if (selectedMentee?.id === menteeId) {
            setSelectedMentee(null);
            setMenteeData(null);
          }
        } catch (err) {
          console.error('Failed to remove mentee:', err);
          setError('Failed to remove mentee.');
        }
      };

      // If viewing a mentee's data, show their profile
      if (selectedMentee && menteeData) {
        return (
          <div className="space-y-6">
            {/* Back button */}
            <button
              onClick={() => { setSelectedMentee(null); setMenteeData(null); }}
              className="flex items-center gap-2 text-blue-600 hover:text-blue-700"
            >
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" className="w-5 h-5">
                <path d="M19 12H5M12 19l-7-7 7-7" />
              </svg>
              Back to Mentees
            </button>

            {/* Mentee Header */}
            <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
              <div className="flex items-center gap-4">
                <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-2xl font-bold text-blue-600">
                  {selectedMentee.displayName?.charAt(0)?.toUpperCase() || '?'}
                </div>
                <div>
                  <h2 className="text-xl font-bold text-gray-900">{selectedMentee.displayName}</h2>
                  <p className="text-gray-500">{selectedMentee.email}</p>
                </div>
              </div>
            </div>

            {/* Render mentee's ProfilePage with their data */}
            <ProfilePage state={menteeData} setState={() => {}} isMobile={isMobile} readOnly={true} />
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header */}
          <div>
            <h1 className="text-2xl font-bold text-gray-900">My Mentees</h1>
            <p className="text-sm text-gray-500 mt-1">Manage and view your mentees' progress</p>
          </div>

          {/* Invite Section */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm p-6">
            <h2 className="font-semibold text-gray-900 mb-4">Invite a Trader</h2>
            
            {error && (
              <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm">
                {error}
              </div>
            )}
            
            {success && (
              <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-600 text-sm">
                {success}
              </div>
            )}

            <form onSubmit={handleInvite} className="flex gap-3">
              <input
                type="email"
                value={inviteEmail}
                onChange={(e) => setInviteEmail(e.target.value)}
                placeholder="Enter trader's email"
                className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                required
              />
              <button
                type="submit"
                disabled={inviting}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50"
              >
                {inviting ? 'Sending...' : 'Send Invite'}
              </button>
            </form>
          </div>

          {/* Mentees List */}
          <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div className="px-6 py-4 border-b border-gray-200">
              <h2 className="font-semibold text-gray-900">Your Mentees ({mentees.length})</h2>
            </div>

            {loading ? (
              <div className="p-8 text-center text-gray-500">Loading...</div>
            ) : mentees.length === 0 ? (
              <div className="p-12 text-center">
                <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                  üë•
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">No mentees yet</h3>
                <p className="text-gray-500">Invite traders to start mentoring them</p>
              </div>
            ) : (
              <div className="divide-y divide-gray-200">
                {mentees.map(mentee => (
                  <div key={mentee.id} className="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-lg font-bold text-blue-600">
                        {mentee.displayName?.charAt(0)?.toUpperCase() || '?'}
                      </div>
                      <div>
                        <h3 className="font-medium text-gray-900">{mentee.displayName}</h3>
                        <p className="text-sm text-gray-500">{mentee.email}</p>
                      </div>
                      <span className={`px-2 py-1 text-xs rounded-full font-medium ${
                        mentee.status === 'active' 
                          ? 'bg-green-100 text-green-700' 
                          : 'bg-yellow-100 text-yellow-700'
                      }`}>
                        {mentee.status === 'active' ? 'Active' : 'Pending'}
                      </span>
                    </div>
                    <div className="flex items-center gap-2">
                      {mentee.status === 'active' && (
                        <button
                          onClick={() => loadMenteeData(mentee)}
                          className="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700"
                        >
                          View Journal
                        </button>
                      )}
                      <button
                        onClick={() => removeMentee(mentee.id)}
                        className="p-2 text-gray-400 hover:text-red-600"
                        title="Remove mentee"
                      >
                        {Icons.trash}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // =============================================================================
    // MENTOR INVITE BANNER (FOR TRADERS)
    // =============================================================================
    function MentorInviteBanner({ userProfile, onUpdate }) {
      const [responding, setResponding] = useState(false);

      const handleResponse = async (accept) => {
        setResponding(true);

        try {
          if (accept) {
            // Accept - update trader's profile
            await db.collection('users').doc(userProfile.uid).update({
              mentorId: userProfile.pendingMentorId,
              mentorName: userProfile.pendingMentorName,
              pendingMentorId: firebase.firestore.FieldValue.delete(),
              pendingMentorName: firebase.firestore.FieldValue.delete(),
              pendingMentorEmail: firebase.firestore.FieldValue.delete(),
            });

            // Update mentor's mentee record
            await db.collection('mentorships')
              .doc(userProfile.pendingMentorId)
              .collection('mentees')
              .doc(userProfile.uid)
              .update({
                status: 'active',
                acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
              });

            // Send email notification to mentor
            const emailData = emailTemplates.inviteAccepted(userProfile.pendingMentorEmail, userProfile.displayName);
            await sendEmail(emailData);
          } else {
            // Decline - remove pending mentor
            await db.collection('users').doc(userProfile.uid).update({
              pendingMentorId: firebase.firestore.FieldValue.delete(),
              pendingMentorName: firebase.firestore.FieldValue.delete(),
              pendingMentorEmail: firebase.firestore.FieldValue.delete(),
            });

            // Remove from mentor's list
            await db.collection('mentorships')
              .doc(userProfile.pendingMentorId)
              .collection('mentees')
              .doc(userProfile.uid)
              .delete();
          }

          onUpdate();
        } catch (err) {
          console.error('Failed to respond to invite:', err);
          alert('Failed to respond. Please try again.');
        } finally {
          setResponding(false);
        }
      };

      if (!userProfile.pendingMentorId) return null;

      return (
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
          <div className="flex items-center justify-between">
            <div>
              <h3 className="font-medium text-blue-900">Mentor Invitation</h3>
              <p className="text-sm text-blue-700">
                <strong>{userProfile.pendingMentorName}</strong> wants to mentor you
              </p>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => handleResponse(false)}
                disabled={responding}
                className="px-4 py-2 text-gray-600 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50"
              >
                Decline
              </button>
              <button
                onClick={() => handleResponse(true)}
                disabled={responding}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
              >
                {responding ? 'Accepting...' : 'Accept'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // =============================================================================
    // MAIN APP
    // =============================================================================
    function App() {
      const [user, setUser] = useState(null);
      const [userProfile, setUserProfile] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [sidebarExpanded, setSidebarExpanded] = useState(true);
      const [activePage, setActivePage] = useState('dashboard');
      const [selectedDate, setSelectedDate] = useState(null);
      const [journalState, setJournalState] = useState(EMPTY_STATE);
      const [storageInfo, setStorageInfo] = useState({ bytes: 0, megabytes: 0, percentUsed: 0, nearLimit: false });
      const [isMobile, setIsMobile] = useState(false);
      const [dataLoading, setDataLoading] = useState(true);

      // Listen for auth state changes
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
          setUser(firebaseUser);
          
          if (firebaseUser) {
            // Load user profile
            const profileDoc = await db.collection('users').doc(firebaseUser.uid).get();
            if (profileDoc.exists) {
              setUserProfile({ uid: firebaseUser.uid, ...profileDoc.data() });
            }
          } else {
            setUserProfile(null);
          }
          
          setAuthLoading(false);
        });

        return () => unsubscribe();
      }, []);

      // Load user's journal data from Firestore
      useEffect(() => {
        if (!user) {
          setDataLoading(false);
          return;
        }

        setDataLoading(true);

        const unsubscribe = db.collection('users')
          .doc(user.uid)
          .collection('journalData')
          .doc('state')
          .onSnapshot((doc) => {
            if (doc.exists) {
              const data = doc.data();
              setJournalState({
                trades: data.trades || [],
                setups: data.setups || [],
                mistakes: data.mistakes || [],
                dailyNotes: data.dailyNotes || {},
                yearlyGoal: data.yearlyGoal || null,
                challenges: data.challenges || [],
              });
            } else {
              setJournalState(EMPTY_STATE);
            }
            setDataLoading(false);
          }, (error) => {
            console.error('Firestore error:', error);
            setDataLoading(false);
          });

        return () => unsubscribe();
      }, [user]);

      // Save journal state to Firestore
      const saveJournalState = async (newState) => {
        if (!user) return;

        setJournalState(newState);

        try {
          await db.collection('users')
            .doc(user.uid)
            .collection('journalData')
            .doc('state')
            .set(newState, { merge: true });
          // Save successful - no alert needed
        } catch (error) {
          console.error('Failed to save to Firestore:', error);
          // Only show alert for actual permission/network errors, not for benign issues
          if (error.code === 'permission-denied') {
            alert('Permission denied. Please sign out and sign back in.');
          } else if (error.code === 'unavailable') {
            alert('Network error. Your changes will sync when connection is restored.');
          }
          // For other errors, just log them - Firestore will retry automatically
        }
      };

      // Reload user profile
      const reloadProfile = async () => {
        if (!user) return;
        const profileDoc = await db.collection('users').doc(user.uid).get();
        if (profileDoc.exists) {
          setUserProfile({ uid: user.uid, ...profileDoc.data() });
        }
      };

      // Handle sign out
      const handleSignOut = async () => {
        try {
          await auth.signOut();
          setActivePage('dashboard');
        } catch (error) {
          console.error('Sign out error:', error);
        }
      };

      // Mobile detection
      useEffect(() => {
        const handleResize = () => {
          const mobile = window.innerWidth < 768;
          setIsMobile(mobile);
          if (window.innerWidth < 1024) setSidebarExpanded(false);
          else setSidebarExpanded(true);
        };
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      // Show loading screen
      if (authLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthScreen />;
      }

      // Show loading while data loads
      if (dataLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-gray-600">Loading your journal...</p>
            </div>
          </div>
        );
      }

      // Build nav items based on role
      const navItems = userProfile?.role === 'mentor' 
        ? [...NAV_ITEMS, { id: 'mentees', label: 'Mentees', icon: 'mentees' }]
        : NAV_ITEMS;

      const renderPage = () => {
        // Show mentor invite banner for traders
        const inviteBanner = userProfile?.role === 'trader' && userProfile?.pendingMentorId ? (
          <MentorInviteBanner userProfile={userProfile} onUpdate={reloadProfile} />
        ) : null;

        switch (activePage) {
          case 'dashboard':
            return <>{inviteBanner}<DashboardPage state={journalState} setState={saveJournalState} setActivePage={setActivePage} setSelectedDate={setSelectedDate} isMobile={isMobile} /></>;
          case 'tradelog':
            return <>{inviteBanner}<TradeLogPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'calendar':
            return <>{inviteBanner}<CalendarPage state={journalState} setState={saveJournalState} selectedDate={selectedDate} setSelectedDate={setSelectedDate} isMobile={isMobile} /></>;
          case 'goals':
            return <>{inviteBanner}<GoalsPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'setups':
            return <>{inviteBanner}<SetupsPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'mistakes':
            return <>{inviteBanner}<MistakesPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
          case 'profile':
            return <>{inviteBanner}<ProfilePage state={journalState} setState={saveJournalState} isMobile={isMobile} userProfile={userProfile} onSignOut={handleSignOut} /></>;
          case 'mentees':
            return <MenteesPage userProfile={userProfile} isMobile={isMobile} />;
          default:
            return <>{inviteBanner}<DashboardPage state={journalState} setState={saveJournalState} isMobile={isMobile} /></>;
        }
      };

      return (
        <AuthContext.Provider value={{ user, userProfile, reloadProfile }}>
          <div className="min-h-screen bg-gray-50">
            {!isMobile && <Sidebar isExpanded={sidebarExpanded} setIsExpanded={setSidebarExpanded} activePage={activePage} setActivePage={setActivePage} isMobile={false} navItems={navItems} />}
            <TopBar storageInfo={storageInfo} sidebarExpanded={sidebarExpanded} isMobile={isMobile} userProfile={userProfile} onSignOut={handleSignOut} />
            <main className={`pt-14 min-h-screen transition-all duration-300 ease-in-out ${isMobile ? 'pb-20' : (sidebarExpanded ? 'pl-56' : 'pl-16')}`}>
              <div className={`${isMobile ? 'p-3' : 'p-6'}`}>{renderPage()}</div>
            </main>
            {isMobile && <Sidebar isExpanded={false} setIsExpanded={() => {}} activePage={activePage} setActivePage={setActivePage} isMobile={true} navItems={navItems} />}
          </div>
        </AuthContext.Provider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
